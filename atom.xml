<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>智伤帝的个人博客</title>
  
  <subtitle>岁月不饶人，我亦未曾饶过岁月。</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.l0v0.com/"/>
  <updated>2022-12-14T02:54:16.794Z</updated>
  <id>https://blog.l0v0.com/</id>
  
  <author>
    <name>智伤帝</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Maya 拍屏方案汇总</title>
    <link href="https://blog.l0v0.com/posts/ffec6f64.html"/>
    <id>https://blog.l0v0.com/posts/ffec6f64.html</id>
    <published>2022-11-28T13:30:46.000Z</published>
    <updated>2022-12-14T02:54:16.794Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;最近接到了一个需求，又是熟悉的 拍屏工具。<br>&emsp;&emsp;其实老早之前我就有写过类似的需求，只是表现形式各不相同。<br>&emsp;&emsp;这里打算将不同的拍屏方案汇总到一起，这样大家可以挑选一个合适的情景的方式完成这个任务。</p></blockquote><h2 id="拍屏方案汇总"><a href="#拍屏方案汇总" class="headerlink" title="拍屏方案汇总"></a>拍屏方案汇总</h2><p><a href="./404240a4.html">Maya Python Publish 检查功能开发</a></p><blockquote><p>&emsp;&emsp;最早在华强实习的时候，就写过将 Arnold 渲染的界面合成并打开 RV 进行预览。<br>&emsp;&emsp;背后主要用 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/renderWindowEditor.html">renderWindowEditor</a> 命令导出。</p></blockquote><hr><p><a href="https://github.com/FXTD-ODYSSEY/MayaViewportCapture">https://github.com/FXTD-ODYSSEY/MayaViewportCapture</a></p><blockquote><p>&emsp;&emsp;后来进入腾讯前，我写了 Maya Viewport Capture 工具。<br>&emsp;&emsp;那个时候写的比较粗糙，我通过 UI 可以定义几个相机的位置，然后规定进行拍屏。<br>&emsp;&emsp;当时研究用 Maya 或者 Qt 的 API 将 Viewport 的画面截取下来。<br>&emsp;&emsp;背后主要用 Maya API <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m3d_view_html">M3dView</a>  的 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m3d_view_html#a02ea5cc758421097ddafe883c64e30ee">readColorBuffer</a><br>&emsp;&emsp;Qt 部分其实也是在拿到 Maya 的 MImage 之后转成 QImage 而已。</p></blockquote><hr><p><a href="./c45d9aff.html">Maya Python 模型拍屏合并工具</a></p><blockquote><p>&emsp;&emsp;后来正式工作之后，发现前辈用的是 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/ogsRender.html">ogsRender</a> 命令将 Maya Hardware 2.0 输出来。<br>&emsp;&emsp;相较于 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/renderWindowEditor.html">renderWindowEditor</a> 命令不需要打开渲染窗口。</p></blockquote><hr><p><a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/playblast.html">playblast</a></p><blockquote><p>&emsp;&emsp;实现拍屏有太多的方案，当然最为基础的方法就是使用 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/playblast.html">playblast</a> 命令。<br>&emsp;&emsp;建议安装上 QuickTime 这样可以极大压缩 Maya 拍屏的文件大小，同时提升 Maya 拍屏的质量。<br>&emsp;&emsp;<a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/playblast.html">playblast</a> 命令既可以直接生成视频也可以拍屏序列帧。</p></blockquote><h2 id="拍屏需求汇总"><a href="#拍屏需求汇总" class="headerlink" title="拍屏需求汇总"></a>拍屏需求汇总</h2><blockquote><p>&emsp;&emsp;上面提供四种拍屏方案，最常用的时 playblast 方案，因为可以直接输出视频。<br>&emsp;&emsp;如果是图片序列还需要借助 <a href="https://ffmpeg.org/">ffmpeg</a> 等命令行工具将图片序列合成为视频。</p></blockquote><blockquote><p>&emsp;&emsp;拍屏的需求千变万化，但是有一些点其实大差不差。</p><ol><li>拍屏信息</li><li>镜头角度</li></ol></blockquote><blockquote><p>&emsp;&emsp;比较常见的信息有 时间，影片的归属名字(比如动画的某一段)，影片负责人 等等。<br>&emsp;&emsp;添加这些信息可以用 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/headsUpMessage.html">headsUpMessage</a> 将相关信息叠加到 Viewport 上。<br>&emsp;&emsp;但是 headsUpMessage 非常难用，而且字体大小等各种非常不方便自定义。<br>&emsp;&emsp;要解决这个问题可以用  插件，它通过 OpenMaya API 扩展了 headsUpMessage 的功能。<br>&emsp;&emsp;作者是 <a href="https://zurbrigg.com/">zurbrigg</a> ，只可惜它之前免费的工具现在变成付费了。<br>&emsp;&emsp;<a href="http://mstools.work/">劲爆羊工具盒</a> 里面有拍屏王，它就是通过 ZShotmask VP2 插件，将各种信息贴到屏幕上。<br>&emsp;&emsp;具体可以在 <code>劲爆羊工具盒</code> 里面找到脚本 <code>resource\tools\MSTools\MST_DATA\plug-ins\zshotmask.py</code><br>&emsp;&emsp;当然它是一个 Maya Python 插件，注册之后提供了一个节点，只要设置节点的属性就可以了。</p></blockquote><hr><blockquote><p>&emsp;&emsp;这个方式可以结合 playblast 解决大部分拍屏的问题。<br>&emsp;&emsp;但有些情况并不能很好解决，比如我遇到的问题就是，每一帧都要重新矫正一下镜头的位置。<br>&emsp;&emsp;而且这个矫正还不能单纯使用约束，需要每一帧单独进行计算。<br>&emsp;&emsp;所以我只能改用 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/ogsRender.html">ogsRender</a> 的方式，在后台进行拍屏。</p></blockquote><h2 id="Maya-ogsRender-输出序列帧"><a href="#Maya-ogsRender-输出序列帧" class="headerlink" title="Maya ogsRender 输出序列帧"></a>Maya ogsRender 输出序列帧</h2><blockquote><p>&emsp;&emsp;使用 <code>ogsRender</code> 输出序列帧只能输出到默认工程 images 文件夹的路径。<br>&emsp;&emsp;因此要控制 <code>ogsRender</code> 输出的位置只能通过修改工程位置</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_workspace_images</span>(<span class="params">folder</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Change maya project images folder temporarily.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        folder (str): Image folder path.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    workspace_settings = pm.workspace(q=<span class="number">1</span>, fr=<span class="number">1</span>)</span><br><span class="line">    image_index = workspace_settings.index(<span class="string">&quot;images&quot;</span>)</span><br><span class="line">    original_image_folder = workspace_settings[image_index + <span class="number">1</span>]</span><br><span class="line">    pm.workspace(fr=[<span class="string">&quot;images&quot;</span>, folder])</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line">    pm.workspace(fr=[<span class="string">&quot;images&quot;</span>, original_image_folder])</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;我写了一个函数，可以修改输出位置，在修改回去。<br>&emsp;&emsp;这样我可以输出到任意路径。</p></blockquote><h2 id="Python-ThreadPool-多线程后处理"><a href="#Python-ThreadPool-多线程后处理" class="headerlink" title="Python ThreadPool 多线程后处理"></a>Python ThreadPool 多线程后处理</h2><blockquote><p>&emsp;&emsp;上面拍屏生成的图片，可以放到 <a href="https://imagemagick.org/">imagemagick</a> 进行图片后处理。<br>&emsp;&emsp;imagemagick 是 maya 自带的命令行图形处理库。<br>&emsp;&emsp;在 Maya 2022 之前叫做 <code>imconvert.exe</code>， 2022 之后叫做 <code>magick.exe</code></p></blockquote><blockquote><p>&emsp;&emsp;之前也研究过通过 imagemagick 处理图片，真的是拳打  <a href="https://python-pillow.org/">Pillow</a>  脚踢 <a href="https://doc.qt.io/qtforpython/PySide6/QtGui/QImage.html?highlight=qimage">QImage</a> </p></blockquote><p><a href="./852e1bef.html">ImageMagick 图像处理介绍</a></p><blockquote><p>&emsp;&emsp;<a href="https://github.com/ImageMagick/ImageMagick">imagemagick</a> 用 C 和 C++ 编写的，非常小巧，而且运行速度很快~<br>&emsp;&emsp;这里我没有使用 ZShotmask VP2 直接拍屏输出我要的信息，因为有些信息想要通过 imagemagick 叠加到图片上。<br>&emsp;&emsp;于是我想到可以利用 Pool 线程池的方式多线程后台调用命令行。</p></blockquote><blockquote><p>&emsp;&emsp;其中 <code>from multiprocessing.dummy import Pool</code> 可以导入 Python 隐藏的线程池。<br>&emsp;&emsp;这个用起来比起使用 <code>threading</code> 库要简单方便很多。<br>注: <code>from multiprocessing import Pool</code> 导入进程池， Maya 不太支持这个。<br>&emsp;&emsp;下面来个实例演示一下多线程调度后处理函数的好处。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_time</span>(<span class="params">func=<span class="literal">None</span>, msg=<span class="string">&quot;elapsed time:&quot;</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> func:</span><br><span class="line">        <span class="keyword">return</span> partial(log_time, msg=msg)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @wraps(<span class="params">func</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">wrapper</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">        curr = time.time()</span><br><span class="line">        res = func(*args, **kwargs)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[&#123;0&#125;]&quot;</span>.<span class="built_in">format</span>(func.__name__),msg, time.time() - curr)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_process</span>(<span class="params">index</span>):</span><br><span class="line">    time.sleep(<span class="number">0.1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;test&quot;</span>, index)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@log_time</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">multi_thread</span>():</span><br><span class="line">    pool = Pool()</span><br><span class="line"></span><br><span class="line">    results = []</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        results.append(pool.apply_async(partial(post_process, index)))</span><br><span class="line"></span><br><span class="line">    [result.wait() <span class="keyword">for</span> result <span class="keyword">in</span> results]</span><br><span class="line">    pool.close()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;done&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@log_time</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sequence_run</span>():</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        post_process(index)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;done&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    multi_thread()</span><br><span class="line">    sequence_run()</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;执行上面的代码</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[sequence_run] elapsed time: 2.201172351837158</span><br><span class="line">[multi_thread] elapsed time: 1.2311382293701172</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;最后会得到用线程池的方式可以比直接执行快1倍。<br>&emsp;&emsp;而且这个代码是 py2 兼容的。<br>&emsp;&emsp;通过这个方式可以在 Maya 拍屏的时候用多线程调用 imagemagick 来对生成的图像进行处理。<br>&emsp;&emsp;这样用户几乎感受不到图像后处理的时间。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>&emsp;&emsp;以上就是 Maya 各种拍屏方案汇总，使用序列帧的自由度比较高，但是需要 ffmpeg 和 imagemagick 等依赖进行处理。<br>&emsp;&emsp;简单的需求可以直接用 playblast 加上 ZShotmask VP2 完成。</p></blockquote>]]></content>
    
    <summary type="html">
    
      结合 imagemagick 实现图片后处理
    
    </summary>
    
      <category term="CG" scheme="https://blog.l0v0.com/categories/CG/"/>
    
      <category term="Maya" scheme="https://blog.l0v0.com/categories/CG/Maya/"/>
    
      <category term="Maya 研究记录" scheme="https://blog.l0v0.com/categories/CG/Maya/Maya-%E7%A0%94%E7%A9%B6%E8%AE%B0%E5%BD%95/"/>
    
    
      <category term="Maya" scheme="https://blog.l0v0.com/tags/Maya/"/>
    
      <category term="Python" scheme="https://blog.l0v0.com/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>C++ 道法器术</title>
    <link href="https://blog.l0v0.com/posts/9d8a36c5.html"/>
    <id>https://blog.l0v0.com/posts/9d8a36c5.html</id>
    <published>2022-11-26T07:59:10.000Z</published>
    <updated>2022-12-14T02:54:16.748Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p><a href="https://www.bilibili.com/video/BV1pu411y7n1">https://www.bilibili.com/video/BV1pu411y7n1</a><br><a href="https://www.bilibili.com/video/BV1RV4y1x7qH">https://www.bilibili.com/video/BV1RV4y1x7qH</a></p><blockquote><p>&emsp;&emsp;上面两个链接是 李老师 的直播视屏。<br>&emsp;&emsp;虽然 李老师 在卖课。<br>&emsp;&emsp;但他免费的直播对我 C++ 小白来说，非常有用，让我对 C++ 语言有了一个大局观的认识。<br>&emsp;&emsp;这样才能更好地定位到自己学习的情况。<br>&emsp;&emsp;下面是对他 PPT 内容的一些总结汇总。</p></blockquote><h2 id="C-道法器术"><a href="#C-道法器术" class="headerlink" title="C++ 道法器术"></a>C++ 道法器术</h2><ul><li>C++ 5个术<ul><li><ol><li>类型系统</li></ol></li><li><ol start="2"><li>编译映射</li></ol></li><li><ol start="3"><li>内存管理</li></ol></li><li><ol start="4"><li>设计范式</li></ol></li><li><ol start="5"><li>习语与规范</li></ol></li></ul></li><li>设计范式<ul><li><ol><li>面向过程</li></ol></li><li><ol start="2"><li>面向对象</li></ol></li><li><ol start="3"><li>泛型编程</li></ol></li><li><ol start="4"><li>函数式编程</li></ol></li><li><ol start="5"><li>模板化编程</li></ol></li></ul></li><li>时空人<ul><li>时间分析 – 发生在什么时候</li><li>空间分析 – 变量/对象放在哪里</li><li>人物分析 – 代码哪来的，如何耦合</li></ul></li><li>模块一 C++ 类型系统与设施<ul><li>类型基础<ul><li>存储: 堆 栈 全局区</li><li>值语义与引用语义</li><li>指针与引用</li><li>初始化与生命周期</li></ul></li><li>其他类型<ul><li>数组序列: vector array 与 C数组</li><li>字符串处理: string string_view与char*</li><li>枚举类 联合 位域</li></ul></li><li>类<ul><li>数据成员</li><li>函数成员</li><li>静态与实例成员</li><li>操作符重载</li></ul></li><li>类型扩展<ul><li>auto 与自动类型推断</li><li>const</li><li>volatile</li><li>结构化绑定</li></ul></li><li>编译与构建<ul><li>C++ 编译机制</li><li>模块 (C++ 20)</li><li>GCC/Clang/MSVC</li></ul></li></ul></li><li>模块二 C++ 面向对象编程<ul><li>C++ 对象模型<ul><li>对象内存模型</li><li>对象成员与指针成员</li><li>对象布局 对齐 和尺寸</li></ul></li><li>三法则与五法则<ul><li>构造函数 / 析构函数</li><li>拷贝构造函数 / 赋值操作符</li><li>移动拷贝构造函数 / 移动赋值函数</li><li>默认定义与删除规则</li></ul></li><li>继承: 类型抽象<ul><li>基类与子类</li><li>成员的继承</li><li>抽象类</li><li>共有 私有 受保护继承</li><li>多继承与虚继承</li></ul></li><li>多态: 运行时绑定<ul><li>虚函数</li><li>虚函数表</li><li>虚析构函数</li><li>运行时绑定</li><li>dynamic_cast</li></ul></li><li>面向对象设计<ul><li>实现继承与接口继承</li><li>组合与继承</li><li>编译时 VS 运行时绑定</li><li>设计模式: Template Strategy Observer</li></ul></li></ul></li><li>模块三 内存管理: 原理 优化技巧与避免踩坑<ul><li>RAII: 内存与资源管理<ul><li>内存与资源</li><li>资源获取即初始化 (RAII)</li><li>C++ Java Go Rust 内存管理对比</li></ul></li><li>智能指针<ul><li>unique_ptr</li><li>shared_ptr</li><li>weak_ptr</li></ul></li><li>移动语义<ul><li>右值与左值</li><li>移动构造与移动赋值</li><li>移动与拷贝</li><li>临时对象与返回值优化(RVO)</li><li>std::move 操作</li><li>std::forward 操作</li></ul></li><li>new 与 delete 扩展<ul><li>全局 new 与 delete</li><li>new 与 delete 操作符</li><li>placement new</li><li>nothrow new</li></ul></li></ul></li><li>模板机制<ul><li>参数化类型<ul><li>类模板</li><li>类型参数与值参数</li><li>模板参数推到</li><li>参数的隐式绑定</li></ul></li><li>参数化操作<ul><li>函数模板</li><li>函数对象</li><li>lambda 表达式</li><li>函数式编程</li></ul></li><li>实用类型<ul><li>pair 与 tuple</li><li>variant optional any</li><li>bitset</li></ul></li><li>模板扩展<ul><li>模板编译模型</li><li>类型别名</li><li>模板特化</li><li>可变参数模板</li><li>constexpr 编译时计算</li><li>SFINAE \ enable_if \ Tag Dispatching \ if constexpr</li><li>模板元编程</li></ul></li></ul></li><li>模块五 泛型编程与 STL<ul><li>容器<ul><li>容器概述</li><li>STL 中的常用容器</li><li>容器及操作性能考虑</li><li>容器最佳实践</li></ul></li><li>算法<ul><li>STL 算法概览</li><li>不同算法的性能考虑</li><li>编写泛型算法</li><li>适配器</li></ul></li><li>迭代器<ul><li>迭代器概念</li><li>STL 中的迭代器</li><li>Ranges 与 for</li></ul></li><li>概念 (Concept)<ul><li>类型约束与接口规约</li><li>概念定义</li><li>STL 常用概念</li></ul></li></ul></li></ul><ul><li>设计原则 Design Principle<ul><li>正交设计四原则<ul><li>消除重复性</li><li>分离关注点</li><li>减少不必要地依赖</li><li>向稳定的方向依赖</li></ul></li><li>整洁代码三原则<ul><li>KISS 原则 (简单以理解)</li><li>DRY 原则 (不要重复自己)</li><li>迪米特原则 (最小依赖)</li></ul></li><li>SOLID 五大设计原则<ul><li>单一职责原则 (SRP)</li><li>开闭原则 (OCP)</li><li>里氏替换原则(LSP)</li><li>接口隔离原则(ISP)</li><li>依赖倒置原则(DIP)</li></ul></li><li>面向对象三原则<ul><li>封装责任 隔离变化</li><li>优化使用对象组合 而不是类继承</li><li>针对接口编程 而不是针对实现编程</li></ul></li></ul></li></ul><ul><li>设计习语 Design Idiom<ul><li>RAII 资源获取即初始化 </li><li>Scope Guard 范围守卫</li><li>Copy &amp; Swap 拷贝后转换</li><li>SOO 小对象优化</li><li>Local Buffer 本地缓存</li><li>Copy-On-Write (COW) 变更时拷贝</li><li>EBCO 空基类优化</li><li>Virtual Constructor 虚构造器</li><li>Pimpl 指向实现的指针</li><li>NVI (Non-Virtual Interface) 非虚接口</li><li>CRTP 奇异递归模板模式</li><li>Mixin 混入类</li><li>Policy Design 策略设计</li><li>Type Traits 类型萃取 </li><li>Lambda 重载</li><li>Tag Dispatcher 标签分发</li><li>Type Erasure 类型擦除</li><li>SFINAE 替换失败不是错误</li><li>Named Template Arguments / Method Chain 命名模板参数 / 方法链</li></ul></li></ul><ul><li>从管理变化的角度理解设计模式<ul><li>晚期扩展<ul><li>Template Method</li><li>Builder</li></ul></li><li>策略对象<ul><li>Strategy</li><li>Observer / Event</li></ul></li><li>对象创建<ul><li>Factory Method</li><li>Abstract Factory</li><li>Prototype</li></ul></li><li>单一职责<ul><li>Decorator</li><li>Bridge</li></ul></li><li>行为变化<ul><li>Command</li><li>Visitor</li></ul></li><li>接口隔离<ul><li>Adapter</li><li>Proxy</li><li>Facade</li><li>Mediator</li></ul></li><li>对象性能<ul><li>Singleton</li><li>Flyweight</li></ul></li><li>数据结构<ul><li>Composite</li><li>Iterator</li><li>Chain of Responsible</li></ul></li><li>状态变化<ul><li>State</li><li>Memento</li></ul></li><li>领域规则<ul><li>Interpreter</li></ul></li></ul></li></ul><h2 id="接口设计"><a href="#接口设计" class="headerlink" title="接口设计"></a>接口设计</h2><table><thead><tr><th>语言构造</th><th>习语与模式</th></tr></thead><tbody><tr><td>封装 - 接口隔离</td><td>Pimpl</td></tr><tr><td>多态基类 - 接口合约</td><td>NVI</td></tr><tr><td>泛型隐式接口</td><td>Template Method</td></tr><tr><td>Type Traits</td><td>Factory</td></tr><tr><td>Tag Dispatching</td><td>Adapter</td></tr><tr><td>SFINAE</td><td>Proxy</td></tr><tr><td>概念 – 泛型显示接口</td><td>Facade</td></tr><tr><td></td><td>Composite</td></tr><tr><td></td><td>Iterator</td></tr></tbody></table><h2 id="继承设计"><a href="#继承设计" class="headerlink" title="继承设计"></a>继承设计</h2><table><thead><tr><th>语言构造</th><th>习语与模式</th></tr></thead><tbody><tr><td>继承</td><td>EBCO</td></tr><tr><td>多继承</td><td>CRTP</td></tr><tr><td>虚继承</td><td>Bridge</td></tr><tr><td>实现继承</td><td>Mixin</td></tr><tr><td>接口继承</td><td>Decorator</td></tr><tr><td>变参继承</td></tr></tbody></table><h2 id="内存设计"><a href="#内存设计" class="headerlink" title="内存设计"></a>内存设计</h2><table><thead><tr><th>语言构造</th><th>习语与模式</th></tr></thead><tbody><tr><td>对象生命周期</td><td>RAII</td></tr><tr><td>值语义/引用语义</td><td>Scope Guard</td></tr><tr><td>对象内存布局</td><td>SOO</td></tr><tr><td>智能指针 {unique_ptr shared_ptr weak_ptr}</td><td>Local Buffer</td></tr><tr><td>移动语义</td><td>Copy-On-Write</td></tr><tr><td></td><td>Singleton</td></tr><tr><td></td><td>Flyweight</td></tr></tbody></table><h2 id="回调设计"><a href="#回调设计" class="headerlink" title="回调设计"></a>回调设计</h2><table><thead><tr><th>语言构造</th><th>习语与模式</th></tr></thead><tbody><tr><td>函数指针</td><td>Policy Design</td></tr><tr><td>多态对象 (策略 命令)</td><td>Strategy</td></tr><tr><td>函数对象 (仿函数)</td><td>Observer</td></tr><tr><td>函数适配器 (bine mem_fn)</td><td>Command</td></tr><tr><td>Lambda 表达式</td><td>Lambda Overload</td></tr><tr><td>std::function (多态回调对象)</td><td>Visitor</td></tr><tr><td>std::invoke (多态调用)</td><td></td></tr><tr><td>std::invocable (回调概念)</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      李建忠的老师直播汇总
    
    </summary>
    
      <category term="C++" scheme="https://blog.l0v0.com/categories/C/"/>
    
    
      <category term="ࠇCpp" scheme="https://blog.l0v0.com/tags/%E0%A0%87Cpp/"/>
    
  </entry>
  
  <entry>
    <title>C++ 基础入门</title>
    <link href="https://blog.l0v0.com/posts/20555bfb.html"/>
    <id>https://blog.l0v0.com/posts/20555bfb.html</id>
    <published>2022-11-13T03:39:03.000Z</published>
    <updated>2022-12-14T02:54:16.747Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;随着学习的深入，C++ 的学习越来越迫在眉睫。<br>&emsp;&emsp;虽然我在学习 Maya API 以及 Unreal 过程中已经写过不少的 C++ 代码。<br>&emsp;&emsp;但以前写 C++ 都是用 Python 的经验迁移过去使用的，很多 C++ 的特性都不懂，很多库也不怎么会用。<br>&emsp;&emsp;所以正因为如此，才希望自己可以深入学习好 C++</p></blockquote><h2 id="课程推荐"><a href="#课程推荐" class="headerlink" title="课程推荐"></a>课程推荐</h2><h3 id="C-MasterClass"><a href="#C-MasterClass" class="headerlink" title="C++ MasterClass"></a>C++ MasterClass</h3><p>在 youtube 上找到了一个非常棒的教程<br>Youtube地址(不完整): <a href="https://www.youtube.com/watch?v=8jLOx1hD3_o">https://www.youtube.com/watch?v=8jLOx1hD3_o</a><br>udemy 完整版地址: <a href="https://www.udemy.com/course/the-modern-cpp-20-masterclass/">https://www.udemy.com/course/the-modern-cpp-20-masterclass/</a><br>B站<br><a href="https://www.bilibili.com/video/BV1Hr4y1H7wB">https://www.bilibili.com/video/BV1Hr4y1H7wB</a><br><a href="https://www.bilibili.com/video/BV1JY4y1Y7uZ">https://www.bilibili.com/video/BV1JY4y1Y7uZ</a><br><a href="https://www.bilibili.com/video/BV1iA4y1X76r">https://www.bilibili.com/video/BV1iA4y1X76r</a><br><a href="https://www.bilibili.com/video/BV1A34y1e7KS">https://www.bilibili.com/video/BV1A34y1e7KS</a><br><a href="https://www.bilibili.com/video/BV1434y1e7N4">https://www.bilibili.com/video/BV1434y1e7N4</a></p><p>Github地址: <a href="https://github.com/rutura/The-C-20-Masterclass-Source-Code">https://github.com/rutura/The-C-20-Masterclass-Source-Code</a></p><blockquote><p>&emsp;&emsp;教程足足有 30 小时长，而且还是 <a href="https://www.udemy.com/course/the-modern-cpp-20-masterclass/">udemy</a> 教程的阉割版本，不过里面有第一章会教导如何使用 <code>MSVC</code> <code>gcc</code> <code>clang</code> 三种 C++ 编译器构建环境。<br>&emsp;&emsp;我 fork 了他的仓库加上我自己的 VSCode 配置 仓库地址: <a href="https://github.com/FXTD-ODYSSEY/The-C-20-Masterclass-Source-Code">https://github.com/FXTD-ODYSSEY/The-C-20-Masterclass-Source-Code</a></p></blockquote><blockquote><p>&emsp;&emsp;默认 tasks 是配置了三中不同编译的选项，如果注释掉两个的话，那就可以直接在 VScode 实现 ctrl+shift+b 实现编译并运行。<br>&emsp;&emsp;教程里面主要 IDE 环境是使用 VScode 搭建的，可能会有人困惑，why not VS。<br>&emsp;&emsp;我很久以前开发 Maya C++ 就是使用 VS 进行开发的，说实话，IDE 隐藏了太多细节，一旦出错，反而是无头苍蝇，无从查起。  <a href="https://www.zhihu.com/question/393152726/answer/1206640121">知乎回答</a><br>&emsp;&emsp;当然也同其他回答说得也对，用什么工具都无所谓，关键是懂得 C++ 的整个编译流程。</p></blockquote><h3 id="The-Cherno-C"><a href="#The-Cherno-C" class="headerlink" title="The Cherno C++"></a>The Cherno C++</h3><p><a href="https://www.youtube.com/watch?v=18c3MTX0PK0&amp;list=PLlrATfBNZ98dudnM48yfGUldqGD0S4FFb">https://www.youtube.com/watch?v=18c3MTX0PK0&amp;list=PLlrATfBNZ98dudnM48yfGUldqGD0S4FFb</a><br><a href="https://www.bilibili.com/video/BV1gk4y1r7UH">https://www.bilibili.com/video/BV1gk4y1r7UH</a></p><blockquote><p>&emsp;&emsp;游戏开发大佬推出的一系列编程课程。</p></blockquote><h3 id="parallel-101"><a href="#parallel-101" class="headerlink" title="parallel 101"></a>parallel 101</h3><blockquote><p>&emsp;&emsp;后来非常偶然地，我翻到一个大佬 (小彭老师) 的课程</p></blockquote><p><a href="https://github.com/parallel101/course">https://github.com/parallel101/course</a><br><a href="https://www.bilibili.com/video/BV1fa411r7zp">https://www.bilibili.com/video/BV1fa411r7zp</a></p><blockquote><p>&emsp;&emsp;这个课程用直播和录播的形式详细介绍了从 cmake 到 C++ 的使用。<br>&emsp;&emsp;而且老师年轻有为，能力很强，经验丰富。</p></blockquote><h3 id="原子之声"><a href="#原子之声" class="headerlink" title="原子之声"></a>原子之声</h3><p><a href="https://www.bilibili.com/video/BV1S54y1Z7Wc">C++现代实用教程(一):基础主线(VSCODE)</a> <a href="https://gitlab.com/yzzy/modern-cpp">gitlab地址</a><br><a href="https://www.bilibili.com/video/BV1eg411Q7nG">C++现代实用教程(二):面向对象基础</a> <a href="https://gitlab.com/yzzy/modern-oop">gitlab地址</a><br><a href="https://www.bilibili.com/video/BV1ZZ4y1e7zy">C++现代实用教程(三):面向对象之友元与继承</a> <a href="https://gitlab.com/yzzy/modern-friend">gitlab地址</a><br><a href="https://www.bilibili.com/video/BV15v4y1M7fF">C++现代实用教程(四):面向对象核心多态</a> <a href="https://gitlab.com/yzzy/modern-polymorphic">gitlab地址</a><br><a href="https://www.bilibili.com/video/BV18B4y187uL">C++现代实用教程:智能指针</a> <a href="https://gitlab.com/yzzy/smart-pointer">gitlab地址</a><br><a href="https://www.bilibili.com/video/BV1Va411T7TJ">C++现代实用教程: Namespace命名空间</a> <a href="https://gitlab.com/yzzy/namespace">gitlab地址</a></p><blockquote><p>&emsp;&emsp;这位老师也很赞~<br>&emsp;&emsp;但是还没仔细看…</p></blockquote><h3 id="C-道法器术"><a href="#C-道法器术" class="headerlink" title="C++ 道法器术"></a>C++ 道法器术</h3><p><a href="https://www.bilibili.com/video/BV1pu411y7n1">https://www.bilibili.com/video/BV1pu411y7n1</a><br><a href="https://www.bilibili.com/video/BV1RV4y1x7qH">https://www.bilibili.com/video/BV1RV4y1x7qH</a></p><blockquote><p>&emsp;&emsp;C++ 是一门很复杂的语言，像我是从 Python 开始进阶编程的。<br>&emsp;&emsp;当我将 Python 很多用法摸透之后，进入到 Python 底层，发现 C++ 还很多底层的内容等待我去学习<em>(:з」∠)</em><br>&emsp;&emsp;那上面的视频，比较系统地总结了 C++ 从入门到进阶的各个不同阶段地内容，学习 C++ 有很清晰的整体图谱。<br>&emsp;&emsp;当然视频里面其实是介绍作者推出的课程的~</p></blockquote><p>个人剖析文章 <a href="http://tw.l0v0.com/#01_C%2B%2B%20%E9%81%93%E6%B3%95%E5%99%A8%E6%9C%AF.md">01_C++ 道法器术.md</a></p><h2 id="搭建运行环境"><a href="#搭建运行环境" class="headerlink" title="搭建运行环境"></a>搭建运行环境</h2><blockquote><p>&emsp;&emsp;C++ 语言和 Python 运行方式有相当大的不同，</p></blockquote><p>参考: <a href="https://smartkeyerror.com/Python-Virtual-Machine">https://smartkeyerror.com/Python-Virtual-Machine</a></p><blockquote><p>&emsp;&emsp;编译 C++ 需要有 C++ 编译器来生成汇编代码(二进制机器码) ，不同的编译器有不同的优化策略，所以版本和编译器平台都会对生成的汇编有很大影响。<br>&emsp;&emsp;教程提供了 <a href="https://en.cppreference.com/w/cpp/compiler_support">https://en.cppreference.com/w/cpp/compiler_support</a> 这个网站。<br>&emsp;&emsp;可以看到不同平台编译器对各种 CPP 规范的支持情况，如果用了老版本就不能使用新版本的 C++ 写法<br>&emsp;&emsp;目前 C++ 也在不断演进，从古老的 C++98 到现在 C++11 C++14 C++17 C++20 以及后续即将推出的 C++23 C++26<br>&emsp;&emsp;目前主流编译器的最新版本都支持到 C++17 了。</p></blockquote><h3 id="编译器下载配置"><a href="#编译器下载配置" class="headerlink" title="编译器下载配置"></a>编译器下载配置</h3><blockquote><p>&emsp;&emsp;市面上最主流的 C++ 编译器有 <code>MSVC</code> <code>gcc</code> <code>clang</code> ，其中 <code>MSVC</code> 是 windows 平台的，另外两个是可跨平台开发。<br>&emsp;&emsp;windows 下如何安装环境呢？ 推荐使用 <a href="https://chocolatey.org/">choco</a> 进行安装</p></blockquote><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set</span>-ExecutionPolicy Bypass -Scope Process -Force; [System.<span class="built_in">Net</span>.ServicePointManager]::SecurityProtocol = [System.<span class="built_in">Net</span>.ServicePointManager]::SecurityProtocol -bor <span class="number">3072</span>; iex ((New-Object System.<span class="built_in">Net</span>.WebClient).DownloadString(&#x27;https://community.chocolatey.org/install.ps1&#x27;))</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;用管理员权限打开 powershell 然后输入上面的命令进行安装。</p></blockquote><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">::安装 MSVC</span><br><span class="line">choco install visualstudio2019buildtools --yes</span><br><span class="line">choco install vcredist140 --yes</span><br><span class="line"></span><br><span class="line">::安装 gcc</span><br><span class="line">choco install mingw --yes</span><br><span class="line"></span><br><span class="line">::安装 clang</span><br><span class="line">choco install llvm --yes</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;执行上面的命令可以安装相对应的环境到系统中。<br>&emsp;&emsp;需要注意的是 MSVC 需要打开 VS installer 配置 windows SDK <code>C:\Program Files (x86)\Microsoft Visual Studio\Installer\setup.exe</code> </p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/20555bfb/n_v285b0b4d8f4df41b999777df16203be55.png" alt="image"></p><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/20555bfb/n_v22aa2ef04a31645f59c6f4ddc91cf8e35.png" alt="image"></p><blockquote><p>&emsp;&emsp;然后选择下载 Windows 10 SDK 再到右下角点击修改。<br>&emsp;&emsp;这样才能将 MSVC 编译器安装到电脑上。</p></blockquote><hr><blockquote><p>&emsp;&emsp;使用 MSVC 进行编译，需要调用 <code>C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\Common7\Tools\VsDevCmd.bat</code> 脚本启动环境。<br>&emsp;&emsp;激活环境之后可以使用 cl.exe 来接链编译 C++ 代码。<br>&emsp;&emsp;而其他编译器默认安装完之后 choco 添加到 PATH 路径下了。</p></blockquote><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span> (<span class="title">x86</span>)\<span class="title">Microsoft</span> <span class="title">Visual</span> <span class="title">Studio</span>\2019\<span class="title">BuildTools</span>\<span class="title">Common7</span>\<span class="title">Tools</span>\<span class="title">VsDevCmd.bat</span></span></span><br><span class="line"><span class="function"><span class="title">cl</span> /<span class="title">Zi</span> /<span class="title">std:c</span>++20 /<span class="title">EHsc</span> /<span class="title">Fe</span>: <span class="title">main.exe</span> <span class="title">main.cpp</span></span></span><br></pre></td></tr></table></figure><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -g -std=c++<span class="number">20</span> main.exe main.cpp</span><br></pre></td></tr></table></figure><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -g -std=c++<span class="number">20</span> main.exe main.cpp</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;使用上面的命令就可以实现 C++20 标准代码的编译。<br>&emsp;&emsp;如果你使用 Visual Studio 之类的 IDE，那背后其实也是调用编译器对 C++ 代码编译生成二进制机器码文件。</p></blockquote><h3 id="VScode-环境配置"><a href="#VScode-环境配置" class="headerlink" title="VScode 环境配置"></a>VScode 环境配置</h3><blockquote><p>&emsp;&emsp;有了上述的环境之后，只要运行命令就可以执行代码了。<br>&emsp;&emsp;开发工具比较推荐使用 <a href="https://code.visualstudio.com/">VScode</a><br>&emsp;&emsp;个人体验了 VS 感觉过于笨重，而且隐藏了很多编译的细节，导致很多环节出错了不知道从何查起。<br>&emsp;&emsp;所以我推荐使用 VScode 编辑器作为入门，了解了基础再使用复杂的 IDE 才能事半功倍。</p></blockquote><hr><blockquote><p>&emsp;&emsp;安装 VScode 之后，可以安装微软官方提供的 <a href="https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools">C++ 扩展</a><br>&emsp;&emsp;实际上 VScode 官方是比较推荐用 <code>tasks.json</code> 配置来管理编译 用 <code>launch.json</code> 来管理启动的。<br>&emsp;&emsp;但是这些配置对小白来说还是稍显复杂。<br>&emsp;&emsp;这里我推荐安装 <a href="https://marketplace.visualstudio.com/items?itemName=formulahendry.code-runner">Code Runner</a> 插件</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/20555bfb/n_v21e4552e31949456090f6e78599693550.png" alt="image"></p><blockquote><p>&emsp;&emsp;去到对应的代码就有启动图标，在右上角，点击一下默认会调用 gcc 编译并执行。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/20555bfb/n_v234ae967db8bb48c4bf2df017554f3462.png" alt="image"></p><blockquote><p>&emsp;&emsp;如果想要修改默认的执行命令，可以去修改 code runner 的配置</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/20555bfb/n_v2d84c274019634fefa2e181f3ef1bae83.png" alt="image"></p><blockquote><p>&emsp;&emsp;默认会有不同语言对应执行的命令，我们这里可以把 Cpp 执行的命令改成我们想要的样子即可。<br>&emsp;&emsp;比如我们想要改成 clang 编译也或者 MSVC 编译也是完全可以的。<br>&emsp;&emsp;MSVC 比较麻烦，需要先跑 <code>VsDevCmd.bat</code> 激活环境才能使用 cl 命令。</p></blockquote><blockquote><p>&emsp;&emsp;另外输入源可以改成通配符识别 <code>*.cpp</code> ，这样多个文件只要都在一个目录里面都会一同编译，方便我们初学跑程序。</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;cpp&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cd $dir &amp;&amp; g++ -g -std=c++20 *.cpp -o $fileNameWithoutExt &amp;&amp; $dir$fileNameWithoutExt&quot;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;另外在线网站 <a href="https://godbolt.org/">https://godbolt.org/</a> 内置了很多不用语言的编译器<br>&emsp;&emsp;可以在线编写代码去验证，也能很方便地查看编译出来的汇编语言。<br>&emsp;&emsp;没有本地环境的时候也可以用这个工具来跑代码进行验证。</p></blockquote><h2 id="C-入门"><a href="#C-入门" class="headerlink" title="C++ 入门"></a>C++ 入门</h2><blockquote><p>&emsp;&emsp;学习一门语言，是骡子是马总得遛 一遛才知道代码是否有问题。<br>&emsp;&emsp;所以只是看教程，脑内编译代码是不行的。</p></blockquote><blockquote><p>&emsp;&emsp;这里我用 C++ 入门会以 <a href="https://github.com/rutura/The-C-20-Masterclass-Source-Code">The-C-20-Masterclass-Source-Code</a><br>&emsp;&emsp;只要按照我上面的配置，就可以愉快地跑这个仓库任意路径的代码，并编译出可执行文件了~</p></blockquote><blockquote><p>&emsp;&emsp;如果你已经有编程基础，比如学过其他的编程语言，那么我更推荐直接看代码执行来学习，遇到不懂的部分再翻视频。<br>&emsp;&emsp;这样比起纯看看视频会更快上手。</p></blockquote><blockquote><p>&emsp;&emsp;另外为了方便能够查阅 <a href="https://en.cppreference.com/w/">cppreference.com</a> <a href="https://cplusplus.com/">cplusplus.com</a> 等官方文档，可以快速跑里面的案例 Demo<br>&emsp;&emsp;我用 Python 做了个简单的爬虫，将不同的资料汇总到一起 <a href="https://github.com/FXTD-ODYSSEY/cppreference">REPO</a> </p></blockquote>]]></content>
    
    <summary type="html">
    
      C++ MasterClass
    
    </summary>
    
      <category term="C++" scheme="https://blog.l0v0.com/categories/C/"/>
    
    
      <category term="ࠇCpp" scheme="https://blog.l0v0.com/tags/%E0%A0%87Cpp/"/>
    
  </entry>
  
  <entry>
    <title>FBX 二进制数据解析</title>
    <link href="https://blog.l0v0.com/posts/8207ba23.html"/>
    <id>https://blog.l0v0.com/posts/8207ba23.html</id>
    <published>2022-11-06T08:38:37.000Z</published>
    <updated>2022-12-14T02:54:16.753Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;最近遇到了一个比较难搞的需求，好不容易解决了，在这里记录一下。<br>&emsp;&emsp;需求是这样的，公司有大佬在 motionbuilder 写了插件，利用 mobu API 做了一个自定义的节点并在里面通过 <a href="https://help.autodesk.com/view/MOBPRO/2020/ENU/?guid=MotionBuilder_SDK_cpp_ref_class_f_b_model_html#a338af922f322871b1001d527851ec995">FBXStore</a> API 存入了自定义数据。<br>&emsp;&emsp;我需要将这些操作通过 Python FBXSDK 来完成这些数据的写入。<br>&emsp;&emsp;主要原因是 motionbuilder 的稳定性不可靠，如果可以利用纯外部调用 FBXSDK 的形式解决问题，就不需要依赖 mobu 了。</p></blockquote><blockquote><p>&emsp;&emsp;用 FBXSDK 来还原自定义节点操作都好说。<br>&emsp;&emsp;主要蛋疼的地方在于需要解决 FBXStore API 调用背后怎么转换成二进制的问题。</p></blockquote><h2 id="motion-builder-C-插件编译"><a href="#motion-builder-C-插件编译" class="headerlink" title="motion builder C++ 插件编译"></a>motion builder C++ 插件编译</h2><blockquote><p>&emsp;&emsp;在 motion builder 的安装路径有 <code>OpenRealitySDK</code> 文件夹，里面的 samples 有很多开发 mobu 的参考代码。<br>&emsp;&emsp;其中比较具有代表性的脚本就是 <code>OpenRealitySDK\samples\devices\devicecamera\ordevicecamera_device.cxx</code><br>&emsp;&emsp;这个脚本就定义怎么将自定义数据存入 FBX 当中，并且利用 <code>FbxRetrieve</code> 方法将功能读取回来。</p></blockquote><blockquote><p>&emsp;&emsp;我们可以把这个东西编译出来作为我们这次测试的内容。</p></blockquote><blockquote><p>&emsp;&emsp;默认 motionbuilder 的 samples 里面提供了 sln 工程，可以直接用 VS 打开。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/8207ba23/n_v2086b51bf6afa43e8952472613069d6e3.png" alt="image"></p><blockquote><p>&emsp;&emsp;打开之后需要将平台工具集升级到最新的 VS 版支持的工具集，默认是 2012 工具集太过古老了。<br>&emsp;&emsp;改完之后本想着愉快地编译，然而这样会报错。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/8207ba23/n_v2a6310a64d7e4473aa71f51f191d1c9ab.png" alt="image"></p><blockquote><p>&emsp;&emsp;这个问题只能归结为新的平台工具集已经去掉了支持，但是头文件依旧引入相应的文件，解决也很简单，将报错的那一行注释即可。</p></blockquote><h2 id=""><a href="#" class="headerlink" title=""></a><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/8207ba23/n_v2c8da73f2b30b44ffa1a28b120ce44a47.png" alt="image"></h2><blockquote><p>&emsp;&emsp;编译完成会默认去到 <code>bin\x64\plugins</code> 的目录，这样只要重启 motion builder 就能加载到这个 dll 了。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/8207ba23/n_v25ed2de89967144a2818f413f2ace29eb.png" alt="image"></p><blockquote><p>&emsp;&emsp;这样将这个图标拖拽到场景就可以创建一个 device.<br>&emsp;&emsp;将这场景以 ascii 的格式保存。<br>&emsp;&emsp;检查保存的 FBX 文件，可以看到 FBXStore 的写入逻辑，会将信息写入到节点的 <code>MoBuAttrBlindData</code> 属性上</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/8207ba23/n_v237187ca650284706973961105736d6fb.png" alt="image"></p><blockquote><p>&emsp;&emsp;存储出来可以看到相应的信息。<br>&emsp;&emsp;这里官方的插件将信息转成了 KString 所以里面的信息也是以 FBX ASCII 的形式存在。<br>&emsp;&emsp;但如果将 FBX 存成 Binary 模式，然后再用 Python FBXSDK 来转存成 ASCII 的话，这些 FBXStore 的数据会转成 base64 的二进制数据。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/8207ba23/n_v288775b70604e49f2a3c93659049bdd50.png" alt="image"></p><blockquote><p>&emsp;&emsp;如果用 base64 解码，可以看到里面存储的二进制数据。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line">in_data = <span class="string">r&quot;cBsAAAABAAAABQAAAAhDb21tVHlwZUkQAAAANAAAAAEAAAAFAAAAB1ZlcnNpb25JUQMAAGIAAAADAAAAGwAAAAZTZXJpYWxJAQAAAEkAlgAAUwwAAABTY2VuZQABTW9kZWycAAAABAAAACQAAAAJU2ltdWxhdG9yRAAAAAAAAPA/RAAAAAAAAPA/RAAAAAAAAAAARAAAAAAAAAAAwwAAAAIAAAATAAAAB05ldHdvcmtTCQAAADEyNy4wLjAuMUm5CwAA9gAAAAIAAAAaAAAADFNoYXJlZE1lbW9yeVMKAAAASE1DX1NITV9WMVMGAAAAMDAwMDAwFAEAAAEAAAAJAAAACFNldHRpbmdzRAAAAAAAAAAAMgEAAAEAAAAFAAAADFNhbXBsaW5nTW9kZUkAAAAAVAEAAAEAAAAFAAAAEEluc3RydW1lbnRBY3RpdmVJAQAAAG0BAAABAAAABQAAAAdWZXJzaW9uSVEDAACOAQAAAQAAAAUAAAAPTGVuc1RhYmxlTG9hZGVkSQAAAADbAQAABgAAAC4AAAASTWFudWFsTW9kZVNldHRpbmdzSQAAAABEBzDzdETpTEBEAAAAAACARkBJAAAAAEQAAAAAAAAAAEQAAAAAAAAAAP4BAAACAAAACgAAAAxJbnZlcnRWYWx1ZXNJAAAAAEkAAAAAHwIAAAEAAAAJAAAAC0FzcGVjdFJhdGlvRFVVVVVVVfU/QwIAAAEAAAAJAAAADlpvb21NdWx0aXBsaWVyRAAAAAAAAPA/aAIAAAEAAAAJAAAAD05vZGFsTXVsdGlwbGllckQAAAAAAABZQIgCAAABAAAABQAAAA5BbmdsZUluRGVncmVlc0kAAAAAywIAAAQAAAAkAAAAEkVuY29kZXJDYWxpYnJhdGlvbkQAAADgzxJjQUQAAADgzxJjwUQAAADgzxJjQUQAAADgzxJjwRsDAAAGAAAANgAAAA1TdHVkaW9PZmZzZXRzRAAAAAAAAAAARAAAAAAAAAAARAAAAAAAAAAARAAAAAAAAAAARAAAAAAAAAAARAAAAAAAAAAANAMAAAEAAAAFAAAAB1ZlcnNpb25JUQMAAE8DAAABAAAABQAAAAlTeW5jRGVsYXlJBAAAAAAAAAAAAAAAAAAAAAA=&quot;</span></span><br><span class="line"></span><br><span class="line">output_path = <span class="string">r&quot;G:\_TEMP\2022-11-1\test_device.bin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(output_path,<span class="string">&#x27;wb&#x27;</span>)<span class="keyword">as</span> wf:</span><br><span class="line">    wf.write(base64.b64decode(in_data))</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/8207ba23/n_v2c9af2c88fe7d412b8a9f65a2da99ebf0.png" alt="image"></p><blockquote><p>&emsp;&emsp;VScode 安装 Hex Editor 可以查看二进制数据。<br>&emsp;&emsp;而我这边需要想办法用 Python 写入二进制数据，从而摆脱 motion builder 的依赖。</p></blockquote><h2 id="FBX-二进制"><a href="#FBX-二进制" class="headerlink" title="FBX 二进制"></a>FBX 二进制</h2><p>FBX 数据格式<br><a href="./c12b915c.html">RenderDoc Python 开发 FBX 导出工具</a></p><blockquote><p>&emsp;&emsp;之前写 renderdoc 导出 FBX 插件的时候，使用的时 FBX ASCII 格式，通过将数据写入到 FBX ASCII 对应的位置。FBX 就可以被读取到。<br>&emsp;&emsp;当时踩了的坑也可以从中窥探到 FBX 存储的结构。</p></blockquote><p>Python 二进制处理<br><a href="./5c00f85e.html">Maya 输出顶点动画到引擎</a></p><blockquote><p>&emsp;&emsp;通过上面的文章，可以了解到 Python 写入二进制数据可以依赖内置的 <a href="https://docs.python.org/3/library/struct.html">struct</a> 包。<br>&emsp;&emsp;写入数据需要了解 C++ 的数据类型的长度，按照长度和数据的写入顺序就可以用 Python 还原二进制数据。</p></blockquote><hr><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/8207ba23/n_v2260d987c1c924d8e92baf610813d12c2.png" alt="image"></p><blockquote><p>&emsp;&emsp;通过 C++ 源码可以知道写入了这些数据</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/8207ba23/n_v2c9af2c88fe7d412b8a9f65a2da99ebf0.png" alt="image"></p><blockquote><p>&emsp;&emsp;通过源码和二进制的对比，可以窥探到其中意思规则<br>&emsp;&emsp;比如利用 C++ 可以知道 Version 数据写入的时 <code>0x0351</code> 的数据</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> struct</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>struct.pack(<span class="string">&quot;i&quot;</span>,<span class="number">0x0351</span>) </span><br><span class="line"><span class="string">b&#x27;Q\x03\x00\x00&#x27;</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;使用 python 将 <code>0x0351</code> 转换为整形会返回 <code>Q\x03\x00\x00</code></p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/8207ba23/n_v23dbc5f16d9bb480697e9f37bba7b3802.png" alt="image"></p><blockquote><p>&emsp;&emsp;正好和 二进制 数据是对应的，中间的 I 则表示是 Int 整形数据。<br>&emsp;&emsp;这个规律我经过我对二进制不少数据的解读总结出来的。但还有一些数据的含义是未知的。</p></blockquote><blockquote><p>&emsp;&emsp;后来在网上搜索了一下这个二进制规则，发现 Blender 官方提供了 FBX 二进制的解读。 <a href="https://code.blender.org/2013/08/fbx-binary-file-format-specification/">链接</a><br>&emsp;&emsp;这个文章有非常完整的 FBX 二进制规则。<br>&emsp;&emsp;通过这个规则可以解读出整个 FBX 二进制数据的存储方式。</p></blockquote><blockquote><p>&emsp;&emsp;比如开头的 <code>CommmType</code> 前面有14位数据，除去开头第一个 <code>0x70</code> 数据，后面的数据分别对应 <code>EndOffset</code> <code>NumProperties</code> <code>PropertyListLen</code> <code>NameLen</code><br>&emsp;&emsp;完全和 Node Record Format 对应。</p></blockquote><blockquote><p>&emsp;&emsp;理解了数据的存储方式之后，就可以很顺利用 Python 写入同样的二进制数据。</p></blockquote><h2 id="FBXSDK-写入问题"><a href="#FBXSDK-写入问题" class="headerlink" title="FBXSDK 写入问题"></a>FBXSDK 写入问题</h2><blockquote><p>&emsp;&emsp;只是我处理的时候发现 Python FBXSDK 无法直接写入 blob 二进制数据。<br>&emsp;&emsp;原因是 <code>FbxProperty.Set</code> 不接受 bytes 数据。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/8207ba23/n_v2e4128595ef4f4b49b00c9f6ff7577ded.png" alt="image"></p><blockquote><p>&emsp;&emsp;这个部分是用 C++ 模板实现的，可能这个功能并没有映射给 Python FBXSDK，导致功能缺失。(也只能说这个功能少用得很)<br>&emsp;&emsp;为了保证数据的长度，我的处理方式是用 FbxString 写入相同长度的 字符串桩 ，比如一堆 <code>*</code> 的字符串。<br>&emsp;&emsp;保存出去的 FBX 二进制文件再度用 Python 读取，然后将 字符串桩 替换为真实的 二进制 数据。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>&emsp;&emsp;这次深度挖掘了 FBX 二进制格式，对 FBX 的文件处理更加得心应手😄~</p></blockquote>]]></content>
    
    <summary type="html">
    
      FBXSDK 如何写入二进制
    
    </summary>
    
      <category term="CG" scheme="https://blog.l0v0.com/categories/CG/"/>
    
      <category term="FBX" scheme="https://blog.l0v0.com/categories/CG/FBX/"/>
    
    
      <category term="ࠕPython" scheme="https://blog.l0v0.com/tags/%E0%A0%95Python/"/>
    
  </entry>
  
  <entry>
    <title>Maya RBF 算法应用</title>
    <link href="https://blog.l0v0.com/posts/1048128c.html"/>
    <id>https://blog.l0v0.com/posts/1048128c.html</id>
    <published>2022-08-25T07:46:44.000Z</published>
    <updated>2022-12-14T02:54:16.806Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="抱歉, 这个密码看着不太对, 请再试试." data-whm="抱歉, 这个文章不能被校验, 不过您还是能看看解密后的内容.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">您好, 这里需要密码.提示(神秘号码 + 光子)</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="ffbed5c3f03360d507f5c5e59067d1b561f71cef21376416139ae9a8634f569a">19a56cc198cba1affde8dbbee0cc4fdb5a7736152c78bb6a882495ffb27df7a130edb8662e032afb0a9361d6230be7911efe03c48bd8d11f852f8c00d71944d68351a395de3e48f1e797e263c10debcad286daa77dc2799440b331a6e8badf02926575cf51e0d3b85d59d3ef72152189045a3545c82137eca23553fbcae8310d62b1bee286764db486b0f4dc80bc3edc29b54f4d308655353abe23062c0a4a678e81998471115c7d8cace8da5a950e91ea008afbbad3ddc6309ba4a46bc6b7a1a072a514cb0a0fed405763651da66a305458104a8905806636b28130b4906d6fa6bc520b3af54fbee617e1a9ba2c67bbe6dcbde04ff56ab9ceac684a9263e2d27dfff908f5e8866dbb7e8da99f84adb38eacb1226588193264dc1800505269b633ab3d087532b82b2c4412c5bdd019bc9dee701ed35965cb51c814754e2c510523d6f5a7081b31c8237d8a64d896272f05f0fea3c3c6ab3f83fb6e86a9976cdec9db01a5e7019f76d795d63923c18254610fa61c60f5c8eeceadbe0135456556384a99d8c423450d5add1512a58cfcbe4b7b1d6b6e1c9ffd97915250a0b8f99fe0baba11a9a230639082bf12a010c0dcc3260141758cd1ac9d52131424f582c6f83bb3a692d3dbe4cf391643bc48ecbd64edd66d126f7203347f24924a97a66c72e53468dbb41de26825b63730599a8f40f501809b9a150da37ab602b6f840a74b9d161fdf1f03c6e31ae12fb1d98c89cf3d206bd35cffdf704b6c3e43292db3739b7cc5ff558fb2fe72347a43747abfe0a4f5081900e7010cf21acdd4b5988009f34d2b3263072264c9b613be4d07f7a73b74598b633afc673710e2d3d292681e680bc0d8466834184a139be7c3df764b0efa3f210b9fdf9cef19bef334121d685d68dd5f9bc6cc4867b0f6ca2a334e773d606ff40434dcba472fe3287af781dd7e77fdc8fdbbe609ffc634dc22a3d5afcae4e177a961dd3254ff015d316ac9bfceade6868969f6afe36aeeb3f3e18a63fbc8133b590c3df9c24ccf86052f701f74563b9737b223d707f6554fc9373656e65d74d5238af4e837769e21798f74d5958c9bdad1d09b8d586090999e3444a72c267afa686c641e163f8fc87fe339baeb20d82f664bb33879721f1bd27e69b827936bcc4da55c70245f16298afa1709c023a52c2a61b72c8e7e8105814560ab2906098736e226f07b9a283b17d7405ad6282f6ee8a1938f9d301a6d0455ba8ea6b3c79dc4304b8bd54d3bc30ce3fe828ac9b04d0824ae1879776e8f09895756b6df51b6cd632e8a071a3091c0157a1a566945756690e34a643ba98580509f711994bfa373bd5140e35a749353fc062c9e1f24e273a1ac37d0a58dda87d07d930b5e4ad4865984355b1b447a68b9f527a4c7a1c1617b3517891d39e30a6d3fbb4cc1f9072a02efce089172feb27b324dd5206d3c52c2f738466c2cac597ac1276513a0e32325d04c9691274d4ec935595791c93217b51adcd2bca9e955d019915cbf90ea3c148a652ded78a5245993609bdc9e002f914fc8a61846371b287cf396d03de793b24429d29c51b3654e10539779ce20ff084b071193b8b4f323d31ed3f31d3c836d645bbf5cbb6619e8c14ccb7ba75c9f245826f64a0c85af2f94d873031fea2ac35bc66139b8c0adca8889effd7773934faf040ca73a4fd4c8d96f5c8629e5ea7d271c6becd3bb5bc6c2f1b505ce362dd799c50c1b5c88adb52a57226feb54c67991508d5b4f560c9833da11f72d05f8c08e9fa71602f34bc0a1e6079d2e9012b81ed1f79abf809699428afcfc8e9a133d8a04218419fd8230160154dae2563db2aef3ddbc72daf338298a359aa3b18c33c26bd3431258334b979418c66ba586fb3c15fb768bac63885fbbf0f2f5f625e5bf346490cab3a40cd1650f6d295a0076828fc567c123f524d9f53b02d41fa21c7194b106eacb194d567048c0aeb795617377951fcd9e2e0c265f7582fdbd95d6893bd9066940b45b2c0eba9fa7661f899c38b4c4c9f78b69e4b16217f1fc246d3b5415addd44671e13790b42f0a47f5747a3ed2bd56d7e1893380c7dbb6a65afc297106d309265ebf6b5838c8970885032ab1a8cfe8d81caaa00ea1a7f0ac282d8cdd563a4077fe789d9ecb4b0a70c3ba6c5a30b0dba74289b70455e544e7435d500fb9a628c990b2f45ad770be46284b740a7acebbdcc3d210348c04a42e37ff527eec4640c4a4071a8b3817a8838db16c1c2f29d5b6f4375cd20338bb4d74577463ade7d907d7dc9012b9e1ff81feed2ef6ee6684fae3f1ca182858f037221ad5ec99f78be64a045f4a154a48d31f039c1ed4e9ee818e5470d16c118d930f92553651648c52d3ef08a05451e57b620be06fbdac4b6efc7d00d0647640b0adb9e37c214096a986d2f9ebaac6d743d91348468c6e0d2c862ed96d07a7dba39d5ddce86b76f17aa59bdffb3554c9ef7937157d102dfcc2f525e9094fe2c717bedcdad207a171ea50a33371c2ee7ed5adf307df3df3ba49053bcfbdaf09f3fc6d7cd74c252aa321dae08f2f50535de22a1964b1ea959e0e3e0a374de81ceb134dfdd1dfac7c26e8f7ef130ae811f986a9c427e487dd07f0201cdcf5ee04f682c62923d292b378b8de78239519c47b09fe1531277a3c790d83a2ed5d1c97e0fb9a6bb0b5c9626bf449a37a7f5620126ce3759647c87969b4fb63bc9c75bd77dfd67ef8b4e06d4d73a475b156718fdae30f38c7cff70f769a3cee4d95ba9e3c90d8d12958cfdfd77d93e105983fe22614cf9aa7c73b3c50bfbe3a2cd072de8b262ca0535661d12fb25d220065045ed0ba4ca85221fe26e8c403983b18b06946ac271c41c1b358bf31fe5ff95ec5f2c7576c57848d13bc25a507aa3961be2c7869132e1df521f6d003c47cb84c0243006c438e04ddc05cd124f5254a1bcb8cb87cf28fb1d7531ec94959b092c579a53851375e74e3831822dc3c58de32389f8cfd35a8bc1beaf362a06cb98a7ecd408fa03cc83270c589103e5c568af72919aeaf1ec4d5bd2d34bd05f29f62248eb9cb2e50979cc2e1859c38507a1b0948e4df3f8a8f93202551e3d296e3b8ca5ab4e71e26071b991010a88a3a7cf6dc21297f05aa5c9e75e68520f1caddb0b9e079c3f0b99d3c06e4431f22bcfa0715c49f4ad8cc9d505c28724ed7549ad6f58b82e7adae4f5757ae457dcffefdbbecd408fe8e3a1f9e31f535c971a829f32bc2df1f1ec1533d301ce6d421c7bb724d80607b94bcaad28aa7ae0bda082867bd0b8a0ff0218158e28b17dc2d7a04dcaed84664eab615a543cab2e9d42ecc1041de48f4e258014dbae3299277c19ac4e3f4779abc506cfbe559cd3a17f7a520906e3b7e1f29dde831db7b8e4c8cac4ba45b0560632565b635528a5eadb81b6a0f2e6c9407c55ccb58745c144200a42133d0c4a87c86a160cdb5cbc19e0851e4262fe1004e247c45952752a982d76ed0ec0c0d585f0b6dbf439a14243c3630b89193d8048d8916a775e425580f8b31698d6375412256dae8b745377608daeec0b30089a5cf8898f504dd4e7efbbe4f7487cd568c0f584f362bd4f2dfc2ce13850e31c84be17f37a763327c753bcda76cfeed013f4f31d602166968d1d04c5dcd96a8b2a25207c74f03ab9dc4f14530afd1a4a91ec2b1dc3b6fe47b2e0761af8d3610e6be3364b21620f658a971c386067fe89b8a580f29aa387ebe1470c3453559cf52eb428a011c2d3dfa77986a6486e1d04d7279d218e7a31e36ca12147f7b7bafeff4880644f590102e8859e89ce8e60b72120d15a862ec7822547481f1f1d7e57b5a06570fb6d6ea4539bcb0ebf5dd2c83fdaa159a2da5ac755d8340baac3d7363e0d5c14f32c2e753378602c5436fc44aa5ec83b30ac40d275de100030cbc9a639add8a9083df2298dbe2516a01fb6dd733c9f249bba2575ded893807a0a7be0f32a72d31d8bb2614ab7661bfd5fb84a86839f5b46949aea37e146a0af37b52e612335fa365c7be6eda50e858e606a39ef053942ed72b07967df21302c686fddd81de778b14476fc36bd7dcbd77849e3afa399f425bad2cdb5b456f9b8d2d8550844801ec46d7b9a5c7ff98a8255d6e3ecfae2f5a537452e4eb0f75b23ab6b1fe5581a82ad88ec28dfa4298e52cff830a07c82e29716339d753ad43331864ffccdb1eb5401861899802d397b12d3eb1b8b1266ceb44018c6c147de3caddd93285926926cd47e6b0428dd3c052a9bdaf435ae98ed77275f6ddc5bc7dd8127e7cf2187bbaa4d053fdcd30018722ab42bce291e5cd9c09d5b53c4716052662b8897f2b7adb23dab610a9000ea1cc5a10c503b37c929583d222a4518cfddc80e70ac44a117c02d0d2351cf88b9dac3f402b860dde5fc674a2f0fd634a74946a65530313a680fa6be29df23fce3c277b554bf72ecc58370748857f0dd79d9face84b141c93601fa1c2147de6969895b25b84759d55e5d5a663916a3b6d5d9e10bc0cffd6fd23451b03194ed324d3271a48c2e7e22ddfb01f36a1aed76c039faa1036bb4b2d6faf1ae8510142562378a49a40be1a75ec50cab30661796a8e1c1af6709376d920f5facd14975d8cd1e1259be0d9460fa9fb618993267fad16aa560bd3d2847060bc56eca2b301b5dae1fca5640bd32ed387d34fb7bb459728aaa2154b1301d9551c2692a8804995d6f64a104e480135a7132e120f2e1e562b6078714032237728b2cede70b7214bacc2afdc184b799d971a764cee01f8d33dac9a86f9897ec595999251733b2580d26f94c5009083448f97ded207a8c73b07464d5dfb21593dded63a1fb50fd340f31a4f1d76972b316e4666f677c857b2bb1cbc73dc29640f74661274d491b09f17165ff8d6184a6c126c8f54f52803225f830f8fc4b323d084415a554509cfa1cf2d186ab245db0a4815cf72a2d74ff1371b0baaff5519b3a0db645bf915d116fb89301e50b902b4abf66db75197b2483f31fbfea595a0022b400810edd62282e54981fc323ccd951b3e5295d0aedd46e3f83d98a5720725e77abe3bd4486035ce3c1153ebd1c8b5cb99b24f79b52c6710161615f25cc13b19427101e975e17eb1d765de77e323c637c8b63a56b862d27a04e600b1030ca6f1f97b0b292e56c8708a4c0ef19fa94834bd5203b4131a361c9c193c35840da221057a91dfcb183640aded4665caecfc9c324f75fb94e5eaf930f1d900c20cbcbe67dd56d22db007e684d73142fc0fcf2a0b631fd11c320cd07096e476ed674626356d61ac8a94196537122cb9d6748281a289c72263d5410bcfd6bc893f43efb869289679da5b8aa2b42835e1eb418b827d317a09b47feb031ff26e01ed0a4ff33194fa1c1d1a879568a53d9828a11c712bc485b0322fa951e765ef0fb64389945668fbf1097d1988dabcfd87bef86bc6cc60b8acf9745a9b86f617cde847d7b4518ae542ce377b87de1fbb86c6281829e665d443b56964e989fd71f63c1f90bd1e6743b7a890163c800fc1f5ae5a24f79763157b932d7c02334337e5216f86d254704cd78e9ca2104b08986b0ac06e3a00b52353427351b20736b3a248cac2308bf2ab2f3fdbaa9dbd91db2b57e6fe34a3d50707dd02ddb59b1650ccd36251a84f09919a35c733df4bcdc6c73d599bb9aa26371cb2a66fa475d9e4299d6e9e170cb0a00dd0cf1fb2cb55b386d04bce255cf27edf6263705c79de2eeedb7005660973998c7d596dde688f39f6f34b7b184397ccc8e4d956d04dd26737e15a2389788d18c2fca5855887f62163d6f37b04ef9c77cd215962774b59f8e48b5c31538687e8c8c5ed8c73b93498f618d65b770f7a9bfac4901cc7ae3baae46a44462dd9033e3838c82867d718a9cee96c973b03c4541428e5a56ed0421e98989b7e1b6ed125b12a489f982cdaf7b160104ffc7cd30fac29d9d563cdcf16dadcafbd091817ed6afaf5946b9fc56a2d6daf27254c8239e971b829e2f7d05691405e4f6fb7d224ec34cb69123f7ad50cc2a371fe98ce4c96e4597f25fdd29e5068cd12ae6d368a0e1be8958d55b53cfbe32289c71dddf8d5817c9af6386afc2d1aa8414a67f92c5db0fc11ba3204983282dcfef7a65d998b5ca4a66586fc7704f39786cd32fb9c79b62da6f5d945b76cdb7e581470ae02498e34f94d05cf06992ca6e28ab341511c308a8718019a1164ab23af8fcd2a02d850a9dcbf056bc9688b1aedbb232cd35739586a5b567db48b46011f9a69ba14805eda30a3f9b02296495f83664b8a9d927b541c388eef8eaa87f894a6cc93615769e1aa5ae0d2ac01757c6cc927b3245337707eb930f3aeb1d6dff8301458e35dc9d54864b7fb65bbd739b5a2f336ca48547141f0bace60a6ed9a1e45d32a75bd7703dadaff8db821ef93290d81138f02a54cabf5c1918071983afd4c0f518404ff0747c9bc6a2ed0859c87bace55c59d9cdbf1a9c334439f5637ebe0ea825e2ef37d7fa90a711cce8e5e5315881adb5fb5ff6533c0dab00781d41a483204be52cec6e88fa334aef87124ed674c5f2df8e6da61c8ed5e71fc7915379a45c34f2987cb786fc9232bd8b0f1b6b8104e93f91f1261847fac9fd6927864018c5561641b5217548e97cc0c7b825dd11c3234417e72858eeffd42def796f0d85f8921fd736819faf0ea0933bcac632e5f3a1d55efa5e7fde140f3527ec6be8d561116b68ccc316bbdef7dc9f4ef2aead7b7e2294c8b8bda703e80699e915b79b2146aacbdda9c7c640ab02e94484d71b9d4c1d69c1715f6dc2b7a4101f9e9bbd0b7c28daeedaa068563a0712aa5492b42247e6b34cfe952442c41a6b2182d16b08999f135e153edbcdde3ca802f179efab543cc71ee850ecc212e33422afbc23ccdaed9b47c662c0798528f4d000b5aa3a1ccb4e17699c92a93efebb97a8e4885cb13216767c65d85d90a5f4d8aa8b575e30377ff451acdb32d3f4896177b671957656020e541fc2945b04bfb2226fc95dbd1150d91054cb5c0acc29593f5f7901a2be112ed2eef688f4db2e5cf3674ecd585f645d7cbe5ce7710670063cfa0cb435e156da1305201ddbf55d47bab74f7eb18132bdf7cb81f137148ee9d723bab2146e7a11135f696dced7437b32dbb87052dffbecf16133ef4cf945c5e221cf8f9d92bec9f89ddfa6e4f6aeeed7fa74aed0f8ec6d258f69bb43e49b4e5b942f25043ae0b048ebf95421619ead63e8ecb7a0e493859b9df56257c96443177100c8b5c4bad68cc1ecb7c02be766da3382d019650a75898df27b473109c714a3b6317f7bd75accf39ad42e0f2a71ae0e0065c17b217724212baaecd683c13045d83b6c496db713484cd8304c0c0cdb0dda367708c6a45467f6f936d385dc5034d4050c1d92677a227aff339b2069f836c6e28e2a8a18a7d369f4db0d3abe9521bbc2e9c7c9e65ab3b5857eae00f7e2837268751a727ec85b43223fbf0c6062db73c400e9c8980041a4812f227d7f60009c81a92fe7652c5696cd1bce68e5772dc7030f22f0e40c683d2294b1cdea3037e5d30deabf055236f0d91f9671bc3e78bdbef146ba4620065603737d6c93a4e64f88bc11213d6650ee79d628412401f03397ad6afea1ab9338e44d0b5f17d38fc2e203280e26b633bd4cca591b1665622cb54f69be5bdef49370dfaa4fb0a571bfbd304ed44c557fb8505abc04142f0613670ff8ee5ecce3466a90526f44189f0ac362c88c7db44eba3dff2eba67bdbd56d34d5cdd6d420dc76a44ec4398bc1e062cca4f4221efad1918ac4da18c1afeb1c24c1e8f0abaf523b4d23a5e58c0955f3d289c9c514922fe7b0b49543b07a1deaaa18826c80841631e7e50beede735ae932cb1e029e2a6f1ca87614c9ffe35aa9040ca13284026be3321f10125f7fc62606e516bed68df52f55da8d49837c9b7cd9daf910b9197a36ee3d39395b6fdee6ea2e48e63b795551b217c70f3f5c2e263e2a6bc43126ef7d43f09e1edefd413bf15b2146660f68bd4205c6a64d3573ddeae133472c962e06bd62e57a4eb5565d130ab611aba6a27560988c08010066603dd4f94949fe00ceb9e92e7599f184444d739fb78b7456b79768d49cf890124bba22faad61177b0eff340222966a91b069966b0fedaf01ded680a099072ad04be0c8ce28143c7783197acf7739bc793613d4233eed61f1cba7ffcecb8fd3ed1efd42ae43769709cea778c690871a29713058b694f8b307cbff1d3b8c52a653baac9e461cc57f982b059eecd1009feaedd2ad76411661b9ba440a5fa4734fe2ce443fbe80df59ea4d3dd216257cc61f412593860ed1eac0d92dfddbe454fd2e59fb19b2bf0aebd8c434e96501dbba2945e1d66dc49eb079421152283d01451b18a3d489c351311ba4d27a608d825a38ce99299b99047f5ea87f39b05a60bd1f5e8dfa24e22e9cc111722805490aace4036b86122f50a3481abc7ed0d0a0100b5f6ad3b1113ddcfa34846fb5277e7092ec1568bad3061604dd434cb17b6445fb70fe889843576b869a9f3f3825f68116aa6dffab881abe72ffe38484c1dd07d32e64e1c8542b7adf0d5c254c6a045f2bcfe0bacb7c51c69dbf8e5a4915d2b9367b1c42db0bb55b4116439b3a1cabbd177086e451d5a319e37bc52b1587ad82f12af582927887fcd6b818f90235bc1dec24a375d08b0905798841b05857981f4293d5df0ab5806d5b4ed7339cb3a192a4bebff3eba6e01eaba68d704e9e556080c8dd36b611a7488d915b931493b258a890f993a7af169f8414731ccf1df3a46b1cc46e266330face62264748882d35b9b7fa6bcfacedc5a8d60ca5fef51025d4109c3aa6e04bb36fe3de1e4dca0c7f1cc9a181cb286f04e3f9110d683352f10e9005b30b07517cb9d5c0d74549a3b032467b72d67944f2496706f37afe05d5df89ad61d8bf78e73399ffba5006867ade15133c4b143a43c221d22ab79b2f6357a78407ec551f45a6e29d5a88fcef7e9c499502dfe1e05b1d62a6f9316f773ffeeeeb8f832641d193a54a6dd4e416fd139711ba042bfaa19e16a86d729bb3c8a71d7138ff6cc4efb87d21840b9646996946f4893575a467eb34e3416cb28d4660e7f83b14b88d536d1476f6c485c2053db05a7ea922c5e938304c84d61888ef89fe97d853379d8969886b11b7b890cf092ac15fd297e3af9664b94d236bb1f43b0d28608c85a8ea382cb75a1eaa118e482f00a79dd341874fd0c39cd884274ab2e2189f2f6d78f7a46acd4d4d9c7e51954e17ddde9b40edec1144105ee8838974166e0fa9286ad9a6fae5d2bc2efe2042fd0f5a532d7c084a1640335101da727ba1d8d34c244599af7e63a2e4582c02a3705166a385c16cfe57894dba8e3d8254a68a9c5c20a543631e7164693ad708d4496a8e4ecbaa82943f6e244162ac3b23e1fad2e787fc5b60a2d1064994634c12a8c43d8da0e2ba57e8c7c52332cf633c97b5e228d78d96b3cfb90d88e1c832d241663d74863bd1ffef2893cd3e5533b8b9d789a4c028db2657f4575fd96b5944e77860f1cf51a753e88a85c4ff47f1dcc0a53025365c5ddd27743367ab10d2c07666924a7b0d79142305a81e792cc98a371a76f77441b7583939fcdf2ec088e8fddd132fdcaf00d0f4b6c62ad89d764c9fe4c0d0288de6506c1673c35f16b4c31c1125aa447292f46ae29fc46e2c458396b6f4ee20bc8431aeef68aefe0abf0dd4b1622ec86f4ce9c8e1b3ec61e4ee2a3535c8d818dd89d8e727bc08c66f39f7fbd5ca302323bf5e4afc2b1a324834a442c45d2bdc01cad59a77159026b70975a9b883eac9a8d7a1f474d74b95af86b44572ac5143f3f3a20f6edb3690b997bcf2c33a2a3dbb614c20ca35fac7c06d444335f46e31897f0c7edd2bbeeab60e4c670f8d2662510caca1f5f78f1d34a75fdf262270a144214858c0989b8d04b0493d4d3db3549085c34948472e69b0766bf8a432519f7f6cb719576a9ac2b298a6f921604978add6921e7bdece76749a8c7c4b1096e296fb1c6734199b3f3ffd58923a353f31576909981b6bb6114173795317e37804cc2608e883448b31ad70238d8ca3931bc563a166ea8727a271693be52c70913df4db800a84298926ee12a937873e97ed951a42628c8985ab3e65f07f0df7496e90d2f65ad8db348bfcc0e5db9f5d6b49d56aac2ac96c7e2ebb318a5d2bfff882450762411793d92504651019adb5e816dc1eabaa16dfb21987ed631daa46cfe9ff8ed15f3b9d3bbe8ee08a7f66b37006fa2c3ebaf654ca0c6fc34f1f0363470f0b6bf06b383ed8c17822830b052ee75ad71278c4a257cf3258b3cc095cbe4b961ab42471e6afa88ad82d5d5914b92578d9274fb5fb8447fdaba4a915b83e4b4d1454f3a2690e4050e3e2c32b09a16bfdd98b9183949b4de8924aa9d64b39be456e88e19057111feb6482e990fd0a4093a85004f7b354f701d094b7aa8f493b4b562bb11da06bd5703c5649870ff16f594ae64f774a97bbfe9b59940fa9f6e55e09b938d072263547eb8c1189da0463c2c31fb17f3eae1d1fba0cacac0203bb80518eaee9375e1ab054e2bab010b136382a7d26cfedb42f1b03c4d830c3ea9ce3f8f4ef9726241f5827933cfb8ccbcda6dc4e593b095f28a6a94f6304b8eca59ddfd8496cb87e3b592f4f4341ace1a31d60eeff1ce54e04b893d2c29fc494d2da1745061ed5491b55fd42325f164f480e781968e6af87360426fbb0279216ee26a8a031c88b930f802560293d276cc1c7d93fea7603a497cf96942163bd40746b920827d078de1ea66704f891d1cc2978d9a3508b346656a7d7affdcd64333c2f25d93a90208280f5a55c6a5d8575b2d83c73313180c09a6b8524d105fb8301d3357b8e41f5f4d70235c6001dc3f3111c953cca6bdc80f7b3f2d95da8327f8b9207c92d3ea2cd286f0c6d23b325ae0eb22360256e49580483df7db738a36b1327cb6f35d6149d576efce245f39866ce0c7d61c4fc4d41fb6a334a7d2e043a1f741d4bcb8992ebb7f70d17fbc212212395488a3ff8bab3e7902cb14eaa851be96a26a6a0c53394b7aa6578a6695c4ebd8a2c15a6f313750a1df0cfe0c051ff50e241b1104f338a742893aaee084c25231f9e9ff3d1c943a91451f9ca545a9e3959439d6c3679576ffc7ea1c967b28a66faeadda307e196f7a5ba168a8d04d6728744ccb9b7eb90caa969ddef910b9a9455780f392a2da6e31cc1d34e7ba7f7e468e22217fe0fd23b4bbaca95d76506c09d520a0203ab1b3dd922e2f8f65e9742f236e5d9a3233f287a0db4c069d469748855a1542cc1aba528d7dcb0f21f7af41e53ddfe59ef41455bcb6da5dbd34439e868c6132751a7ad2d8627d53cc77bd75e3b5e1268afd189bc17129b8e9310d7892ae5719ccb584938cad711c38edd31ff7218775075d34bf4253f086f74ace6b3a6c6c12911362368b398049b35a789190b07836981d3e192bc3a4645ae8e3ab01f3a552994825bc58593bf650213baf17c758c31eea4372a8f93f22631178c61adf94d4f5dc65b2f89534b96cd08ecd5e907eefbbfa03034caa2e726a1b8230ac5ff1c30d653d747a8dd1095f04c075dccf543ffb17b51853cb567401a731adea4ba44a70fd6e2a8bc200ffe32d2adaad6bd55cf81ddc1c1cba3773e450376709d18c97d3c27895d219bf03ece55cb4bd40e28b83aa812af5c81fa5d275dd203ea39af1441238e36c6c32d33d742a09d779269aad07088a0e01025786022d91f2fe57ce3b14d04c1cb37550a24e1b01331740afb8b8b449b82e8985f79dbea2d9b75eac5f221bb22a6d0e734a79d118aafab6eae90869846a68cf46683a0bcec567caaa1b638c7dd82aa9184d09726fbeeb9de6069a54f3dd80f5e53f7568256c92f612d8c7c59a4580d11aff42fcc49dcdc5d67aa2202d045dadc8a1959dab2c6ab1b82ac4e8193ff99c1344c674bb3cae7c42724f7cda3e26af5b49af9af68a540181acd67a6b78039ff00e2e40f49c9db17092dc4d96faa2dd6cf6f1c4870e148954cad98e535726c3d19926f3c9fd90052ff8b0dae1d97d98a2b31922f84a364cc303791760f47287371f426d9c08fac48e3373980eaf0e55428a1664171186e94511f2be2c4dc1f822e30e634219b728725a946d206e25a94424f6c15db8de4a47f6adf5b0ea19544d1ae07f6e50de30ec9731535772a3f0037c823c46917775d83278a1d8fc378b4472e0e6b31e673c802c1e012747bd8082924d53188563be3fcdf9c47f3bdcce8d7f1537f4b667bde73120726d51dd6c04711ba14b13d9a8f8d64d90b8539d76064f2f2262642fe55ee50e1b32c9710a49f25e09bd7914bbb5bacff81137f2e4fb9bdabb7feb4326b9f79e69348d72fc6103959e7b5b798e2e3e3bfcebde66bbdb9da4e9ae80d999298bbe23b906b347189e58863c14072be68c3cb6eba1c877dfd22326e36926464f8afce06ec60d5143c2cd615adfa4020520ff45a321c16b584c639151e86196c3470aba490ae0984b0bedbe14616d80c6b1b787cab44eb34d5fc0ec33418d53a4795684304cbb66b9702d6fbc22c74cd2fe4b6ad0a9563bd1cb80b1b74d856dc80fb2825f01b26626767235b7fbe69e3285c5d4de5be5933ebce04c433c40b3bb6a61cbe73b2bf42fc244dbe8116833efbc0becbfa55f32bf7a94008a943e517854d1b83a76f18866b26a774ec152de4370e4b336d84a603a6452da15e0f290b8648c446348e5e314520b01c8aa1f8048f94708236aa924a9412308af19ff6417d07ece8bdec98dde014f4a8e45a56566e1e38150c411d5bc070b7a51a7b3cbde04e05416be4dc45ae7cb9a06bafda502f2992a457121168a44d5a26d73c12969d228b6ad6966b4e108331be4d1c9fe74178a21cb16461a972f06e9e12b3703707fbd1568515fb599a67056fca8ec15a5b208b7285d37b903bd9764996841c24de20457e7e1d99de9979496cca9d67ef737a0bc082272bd2d0ea343849fdabd65ac961f39faea8627d7154e816baaa477c602fe82d19206f7daabf47fc3d8e40974d707d4665da598780ed80fa5cf7810bf7220efe9545de0419edf2005d7ffc8a36bf0468274e5d96fc29bbd828c4703fcc3f597e1b607b724883a9466765e5e54bcd5fe0ee6efdd0050b75f84223759ed9159bd7880786e589fb2a134763b802776745da9c215433522f67dfce880a0e41f7e8d8a4d6a1d4056dfd5f075e5fbe3040a3ac15c7427d5e609022617b54e359a9c2ff78943086312f9d02db08b08de97f2069097f4810845709cd25621e868e747888d0a52b79592298c95377dca307f418dc12d8bf8bdde6c5e00d2f9f0c186ee377ebfbd7bfac1757740b20a3463ca6463dd9d836a00902b51973b72a121e4e4554a3006179831c0a1b5084a677861a81c244bb2f25d195ce1bde092f51564fc8bfa54ae16f76ece746fab6435929775d355b513139c04c15079d8255864f0bf96606f353483399812319d6834446ead0e1607402c8b220663ebf3788b6654824c935b894716a44495d0f70a8899b8b7c7cdce2ee199018fd135054ad4bf0eb8a051fd60d685cd43080f67623b2f31abd14757f417dd8403e878748f6ac56159b6931f2dcf8bd7f59896d019b93ab2c5a61b0e1be1a6821632cd40e786f5e0ceeb2ac027086a71b9aabd37351d5e21874a85229951dcc05836776ffabcd9af765081bc9510dbc422be449985c0c4e908c5850aba475e0c757b8beecd0133d9dda0e945e519d999da41d0263ffb20ab0d2de9ed9185b3115e43a6b9799ef35eb1793e37eeab3ed9d16f93eff8370b3d59eb57c21b907e3fdea73b724c1ef0e87003a26087bc374b8e4294988ff1fb03f186cc23a9a588b794d3421e55c5028b7db0c37c137056fbfcbf8e09a7d5c35e2966c449d75db5f6b594c2b783978de5b4911090acc3fd03fab0e18dc6d54f2e7c3f61e2f0d51f196ab4f7d0cbc54168709c9580fa6773903e52f2486162d4a6fb5e41f72ce18f1735ce3cea37bf020dc63d49a870746799b5b6e0324e05b2792cdd65ef7bf5b1e96cacc8f3ecd4b6f9745767b7d15c904e7a0da410a236fc1fd9b71708d0a40b1d75d8a39bfb17e05445f34495b4812df8d31e7f75508c28a68ba228d230918ff9eb0abf7c55318ea02bed28901a73c681a7d4ff262adb16bbfb2863daf990f93041567936396ca5c1974fae7f9d4ec8d18da22eb0e9c278e846ba177e5a3e374e878f8c3e07ceb441eaf7a758882467a2516e062f39a3316c65eed361af960accf1a906471263b4ca86bba9fecd81cd1674b1e49bbe613aae29f3a4b8422c325a2fafc4175a65f23c17d725e1d2a13b81230c2b1c95d8dec3d4180bfcc4254210b66468278ccd4b2a457f4179e06d69d13d9803a114595028434fd48667da4bce43ee085943bbdeaeb2c3db8a8775c6f557241483186ff061cfe437eebc246eb86c08f652c8e2a433eca7928583211650347c60806c824ceb992d9ce0026e6d7847eafb5f4d42697fb64ff1c253efeb1f87279fd27b8028dc94ef687434146c134ddccf4b85a5434557f9dac58a1a20290d0a91b798cd165f5e4bf5e514045640177974dfafde405873d7b2b01148c353124ca0a4447dfdd42c0f06789dac94991c4a5721ded1492e42d0dac903847895cf980959564d20c1634a419e3ae4cdb5720ca094d84c02eee9d8c0406ed92b2f7c8735c25beeddbf1e6ef717120c5ef293c7e28d76f0d01cbcfc705eebb9ffc9b617344b1a877a639732c20bd0f695381c2430ebd857c7a1c77d1dd466955d05380c72742fcd6ef93baf7a9a003d570f86a08cf0d500716bb1a88ae4047d2c4268bc192aaab9ad5d1a4f01d1ac11b18e88e87f2dfa134eb8f8a8f49449302122fecfdaeb3191b4d7c70feb5fa7a488f9ef74383659a28f231432c8ab182ed6dcd64b6dfa46f6bbae21521fd7fa9941836fbe79766d427eb2b2b9ea2cde6b4084bb3b7d026e047146b2a104a35703cddb474627fa814276fce79b84cbf1e6fd56816b9efa8eb419de2d50f0321985aed0b587678355d9a7324dadbdc1eededc87340da024144664f700863151941eae9709df379796176d0f77127f33d52d07a28eb108f51dca3802ddfb624ba9ddc8c71bf3e2ae3c19df5d66930e303e1566267b93f37540daaa57f09e2a927ac9ad1ce2c28a8b7135a32169ff422fb8863f060fdaef66eeb0c231dbe63a3704856c603bbd5ff541fd4375e39a03601b44f95b643f6e173bdb326dc57cfe02ce3ec74d0b58df546b169c2cd20389f5ac4e5fd9944f79eb8b0388ba7e0ee894b752b9dde4b5215f99735a10c8644f0e5c16349ec7d5a0439cb455c9982adcd94b1e8d8f119d0706cc7586fe6f8966ffffaa16fbeead7630e8bb377b82ceff55415bd71003780b179dc1de2b96f0cd68588f64085ebff13d379d46e247cdfbb953a7c1536f2451b1ab06152651c6dc21fb764ea6194f6158ac72aa94e479b7d1443835ed45bb21c2dd8a7fbeef9e7b68f72d0c653e1f944936c0ef7e633b53193a3123aef61129dc998779f0d910a8b46569b6f3ba5443768855a6667c8d4e63425a93fffe23f9e6dcb9f4a8c55005a3f57f87e3f5ff3b462312895b4496af2ac0cf8ddcc87cce136b7e9fbb6c345ce4902129b106103f1d7a011dfb6893571ac2478511fb1c570a357eae86365be9eeb7df795820e12c8b7a496da5aab9739b6148f387cde52ba664c68f4cf896d7292725ed6eb460d9700b1e941fd15539520f7590be13da1c4c1b43088202968d42cf2de7013bc80dfaa8ed53c81cc17edf84feddb098288cb02e465b9736ea6c56a88f7ba4f4c3c6a465ffc3c6e444b80778b7d843a4632a8ea988caab2789ec723ce44b0d8c36ba8cfe297d1025d0491159591e310eac185b45db84d79c13196541f071da08b7e1779caae67338f0a7fcd5160cd72f445b69aa407dbb7e840bb7f96228ddd41a00b7955358c954b02d777a6afbf2e5cb8d4e488a3ea8dfbf7f310453c3438a647d06206469837700d76b112363117fffe2836cc4658adbed215eb35793626b331e686f578e8683a5c4494610ddeba8cf1b0246d3f4f9e7f0f397d12d9f319a49c156c5914722b85a71a29e1d5cfed5d8e39ed1b7dadb13bf8c2d847795af9386862264d86905f1036b8800fde77ad130bbfb0ae5e73d93fcd683b5252b9848b6171e1555a72f792989a56cba5b292f5258d945760f69aac6deda3175098074f31173caa8fe6ac2dfb8d08dde6962d8698d5181188c0e7c0c86485ad5323567ca9dd6d3532024adee8cb2f602315a8172abc5f2ffb9edf2ea0f14abe5c373b2e1de57cc27e45bced6188d70248acbcabd725ff6c07d0a9deea84ef802846d57768b502b373ba9a844caca12db8ca711ec2936467842ba9a2f90aada424a17eabe117c84b3a2c82c28c3643319aad074ccce89566e15970d9a373059c6826a5117366963621198a95434549bbb669022217def6537e2967e6da8260e0cdfb5126d92c30d43aba3d301b6f8624f2583e079ecf5f70dbdd8c0eef6e28b551ef0077ccbdcf0693c523e969a0ba0f0682d2893605b2cceae95c76b722ef8638b8e6a34213af37f374b7a7cbd519982b0a392e4d76d316421386643823f122460c4212613939d87877199d6d6b58328a2747017580d1561b6b8b7cc6fe20a809ef900516410b1a048f6dabfb4cefc00440b67aae2c603e3b0a2725054c63a4fd8d0e2ba0eab564dcf07d7a3674115c381dcdc15b5794895d901662ca17b91b1abefdd0a8b37a9e185ffbbabdc2caeb4bac3756bc5822abb9ea6501ef305f4ff594b50674b27b9009756f72d62dbcda880c442dcdb43f8b6ff9e72de6512439194e3e82a15bea44944d45858b9cde4c40268af0a4ecc50bd15f9611490d54bf7f26997c6f2b06efcd0846a7c27b289da2b452b03ab2b26bfe1d3be51a113a9124bd00032a249a235b84de96b50a16ce87f4597e9b1ff694a6c49e3b4b429cbe89f51a0d253a363eea6c04fd7a39b7942ea667ba8db9d904344f32a84c4a0807816318c7800c8ff65f58aece9e04b6a93ca7646b5fe3ac3b9773d6a98e1d4f6ee6cee7cb912865ce5996df8a6729b294cc4a0b8c840bada4c441becc087d70fd8e7d1fe38fc295fb6f793328523ea09ee4a3c5e2a33a9a25d4a34e695b8e90bea8feb41ea6f1447593a337de3949bda801485ce18f3ab3dda46fe5233c856c7075298d80f8f7cde86d66418cf015f3cbec9c16356c9f3678843e5366d5efd7d412469fb09c3be6f7cde2a316595af6d34538b3b7cc8f76ddcd00ca09f22e6e310d9067ee96d7ab7867176d31919780d39aa3df69ec2890c56e44650cf949ba168d7b6c0a34edb1eb8dc8a216ad2a5ceb312fdca199878f00b33169d7950b98c52cf885059ba7d6a1eb40e14df74c4754075c98df6268ed427366991abc635e1ec37d2ba0cf9a1b0de801857f706e60516382b4c87f2a822fdb1bd6041e765bc21d58d2df68d61e816bbde1a26dc2e8f305ca768defa7a8f51f2816b932317cc922640e5a1858028c0636182cc9df0793c0354e7be8b535207c66e5078c085c3bdd3fef150aab4abf4f99be577f44f6dd939c0d994f6ba7f0598f4be95b8f93b195727aec3cc1e4753c348dab1ae9a5f78e4c2744428b14d1e34e63b183673b9cd3d238c25d2ce6875522c5d0194accdc2f446973d5aa1f73d68e21d4837cc73331a0adcc6d96fd757bdd85d21455c7ca1269eac56a52271ed487551fd8160618482376b046765a8c2dc6c6722eb3f257d199b921d0cf0adfd82f68d2270bba7504b945326d75a5b67ef471bde01710fa7067c896f2314ad7978deb7f0396535d7d4e3dd3037579290f3aa16b7cef834df82aeeb75cd624752ad21fda7ef1b1198105fba392b25a08ec2e218be174e1b46a52df0c02ddca6561498731da9cd430b95a937d1ba03c8d27553efaa27998ca78d80e2170e4c30707c00b8a2bead782458a1bb6da5d378f13f44aeff414d425293e3a937250b7eee6e538b93e4a5489ac16c9653ea985326f10a2fb34dfec624f41196f061de41477e9e5674455b5e8a04a1c94fe5442021d6297787235882c87fbd0abc33c36d9c22fa1554c8e20df31cfbf5ce0bc9b81d5ecdcd72879548c176a2f439951a1899f1056b3585fd798395c80070dc3e33dec62eb106d5a5993417efe2e93fd83edaeeb94eca5eca8bf799e77637b8ac062d43e4aa0ab88940488e04302d2e33f46bfbca73fad23105a64031e7ddedbccaf6baf142a078d562d11582fcf9d507023a64b7378d2002250d7fe95fb4e88b1303cf4fa8f9a4eea1d78ecff59742941942c706c96bd30cb9797fd82c5d38f70ef4b9b4fac2b0392e0599b0d4c95ec690d1368b2ed0841e72f17aefefb9edc5f0489e5467f8c33430bc19cb80951817eb6dee6c0a90571f78b8e526b848982b37b85a4e375c11308acee4f64073ee9e9c774d4f79242718fc94aa19ad3ac52f46aec95789659aba61a02b36f4ce40eaf3b58032f3cff9fe32adb5e969408d83288ac9bc854f1c8a6888634d31f941e5a4fe15d02205b6da9c572c398113e0fe3e25a72cd825d7334d812146e296d7c4ab486efb73956e28f94a6c34c2e1b2c5977d5289ed4264e35048a9cfb5103e44accf97177c677a7e871eee5d2a346369412720584e93304c77169a2c706355347e0159937e4bda5cdf1638ae25f7ba485a985738fc373c23af11c66523c67b155cea0a423280f8aff7627c103c254ab17086e1dea9395f79fc32cba0d0d409112ee7ac0ae0477e8508c7182c56b1a950b7e50e0424f924630d640e9a4e737ded9d2eda7419242736647b4cc3f167c04d135642c7531f1f6f492e392ee021c10b8dfa9836fc99b38f86f7f1b0a62cfe480d33e6d836ce032c0e4a4fd5f6cc68cf58ccc7c395369ed352000c3f2df406df771ca9b26e4488c8d38e50494977a1e9842d79ef52ea7ebfe3c7d17610c987648ce9931cfb20d40aac0e54f2386b7effe024d72163832c1ef6bcf3c3a80a1cc1e232657aa0b88680a2b299b04d5cb543697e600cfac5365ea55608bc5cddca61e25eaf186f5b60d5674e4a1aac06992ecedbaa3951f8cd3305f5d99569b29f2fa5e3260b17e9e017ac3072cab95f7438626c9753f4a446caed98615a99f280274195e089ca1791b0d5dac090ceecc897b8b8678dad7f6915315f5d6a32a62daeb5576c0d9d0c5d5766476c5d8945c3038d5ca4e9c087f16bac8de3ff225224ad13fd5f9645fc0802431e4125e97ad721962c55050abff366d5f6244248a678408187bfca3d84a150357d6a2c98263e5d6b603788fb2283fcaf02ed717f4697b53a938c6b15f870bff0fec9d289bd5f3bf648874e106fb95f138ed16b3fecb3256c97dc157838dc41a84b312ba85891fba5994ea7976b0a11bbb527fbf952c4fa2d9123dbe3a5411de4716e20c7bfd4fc2754adf1ad178096ef97b7807e91442e529874a84c194e749a28595845bf217562aeb416b226f8e7960ab0552776e0b2bfc612b3fdb950b7d27b92d0f0a34c250b971a6e80f487a6a2b823a68549eed7507e9fc439e0b4d8306d69a9da61f379c247d3ad858b8f33b08f610415d6a47f22dbf9f9658a82c29d4f7c065252e6c22d6d1cfae0c74fe1e7acdfb50c26f286d8496e38e69428ac0af129ba5756cd8ac41aa52d5c2daced30dc3a1b521d735c133b5f19036385bbd4da27dd4be554016cfc51610b829be006243248c40e763eb261b066583c1318fd977cb53b23eade911991a967268c319a88186e9633f39ef159fdfc77d61446866c1b93ad280bc76fef6389b9ec474b3fa1089174993c0504ba54bc39dd4c6bfa7deff817a20ff992798626f366e4d6692e202f8353caa91cb3e3171fa6c4a85f8aa4eb96cecb3bc5e6aed06856756ae3e34be7e3549803e75ae6514f8566af59d3b883301c40b9acf765a163b494eebfebcf0bfcf1e05596c4620bbd0d8a1537e782275fa29dc60d45324e7b231fb1dd1533e98a7c49646500b65bc3b9695a46dcbdbf6ff051b1fb2dd5f8a24dd736df6264976c09474ddc2862e2770ec72e65ae5171936c3d01ae655da4462f05f1957181ac371db24625f4a98428c92119c263905a70d09aae67609b3c356b606df55ed3cf042fa221606f634916550e4bebbba7b935a766cc567c4872a52136c0164a71ba5d7885e18e99a244e73318f5d728f58969ad3ff02e154fc1baaef1cf4583293204089cc1146c4ee305ff2dfdffcedcc0db2091192f7d2342cea25c2c185403647eae943e9dd6b6913e36082a9bad88ba8a519af1319d7ba8423901967cfae2f0dc46a5cd66c57a91158ae9567485974a99c7f6548532851400bcae32d228f31da6b6001a40e8c6f9e6ee57ab2c3c71f5fd5c719a7fd1487099a122e97c6f2c151e6c104d2e131af80a4b56a558e3ff589b0eec89feb9f5c07593303ed881243efed3a9cbe4323e43696252dd02fdac2798ec09f10139aae615ea9a1e8d757e03b4c010e84d56270e84c079e6c57c76687fa4b3d00ae98cf09064db59c230100e41da97e6e030f37241daae08bf28fa82d4f36ecdd8b22bdbc5cd0ca48a5ec5a28cb31209c033319a7f4d662405dce94c84a8402f5a89dc7778f20f013b8cf3a2428027c9c8724040fd14f6369ece86081a0c55279b534d1b67f5cd27cb38a6033a2d1008c97f64e427463dbcbca31f69cd07f6e797bfce4d201d2456077e21e50ba7b6354709283a3fb348b73e28ef30a39e66a1e45fb53af8b019627328711f80e495c05bcbeddca727bf8dff6dd42cb0f39a0ee0c70d904f42249ac5875519f3349921649d6a9c178674908ff835551bb99c8e5b360b474797d910490587ef7495f76083bc316c467133a488e4d4e4a5f98a3ea97c9cdd550711ea04fbace1ff8a2ffc32740dc18fec5522410cd584c037ef317113c6db5541d039d4f6b486591f3ab0722e4d15702da4d84b98cb80c9dd05b32e7dbc8aa07911cfef702b083ece938e93c40b9a86136f572273598b745f135902cbb5b20341cf7037ce03931795ef9c5db6fcebef24291d48bd3e1de7c0a776d6fd22c795ddbc6c4ed46836c9e750d5df097f09d8cb35617e707cd551bdf8fcecb895ee537f647b2e5dfc53e1e69c7d7c922d4ed0e58b953ae709985591471a03dd04e2c7a5c60d3aa315ec95a1ff82e69bdb44e993bec517e910e431415c1c7fea04405b5207ed4125f6440da277f3d4ddbaaf972f53017861464c87da08ac8a017e1aca582ffee10f1196616de585cc6ef66c952abe4f1d05ccc9bab79f9fe8b65624ca001880f54f7079d793f66dc430260d83247038c3f719335aa3229e66bacac285205810f31665bac609f28cda90d821b8e495267350f00517174819111192ee1aabce8183d87828a7dc70a40c995adba5550f88a0b8998c74f3143e98772d58b9f092329853231692fb2de3589da4535017437fbd426ab2788a33f009f7ab122e5f88d80cc41772bdef910c652ffc373d74034db31d33c81958fae03b911b0de44b02b6cdd3eecd6952d4ea16570ecc3eb7d06878cf9f2757a572f13b7b76beaf8b74c549dbd18bc3da0a245adb7c3af134c5ae92ece1f871afaab3a8c45a2ebf23b92fafe3c63c08c697cd1b8c597e97b18e616fa06ab9ac4b90dc5d2775157ec25c42654ab399cd7fecc3d6df8ebfeeaa402edf9cfd38cf855ac74fcedb21906c63a4196930a450249cf0ad4d52fb88ac5de5d56d31aac05c39d26a0590a890799646cad225263ae4402ace5b9d7fcba6dcdbed36025391c2e12a9fd04c4fca0126b2dea757d2fe5f9106456eb8c4e350ed3a5950449c9c05fda7944637366edcbb067107b18d55b447d5ebc63e96b8fe5a4170f4f1e1fe92b0317b4cae7d6ae8d867c766c9a63910b3222d25b06ef3efd696c0f1a946dcb3792844304da22c60f124dc5438424ef7afced05bf3409c9e0b660320a66a5ddf27bb300df6ba2d9095900d641ba287b7a86a2d2838da70e11723d99ac99e16ca51060fbe3730bd488e15a0f60cf8be2b4cceb2cec2fd242ebc154e00419c8112ef2da97f9fa591ab7ca515ff501da952d4b14100ec0c67f42e11f21a0772733532f473e18a86a799e67292e6c451f5be6f78ca1a40a010ebf56ad4f6074305e8fc5863a728aba229148e1ee5f4b02573fe8f054a78b144f9f4339269e138e57e529c51c371d329e7ddf61376753d519e716c50ed99a2e585d783a164c4a8d30df7d80b99ec3e38628471a27d0f280095a0eae6c70f9d827c8fb4015ba7f2d6fc478aab09e158e104008d904f504c94d4f72e37d186de2f9b926337cd007286697900a8816057e73e31d5ef04f4279bd5ec2e4f22e6125194c592bf39f640fcc23d1c1191c468aa933c368b67cc5ba05d1839d1dcdc284fd68cb4ef356f24504366a8358b4ac42791ab88b5ec8cbbee47cd7ee97f223916e2377ef6cab55c2689a46b93dd83ee8dc805f4aa1f19bfde47c98dfd2090d39d50b5b821f7edd634a9b32664d97c71838250757c347319478bb08de272d9e2a630695535f9bc611de5512c0a031342f481ae4f311ed106412ce1dc105e10046c72dc9708d2db71b6cdc99841d624f21ed8d27d8de35cbc10f6f86f43a75aeeddf7c753a5d2758f0404b4db86689995ba470fa9c2d4e69723958b1a39f9e10b3a496f546c2b4966b6a31c918b2e36d4e0abf5b600ad28029787c89663ff0d1f58733c1f2f57346d4a6d03fbde10f930ca7d5a6a927ac47afd4d04a8ceb20cfec0364fd4fdc126af2732f7a4cedb1d8a2ed400b4b40ab387b552ea32629595604397eaf46d914d1ed8d4de019cbc5c7bded8f101c77a57ef442fe5d2398adef697ec08eeeb594327bc2bd2beec4c97917756f8236ac34385e44a40eb269c5e736be946ed1f0bba1723f3e00630285d1cc06dbd82810287fda76cc358c8fb1a8bd85b8131bf9804cb0221a903412b150348d80fd0e7711868127eaba79d811cb54ce8012404828d43191ac8238e1ca67676adc9e518252281294a504ce3606a9cd01d78c561a9c221807ca641dd59df9ce685f00d74f0f57d778817f6ef4f7cff47c273b472471e32b60e20a5ca46f2047ed06502918867473f86116d96c0a28f485bb3486ac634892deaaeba57330a7701b731ad94fffaad2f92dd0b362d311cd8bc4479edd862293188e06edb05aff0e2703358266ab07baea40cce2a6b57fda8a40ee659bfb16b4c8025caf406a30a0ac6efa6a7c70214c0bbf52f73ad2cc5cbc4b2f48b41cf26e3d33d2b9d989e113f005b6978bfa2923953f50c10329eff35e284c5ac7f51c63c56866980dbed653ec78199ed5293ce425573653c563d1c24c4b78572684998cffe8ba2ef133f307c58383c850ad060898a36505e35da012fc688a495b2be37d87da1834ab51415a756e3305ec228f5adbbdc8d4fdd1e970229c6636851af4469a0b92e4cb6e34e5fdb76257302c8730bb6a8add9c6f7b71081ad1868a5f42fca1aa22f01b55b78311e43e2bbd479ce617462c19a33581555c666518360796c6f13b6241316c426c3d9e29892c1d2bcb2b27c81d98bd14c25f2a9433fe9e711d02d82bb506f7e1550613a1343fee0c9abf86aee362b9602c95b41d76866593a26326cbbea16b670312830cedf6d4c58205b7f849a43ab21d870d38a5a639aa638ef73c0379520ff11c0bb7c8686f560995741f8429d55a6c6a9e7b46cabfc6bfc7ebbb6ea0855ae080c65d297c2beb953d4905c4c94b01c0421b47b541271ee2e86f3cd679f101b828d5518f20d66ad11931ff8d838fbac922c5cc4f1babc020c11acb7c135c2a4afe7333dd6e830cb07f1d79aa2bd26cf5d5ebb3a1aec5f7e9d3045fb79601f0cd5e8decf5f4fcccf19818e95b8e40d6a2b2a321844f41c813accf56262e47d1d740913f532673b5c780b1ac3c6e432c92f6e4381c3e1ac95bf288c2af45fef3256bc6b2fad12a4f438c3f679ca2fc59a3be481def124d02b7124318db4670e9a8aba26d64174de1aec9c15c06a55b4db5396bdb6ff7b6ba2f1fde13900b7b2d5d52d0ed0542f8608e2614d20ef3cfadeb9a2d9596d4497e44f90b1dd2210d5f7fdc12184c7b6b07d4fb672762745ff0f9aab03151024aeb2ecca40442208394305d8b1da36eccfb8585111d0a9d4d74ef2c36262f79d85f7da3eddc5c05f09dd614d345210e5c67aa5eac71915c74d9610440e891942490f9dee36fa98d884c12a4dcb9f2863230e458edd904b52c45810f512085b3621f40eda9588c9ca683fa925271b12e80be829f10420a4a2c725c03b43dba01654fafd0cc951c6adbd99a1332163aef3561284059a0b6e7716ea92df29756dbe56a224beaaebb7e7fff1ea33a4434c16ed1bc1beb7342ef8888df6df595382f3358c9a0183625fc9b5bef1831189aab16690288f1db328ff4437f23aa9077950fe5f4394c180c57b91655781650c1d7fc400f86afec4c2ec14c8777a8ea7108d181d3e0a8cd96a159877a1331ad34027b6a9f49ed734404c7f19534a2b193075cd13f538337b9a6516729ab60d9d0f993e35b72a375ca7fe91f9071d0b3fccd060446c79a10cdf29668e6219ca69b3f5e38b2d77b71ef8f44aef2d07ca67de83e86df5525f3116b28f961d3cacd5779484d52d45d1a31ad3a0f2706835e1d93d7c10333d22386ee9fe9bee1300a28e9187f8e26e0165e50066f1c19f665fc5c6f9ab8a47b9299c143adb7e2879a1a7a740a388cad993e7a197332c22d546502889bb90566af26b7e6e1799bca849aa7ab8dea844c7c0059593226242c58a62e4591d8e5faf5d5f0d4d85fa265ade3a932314f7a801279a71a0f16d218b684ed023b6958bea4668cf9f5a7a9a27c98862d1c101a3bbf3355910fd1b70ec94d522a4e1d2fbf35678dcc282ca2dc33c74c3a124959939d9c4d3796056a48b78f238b21ae33c6f8db9a3a0edd9b3194b590acd8c2ea36a3cdba34df70ff56cf3af01ab31654fd8d8a6777da7ec4f8a2679feb46df9cb662b141f38208bf40ad97c17c707a84664b45a18875e1aec3bc62394582236e642a2825c0a1945f1129d214646611a4218c39136c039a89ca4d7219590bbfe10de0baa155651a009280fec3ac0545382310503b864b1eb719c24a2100de0e170772ab0eaab99d4f774f5ef477cff28f5ab7d06b8c949a3e2579000d506d7d23b7f6428f56c802c2408b40ee1a8c65da0788fef8b2aa0cf9c88e321f951b628d684e2c5bbab19bbd44e83840af2e9ff6e8bc28e9c257ee8471103523f0080e53adbd2b2e5adf60d7f66953ff18dbc3af1d15ec02f38cad92bfe2270d155a6dee59aa16e88715a479909acaba21489af8c9db119d76094d6da8965e9d41968f95ff99cec7d75f0d0cea7cc99e309d79b3b36410bb76e47b799ff8e5867da095b62d0a9f2966fd0255946de3d311405f8f421b77ac611303935115c92323151f5003ea7626b5407085ffd0b0cdf00cbf8b3b4043800828f2826f34859c2414435b0f463915e523f908f64f8426e870c21eb2dfbd458560eb3e9e66c229bb6da88ab3e3e7678363a7c463e66bca0857c567462da9735c19b11006ae7a67b69d81f2a64a5ad00efad3f0072b3a68b8803a7290bf8d56b2eb660fb75cecd80616b794ec69219b0b0f5887f49f8318adfbbe5a9619246991726188731db5bd50f3a1d4e47737fae3604d68e3ea30e49a7d3554f98ab69c01b352e408ade9eee6475fc7ebd3fae2c6be4ae9da12f983497356aa3418b342e82c4bfce7080b8139af0bb5ebf573181eccccd7617b4acdd84982597ac0803a26fb34213e5da4beee644ba3aa2917e545482ed019188825c706262448d9ba7000b577ed8500b9df94bf1d28b1ecfa27dc456988694aaae784932a2b63fa53e95cb06916ea574c2bebb9f64f630e5a1120016a6cfbb99d5f0fd67eeca7cc6ad596dc9aca78bc1c05b436df1af49d44dd168f654b24ce8880d774a5bc25ba9509c21a1cb71a58aa661721315409a2b1fcc87e143e1165449d7fba0bf20da89f0a5ac003ef484a707a49be7338603a597d728beb0f4856fff36627fd2566b4f39f3488540dd9dd7bc3629dd42eec8c0c5df8e84b355ea7362b768877277fa6ead1cd45a81f4dd227c223920f42ca09d37032c09831cf68660a45208882bd7d2dd97b0a375fd1357e7b979a390312f83697a68939a6a4c92e1ccf9617962322803fdc11fd460431b776f172d270ba5784db1b45eda5158d4759fd95e1c6df9f8e313060dadfef9a0b5cde1e98c545132f447dd0f4d6cfa835d276aa698ac863b6b11995e46f747d7a0ebe82a35f0bc09acbaf38f26afade105f7fbc3f9c3411ecc82c149c3528dd27f8c2a3faa65051eee67df051244a0c6b8dabda0916158fc0cf35cbaed01b12f78f2963789962c1391523b4b9e4b2d49bc90a983782c7dc87b94ed9d69c65ebad2c479028701d34b7d506a8fa85c2bfe978aeec02d41d18f79c51c92b4fe34e185986728a70bcf30283b42b0a3e784a1131aea4bcabb2c72a6836c2b9e246352bbd844a8da5c171761259f5fa4920b24ac6eb178e545e7b885c52e6dfd2447f0ead19b30f1df82e98428c7f5b80ae1477ea8e6138a66bf92accb7e9c8f4f14e859b34dc0734ac3fbe4ba8917c993e41cd741654770995fae2ebceb1136060e445a07fe15ecb0537e3d5fcc0f87d3bce7c8925c08b058733efbcd2e87ef65113aab807c87c7b42e18d85eae40279959b3169c8a7ff3ca1da8468347240e3b5774635e8fad689e81269ecc2e2f8106f6fc06d6c238cbb3ff103670486f9b58634c0b9185e88a4f7c6f042256a68f8041f6d27a5d8d8642448a401c96dec384b64660da98f6933d9231cff28b</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      绑定中非常实用的算法应用
    
    </summary>
    
      <category term="CG" scheme="https://blog.l0v0.com/categories/CG/"/>
    
      <category term="Maya" scheme="https://blog.l0v0.com/categories/CG/Maya/"/>
    
      <category term="Rigging" scheme="https://blog.l0v0.com/categories/CG/Maya/Rigging/"/>
    
    
      <category term="ࠀMaya" scheme="https://blog.l0v0.com/tags/%E0%A0%80Maya/"/>
    
  </entry>
  
  <entry>
    <title>Maya 顶点色单通道笔刷</title>
    <link href="https://blog.l0v0.com/posts/1cdbfd5e.html"/>
    <id>https://blog.l0v0.com/posts/1cdbfd5e.html</id>
    <published>2022-08-16T08:11:28.000Z</published>
    <updated>2022-12-14T02:54:16.779Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;上次我们讨论了怎么在 Maya 实现各种笔刷的姿势 <a href="./cacaf61d.html">Maya CurveBrush 笔刷开发</a><br>&emsp;&emsp;趁着最近比较有空，我又捡起了之前想要开发顶点颜色单通道笔刷，<br>&emsp;&emsp;仓库早在 1 年前就创建了，但是并没有好好开发出来。</p></blockquote><p><a href="https://github.com/FXTD-ODYSSEY/Maya-VertexColorPainter">https://github.com/FXTD-ODYSSEY/Maya-VertexColorPainter</a></p><blockquote><p>&emsp;&emsp;关于单通道顶点色笔刷，其实是之前项目组给我提的需求，Maya 官方提供的 <code>Paint Vertex Color Tool</code> 挺好的</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/2b1586377c548119cf7f0ad1e2bb1e1e.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;就是绘制的时候顶点色是混合在一起的。无法实现分通道绘制。<br>&emsp;&emsp;网上也可以找到有不少帖子抱怨 Maya 竟然没有实现这个功能的。</p></blockquote><p><a href="https://polycount.com/discussion/191918/single-channel-vertex-painting-in-maya-2018">https://polycount.com/discussion/191918/single-channel-vertex-painting-in-maya-2018</a><br><a href="https://www.reddit.com/r/Maya/comments/87znt2/paint_on_separate_channels_in_vertex_painting/">https://www.reddit.com/r/Maya/comments/87znt2/paint_on_separate_channels_in_vertex_painting/</a></p><blockquote><p>&emsp;&emsp;我当时做了一些研究，后来因为太忙了，就将需求转交给其他同事负责了。<br>&emsp;&emsp;那个同事解决了需求，只是解决方案比较复杂，需要用 OpenMaya 写一个节点，再加自定义笔刷实现。</p></blockquote><blockquote><p>&emsp;&emsp;经过我上次笔刷的折腾，我在想能否扩展原本 Maya <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=GUID-3DB9DB65-78B6-407B-8CB0-5212217B645F">Paint Vertex Color Tool</a> 的功能</p></blockquote><video src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/demo.mp4" autoplay="autoplay" loop="loop" style="width: 100%; height:100%;"></video><blockquote><p>&emsp;&emsp;上面就是我最终实现的效果，在 Maya 的原生 UI 上进行修改，提供了额外的 UI 配置来进行单通道绘制。</p></blockquote><h2 id="笔刷选型"><a href="#笔刷选型" class="headerlink" title="笔刷选型"></a>笔刷选型</h2><blockquote><p>&emsp;&emsp;<a href="./cacaf61d.html">Maya CurveBrush 笔刷开发</a> 我这篇文章已经覆盖了写笔刷的各种姿势。<br>&emsp;&emsp;用 Maya 开放的 <code>MPxContext</code> 写笔刷实最为自由的，但是很多功能都没有。<br>&emsp;&emsp;使用 Maya 内置的 <code>artisan</code> 笔刷，则已经实现了好多功能。</p></blockquote><ol><li>自带镜像</li><li>笔刷可以自定义笔刷图章实现渐变</li><li>内置序列化功能</li></ol><p><a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=GUID-72D60883-07A4-4536-AE72-226A2AD0845E">artisan painting 扩展官方文档</a></p><blockquote><p>&emsp;&emsp;所以如果不是复杂的笔刷，能用 artisan 就用 artisan 去实现。<br>&emsp;&emsp;只可惜 Maya 没有暴露 artisan 笔刷的 C++ 接口，所以如果用 C++ 开发就只能重新实现一遍 <code>artisan</code> 的功能，比较麻烦。<br>&emsp;&emsp;当然绘制顶点色我直接使用 <code>artAttrPaintVertexCtx</code> 即可。</p></blockquote><h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><h3 id="单通道-color-set-拆分"><a href="#单通道-color-set-拆分" class="headerlink" title="单通道 color set 拆分"></a>单通道 color set 拆分</h3><blockquote><p>&emsp;&emsp;利用 Maya 提供的 <code>ColorSet</code> 功能，将模型的主顶点色分拆成四个通道的 <code>ColorSet</code> ，<br>&emsp;&emsp;我这里就分别命名为 <code>VertexColorR</code> <code>VertexColorG</code> <code>VertexColorB</code> <code>VertexColorA</code><br>&emsp;&emsp;绘制的时候根据选择 UI 的选择激活相应的 <code>ColorSet</code> 。</p></blockquote><blockquote><p>&emsp;&emsp;这一步可以用 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/artAttrPaintVertexCtx.html">artAttrPaintVertexCtx</a> 的 <code>toolOnProc</code> 和 <code>toolOffProc</code> 定义激活和关闭的回调。<br>&emsp;&emsp;激活 context 的时候创建 <code>ColorSet</code> 拆分，退出 Context 的时候删除冗余的 <code>ColorSet</code><br>&emsp;&emsp;这个地方的 <code>toolOnProc</code> <code>toolOffProc</code> 同样只接受 mel 函数，用 Python 解决的方案参考 <a href="./cacaf61d.html">Maya CurveBrush 笔刷开发</a> 这篇文章。</p></blockquote><h3 id="颜色分解"><a href="#颜色分解" class="headerlink" title="颜色分解"></a>颜色分解</h3><blockquote><p>&emsp;&emsp;那么上面拆分 <code>ColorSet</code> 的时候就需要将对应的 MainColorSet 的颜色按通道赋值给对应单通道的 <code>ColorSet</code>.</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pyeml.core <span class="keyword">as</span> pm</span><br><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> OpenMaya</span><br><span class="line">PAINT_CTX = <span class="string">&quot;artAttrColorPerVertexContext&quot;</span></span><br><span class="line">color_set_representation = &#123;</span><br><span class="line">    <span class="string">&quot;R&quot;</span>: <span class="string">&quot;RGB&quot;</span>,</span><br><span class="line">    <span class="string">&quot;G&quot;</span>: <span class="string">&quot;RGB&quot;</span>,</span><br><span class="line">    <span class="string">&quot;B&quot;</span>: <span class="string">&quot;RGB&quot;</span>,</span><br><span class="line">    <span class="string">&quot;A&quot;</span>: <span class="string">&quot;A&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_color_sets</span>(<span class="params">node</span>):</span><br><span class="line">    color_sets = pm.polyColorSet(node, q=<span class="number">1</span>, allColorSets=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> color_sets <span class="keyword">or</span> pm.polyColorSet(node, create=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">filter_color</span>(<span class="params">color, index, source_color=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> index &gt; <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> color</span><br><span class="line">    is_color = <span class="built_in">isinstance</span>(source_color, OpenMaya.MColor)</span><br><span class="line">    color_list = <span class="built_in">list</span>(source_color) <span class="keyword">if</span> is_color <span class="keyword">else</span> [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line">    color_list[index] = color[index]</span><br><span class="line">    <span class="keyword">return</span> OpenMaya.MColor(*color_list)</span><br><span class="line"></span><br><span class="line"><span class="comment"># NOTES(timmyliang): 获取当前正在绘制的节点</span></span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> <span class="built_in">set</span>(pm.artAttrPaintVertexCtx(PAINT_CTX, q=<span class="number">1</span>, pna=<span class="number">1</span>).split()):</span><br><span class="line">    node = pm.PyNode(node)</span><br><span class="line">    node.displayColors.<span class="built_in">set</span>(<span class="number">1</span>)</span><br><span class="line">    color_sets = get_color_sets(node)</span><br><span class="line">    main_color_set = color_sets[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    mesh = node.__apimfn__()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># NOTES(timmyliang): 获取主 color set 顶点色</span></span><br><span class="line">    color_array = OpenMaya.MColorArray()</span><br><span class="line">    mesh.getVertexColors(color_array, main_color_set)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NOTES(timmyliang): 获取顶点序号数组</span></span><br><span class="line">    vtx_array = OpenMaya.MIntArray()</span><br><span class="line">    <span class="keyword">for</span> array_index <span class="keyword">in</span> <span class="built_in">range</span>(color_array.length()):</span><br><span class="line">        vtx_array.append(array_index)</span><br><span class="line"></span><br><span class="line">    final_colors = OpenMaya.MColorArray()</span><br><span class="line">    <span class="keyword">for</span> channel_index, color_channel <span class="keyword">in</span> <span class="built_in">enumerate</span>(cls.CHANNELS):</span><br><span class="line">        <span class="comment"># NOTES(timmyliang): 如果通道 color set 不存在则创建</span></span><br><span class="line">        color_set = <span class="string">&quot;VertexColor&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(color_channel)</span><br><span class="line">        <span class="keyword">if</span> color_set <span class="keyword">not</span> <span class="keyword">in</span> color_sets:</span><br><span class="line">            rpt = color_set_representation.get(color_channel)</span><br><span class="line">            pm.polyColorSet(node, create=<span class="number">1</span>, rpt=rpt, colorSet=color_set)</span><br><span class="line"></span><br><span class="line">        mesh.setCurrentColorSetName(color_set)</span><br><span class="line">        final_colors.clear()</span><br><span class="line">        <span class="keyword">for</span> array_index <span class="keyword">in</span> <span class="built_in">range</span>(color_array.length()):</span><br><span class="line">            full_color = color_array[array_index]</span><br><span class="line">            color = filter_color(full_color, index=channel_index)</span><br><span class="line">            final_colors.append(color)</span><br><span class="line">        <span class="comment"># NOTES(timmyliang): 批量设置顶点色</span></span><br><span class="line">        mesh.setVertexColors(final_colors, vtx_array)</span><br><span class="line">    mesh.setCurrentColorSetName(main_color_set)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;这里利用 pymel 提供的 <code>__apimfn__</code> 直接获取 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_fn_mesh_html">MFnMesh</a> 对象<br>&emsp;&emsp;利用 <code>setVertexColors</code> API 批量设置顶点色，性能比起单点设置要好很多。</p></blockquote><h3 id="单通道-单颜色-绘制"><a href="#单通道-单颜色-绘制" class="headerlink" title="单通道 单颜色 绘制"></a>单通道 单颜色 绘制</h3><blockquote><p>&emsp;&emsp;下一步就是要实现绘制将颜色锁在对应通道上。<br>&emsp;&emsp;比如我在 UI 上设置为值绘制 R 通道的状态，绘制选择的颜色是 白色 [255,255,255]，点击 Viewport 的时候会将颜色过滤成 红色 [255,0,0] ，这样勾选 R 的时候就只会刷出 红色 没有其他颜色。<br>&emsp;&emsp;这里可以监听 Viewport 的 press 和 release 触发，当点击 viewport 的时候根据 UI 勾选的通道过滤 Ctx 颜色配置。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># NOTES(timmyliang): 获取 UI 的颜色和透明值</span></span><br><span class="line">rgb = pm.colorSliderGrp(<span class="string">&quot;colorPerVertexColor&quot;</span>, q=<span class="number">1</span>, rgb=<span class="number">1</span>)</span><br><span class="line">alpha = pm.floatSliderGrp(<span class="string">&quot;colorPerVertexAlpha&quot;</span>, q=<span class="number">1</span>, value=<span class="number">1</span>)</span><br><span class="line">rgb.append(alpha)</span><br><span class="line"><span class="comment"># NOTES(timmyliang): 组装颜色，过滤掉相应的通道。</span></span><br><span class="line"><span class="comment"># 获取 ui 的选项</span></span><br><span class="line">sel = pm.radioButtonGrp(SINGLE_CONTROL, q=<span class="number">1</span>, sl=<span class="number">1</span>)</span><br><span class="line"><span class="comment"># 过滤颜色</span></span><br><span class="line">color = filter_color(rgb, index=sel)</span><br><span class="line">pm.artAttrPaintVertexCtx(PAINT_CTX, e=<span class="number">1</span>, cl4=<span class="built_in">tuple</span>(color))</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;release 的时候恢复之前的 顶点色 颜色配置。</p></blockquote><h3 id="release-通道颜色同步"><a href="#release-通道颜色同步" class="headerlink" title="release 通道颜色同步"></a>release 通道颜色同步</h3><blockquote><p>&emsp;&emsp;最后还需要实现将绘制完的通道同步到其他的 color set 上的功能。<br>&emsp;&emsp;因此 release 触发的时候要判断当前绘制的模式，如果绘制 rgb 就将颜色分解到对应的单通道上。<br>&emsp;&emsp;相反如果是单通道绘制就要将颜色反馈到 rgb 的主 color set 上。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">apply_color_channel</span>(<span class="params">cls</span>):</span><br><span class="line">    index = pm.radioButtonGrp(cls.SINGLE_CONTROL, q=<span class="number">1</span>, sl=<span class="number">1</span>)</span><br><span class="line">    mode = cls.OPTION_ITEMS[index + <span class="number">1</span>]</span><br><span class="line">    is_rgb = mode == <span class="string">&quot;RGB&quot;</span></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> cls.get_paint_nodes():</span><br><span class="line">        dag_path = node.__apimdagpath__()</span><br><span class="line">        mesh = OpenMaya.MFnMesh(dag_path)</span><br><span class="line">        color_sets = cls.get_color_sets(node)</span><br><span class="line">        main_color_set = color_sets[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        current_color_set = mesh.currentColorSetName()</span><br><span class="line"></span><br><span class="line">        main_colors = OpenMaya.MColorArray()</span><br><span class="line">        mesh.getVertexColors(main_colors, main_color_set)</span><br><span class="line">        vtx_array = cls.vertex_color_data[node.fullPathName()]</span><br><span class="line">        final_colors = OpenMaya.MColorArray()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># NOTES(timmyliang): 如果当前绘制为非单通道</span></span><br><span class="line">        <span class="keyword">if</span> is_rgb:</span><br><span class="line">            <span class="comment"># NOTES(timmyliang): 将当前的主颜色 拆分到各个通道上</span></span><br><span class="line">            <span class="keyword">for</span> channel_index, color_channel <span class="keyword">in</span> <span class="built_in">enumerate</span>(cls.CHANNELS):</span><br><span class="line">                final_colors.clear()</span><br><span class="line">                color_set = <span class="string">&quot;VertexColor&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(color_channel)</span><br><span class="line">                mesh.setCurrentColorSetName(color_set)</span><br><span class="line">                <span class="keyword">for</span> vtx_index <span class="keyword">in</span> vtx_array:</span><br><span class="line">                    main_color = main_colors[vtx_index]</span><br><span class="line">                    color = cls.filter_color(main_color, channel_index)</span><br><span class="line">                    final_colors.append(color)</span><br><span class="line">                mesh.setVertexColors(final_colors, vtx_array)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mode_index = cls.OPTION_ITEMS.index(mode) - <span class="number">2</span></span><br><span class="line">            channel_colors = OpenMaya.MColorArray()</span><br><span class="line">            fix_colors = OpenMaya.MColorArray()</span><br><span class="line">            color_set = <span class="string">&quot;VertexColor&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(mode)</span><br><span class="line">            mesh.getVertexColors(channel_colors, color_set)</span><br><span class="line">            <span class="comment"># NOTES(timmyliang): 获取单通道的颜色 回馈到主颜色上</span></span><br><span class="line">            <span class="keyword">for</span> vtx_index <span class="keyword">in</span> vtx_array:</span><br><span class="line">                channel_color = channel_colors[vtx_index]</span><br><span class="line">                main_color = main_colors[vtx_index]</span><br><span class="line">                color = cls.filter_color(channel_color, mode_index, main_color)</span><br><span class="line">                final_colors.append(color)</span><br><span class="line">                fix_color = cls.filter_color(channel_color, mode_index)</span><br><span class="line">                fix_colors.append(fix_color)</span><br><span class="line"></span><br><span class="line">            mesh.setVertexColors(fix_colors, vtx_array)</span><br><span class="line">            mesh.setCurrentColorSetName(main_color_set)</span><br><span class="line">            mesh.setVertexColors(final_colors, vtx_array)</span><br><span class="line"></span><br><span class="line">        mesh.setCurrentColorSetName(current_color_set)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;通过上面的方式就可以每次绘制完之后同步顶点色到对应的 color set 上。</p></blockquote><h2 id="Maya-UI-修改-amp-扩展"><a href="#Maya-UI-修改-amp-扩展" class="headerlink" title="Maya UI 修改 &amp; 扩展"></a>Maya UI 修改 &amp; 扩展</h2><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/dfb9ca62bbf7b8121c65dfb559630a1c.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;Maya 有个非常好的设计是 UI 使用过 mel 脚本组装的，这样不需要编译就可以改动 UI，而且这部分的 mel 脚本都是开源的。<br>&emsp;&emsp;可以很清楚地知道 Maya 是如何组装出相应工具的界面。</p></blockquote><p><code>C:\Program Files\Autodesk\Maya2018\scripts\others\artAttrColorPerVertexProperties.mel</code></p><blockquote><p>&emsp;&emsp;Maya 的颜色笔刷是通过上面路径的 mel 脚本实现的。<br>&emsp;&emsp;这样可以找到对应 UI 的名字</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/e00422a70b50bbc821d9f6f33f5c448c.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;如上图所示，可以找到 <code>artAttrColorChannelChoices</code> 的名字。<br>&emsp;&emsp;然后用 cmds 命令可以对这些 UI 进行二次修改。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line">cmds.radioButtonGrp(<span class="string">&#x27;artAttrColorChannelChoices&#x27;</span>,e=<span class="number">1</span>,gbc=[<span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>])</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/dfb16fc909c3bb878347cf03adda2bf5.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;比如执行上面的代码可以修改相应 UI 的背景颜色。</p></blockquote><hr><blockquote><p>&emsp;&emsp;上面已经展示了如何修改原生的 UI<br>&emsp;&emsp;这些操作需要学习 Mel 的 UI 构建方式，会有点复杂。</p></blockquote><blockquote><p>&emsp;&emsp;不过 Mel 的 example 都有案例，比如这里的UI 使用了 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/columnLayout.html">columnLayout</a><br>&emsp;&emsp;那我可以去到 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/columnLayout.html">columnLayout</a> 的文档运行案例代码进行学习。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/8d91b5c6f91a3098c1bdddfb4dadba3a.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;将代码放到代码编辑器执行。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/38cb3e0d0968119fbcab02762fd3dea9.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;查了一下 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/columnLayout.html">columnLayout</a> 的 API ，发现它竟然没有 insert 功能。<br>&emsp;&emsp;于是我找了一下 Mel Tips大全的网站 <a href="http://ewertb.mayasound.com/mel/mel.php"><strong>MEL How-To</strong></a> (上古网站，但对学习Mel很有帮助)</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/a8b9a2bf48400f9676c23ccfba27949f.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;可以找到一个 <a href="http://ewertb.mayasound.com/mel/mel.022.php">链接</a> 如何实现UI的置顶插入。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/d3657cce79e9589239f71eeb29f6bd58.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;方案一使用 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/frameLayout.html">frameLayout</a> 比较繁琐<br>&emsp;&emsp;方案二则是使用一个新的 Layout 然后将旧 Layout 的 UI 删除掉。<br>&emsp;&emsp;这个方法删除 UI 对我想要的效果并不适用。</p></blockquote><blockquote><p>&emsp;&emsp;不过倒是启发了我，我想到了可以利用 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/columnLayout.html#flagchildArray">childArray</a> 可以拿到 Layout 下所有的 Control 名字。<br>&emsp;&emsp;然后对每个 Control 修改 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/control.html#flagparent">parent</a> 到新的 Layout 上。</p></blockquote><h3 id="使用-cmds-嵌入-UI"><a href="#使用-cmds-嵌入-UI" class="headerlink" title="使用 cmds 嵌入 UI"></a>使用 cmds 嵌入 UI</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line">parent = cmds.radioButtonGrp(<span class="string">&#x27;artAttrColorChannelChoices&#x27;</span>,q=<span class="number">1</span>,parent=<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(parent)</span><br><span class="line"><span class="comment"># ToolSettings|MainToolSettingsLayout|tabLayout1|artAttrColorPerVertex|artCommonOperationFrame|columnLayout1061|columnLayout1065</span></span><br><span class="line">window = cmds.window()</span><br><span class="line">column_layout = cmds.columnLayout()</span><br><span class="line"><span class="keyword">for</span> control <span class="keyword">in</span> cmds.layout(parent,q=<span class="number">1</span>,childArray=<span class="number">1</span>):</span><br><span class="line">    cmds.control(control, e=<span class="number">1</span>, p=column_layout)</span><br><span class="line">    </span><br><span class="line">cmds.showWindow(window)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;上面的想法写成代码如上所示</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/c6d720eec66764ff4d8db70e56721174.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;直接实现了 UI 的乾坤大挪移<br>&emsp;&emsp;只是显示上有些不一样，主要原因是 mel 构建 UI 的时候使用 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/setUITemplate.html">setUITemplate</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line">window = cmds.window()</span><br><span class="line">cmds.setUITemplate(<span class="string">&quot;OptionsTemplate&quot;</span>, pushTemplate=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">column_layout = cmds.columnLayout()</span><br><span class="line">parent = cmds.radioButtonGrp(<span class="string">&#x27;artAttrColorChannelChoices&#x27;</span>,q=<span class="number">1</span>,parent=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> control <span class="keyword">in</span> cmds.layout(parent,q=<span class="number">1</span>,childArray=<span class="number">1</span>):</span><br><span class="line">    cmds.control(control, e=<span class="number">1</span>, p=column_layout)</span><br><span class="line">    </span><br><span class="line">cmds.setUITemplate(popTemplate=<span class="number">1</span>)</span><br><span class="line">cmds.showWindow(window)</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/b84161550157b6f4ff918fa439166f22.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;加上了 <code>OptionsTemplate</code> 之后 UI 的显示就保持一致了<br>&emsp;&emsp;所以在 parent control 的过程中加入自己的 UI ，就可以实现对应位置的嵌入效果。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line">window = cmds.window()</span><br><span class="line">cmds.setUITemplate(<span class="string">&quot;OptionsTemplate&quot;</span>, pushTemplate=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">column_layout = cmds.columnLayout()</span><br><span class="line">parent = cmds.radioButtonGrp(<span class="string">&#x27;artAttrColorChannelChoices&#x27;</span>,q=<span class="number">1</span>,parent=<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> control <span class="keyword">in</span> cmds.layout(parent,q=<span class="number">1</span>,childArray=<span class="number">1</span>):</span><br><span class="line">    cmds.control(control, e=<span class="number">1</span>, p=column_layout)</span><br><span class="line">    <span class="keyword">if</span> control == <span class="string">&quot;artAttrColorChannelChoices&quot;</span>:</span><br><span class="line">        cmds.button(label=<span class="string">&quot;click me&quot;</span>)</span><br><span class="line">    </span><br><span class="line">cmds.setUITemplate(popTemplate=<span class="number">1</span>)</span><br><span class="line">cmds.showWindow(window)</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/dce4c6b736b41b3a08ad3f20de378342.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;比如上面的效果，如此就可以在相应的位置嵌入任意的 UI</p></blockquote><blockquote><p>&emsp;&emsp;最后是怎么将 UI 嵌入到原本的位置，关键就是使用 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/setParent.html">setParent</a> 命令</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> cmds</span><br><span class="line">parent = cmds.radioButtonGrp(<span class="string">&#x27;artAttrColorChannelChoices&#x27;</span>,q=<span class="number">1</span>,parent=<span class="number">1</span>)</span><br><span class="line">cmds.setParent(parent)</span><br><span class="line">cmds.setUITemplate(<span class="string">&quot;OptionsTemplate&quot;</span>, pushTemplate=<span class="number">1</span>)</span><br><span class="line">column_layout = cmds.columnLayout()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> control <span class="keyword">in</span> cmds.layout(parent,q=<span class="number">1</span>,childArray=<span class="number">1</span>):</span><br><span class="line">    cmds.control(control, e=<span class="number">1</span>, p=column_layout)</span><br><span class="line">    <span class="keyword">if</span> control == <span class="string">&quot;artAttrColorChannelChoices&quot;</span>:</span><br><span class="line">        cmds.button(label=<span class="string">&quot;click me&quot;</span>)</span><br><span class="line">    </span><br><span class="line">cmds.setUITemplate(popTemplate=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/d20d3533d76f1a8f35b804f7f6ba043b.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;如此就可以了， <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/setParent.html">setParent</a> 会将当前 UI 创建设置到之前的 Layout 下。</p></blockquote><h3 id="使用-Qt-嵌入-UI"><a href="#使用-Qt-嵌入-UI" class="headerlink" title="使用 Qt 嵌入 UI"></a>使用 Qt 嵌入 UI</h3><blockquote><p>&emsp;&emsp;既然 cmds 可以实现 UI 嵌入，那能否利用 Qt API 来实现这个效果呢？</p></blockquote><blockquote><p>&emsp;&emsp;我也想过将 Layout 转成 Qt Object 的方式进行调用。<br>&emsp;&emsp;但这个方式获取到的是 QLayout 无法使用 <code>insertWidget</code> 插入，倒是可以使用 <a href="https://doc.qt.io/qtforpython-5/PySide2/QtWidgets/QLayout.html?highlight=indexof#PySide2.QtWidgets.PySide2.QtWidgets.QLayout.addWidget">addWidget</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymel.core <span class="keyword">as</span> pm</span><br><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtWidgets</span><br><span class="line">widget = pm.uitypes.toQtObject(<span class="string">&quot;artAttrColorChannelChoices&quot;</span>)</span><br><span class="line">parent = widget.parent()</span><br><span class="line"><span class="built_in">print</span>(parent.objectName())</span><br><span class="line"><span class="comment"># columnLayout1065 objectName 和 mel 的 controlName 是一样的</span></span><br><span class="line">layout = parent.layout()</span><br><span class="line"><span class="built_in">print</span>(layout)</span><br><span class="line"><span class="comment"># &lt;PySide2.QtWidgets.QLayout object at 0x0000014DB0917648&gt;</span></span><br><span class="line">layout.addWidget(QtWidgets.QPushButton(<span class="string">&quot;asd&quot;</span>))</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/2114ac0e4b10f70c2127952a6bd92b0b.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;利用上面的方式就可以在 Layout 的最末端添加一个按钮。<br>&emsp;&emsp;上面使用了 <a href="https://help.autodesk.com/cloudhelp/2019/ENU/Maya-Tech-Docs/PyMel/generated/functions/pymel.core.uitypes/pymel.core.uitypes.toQtObject.html?highlight=toqtobject">toQtObject</a> 的 pymel API<br>&emsp;&emsp;背后调用 OpenMayaUI 库通过 objectName 查找到对应的 Qt 组件，然后 wrapInstance 将组件转换为 QObject 类型。<br>&emsp;&emsp;用 pymel 的方式比较方便。</p></blockquote><blockquote><p>&emsp;&emsp;要实现 insert 的效果可以利用 <code>takeAt</code> API 将 widget 提取出来再放回去。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymel.core <span class="keyword">as</span> pm</span><br><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtWidgets</span><br><span class="line">widget = pm.uitypes.toQtObject(<span class="string">&quot;artAttrColorChannelChoices&quot;</span>)</span><br><span class="line">parent = widget.parent()</span><br><span class="line">layout = parent.layout()</span><br><span class="line">index = layout.indexOf(widget)</span><br><span class="line">widget_list = [layout.takeAt(<span class="number">0</span>).widget() <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(layout.count())]</span><br><span class="line">widget_list.insert(index,QtWidgets.QPushButton(<span class="string">&quot;click me&quot;</span>))</span><br><span class="line"><span class="keyword">for</span> widget <span class="keyword">in</span> widget_list:</span><br><span class="line">    layout.addWidget(widget)</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cdbfd5e/ffd79713320585a38c6f070133ef54c5.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;如上所示，也完全实现了 cmds 库一样的效果，使用 Qt API 就比 cmds 要灵活很多。<br>&emsp;&emsp;可以嵌入 Designer 生成的 Widget 等等。</p></blockquote><blockquote><p>&emsp;&emsp;这里只是展望了一下，我的实现还是基于 cmds 的方式。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>&emsp;&emsp;我的工具已经做成了 Maya 插件，启用按照插件的方式加载即可。</p></blockquote>]]></content>
    
    <summary type="html">
    
      Paint Vertex Color Tool 增强
    
    </summary>
    
      <category term="CG" scheme="https://blog.l0v0.com/categories/CG/"/>
    
      <category term="Maya" scheme="https://blog.l0v0.com/categories/CG/Maya/"/>
    
      <category term="Maya 工具开发" scheme="https://blog.l0v0.com/categories/CG/Maya/Maya-%E5%B7%A5%E5%85%B7%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="ࠀMaya" scheme="https://blog.l0v0.com/tags/%E0%A0%80Maya/"/>
    
      <category term="ࠕPython" scheme="https://blog.l0v0.com/tags/%E0%A0%95Python/"/>
    
  </entry>
  
  <entry>
    <title>Maya CurveBrush 笔刷开发</title>
    <link href="https://blog.l0v0.com/posts/cacaf61d.html"/>
    <id>https://blog.l0v0.com/posts/cacaf61d.html</id>
    <published>2022-08-09T07:01:17.000Z</published>
    <updated>2022-12-14T02:54:16.766Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;最近因为比较特殊的原因，工作上突然闲下来了，于是我就去研究了我们组做的 Maya 毛发工具。<br>&emsp;&emsp;学习一下 Maya 做笔刷有哪些坑。</p></blockquote><blockquote><p>&emsp;&emsp;这次我的主要目的是模仿 <code>XGen</code> 的毛发笔刷效果，通过最小案例的实现，探讨不同的实现方案。</p></blockquote><video src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/xgen_brush.mp4" autoplay="autoplay" loop="loop" style="width: 100%; height:100%;"></video><p>官方文档: <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=GUID-496603B0-F929-45CD-B607-1CFCD3283DBE">XGen Interactive Grooming</a></p><blockquote><p>&emsp;&emsp;上面的视频就是 XGen 实现的笔刷效果，对于毛发制作非常丝滑好用。<br>&emsp;&emsp;只可惜这个笔刷不能对曲线直接生效。</p></blockquote><video src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/curve_brush.mp4" autoplay="autoplay" loop="loop" style="width: 100%; height:100%;"></video><blockquote><p>&emsp;&emsp;上面是我用 C++ 写的曲线笔刷，下面我也会来探讨如何用 Python OpenMaya 结合 Qt 开发笔刷的流程。<br>&emsp;&emsp;具体代码已经开源到 <a href="https://github.com/FXTD-ODYSSEY/Maya-CurveBrush">https://github.com/FXTD-ODYSSEY/Maya-CurveBrush</a><br>&emsp;&emsp;C++ 插件提供了 2020 - 2023 支持<br>&emsp;&emsp;Python 插件有 <code>om1_curve_brush.py</code> 和 <code>om2_curve_brush.py</code></p></blockquote><h2 id="Maya-C-笔刷开发流程"><a href="#Maya-C-笔刷开发流程" class="headerlink" title="Maya C++ 笔刷开发流程"></a>Maya C++ 笔刷开发流程</h2><h3 id="Maya-C-MPxContext"><a href="#Maya-C-MPxContext" class="headerlink" title="Maya C++ MPxContext"></a>Maya C++ MPxContext</h3><blockquote><p>&emsp;&emsp;什么是 Maya Context ？ <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__developer_Maya_SDK_MERGED_Command_plug_ins_Contexts_html">官方文档说明</a><br>&emsp;&emsp;Maya Context 就是一个开放的接口，可以用于自定义 鼠标 在 Viewport 上执行的逻辑，实现 绘制 修改选择物体 等操作。</p></blockquote><p><a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__developer_Maya_SDK_MERGED_Command_plug_ins_MPxContext_html">MPxContext 官方文档</a></p><blockquote><p>&emsp;&emsp;上面的链接是一个 Maya Devkit 里面的案例 <code>devkit\plug-ins\marqueeTool\marqueeTool.cpp</code><br>&emsp;&emsp;<a href="./5875a169.html">Maya CMake 构建 C++ 插件编译环境</a> 我的这篇文章有提到如何将 devkit 的源码编译生成 mll </p></blockquote><p><a href="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/marqueeTool.mll">maya2020 - marqueeTool.mll</a></p><blockquote><p>&emsp;&emsp;这里提供 Maya2020 windows 版本的 mll 插件<br>&emsp;&emsp;Maya 加载 mll 插件</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.cmds <span class="keyword">as</span> cmds</span><br><span class="line">ctx = cmds.marqueeToolContext()</span><br><span class="line">cmds.setToolTo(ctx)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;加载mll 插件后，可以使用上面的代码激活 Context</p></blockquote><video src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/marqueeTool.mp4" autoplay="autoplay" loop="loop" style="width: 100%; height:100%;"></video><blockquote><p>&emsp;&emsp;上面实现的效果和默认的 框选物体是一样的。<br>&emsp;&emsp;只是框的颜色变成了自定义的 黄色。</p></blockquote><hr><blockquote><p>&emsp;&emsp;实现这个 context 需要继承实现两个类，一个是 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_px_context_html">MPxContext</a> 另一个是 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_px_context_command_html">MPxContextCommand</a><br>&emsp;&emsp;<a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_px_context_html">MPxContext</a> 类定义了鼠标拖拽 移动 等逻辑的虚函数，<a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_px_context_command_html">MPxContextCommand</a> 则是用来读取 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_px_context_html">MPxContext</a> 数据的 Mel 命令。<br>&emsp;&emsp;通过 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_px_context_command_html">MPxContextCommand</a> 就可以用 Mel 命令来修改 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_px_context_html">MPxContext</a> 的变量(比如笔刷大小之类的)</p></blockquote><p><a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__developer_Maya_SDK_MERGED_Command_plug_ins_MPxContextCommand_html">MPxContextCommand 官方文档</a></p><h3 id="Maya-C-MPxToolCommand"><a href="#Maya-C-MPxToolCommand" class="headerlink" title="Maya C++ MPxToolCommand"></a>Maya C++ MPxToolCommand</h3><p><a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__developer_Maya_SDK_MERGED_Command_plug_ins_MPxToolCommand_html">MPxToolCommand 官方文档</a></p><blockquote><p>&emsp;&emsp;上面提到的方案 Context 进行处理的时候是没有 Undo 功能的。<br>&emsp;&emsp;因此 Maya C++ 提供了 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_px_tool_command_html">MPxToolCommand</a> 这样将需要 undo 的逻辑放到 Command 当中实现，就可以 undo redo 操作了。<br>&emsp;&emsp;上面文档的案例来自于 <code>devkit\plug-ins\helixTool\helixTool.cpp</code></p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/29da80e2a9a4b9a1513eb82a93e5ec30.jpeg" alt="image"><br><a href="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/helixTool.mll">maya2020 - helixTool.mll</a></p><blockquote><p>&emsp;&emsp;这里照样提供 Maya2020 windows 版本的 mll 插件<br>&emsp;&emsp;Maya 加载 mll 插件</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.cmds <span class="keyword">as</span> cmds</span><br><span class="line">ctx = cmds.helixToolContext()</span><br><span class="line">cmds.setToolTo(ctx)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;加载mll 插件后，可以使用上面的代码激活 Context</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/4bb07f53fb16d1d0b3afe0449630340c.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;<strong>需要注意这个插件只能在旧的 Viewport 生效</strong> (我测了好久才明白过来)</p></blockquote><video src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/helixTool.mp4" autoplay="autoplay" loop="loop" style="width: 100%; height:100%;"></video><blockquote><p>&emsp;&emsp;这个工具可以在 Maya Viewport 拖拽一个 圆柱预览 ，这个圆柱最后生成 螺旋线。<br>&emsp;&emsp;通过 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_px_tool_command_html">MPxToolCommand</a> 的方式就可以让生成的 螺旋线 支持undo。</p></blockquote><hr><blockquote><p>&emsp;&emsp;为何这个工具不能在 viewport2.0 下使用</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/581b6161891458d2098e7e062cd62bf2.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;从上面的 API 列表可以看到 <code>doDrag</code> <code>doPress</code> 好几个 API 都有两个实现。<br>&emsp;&emsp;一个是只传入 event 的，这个方法只在 老 Viewport 下调用。<br>&emsp;&emsp;Viewport2.0 调用的是传入 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_h_w_render_1_1_m_u_i_draw_manager_html">MUIDrawManager</a> 的方法。<br>&emsp;&emsp;<a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_helix_tool_2helix_tool_8cpp_example_html">helixTool</a> 没有实现 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_h_w_render_1_1_m_u_i_draw_manager_html">MUIDrawManager</a> 的方法，所以 Viewport2.0 下不起作用。</p></blockquote><p><a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__developer_Maya_SDK_MERGED_Viewport_2_0_API_Maya_Viewport_2_0_API_Guide_Plug_in_Entry_Points_Tool_Contexts_html">Tool Contexts 官方文档</a></p><blockquote><p>&emsp;&emsp;官方文档被打散到 Viewport2.0 的目录下了，具体的说法可以参照上面</p></blockquote><h3 id="笔刷工具的-UI"><a href="#笔刷工具的-UI" class="headerlink" title="笔刷工具的 UI"></a>笔刷工具的 UI</h3><p><a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__developer_Maya_SDK_MERGED_Command_plug_ins_Tool_property_sheets_html">Tool property sheets 官方文档</a></p><p><code>&lt;&gt;Properties.mel</code> 实现左侧的可修改界面<br><code>&lt;&gt;Values.mel</code> 获取笔刷数值 (更新到界面上)</p><blockquote><p>&emsp;&emsp;Context 激活之后，双击可以看到工具界面</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/5839bf8a5a103ef28fd5ee770f6b67cc.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;这个界面就是遵循上面两个 mel 的方法来实现的。</p></blockquote><hr><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/29da80e2a9a4b9a1513eb82a93e5ec30.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;可以继续参考 helixTool 的源码目录，它提供了 <code>helixProperties.mel</code> 和 <code>helixValues.mel</code> 脚本<br>&emsp;&emsp;那么上面的命名 <code>&lt;&gt;</code> 是怎么决定的，为啥用 <code>helixProperties</code> 而不是 <code>helixToolProperties</code></p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/d9ae6102b9d5478f9956c83a03beb640.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;其实这是 <code>getClassName</code> 决定的。<br>&emsp;&emsp;mel脚本并不是重点，双击 Context 调用的是 <code>helixProperties</code> <code>helixValues</code> 两个 mel 方法，如果找不到才会找同名脚本。</p></blockquote><h3 id="用-Python-生成-Mel-Proc"><a href="#用-Python-生成-Mel-Proc" class="headerlink" title="用 Python 生成 Mel Proc"></a>用 Python 生成 Mel Proc</h3><blockquote><p>&emsp;&emsp;如果要编写自定义的 UI，一定要用 mel 才能编写吗？<br>&emsp;&emsp;能否用 Python 解决问题呢？</p></blockquote><p><a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=GUID-8A96A8DB-FD6F-434F-A878-288DD84E99C7#GUID-8A96A8DB-FD6F-434F-A878-288DD84E99C7__WS73099CC142F48755F2FC9DF120970276F7-BBF">Python function as a MEL procedure 官方文档</a> </p><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/a3e91c75f34ee059bed5905ccd505edb.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;如果嫌弃使用 mel 确实可以参考上面的链接用 Python 创建的 Mel Proc</p></blockquote><p><code>C:\Program Files\Autodesk\Maya2020\Python\Lib\site-packages\maya\mel\melutils.py</code><br>具体的代码实现可以通过上面的路径找到。</p><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/bef869fe72657a593b289fd018356fb2.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;我尝试了一下，默认 <code>returnCmd</code> 是 False 会打开文件窗口生成出 mel 脚本。<br>&emsp;&emsp;可以设置 <code>returnCmd=True</code> 这样就返回 mel 代码了。<br>&emsp;&emsp;后面可以用 <code>mel.eval</code> 来执行返回的代码</p></blockquote><blockquote><p>&emsp;&emsp;就是传入的Python <code>function</code> 如果不在 Python 模块之下会弹出警告</p></blockquote><hr><p><a href="https://help.autodesk.com/cloudhelp/2020/JPN/Maya-Tech-Docs/PyMel/generated/functions/pymel.tools.py2mel/pymel.tools.py2mel.py2melProc.html">py2melProc 文档</a> </p><blockquote><p>&emsp;&emsp;pymel 库也提供了 py2mel 的方法<br>&emsp;&emsp;使用这个方法会比 Maya 内置的处理好一些<br>&emsp;&emsp;实现的原理基本一致，都是通过 Python 构建出 Mel 代码，<br>&emsp;&emsp;Mel 代码本质就是用 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/Commands/python.html">python</a> 关键字执行 Python 代码 (一会 Python 一会 Mel 的似乎挺绕的<em>(:з」∠)</em>)</p></blockquote><blockquote><p>&emsp;&emsp;pymel 还提供了 <code>mel2pyStr</code> 的方法可以直接将 mel 代码转成 Python 的版本。<br>&emsp;&emsp;这样就可以避免 python 和 mel 混写。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymel.tools <span class="keyword">import</span> mel2py</span><br><span class="line">path = <span class="string">r&quot;C:\Program Files\Autodesk\Maya2018\scripts\others\customtoolPaint.mel&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(path,<span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> rf:</span><br><span class="line">    content = rf.read()</span><br><span class="line">py_str = mel2py.mel2pyStr(content, pymelNamespace=<span class="string">&quot;pm&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(py_str)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;比如上面就可以将一些内置的 mel 案例转换成 python 版本。<br>&emsp;&emsp;<code>pymelNamespace</code> 可以给所有的调用加上相应的前缀。</p></blockquote><blockquote><p>&emsp;&emsp;利用上面的方法就可以将 helixTool 的 mel 脚本转为 Python 实现</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/b4775fae8fea92958f3eee9ab6d8ef0d.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;转换完成之后需要注意 function 调用，要将 <code>pm.mel</code> 去掉<br>&emsp;&emsp;因为之前 proc 编程 Python function 用 <code>pm.mel.helixSetCallbacks</code> 是调用不了的。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/09520a8d62d92800c1bd8e8f7dd8b97d.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;另外一些变量名 mel 里面可能命名为了 <code>set</code> ，如果这些是 Python 的关键字或者内置命名需要注意。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pymel.core <span class="keyword">as</span> pm</span><br><span class="line"><span class="keyword">from</span> pymel.tools <span class="keyword">import</span> py2mel</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">helixProperties</span>():</span><br><span class="line">    pm.setUITemplate(<span class="string">&quot;DefaultTemplate&quot;</span>, pushTemplate=<span class="number">1</span>)</span><br><span class="line">    parent = <span class="built_in">str</span>(pm.toolPropertyWindow(q=<span class="number">1</span>, location=<span class="number">1</span>))</span><br><span class="line">    pm.setParent(parent)</span><br><span class="line">    pm.columnLayout(<span class="string">&quot;helix&quot;</span>)</span><br><span class="line">    pm.tabLayout(<span class="string">&quot;helixTabs&quot;</span>, childResizable=<span class="literal">True</span>)</span><br><span class="line">    pm.columnLayout(<span class="string">&quot;helixTab&quot;</span>)</span><br><span class="line">    pm.frameLayout(<span class="string">&quot;helixFrame&quot;</span>, cll=<span class="literal">True</span>, l=<span class="string">&quot;Helix Options&quot;</span>, cl=<span class="literal">False</span>)</span><br><span class="line">    pm.columnLayout(<span class="string">&quot;helixOptions&quot;</span>)</span><br><span class="line">    pm.separator(style=<span class="string">&quot;none&quot;</span>)</span><br><span class="line">    pm.intSliderGrp(</span><br><span class="line">        <span class="string">&quot;numCVs&quot;</span>, field=<span class="number">1</span>, minValue=<span class="number">20</span>, maxValue=<span class="number">100</span>, value=<span class="number">1</span>, label=<span class="string">&quot;Number of CVs&quot;</span></span><br><span class="line">    )</span><br><span class="line">    pm.checkBoxGrp(<span class="string">&quot;upsideDownGrp&quot;</span>, numberOfCheckBoxes=<span class="number">1</span>, l1=<span class="string">&quot; &quot;</span>, label=<span class="string">&quot;Upside Down&quot;</span>)</span><br><span class="line">    pm.setParent(<span class="string">&quot;..&quot;</span>)</span><br><span class="line">    <span class="comment"># helixOptions</span></span><br><span class="line">    pm.setParent(<span class="string">&quot;..&quot;</span>)</span><br><span class="line">    <span class="comment"># helixFrame</span></span><br><span class="line">    pm.setParent(<span class="string">&quot;..&quot;</span>)</span><br><span class="line">    <span class="comment"># helixTab</span></span><br><span class="line">    pm.setParent(<span class="string">&quot;..&quot;</span>)</span><br><span class="line">    <span class="comment"># helixTabs</span></span><br><span class="line">    pm.setParent(<span class="string">&quot;..&quot;</span>)</span><br><span class="line">    <span class="comment"># helix</span></span><br><span class="line">    <span class="comment"># Name the tabs; -tl does not allow tab labelling upon creation</span></span><br><span class="line">    pm.tabLayout(<span class="string">&quot;helixTabs&quot;</span>, tl=(<span class="string">&quot;helixTab&quot;</span>, <span class="string">&quot;Tool Defaults&quot;</span>), e=<span class="number">1</span>)</span><br><span class="line">    pm.setUITemplate(popTemplate=<span class="number">1</span>)</span><br><span class="line">    helixSetCallbacks(parent)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">helixSetCallbacks</span>(<span class="params">parent</span>):</span><br><span class="line">    pm.setParent(parent)</span><br><span class="line">    pm.checkBoxGrp(</span><br><span class="line">        <span class="string">&quot;upsideDownGrp&quot;</span>,</span><br><span class="line">        e=<span class="number">1</span>,</span><br><span class="line">        on1=<span class="keyword">lambda</span> *args: pm.helixToolContext(pm.currentCtx(), upsideDown=<span class="literal">True</span>, e=<span class="number">1</span>),</span><br><span class="line">        of1=<span class="keyword">lambda</span> *args: pm.helixToolContext(pm.currentCtx(), upsideDown=<span class="literal">False</span>, e=<span class="number">1</span>),</span><br><span class="line">    )</span><br><span class="line">    pm.intSliderGrp(</span><br><span class="line">        <span class="string">&quot;numCVs&quot;</span>,</span><br><span class="line">        e=<span class="number">1</span>,</span><br><span class="line">        cc=<span class="keyword">lambda</span> *args: pm.helixToolContext(pm.currentCtx(), numCVs=args[<span class="number">0</span>], e=<span class="number">1</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">helixValues</span>(<span class="params">toolName</span>):</span><br><span class="line">    parent=(<span class="built_in">str</span>(pm.toolPropertyWindow(q=<span class="number">1</span>, location=<span class="number">1</span>)) + <span class="string">&quot;|helix|helixTabs|helixTab&quot;</span>)</span><br><span class="line">    pm.setParent(parent)</span><br><span class="line">    icon=<span class="string">&quot;helixTool.xpm&quot;</span></span><br><span class="line">    <span class="built_in">help</span>=<span class="string">&quot;&quot;</span></span><br><span class="line">    pm.mel.toolPropertySetCommon(toolName, icon, <span class="built_in">help</span>)</span><br><span class="line">    pm.frameLayout(<span class="string">&#x27;helixFrame&#x27;</span>, en=<span class="literal">True</span>, e=<span class="number">1</span>, cl=<span class="literal">False</span>)</span><br><span class="line">    helixOptionValues(toolName)</span><br><span class="line">    pm.mel.toolPropertySelect(<span class="string">&#x27;helix&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">helixOptionValues</span>(<span class="params">toolName</span>):</span><br><span class="line">    </span><br><span class="line">    cv_num = <span class="number">0</span></span><br><span class="line">    cv_num=<span class="built_in">int</span>(pm.mel.<span class="built_in">eval</span>(<span class="string">&quot;helixToolContext -q -numCVs &quot;</span> + toolName))</span><br><span class="line">    pm.intSliderGrp(<span class="string">&#x27;numCVs&#x27;</span>, e=<span class="number">1</span>, value=cv_num)</span><br><span class="line">    cv_num=<span class="built_in">int</span>(pm.mel.<span class="built_in">eval</span>(<span class="string">&quot;helixToolContext -q -upsideDown &quot;</span> + toolName))</span><br><span class="line">    <span class="keyword">if</span> cv_num:</span><br><span class="line">        pm.checkBoxGrp(<span class="string">&#x27;upsideDownGrp&#x27;</span>, e=<span class="number">1</span>, value1=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pm.checkBoxGrp(<span class="string">&#x27;upsideDownGrp&#x27;</span>, e=<span class="number">1</span>, value1=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">py2mel.py2melProc(helixProperties, procName=<span class="string">&quot;helixProperties&quot;</span>)</span><br><span class="line">py2mel.py2melProc(helixValues, procName=<span class="string">&quot;helixValues&quot;</span>)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;经过一些修改之后，可以实现用 Python 的方式来编写 Mel Proc。<br>&emsp;&emsp;只是还是需要熟悉一下 mel UI 构建的语法。</p></blockquote><h2 id="Maya-C-CurveBrush"><a href="#Maya-C-CurveBrush" class="headerlink" title="Maya C++ CurveBrush"></a>Maya C++ CurveBrush</h2><blockquote><p>&emsp;&emsp;通过上面一番探讨之后，我们理清楚了做一个笔刷需要什么。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/31a73f4c83ccff69f92bc03bde499e99.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;所以我在 C++ 代码层面拆分三个头文件，分别对应 <code>MPxContext</code> <code>MPxContextCommand</code> <code>MPxContextToolCommand</code> 的实现。<br>&emsp;&emsp;如何开发也可以参考 helixTool 的代码。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/9fff8010770bff57783e3e1fdd93120a.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;注册插件的时候需要同时注册 <code>MPxContextCommand</code> 和 <code>MPxContextToolCommand</code><br>&emsp;&emsp;这样 Maya 就知道这两个命令是关联在一起的， <code>MPxContext</code> 里面调用 <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__py_ref_class_open_maya_u_i_1_1_m_px_context_html#a8e65ca6ff1d97d4b49ac94897462dc72">newToolCommand</a> 方法就可以获取到 <code>MPxContextToolCommand</code></p></blockquote><h3 id="笔刷属性调整"><a href="#笔刷属性调整" class="headerlink" title="笔刷属性调整"></a>笔刷属性调整</h3><blockquote><p>&emsp;&emsp;我先要让笔刷按住 B 键的时候可以实现 大小 调整。<br>&emsp;&emsp;默认 Maya API 没有提供键盘事件的监听。<br>&emsp;&emsp;于是查找官方的案例，找到了 <code>devkit\plug-ins\grabUVMain.cpp</code>   </p></blockquote><p><a href="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/grabUV.mll">maya2020 - grabUV.mll</a></p><blockquote><p>&emsp;&emsp;这里提供 Maya2020 windows 版本的 mll 插件<br>&emsp;&emsp;Maya 加载 mll 插件</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> maya.cmds <span class="keyword">as</span> cmds</span><br><span class="line">ctx = cmds.grabUVContext()</span><br><span class="line">cmds.setToolTo(ctx)</span><br></pre></td></tr></table></figure><video src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/grabUV.mp4" autoplay="autoplay" loop="loop" style="width: 100%; height:100%;"></video><blockquote><p>&emsp;&emsp;这个插件可以按住 B 键调整笔刷的大小。<br>&emsp;&emsp;原理是利用 Qt 的 eventFilter 监听全局的键盘响应，所以编译的 include 路径需要有 Qt 的头文件，默认的 include 路径只有 Qt 头文件压缩包，需要解压缩来索引。</p></blockquote><blockquote><p>&emsp;&emsp;所以我也是用同样的方式监听是否有按 B 键。<br>&emsp;&emsp;左键拖拽调整笔刷大小，中键拖拽调整笔刷强度。</p></blockquote><h3 id="曲线衰变颜色"><a href="#曲线衰变颜色" class="headerlink" title="曲线衰变颜色"></a>曲线衰变颜色</h3><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/63b2f06b1f337413c94aee582df735de.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;笔刷覆盖的范围呈现颜色，这个是用 <code>Viewport2.0</code> 的 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_h_w_render_1_1_m_u_i_draw_manager_html">MUIDrawManager</a> 实现的。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/8917c29ae2838d566878dd7f92c712a3.jpeg" alt="image"><br><a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_h_w_render_1_1_m_u_i_draw_manager_html">MUIDrawManager</a></p><blockquote><p>&emsp;&emsp;<a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_h_w_render_1_1_m_u_i_draw_manager_html">MUIDrawManager</a> 提供了 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_h_w_render_1_1_m_u_i_draw_manager_html#ab7479336abc018548fe68277932d848a">mesh</a> 的 API 进行曲线模型等的绘制。<br>&emsp;&emsp;最重要的第一点是可以传入颜色数组，根据每个点自定义颜色，其他的 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_h_w_render_1_1_m_u_i_draw_manager_html#abe48ac82aa2ede6d0efd3c9cfadb068c">line</a> API 无法实现这个功能</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MStatus <span class="title">curveBrushContext::doPtrMoved</span><span class="params">(MEvent &amp;event, MHWRender::MUIDrawManager &amp;drawMgr, <span class="type">const</span> MHWRender::MFrameContext &amp;context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">short</span> x, y;</span><br><span class="line">    event.<span class="built_in">getPosition</span>(x, y);</span><br><span class="line">    mBrushCenterScreenPoint = <span class="built_in">MPoint</span>(x, y);</span><br><span class="line">    <span class="keyword">auto</span> radius = mBrushConfig.<span class="built_in">size</span>();</span><br><span class="line"></span><br><span class="line">    drawMgr.<span class="built_in">beginDrawable</span>();</span><br><span class="line">    <span class="keyword">if</span> (bFalloffMode)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> index = <span class="number">0</span>; index &lt; objDagPathArray.<span class="built_in">length</span>(); ++index)</span><br><span class="line">        &#123;</span><br><span class="line">            MPointArray pointArray;</span><br><span class="line">            MColorArray colorArray;</span><br><span class="line">            <span class="function">MFnNurbsCurve <span class="title">curveFn</span><span class="params">(objDagPathArray[index])</span></span>;</span><br><span class="line">            <span class="type">unsigned</span> <span class="type">int</span> segmentCount = <span class="number">100</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> pointIndex = <span class="number">0</span>; pointIndex &lt; segmentCount; ++pointIndex)</span><br><span class="line">            &#123;</span><br><span class="line">                MPoint point;</span><br><span class="line">                <span class="keyword">auto</span> param = curveFn.<span class="built_in">findParamFromLength</span>(curveFn.<span class="built_in">length</span>() * pointIndex / segmentCount);</span><br><span class="line">                curveFn.<span class="built_in">getPointAtParam</span>(param, point, MSpace::kWorld);</span><br><span class="line">                pointArray.<span class="built_in">append</span>(point);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// NOTE(timmyliang): draw falloff</span></span><br><span class="line">                <span class="type">short</span> x_pos, y_pos;</span><br><span class="line">                view.<span class="built_in">worldToView</span>(point, x_pos, y_pos);</span><br><span class="line">                <span class="function">MPoint <span class="title">screenPoint</span><span class="params">(x_pos, y_pos)</span></span>;</span><br><span class="line">                <span class="keyword">auto</span> distance = (mBrushCenterScreenPoint - screenPoint).<span class="built_in">length</span>();</span><br><span class="line">                <span class="keyword">auto</span> field = <span class="number">1</span> - distance / radius;</span><br><span class="line">                <span class="comment">// NOTE(timmyliang): transparent</span></span><br><span class="line">                colorArray.<span class="built_in">append</span>(distance &gt; radius ? <span class="built_in">MColor</span>(<span class="number">0.f</span>) : <span class="built_in">MColor</span>(field, field, field));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            drawMgr.<span class="built_in">setLineWidth</span>(<span class="number">12.0f</span>);</span><br><span class="line">            drawMgr.<span class="built_in">mesh</span>(MHWRender::MUIDrawManager::kLineStrip, pointArray, <span class="literal">NULL</span>, &amp;colorArray);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    drawMgr.<span class="built_in">setColor</span>(<span class="built_in">MColor</span>(<span class="number">1.f</span>, <span class="number">1.f</span>, <span class="number">1.f</span>));</span><br><span class="line">    drawMgr.<span class="built_in">setLineWidth</span>(<span class="number">2.0f</span>);</span><br><span class="line">    drawMgr.<span class="built_in">circle2d</span>(mBrushCenterScreenPoint, radius);</span><br><span class="line"></span><br><span class="line">    drawMgr.<span class="built_in">endDrawable</span>();</span><br><span class="line">    <span class="keyword">return</span> MS::kSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;那么问题就变成怎么获取顶点上色了，如果曲线的顶点数量很少就很难有好的显示效果。</p></blockquote><blockquote><p>&emsp;&emsp;因此这里使用 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_fn_nurbs_curve_html#a6fc77e351e95b453079bbad771940d9f">findParamFromLength</a> <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_fn_nurbs_curve_html#ab2f1acb5a0653b12d7430d5786ef2e3e">getPointAtParam</a>  的方式重新采样曲线的顶点。<br>&emsp;&emsp;对采样的顶点再判断一下是否在笔刷的圆圈范围内，范围外的附上透明的颜色，范围内的根据距离附上黑白色。</p></blockquote><h3 id="曲线-CV-移动"><a href="#曲线-CV-移动" class="headerlink" title="曲线 CV 移动"></a>曲线 CV 移动</h3><blockquote><p>&emsp;&emsp;首先要获取 drag 偏移的向量。<br>&emsp;&emsp;通过 <code>doPress</code> 方法可以获取到点击的时候的向量偏移。<br>&emsp;&emsp;再通过 <code>doDrag</code> 获取拖拽的时候鼠标的位置。<br>&emsp;&emsp;两个位置坐标就可以得到偏移的向量。</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MStatus <span class="title">curveBrushContext::doPress</span><span class="params">(MEvent &amp;event, MHWRender::MUIDrawManager &amp;drawMgr, <span class="type">const</span> MHWRender::MFrameContext &amp;context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    view = M3dView::<span class="built_in">active3dView</span>();</span><br><span class="line">    event.<span class="built_in">getPosition</span>(startPosX, startPosY);</span><br><span class="line">    fStartBrushSize = mBrushConfig.<span class="built_in">size</span>();</span><br><span class="line">    fStartBrushStrength = mBrushConfig.<span class="built_in">strength</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> MS::kSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">MStatus <span class="title">curveBrushContext::doDrag</span><span class="params">(MEvent &amp;event, MHWRender::MUIDrawManager &amp;drawMgr, <span class="type">const</span> MHWRender::MFrameContext &amp;context)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    view.<span class="built_in">refresh</span>(<span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="type">short</span> currentPosX, currentPosY;</span><br><span class="line">    event.<span class="built_in">getPosition</span>(currentPosX, currentPosY);</span><br><span class="line">    <span class="keyword">auto</span> currentPos = <span class="built_in">MPoint</span>(currentPosX, currentPosY);</span><br><span class="line"></span><br><span class="line">    <span class="function">MPoint <span class="title">start</span><span class="params">(startPosX, startPosY)</span></span>;</span><br><span class="line">    MVector delta = <span class="built_in">MVector</span>(currentPos - start);</span><br><span class="line"></span><br><span class="line">    drawMgr.<span class="built_in">beginDrawable</span>();</span><br><span class="line">    drawMgr.<span class="built_in">setColor</span>(<span class="built_in">MColor</span>(<span class="number">1.f</span>, <span class="number">1.f</span>, <span class="number">1.f</span>));</span><br><span class="line">    drawMgr.<span class="built_in">setLineWidth</span>(<span class="number">2.0f</span>);</span><br><span class="line">    <span class="comment">// NOTE(timmyliang): hold down `B` key</span></span><br><span class="line">    <span class="keyword">if</span> (eDragMode == kBrushSize)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">float</span> deltaValue;</span><br><span class="line">        <span class="type">char</span> info[<span class="number">64</span>];</span><br><span class="line">        <span class="comment">// NOTES(timmyliang): left mouse for size</span></span><br><span class="line">        <span class="keyword">if</span> (event.<span class="built_in">mouseButton</span>() == MEvent::kLeftMouse)</span><br><span class="line">        &#123;</span><br><span class="line">            deltaValue = delta.x &gt; <span class="number">0</span> ? delta.<span class="built_in">length</span>() : -delta.<span class="built_in">length</span>();</span><br><span class="line">            mBrushConfig.<span class="built_in">setSize</span>(fStartBrushSize + deltaValue);</span><br><span class="line">            <span class="built_in">sprintf</span>(info, <span class="string">&quot;Brush Size: %.2f&quot;</span>, mBrushConfig.<span class="built_in">size</span>());</span><br><span class="line">            drawMgr.<span class="built_in">text2d</span>(currentPos, info);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// NOTES(timmyliang): middle mouse for strength</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (event.<span class="built_in">mouseButton</span>() == MEvent::kMiddleMouse)</span><br><span class="line">        &#123;</span><br><span class="line">            deltaValue = delta.y &gt; <span class="number">0</span> ? delta.<span class="built_in">length</span>() : -delta.<span class="built_in">length</span>();</span><br><span class="line">            mBrushConfig.<span class="built_in">setStrength</span>(fStartBrushStrength + deltaValue);</span><br><span class="line">            <span class="built_in">sprintf</span>(info, <span class="string">&quot;Brush Strength: %.2f&quot;</span>, mBrushConfig.<span class="built_in">strength</span>());</span><br><span class="line">            drawMgr.<span class="built_in">text2d</span>(currentPos, info);</span><br><span class="line">        &#125;</span><br><span class="line">        drawMgr.<span class="built_in">line2d</span>(start, <span class="built_in">MPoint</span>(startPosX, startPosY + mBrushConfig.<span class="built_in">strength</span>() * <span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        MPoint startNearPos, startFarPos, currNearPos, currFarPos;</span><br><span class="line">        view.<span class="built_in">viewToWorld</span>(currentPosX, currentPosY, currNearPos, currFarPos);</span><br><span class="line">        view.<span class="built_in">viewToWorld</span>(startPosX, startPosY, startFarPos, startFarPos);</span><br><span class="line">        <span class="comment">// NOTE(timmyliang): use tool command for undo</span></span><br><span class="line">        curveBrushTool *cmd = (curveBrushTool *)<span class="built_in">newToolCommand</span>();</span><br><span class="line">        cmd-&gt;<span class="built_in">setStrength</span>(mBrushConfig.<span class="built_in">strength</span>());</span><br><span class="line">        cmd-&gt;<span class="built_in">setRadius</span>(mBrushConfig.<span class="built_in">size</span>());</span><br><span class="line">        cmd-&gt;<span class="built_in">setMoveVector</span>((currFarPos - startFarPos).<span class="built_in">normal</span>());</span><br><span class="line">        cmd-&gt;<span class="built_in">setStartPoint</span>(start);</span><br><span class="line">        cmd-&gt;<span class="built_in">setDagPathArray</span>(objDagPathArray);</span><br><span class="line">        cmd-&gt;<span class="built_in">redoIt</span>();</span><br><span class="line">        cmd-&gt;<span class="built_in">finalize</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    drawMgr.<span class="built_in">circle2d</span>(start, mBrushConfig.<span class="built_in">size</span>());</span><br><span class="line">    drawMgr.<span class="built_in">endDrawable</span>();</span><br><span class="line">    <span class="keyword">return</span> MS::kSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;<code>doDrag</code> 还会判断是否按住 <code>B</code> 键，按住的话就调整笔刷的大小。<br>&emsp;&emsp;反之则调用 <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__py_ref_class_open_maya_u_i_1_1_m_px_context_html#a8e65ca6ff1d97d4b49ac94897462dc72">newToolCommand</a>  执行 CV 移动的逻辑</p></blockquote><hr><blockquote><p>&emsp;&emsp;<code>ToolCommand</code> 会获取曲线上 CV 点的位置，将空间坐标转为屏幕坐标。<br>&emsp;&emsp;这样可以判断这些 CV 点是否在笔刷范围内。<br>&emsp;&emsp;如果在范围的 CV 点根据笔刷提供的方向进行偏移。</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MStatus <span class="title">curveBrushTool::redoIt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    MVector offsetVector = moveVector * <span class="number">0.002</span> * strength;</span><br><span class="line">    M3dView view = M3dView::<span class="built_in">active3dView</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// NOTE(timmyliang): move curves cv in radius</span></span><br><span class="line">    <span class="type">short</span> x_pos, y_pos;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> index = <span class="number">0</span>; index &lt; dagPathArray.<span class="built_in">length</span>(); ++index)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">MFnNurbsCurve <span class="title">curveFn</span><span class="params">(dagPathArray[index])</span></span>;</span><br><span class="line">        std::map&lt;<span class="type">int</span>, MVector&gt; offsetMap;</span><br><span class="line">        <span class="keyword">for</span> (MItCurveCV <span class="built_in">cvIter</span>(dagPathArray[index]); !cvIter.<span class="built_in">isDone</span>(); cvIter.<span class="built_in">next</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            MPoint pos = cvIter.<span class="built_in">position</span>(MSpace::kWorld);</span><br><span class="line">            <span class="type">int</span> cvIndex = cvIter.<span class="built_in">index</span>();</span><br><span class="line">            curvePointMap[index][cvIndex] = pos;</span><br><span class="line">            view.<span class="built_in">worldToView</span>(pos, x_pos, y_pos);</span><br><span class="line">            <span class="keyword">if</span> ((startPoint - <span class="built_in">MPoint</span>(x_pos, y_pos)).<span class="built_in">length</span>() &lt; radius)</span><br><span class="line">            &#123;</span><br><span class="line">                offsetMap[cvIndex] = pos + offsetVector;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp;it : offsetMap)</span><br><span class="line">        &#123;</span><br><span class="line">            curveFn.<span class="built_in">setCV</span>(it.first, it.second, MSpace::kWorld);</span><br><span class="line">        &#125;</span><br><span class="line">        curveFn.<span class="built_in">updateCurve</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> MStatus::kSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;通过 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_it_curve_c_v_html">MItCurveCV</a> 遍历曲线上所有的 CV 点。<br>&emsp;&emsp;利用 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_fn_nurbs_curve_html#a48b56f4698e7040883822351234c8c63">setCV</a> 方法可以实现顶点的偏移<br>&emsp;&emsp;C++ 这边我发现不能在 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_it_curve_c_v_html">MItCurveCV</a> 的遍历过程中调用 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_fn_nurbs_curve_html#a48b56f4698e7040883822351234c8c63">setCV</a> ，它会导致遍历中断。<br>&emsp;&emsp;但是用 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_it_curve_c_v_html">MItCurveCV</a> 提供的 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_it_curve_c_v_html#a0cb9d81962afa9947eb5aa0b4465f217">setCVPosition</a> 无法实现位置的刷新。<br>&emsp;&emsp;最后只好将 CV序号 和 位置通过 Map 保存起来，通过 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_fn_nurbs_curve_html#a48b56f4698e7040883822351234c8c63">setCV</a> API 去偏移。</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">MStatus <span class="title">curveBrushTool::undoIt</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// NOTE(timmyliang): reset point position</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp;kv : curvePointMap)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">MFnNurbsCurve <span class="title">curveFn</span><span class="params">(dagPathArray[kv.first])</span></span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> &amp;it : kv.second)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> cvIndex = it.first;</span><br><span class="line">            MPoint pos = it.second;</span><br><span class="line">            curveFn.<span class="built_in">setCV</span>(cvIndex, pos, MSpace::kWorld);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> MStatus::kSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;通过 <code>curvePointMap</code> 变量保存了上一次所有 CV 点的位置，undo 只要遍历这个字典去重置 CV 位置即可。</p></blockquote><h2 id="OpenMaya-2-0-笔刷开发"><a href="#OpenMaya-2-0-笔刷开发" class="headerlink" title="OpenMaya 2.0 笔刷开发"></a>OpenMaya 2.0 笔刷开发</h2><blockquote><p>&emsp;&emsp;既然 C++ 可以开发出如上看到的笔刷，理论上也可以通过 Python OpenMaya 库进行笔刷开发。<br>&emsp;&emsp;但是我发现 OpenMaya 1.0 不支持 Viewport 2.0 的 API，比如上面关键的 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_h_w_render_1_1_m_u_i_draw_manager_html">MUIDrawManager</a><br>&emsp;&emsp;在 OpenMaya1.0 下是不不存在的。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> maya <span class="keyword">import</span> OpenMayaRender</span><br><span class="line">OpenMayaRender.MUIDrawManager </span><br><span class="line"><span class="comment"># Error: AttributeError: file &lt;maya console&gt; line 2: &#x27;module&#x27; object has no attribute &#x27;MUIDrawManager&#x27; # </span></span><br><span class="line"><span class="keyword">from</span> maya.api <span class="keyword">import</span> OpenMayaRender</span><br><span class="line">OpenMayaRender.MUIDrawManager</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;可以看到 OpenMaya 2.0 才有 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__py_ref_class_open_maya_render_1_1_m_u_i_draw_manager_html">MUIDrawManager</a></p></blockquote><p><a href="https://matiascodesal.com/blog/maya-python-api-20-it-ready-yet/">https://matiascodesal.com/blog/maya-python-api-20-it-ready-yet/</a></p><blockquote><p>&emsp;&emsp;以前 18 年的时候还看到有人了文章介绍 OpenMaya 2.0 到底是否可以已经完善了。<br>&emsp;&emsp;OpenMaya 2.0 与 OpenMaya 1.0 相比还缺了挺多的 C++ 类的。<br>&emsp;&emsp;而且 OpenMaya2.0 的案例都有一些代码错误，比如 <code>plug-ins\python\api2\py2LassoTool.py</code> (已经是 2023 的最新版本了)<br>&emsp;&emsp;这实在是令人失望，脚本的第 224 行有明显 <code>true</code> 使用不当，并且 <code>MItCurveCV</code> 这个类 OpenMaya 2.0 不支持的。<br>&emsp;&emsp;我启用这个脚本框选 CV 点直接给我报错<em>(:з」∠)</em><br>&emsp;&emsp;也因为 OpenMaya 2.0 各种不完善， <a href="http://tw.l0v0.com/#%F0%9F%91%A8%E2%80%8D%F0%9F%92%BBmottosso">👨‍💻mottosso</a> 大佬才会做自己的 Pyd wrapper 封装 C++ API <a href="https://github.com/mottosso/cmdc">cmdc</a> ，只是目前的进度还需要更多人加入支持开发。</p></blockquote><hr><blockquote><p>&emsp;&emsp;那是用 OpenMaya 2.0 能否完成我上面的 C++ 曲线笔刷的复刻呢？<br>&emsp;&emsp;我查了一下，发现 Maya 2020 之后添加了 <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__py_ref_class_open_maya_u_i_1_1_m_px_tool_command_html">MPxToolCommand</a> 命令，似乎可以实现和 C++ 一样的 undo 命令。<br>&emsp;&emsp;然而我的实测却让我非常失望。</p></blockquote><p><a href="https://github.com/FXTD-ODYSSEY/Maya-CurveBrush/blob/main/plug-ins/om2_curve_brush.py">https://github.com/FXTD-ODYSSEY/Maya-CurveBrush/blob/main/plug-ins/om2_curve_brush.py</a></p><h3 id="MPxContextCommand-缺失-syntax-parser-方法"><a href="#MPxContextCommand-缺失-syntax-parser-方法" class="headerlink" title="MPxContextCommand 缺失 syntax parser 方法"></a>MPxContextCommand 缺失 syntax parser 方法</h3><blockquote><p>&emsp;&emsp;基于 OpenMaya 2.0 版本的插件我已经写完了，只是被它的不完整气得不轻。<br>&emsp;&emsp;首先 <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__py_ref_class_open_maya_u_i_1_1_m_px_context_command_html">MPxContextCommand</a> 缺失了 <code>syntax</code> <code>parser</code> 方法<br>&emsp;&emsp;即便提供了 <code>doQueryFlags</code> <code>doEditFlags</code> 的 API 但是没法和 C++ 一样进行调用，但是 OpenMaya 1.0 提供了 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_px_context_command_html#a7d98dc216bb8f7089f649230e06f6da9">_syntax</a> <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_px_context_command_html#aa367dd5b853c97af707d0fb44aa37971">_parser</a> 方法给 Python 调用。</p></blockquote><h3 id="registerContextCommand-不支持-MPxToolCommand-注册"><a href="#registerContextCommand-不支持-MPxToolCommand-注册" class="headerlink" title="registerContextCommand 不支持 MPxToolCommand 注册"></a>registerContextCommand 不支持 MPxToolCommand 注册</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">initializePlugin</span>(<span class="params">plugin</span>):</span><br><span class="line">    pluginFn = om.MFnPlugin(plugin)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pluginFn.registerContextCommand(CONTEXT_NAME, CurveBrushContextCmd.creator)</span><br><span class="line">        <span class="comment"># TODO(timmyliang): not support MPxToolCommand registered</span></span><br><span class="line">        <span class="comment"># pluginFn.registerContextCommand(</span></span><br><span class="line">        <span class="comment">#     CONTEXT_NAME,</span></span><br><span class="line">        <span class="comment">#     CurveBrushContextCmd.creator,</span></span><br><span class="line">        <span class="comment">#     CONTEXT_TOOL_NAME,</span></span><br><span class="line">        <span class="comment">#     CurveBrushTool.creator,</span></span><br><span class="line">        <span class="comment">#     CurveBrushTool.newSyntax,</span></span><br><span class="line">        <span class="comment"># )</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sys.stderr.write(<span class="string">&quot;Failed to register command: %s\n&quot;</span> % CONTEXT_NAME)</span><br><span class="line">        <span class="keyword">raise</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;OpenMaya 2.0 终于在 Maya 2020 提供了 <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__py_ref_class_open_maya_u_i_1_1_m_px_tool_command_html">MPxToolCommand</a> 的接口。<br>&emsp;&emsp;但是 <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__py_ref_class_open_maya_u_i_1_1_m_px_tool_command_html">MPxToolCommand</a> 需要通过 <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__py_ref_class_open_maya_1_1_m_fn_plugin_html#af866d7403152d0a96ab838a9dd16d460">registerContextCommand</a> 来注册进去。<br>&emsp;&emsp;但是它目前不支持 5 个参数的调用，导致 <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__py_ref_class_open_maya_u_i_1_1_m_px_tool_command_html">MPxToolCommand</a> 无法注册。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># Error: TypeError: file F:/repo/CMakeMaya/modules/Maya-CurveBrush/plug-ins/om2_curve_brush.py line 448: function takes exactly 2 arguments (5 given) # </span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;注册的时候会提示 <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__py_ref_class_open_maya_1_1_m_fn_plugin_html#af866d7403152d0a96ab838a9dd16d460">registerContextCommand</a> 只接受两个参数。</p></blockquote><h3 id="MPxToolCommand-doFinalize-无法传入参数"><a href="#MPxToolCommand-doFinalize-无法传入参数" class="headerlink" title="MPxToolCommand doFinalize 无法传入参数"></a>MPxToolCommand doFinalize 无法传入参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CurveBrushTool</span>(omui.MPxToolCommand):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">finalize</span>(<span class="params">self</span>):</span><br><span class="line">        command = om.MArgList()</span><br><span class="line">        command.addArg(self.commandString)</span><br><span class="line">        <span class="keyword">for</span> flag, config <span class="keyword">in</span> self.flags_data.items():</span><br><span class="line">            long_flag = config.get(<span class="string">&quot;long&quot;</span>)</span><br><span class="line">            command.addArg(flag)</span><br><span class="line">            command.addArg(<span class="built_in">getattr</span>(self, long_flag[<span class="number">1</span>:]))</span><br><span class="line">        <span class="comment"># TODO(timmyliang): not accept the command argument</span></span><br><span class="line">        <span class="comment"># return self.doFinalize(command)</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;虽然 <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__py_ref_class_open_maya_1_1_m_fn_plugin_html#af866d7403152d0a96ab838a9dd16d460">registerContextCommand</a> 无法注册 <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__py_ref_class_open_maya_u_i_1_1_m_px_tool_command_html">MPxToolCommand</a> 导致 <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__py_ref_class_open_maya_u_i_1_1_m_px_context_html#a8e65ca6ff1d97d4b49ac94897462dc72">newToolCommand</a> 没有正常的返回。<br>&emsp;&emsp;但我可以单独实例化 <code>MPxToolCommand</code> 从而实现 undo<br>&emsp;&emsp;可是还是不行，而且这个坑爹的情况明显是官方的问题。<br>&emsp;&emsp;<a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__py_ref_class_open_maya_u_i_1_1_m_px_tool_command_html#adf6d293860cfea905a954f2931f7c3c5">doFinalize</a> 明明可以接受一个 <code>MArgList</code> 类型的参数，但是这个 Python 函数却不接受任何参数<em>(:з」∠)</em></p></blockquote><h3 id="OpenMaya-2-0-展示"><a href="#OpenMaya-2-0-展示" class="headerlink" title="OpenMaya 2.0 展示"></a>OpenMaya 2.0 展示</h3><video src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/om2.mp4" autoplay="autoplay" loop="loop" style="width: 100%; height:100%;"></video><blockquote><p>&emsp;&emsp;虽然 2.0 有上述的诸多问题，笔刷的基础功能还是可以实现的。<br>&emsp;&emsp;只是 undo 功能解决不了，倒是可以将曲线的 tweak 操作转移到另一个 Command 上从而实现 undo 的。<br>&emsp;&emsp;不过我这里就点到为止，主要踩了 OpenMaya 2.0 的坑，对它好感度降低了不少<em>(:з」∠)</em></p></blockquote><h2 id="Python-Qt-Overlay-实现自定义绘制"><a href="#Python-Qt-Overlay-实现自定义绘制" class="headerlink" title="Python Qt Overlay 实现自定义绘制"></a>Python Qt Overlay 实现自定义绘制</h2><blockquote><p>&emsp;&emsp;上面提到了 OpenMaya 1.0 缺失了 <code>MUIDrawManager</code> 所以无法在 Viewport 2.0 下进行图像绘制。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/581b6161891458d2098e7e062cd62bf2.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;C++ 文档也注明了带 <code>MUIDrawManager</code> 是无法在 Python 下使用的。<br>&emsp;&emsp;我也测试了不传入 <code>MUIDrawManager</code> 的几个方法，他们只能在 Legacy Viewport 下响应触发。</p></blockquote><blockquote><p>&emsp;&emsp;那还有什么方法不用 C++ 也可以实现 Python 的绘制呢？<br>&emsp;&emsp;这就可以参考一个非常棒的 Maya Python 工具 <a href="https://github.com/wiremas/spore">spore</a></p></blockquote><blockquote><p>&emsp;&emsp;spore 也实现了自己的笔刷工具，并且对低版本 Maya 兼容。<br>&emsp;&emsp;它的做法不是通过 Maya API 实现，而是利用 Qt 的 API 进行绘制。<br>&emsp;&emsp;首先对 Maya 的 Viewport 叠加一层透明的 QWidget 层，通过 <a href="https://doc.qt.io/qtforpython-5/PySide2/QtWidgets/QWidget.html?highlight=paintevent#PySide2.QtWidgets.PySide2.QtWidgets.QWidget.paintEvent">paintEvent</a> 的实现，绘制自定义图形叠加到 Viewport 上。</p></blockquote><video src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/om1.mp4" autoplay="autoplay" loop="loop" style="width: 100%; height:100%;"></video><blockquote><p>&emsp;&emsp;实现效果如上图，基本和 Maya API 的绘制效果很接近。</p></blockquote><h3 id="Overlay-组件实现"><a href="#Overlay-组件实现" class="headerlink" title="Overlay 组件实现"></a>Overlay 组件实现</h3><blockquote><p>&emsp;&emsp;组件叠加的方案我之前的文章也有过 <a href="./5905c2c9.html">Unreal Python 路径定位启动器</a><br>&emsp;&emsp;核心思路就是取消 Widget 的边框，忽略输入影响，透明化背景并且永远保持在最前面。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CanvasOverlay</span>(QtWidgets.QWidget):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, context</span>):</span><br><span class="line">        <span class="comment"># type: (CurveBrushContext) -&gt; <span class="literal">None</span></span></span><br><span class="line">        <span class="built_in">super</span>(CanvasOverlay, self).__init__()</span><br><span class="line">        self.setWindowFlags(</span><br><span class="line">            QtCore.Qt.FramelessWindowHint</span><br><span class="line">            | QtCore.Qt.SplashScreen</span><br><span class="line">            | QtCore.Qt.WindowStaysOnTopHint</span><br><span class="line">            | QtCore.Qt.WindowTransparentForInput</span><br><span class="line">        )</span><br><span class="line">        self.setAttribute(QtCore.Qt.WA_TranslucentBackground)</span><br><span class="line">        self.setAttribute(QtCore.Qt.WA_NoSystemBackground)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;这样就是一个无边框透明的窗口，如果不加上颜色用户是无感知的。</p></blockquote><p><a href="https://github.com/wiremas/spore/blob/b1ec511017cc9ba05d9034321369e5e404550232/scripts/ui/canvas.py#L18">spore 参考</a></p><h3 id="多个-Viewport-叠加支持"><a href="#多个-Viewport-叠加支持" class="headerlink" title="多个 Viewport 叠加支持"></a>多个 Viewport 叠加支持</h3><video src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/overlay.mp4" autoplay="autoplay" loop="loop" style="width: 100%; height:100%;"></video><br>注: 这里的 Overlay 加上了大色块方便观察。<br><br>&gt; &emsp;&emsp;我添加了多个 Viewport 的 Overlay 支持，spore 默认是只对笔刷激活时的 Viewport 进行 Overlay 操作。<br>&gt; &emsp;&emsp;如果切换到多视图或者单独的 Viewport 窗口就会让 Overlay 显示不正常。<br><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AppFilter</span>(QtCore.QObject):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, canvas</span>):</span><br><span class="line">        <span class="comment"># type: (CurveBrushContext) -&gt; <span class="literal">None</span></span></span><br><span class="line">        <span class="built_in">super</span>(AppFilter, self).__init__()</span><br><span class="line">        self.canvas = canvas</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">eventFilter</span>(<span class="params">self, receiver, event</span>):</span><br><span class="line">        <span class="keyword">if</span> event.<span class="built_in">type</span>() == QtCore.QEvent.MouseButtonPress:</span><br><span class="line">            widget = QtWidgets.QApplication.widgetAt(QtGui.QCursor.pos())</span><br><span class="line">            panel = <span class="built_in">isinstance</span>(widget, QtCore.QObject) <span class="keyword">and</span> widget.parent()</span><br><span class="line">            name = panel <span class="keyword">and</span> panel.objectName()</span><br><span class="line">            <span class="keyword">if</span> name:</span><br><span class="line">                is_model_editor = cmds.objectTypeUI(name, i=<span class="string">&quot;modelEditor&quot;</span>)</span><br><span class="line">                self.canvas.setVisible(is_model_editor)</span><br><span class="line">                <span class="keyword">if</span> is_model_editor:</span><br><span class="line">                    QtCore.QTimer.singleShot(<span class="number">0</span>, self.canvas.setup_active_viewport)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(AppFilter, self).eventFilter(receiver, event)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CurveBrushContext</span>(OpenMayaMPx.MPxContext):</span><br><span class="line">    <span class="comment"># 省略 ...</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">toolOnSetup</span>(<span class="params">self</span>):</span><br><span class="line">        self.canvas = CanvasOverlay(self)</span><br><span class="line">        <span class="comment"># NOTES(timmyliang): 获取 QApplication 进行监听</span></span><br><span class="line">        app = QtWidgets.QApplication.instance()</span><br><span class="line">        app_filter = AppFilter(self.canvas)</span><br><span class="line">        app.installEventFilter(app_filter)</span><br></pre></td></tr></table></figure><br><br>&gt; &emsp;&emsp;我这里的做法是利用 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_px_context_html#a658f83d3a196c6c8e77e7ed2655eb6d7">toolOnSetup</a> API ，激活笔刷的时候监听 Maya QApplication 全局的点击事件<br>&gt; &emsp;&emsp;如果点击的 Widget 是 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/modelEditor.html">modelEditor</a> 就将 overlay 同步过去。<br>&gt; &emsp;&emsp;Qt 的 objectName 就是 Maya 的 UI control Name ，所以从 <code>objectName()</code> 获取的 API 可以直接用 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/objectTypeUI.html">objectTypeUI</a> 判断类型<br>&gt; &emsp;&emsp;利用这个方法任何 Viewport 点击都可以直接 resize Overlay 上去。<br><br>&gt; &emsp;&emsp;本来不想搞得那么复杂的，但是 Maya 原生的监听方案不起作用 <a href="https://stackoverflow.com/q/60470709">stackoverflow</a><br>&gt; &emsp;&emsp;stackoverflow 的回答是使用 timer 定时触发，也不是很理想，所以还是借助 Qt API 监听鼠标按键的方法最好。<br><br>### 监听 Viewport 事件<br><br>&gt; &emsp;&emsp;正如上面所说的 <code>doDrag</code> <code>doPress</code> 等一系列 API 在 Viewport 2.0 下是失效的。<br>&gt; &emsp;&emsp;通过 Qt 的 <a href="https://doc.qt.io/qtforpython-5/PySide2/QtCore/QObject.html?highlight=installeventfilter#PySide2.QtCore.PySide2.QtCore.QObject.installEventFilter">installEventFilter</a> 可以实现对 Viewport 的事件监听。<br><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> shiboken2</span><br><span class="line"><span class="keyword">import</span> maya.OpenMaya <span class="keyword">as</span> om</span><br><span class="line"><span class="keyword">import</span> maya.OpenMayaUI <span class="keyword">as</span> omui</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PySide2.QtWidgets <span class="keyword">import</span> QWidget</span><br><span class="line"><span class="keyword">from</span> PySide2.QtCore <span class="keyword">import</span> QObject</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">active_view</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot; return the active 3d view &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> omui.M3dView.active3dView()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">active_view_wdg</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot; return the active 3d view wrapped in a QWidget &quot;&quot;&quot;</span></span><br><span class="line">    view = active_view()</span><br><span class="line">    active_view_widget = shiboken2.wrapInstance(long(view.widget()), QWidget)</span><br><span class="line">    <span class="keyword">return</span> active_view_widget</span><br></pre></td></tr></table></figure><br><br><a href="https://github.com/wiremas/spore/blob/b1ec511017cc9ba05d9034321369e5e404550232/scripts/utils/window_utils.py#L15">spore 参考</a><br><br>&gt; &emsp;&emsp;通过 OpenMaya 1.0 的 API 可以获取当前激活的 Viewport QWidget<br>&gt; &emsp;&emsp;拦截这个 Viewport QWidget 的事件可以实现鼠标点击拖拽等等的响应。<br><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MouseFilter</span>(QtCore.QObject):</span><br><span class="line">    wheel = QtCore.Signal(QtCore.QEvent)</span><br><span class="line">    moved = QtCore.Signal(QtCore.QEvent)</span><br><span class="line">    clicked = QtCore.Signal(QtCore.QEvent)</span><br><span class="line">    dragged = QtCore.Signal(QtCore.QEvent)</span><br><span class="line">    released = QtCore.Signal(QtCore.QEvent)</span><br><span class="line">    entered = QtCore.Signal()</span><br><span class="line">    leaved = QtCore.Signal()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">super</span>(MouseFilter, self).__init__(*args, **kwargs)</span><br><span class="line">        self.is_clicked = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">eventFilter</span>(<span class="params">self, receiver, event</span>):</span><br><span class="line">        event_type = event.<span class="built_in">type</span>()</span><br><span class="line">        <span class="keyword">if</span> event_type == QtCore.QEvent.MouseMove:</span><br><span class="line">            self.moved.emit(event)</span><br><span class="line">            <span class="keyword">if</span> self.is_clicked:</span><br><span class="line">                self.dragged.emit(event)</span><br><span class="line">        <span class="keyword">elif</span> (</span><br><span class="line">            event_type == QtCore.QEvent.MouseButtonPress</span><br><span class="line">            <span class="keyword">or</span> event_type == QtCore.QEvent.MouseButtonDblClick</span><br><span class="line">        ):</span><br><span class="line">            self.is_clicked = <span class="literal">True</span></span><br><span class="line">            self.clicked.emit(event)</span><br><span class="line">        <span class="keyword">elif</span> event_type == QtCore.QEvent.MouseButtonRelease:</span><br><span class="line">            self.is_clicked = <span class="literal">False</span></span><br><span class="line">            self.released.emit(event)</span><br><span class="line">        <span class="keyword">elif</span> event_type == QtCore.QEvent.Enter:</span><br><span class="line">            self.entered.emit()</span><br><span class="line">        <span class="keyword">elif</span> event_type == QtCore.QEvent.Leave:</span><br><span class="line">            self.leaved.emit()</span><br><span class="line">        <span class="keyword">elif</span> event_type == QtCore.QEvent.Wheel:</span><br><span class="line">            self.wheel.emit(event)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>(MouseFilter, self).eventFilter(receiver, event)</span><br><span class="line"></span><br><span class="line">viewport = active_view_wdg()</span><br><span class="line">mouse_filter = MouseFilter()</span><br><span class="line">viewport.installEventFilter(mouse_filter)</span><br></pre></td></tr></table></figure><br><br>&gt; &emsp;&emsp;通过上面的方式就可以拦截 viewport 的 event 通过 <code>MouseFilter</code> 的信号槽做相应的触发。<br><br>### 绘制实现<br><br><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/ca328c45d71ebda1041ee55d0eac4a97.jpeg" alt="image"><br><br>&gt; &emsp;&emsp;参考上图可以看到，Qt API 基本上和 Maya API 绘制的效果差不多。<br>&gt; &emsp;&emsp;Maya API 的 <code>MUIDrawManager</code> 提供了 mesh API 来绘制复杂图形。<br>&gt; &emsp;&emsp;Qt API 并没有类似的方法，不过 Qt 也有 <a href="https://doc.qt.io/qtforpython-5/PySide2/QtGui/QGradient.html">QGradient</a><br>&gt; &emsp;&emsp;通过 <a href="https://doc.qt.io/qtforpython-5/PySide2/QtGui/QLinearGradient.html#qlineargradient">QLinearGradient</a> 可以实现上面的效果。<br>&gt; &emsp;&emsp;同样地需要对曲线进行二次采样，提高分段数。<br><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">paintEvent</span>(<span class="params">self, event</span>):</span><br><span class="line">    self.draw_shape(self.create_brush_cricle(), QtCore.Qt.white, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">if</span> self.is_press_B:</span><br><span class="line">        self.draw_shape(self.create_brush_line(), QtCore.Qt.white, <span class="number">2</span>)</span><br><span class="line">    self.draw_text(self._message_info)</span><br><span class="line">    <span class="keyword">for</span> curve, data <span class="keyword">in</span> self.color_data.items():</span><br><span class="line">        self.draw_shape(data.get(<span class="string">&quot;points&quot;</span>), data.get(<span class="string">&quot;colors&quot;</span>), <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>(CanvasOverlay, self).paintEvent(event)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_brush_cricle</span>(<span class="params">self, count=<span class="number">60</span></span>):</span><br><span class="line">    shape = []</span><br><span class="line">    radius = self.radius</span><br><span class="line">    pt = self.start_pos <span class="keyword">if</span> self.is_press_B <span class="keyword">else</span> self.current_pos</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> <span class="built_in">range</span>(count + <span class="number">1</span>):</span><br><span class="line">        theta = math.radians(<span class="number">360</span> * index / count)</span><br><span class="line">        pos_x = pt.x() + radius * math.cos(theta)</span><br><span class="line">        pos_y = pt.y() + radius * math.sin(theta)</span><br><span class="line">        shape.append(QtCore.QPointF(pos_x, pos_y))</span><br><span class="line">    <span class="keyword">return</span> shape</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_brush_line</span>(<span class="params">self</span>):</span><br><span class="line">    shape = []</span><br><span class="line">    start_pt = self.start_pos <span class="keyword">if</span> self.is_press_B <span class="keyword">else</span> self.current_pos</span><br><span class="line">    shape.append(start_pt)</span><br><span class="line">    shape.append(QtCore.QPoint(start_pt.x(), start_pt.y() - self.strength))</span><br><span class="line">    <span class="keyword">return</span> shape</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_shape</span>(<span class="params">self, line_shapes, colors, width=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(line_shapes) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    colors = colors <span class="keyword">or</span> QtCore.Qt.white</span><br><span class="line">    painter = QtGui.QPainter(self)</span><br><span class="line"></span><br><span class="line">    painter.setRenderHint(painter.Antialiasing)</span><br><span class="line">    painter.begin(self)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="built_in">isinstance</span>(colors, Iterable)</span><br><span class="line">        <span class="keyword">and</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(colors, six.string_types)</span><br><span class="line">        <span class="keyword">and</span> <span class="built_in">len</span>(colors) == <span class="built_in">len</span>(line_shapes)</span><br><span class="line">    ):</span><br><span class="line">        <span class="comment"># NOTES(timmyliang): paint falloff</span></span><br><span class="line">        <span class="keyword">for</span> index, point <span class="keyword">in</span> <span class="built_in">enumerate</span>(line_shapes[:-<span class="number">1</span>]):</span><br><span class="line">            start_point = point</span><br><span class="line">            end_point = line_shapes[index + <span class="number">1</span>]</span><br><span class="line">            grandient_color = QtGui.QLinearGradient(start_point, end_point)</span><br><span class="line">            start_color = colors[index]</span><br><span class="line">            end_color = colors[index + <span class="number">1</span>]</span><br><span class="line">            grandient_color.setColorAt(<span class="number">0</span>, start_color)</span><br><span class="line">            grandient_color.setColorAt(<span class="number">1</span>, end_color)</span><br><span class="line">            pen = QtGui.QPen(grandient_color, width)</span><br><span class="line">            pen.setCapStyle(QtCore.Qt.RoundCap)</span><br><span class="line">            pen.setJoinStyle(QtCore.Qt.RoundJoin)</span><br><span class="line">            painter.setPen(pen)</span><br><span class="line">            painter.drawLine(start_point, end_point)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        path = QtGui.QPainterPath()</span><br><span class="line">        path.moveTo(line_shapes[<span class="number">0</span>])</span><br><span class="line">        [path.lineTo(point) <span class="keyword">for</span> point <span class="keyword">in</span> line_shapes]</span><br><span class="line">        color = QtGui.QColor(colors)</span><br><span class="line">        pen = QtGui.QPen(color, width)</span><br><span class="line">        painter.setPen(pen)</span><br><span class="line">        painter.drawPath(path)</span><br><span class="line"></span><br><span class="line">    painter.end()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw_text</span>(<span class="params">self, text, pos=<span class="literal">None</span>, color=QtCore.Qt.white, width=<span class="number">1</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> text:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    painter = QtGui.QPainter(self)</span><br><span class="line">    pen = QtGui.QPen(color, width)</span><br><span class="line">    painter.setPen(pen)</span><br><span class="line">    pos = pos <span class="keyword">or</span> self.current_pos + QtCore.QPoint(<span class="number">10</span>, <span class="number">0</span>)</span><br><span class="line">    painter.drawText(pos, text)</span><br><span class="line">    painter.end()</span><br></pre></td></tr></table></figure><br><br>&gt; &emsp;&emsp;上面是绘制用到的 一些 API<br>&gt; &emsp;&emsp;核心就是 <code>draw_shape</code> 里面如果传入了多个 color ，获取color每个顶点画一条渐变的线<br>&gt; &emsp;&emsp;多条线组合成圆形，由此有了衰变颜色的圆形曲线。<br><br>&gt; &emsp;&emsp;其他的绘制比如 绘制文字，Qt 有 <code>drawText</code> API<br>&gt; &emsp;&emsp;绘制圆圈可以利用 <code>sin</code> <code>cos</code> 数学函数来生成圆形的顶点进行绘制。<br><br><br>### 踩坑注意<br><br>&gt; &emsp;&emsp;<code>QtCore.QPoint</code> 和 <code>OpenMaya.MPoint</code> 两者的 Y 轴坐标起始不一样，所以通过 M3dView 将世界坐标转换为屏幕坐标的时候需要额外的处理。<br><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">world_to_view</span>(<span class="params">position, invertY=<span class="literal">True</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    convert the given 3d position to  2d viewport coordinates</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    view = OpenMayaUI.M3dView.active3dView()</span><br><span class="line">    arg_x = OpenMaya.MScriptUtil(<span class="number">0</span>)</span><br><span class="line">    arg_y = OpenMaya.MScriptUtil(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    arg_x_ptr = arg_x.asShortPtr()</span><br><span class="line">    arg_y_ptr = arg_y.asShortPtr()</span><br><span class="line">    view.worldToView(position, arg_x_ptr, arg_y_ptr)</span><br><span class="line">    x_pos = arg_x.getShort(arg_x_ptr)</span><br><span class="line">    y_pos = arg_y.getShort(arg_y_ptr)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> invertY:</span><br><span class="line">        y_pos = view.portHeight() - y_pos</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (x_pos, y_pos)</span><br></pre></td></tr></table></figure><br><br><a href="https://github.com/wiremas/spore/blob/b1ec511017cc9ba05d9034321369e5e404550232/scripts/utils/window_utils.py#L30">spore 参考</a><br><br>## 基于 draggerContext 笔刷<br><br><a href="https://www.highend3d.com/maya/script/curve-paint-and-tweak-tool-for-maya#google_vignette">Curve paint and tweak tool</a><br><br><br><video src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/ysv.mp4" autoplay="autoplay" loop="loop" style="width: 100%; height:100%;"></video><blockquote><p>&emsp;&emsp;最后在 <a href="https://www.highend3d.com/maya/script/curve-paint-and-tweak-tool-for-maya#google_vignette">highend3d</a> 里面也找到了一个直接 tweak CV 点的方案。<br>&emsp;&emsp;这个方案采用 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/draggerContext.html">draggerContext</a> 实现<br>&emsp;&emsp;<a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/draggerContext.html">draggerContext</a> 的案例就可以实现在 viewport 拖拽的时候实现回调。<br>&emsp;&emsp;<code>highend3d</code> 的 ysd 曲线工具集还结合软选择的范围作为笔刷移动的范围参数，这是非常聪明的做法。<br>&emsp;&emsp;也可以通过这个方式实现拖拽生成一条曲线。<br>&emsp;&emsp;结合 OpenMaya API 可以做更多的事情，比如散布物体等等，用这个的方案比起 从零构建一个 <a href="https://help.autodesk.com/view/MAYAUL/2018/ENU/?guid=__cpp_ref_class_m_px_context_html">MPxContext</a> 要简单许多。</p></blockquote><blockquote><p>&emsp;&emsp;绘制功能还是无法通过 <a href="https://help.autodesk.com/cloudhelp/2018/ENU/Maya-Tech-Docs/CommandsPython/draggerContext.html">draggerContext</a> 解决，不过可以用上面 Qt Overlay 方案来解决。</p></blockquote><h3 id="ysv-工具优化"><a href="#ysv-工具优化" class="headerlink" title="ysv 工具优化"></a>ysv 工具优化</h3><blockquote><p>&emsp;&emsp;从 <code>highend3d</code> 下载的 ysv 曲线工具可以用，但是有几个问题</p><ol><li>直接调用 PySide 导致不兼容</li><li>没有做 Python3 兼容</li><li>部分代码在新版本代码下运行有 BUG</li></ol></blockquote><h4 id="PySide-兼容"><a href="#PySide-兼容" class="headerlink" title="PySide 兼容"></a>PySide 兼容</h4><blockquote><p>&emsp;&emsp;将 PySide 的导入转成 Qt.py 的导入<br>&emsp;&emsp;Qt.py 库的引入则是采用 submodule 的方式放到 scripts 目录下。</p></blockquote><h4 id="Python3-兼容"><a href="#Python3-兼容" class="headerlink" title="Python3 兼容"></a>Python3 兼容</h4><blockquote><p>&emsp;&emsp;Python3 兼容使用 Python内置的 lib2to3 库进行转换 <a href="https://cainiaojiaocheng.com/Python/docs/3.8/library/2to3">参考链接</a></p></blockquote><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mayapy -m lib2to3 -w F:\repo\Maya-CurveBrush\scripts\ysv\ysvView.py</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;通过这个方式就可以自动将所有的 print 括号加上等操作。省去繁琐的人工操作。<br>&emsp;&emsp;我当时是写了一个脚本，批量执行，执行完之后调用 black 和 isort 风格化代码。</p></blockquote><blockquote><p>&emsp;&emsp;生成完之后会将之前的文件加上 <code>.bak</code> 后缀，如果没有问题就可以把 bak 删除。</p></blockquote><h4 id="BUG-修复"><a href="#BUG-修复" class="headerlink" title="BUG 修复"></a>BUG 修复</h4><blockquote><p>&emsp;&emsp;原代码获取当前摄像机是通过下面的方式</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymel.core <span class="keyword">import</span> *</span><br><span class="line">modelEditor(getPanel(wf=<span class="number">1</span>), e=<span class="number">1</span>, nurbsCurves=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;但是如果当前 focus 的 panel 不是 modelEditor 就遭殃了。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pymel.core <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">for</span> mp <span class="keyword">in</span> getPanel(<span class="built_in">type</span>=<span class="string">&quot;modelPanel&quot;</span>):</span><br><span class="line">    <span class="keyword">if</span> modelEditor(mp, q=<span class="number">1</span>, av=<span class="number">1</span>):</span><br><span class="line">        modelEditor(mp, e=<span class="number">1</span>, nurbsCurves=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;所以我把代码改成上面的效果。</p></blockquote><hr><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> crv <span class="keyword">in</span> self.inViewCurves:</span><br><span class="line">    <span class="keyword">for</span> cv <span class="keyword">in</span> [crv.cv[<span class="number">0</span>], crv.cv[-<span class="number">1</span>]]:</span><br><span class="line">        cv = <span class="built_in">str</span>(cv) <span class="comment"># fix add here</span></span><br><span class="line">        setAttr(cv + <span class="string">&quot;.xv&quot;</span>, lock=<span class="number">1</span>)</span><br><span class="line">        setAttr(cv + <span class="string">&quot;.yv&quot;</span>, lock=<span class="number">1</span>)</span><br><span class="line">        setAttr(cv + <span class="string">&quot;.zv&quot;</span>, lock=<span class="number">1</span>)</span><br><span class="line">        </span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;用 pymel 获取 cv 点之后，直接将 <code>NurbsCurveCV</code> 与字符串相加<br>&emsp;&emsp;但是 <code>NurbsCurveCV</code> 有自己的相加逻辑，所以这里需要加上字符串转换可以修复 BUG。</p></blockquote><h2 id="artisan-笔刷"><a href="#artisan-笔刷" class="headerlink" title="artisan 笔刷"></a>artisan 笔刷</h2><blockquote><p>&emsp;&emsp;<a href="./77ed9d8.html">Maya 根据贴图在模型表面散列物体</a> 以前也写过散列物体的文章，不过实现方式是非笔刷的。<br>&emsp;&emsp;利用 artisan 就可以实现笔刷的方式散布物体了。</p></blockquote><p>官方文档: <a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=GUID-72D60883-07A4-4536-AE72-226A2AD0845E">Overview of MEL script painting</a></p><blockquote><p>&emsp;&emsp;官方提到有 <code>spherePaint</code> <code>geometryPaint</code> <code>emitterPaint</code> 几个案例。<br>&emsp;&emsp;具体的代码可以在 mel 脚本库里面找到 eg: <code>C:\Program Files\Autodesk\Maya2018\scripts\others\spherePaint.mel</code><br>&emsp;&emsp;从最简单的 <code>spherePaint</code> 介绍</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/d0c515791bd2c9e96e5347e4cb3865dc.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;在 <code>Modify</code> 页面下找到 <code>Paint Scripts Tool</code> 工具<br>&emsp;&emsp;打开工具属性面板，在 <code>Setup</code> 标签页的 <code>Tool setup cmd</code> 输入 <code>spherePaint</code> 就可以激活笔刷</p></blockquote><video src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/cacaf61d/spherePaint.mp4" autoplay="autoplay" loop="loop" style="width: 100%; height:100%;"></video><blockquote><p>&emsp;&emsp;激活工具之后就可以模型上刷 Sphere</p></blockquote><hr><blockquote><p>&emsp;&emsp;只可惜 artisan 笔刷它不响应 <code>NurbsCurve</code> ，只支持 mesh。<br>&emsp;&emsp;所以无法实现上面探讨的 曲线笔刷 的功能。<br>&emsp;&emsp;artisan 方案更适合颜色绘制或者是物体散布。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>&emsp;&emsp;以上就是我发现的 Maya 笔刷的多种使用姿势。<br>&emsp;&emsp;后面有机会可以再探讨一下 artisan 笔刷的关于顶点色编辑相关的内容。</p></blockquote>]]></content>
    
    <summary type="html">
    
      Maya 笔刷开发的各种姿势汇总
    
    </summary>
    
      <category term="CG" scheme="https://blog.l0v0.com/categories/CG/"/>
    
      <category term="Maya" scheme="https://blog.l0v0.com/categories/CG/Maya/"/>
    
      <category term="C++" scheme="https://blog.l0v0.com/categories/CG/Maya/C/"/>
    
    
      <category term="ࠇCpp" scheme="https://blog.l0v0.com/tags/%E0%A0%87Cpp/"/>
    
      <category term="ࠀMaya" scheme="https://blog.l0v0.com/tags/%E0%A0%80Maya/"/>
    
  </entry>
  
  <entry>
    <title>Unreal C++ 工具开发最小实践</title>
    <link href="https://blog.l0v0.com/posts/cab0d099.html"/>
    <id>https://blog.l0v0.com/posts/cab0d099.html</id>
    <published>2022-07-15T08:00:58.000Z</published>
    <updated>2022-12-14T02:54:16.862Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;Unreal 的学习浩瀚且博杂，有时候一个最小 Demo 就是很好的学习起点。<br>&emsp;&emsp;想起我以前翻阅 UE 的源码一大堆的文件，看得我是无比头疼。<br>&emsp;&emsp;偶然间发现 CSDN YakSue 写了好多篇 Unreal 工具开发的 介绍。<br>&emsp;&emsp;虽然没有配上 Github 链接，但是源码都在文章里面体现了。<br>&emsp;&emsp;对于工具开发的不同模块都大有裨益。<br>&emsp;&emsp;于是我将这些内容整合到一起，并且详细讲解其中实现的核心点。</p></blockquote><h2 id="Custom-Asset"><a href="#Custom-Asset" class="headerlink" title="Custom Asset"></a>Custom Asset</h2><p><a href="https://yaksue.blog.csdn.net/article/details/107646900">https://yaksue.blog.csdn.net/article/details/107646900</a><br><a href="https://github.com/FXTD-ODYSSEY/Unreal-Playground/tree/main/Plugins/Yaksue/TestAssetEditorPlg">https://github.com/FXTD-ODYSSEY/Unreal-Playground/tree/main/Plugins/Yaksue/TestAssetEditorPlg</a></p><blockquote><p>&emsp;&emsp;创建一个自定义的 Asset 需要有三个类</p><ol><li>Asset (UObject)</li><li>AssetFactory (UFactory)</li><li>AssetTypeActions (FAssetTypeActions_Base)</li></ol></blockquote><blockquote><p>&emsp;&emsp;Asset 描述对象本身的数据<br>&emsp;&emsp;AssetFactory 描述如何创建对象<br>&emsp;&emsp;AssetTypeActions 返回对象显示的信息</p></blockquote><blockquote><p>&emsp;&emsp;<code>AssetTypeActions</code> 包含方法 <code>GetName</code> <code>GetTypeColor</code> <code>GetSupportedClass</code> <code>GetCategories</code> 用来描述对应的信息。<br>&emsp;&emsp;<code>GetCategories</code> 会分配 Asset 所属的位置。</p></blockquote><blockquote><p>&emsp;&emsp;这个方式默认打开的窗口是 Details Panel.<br>&emsp;&emsp;如果想要自定义打开的窗口需要添加 <code>FAssetEditorToolkit</code> 类<br>&emsp;&emsp;<code>AssetTypeActions</code> 添加 <code>OpenAssetEditor</code> 方法将 Toolkit 生成并初始化。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FAssetEditorToolkit</span><br><span class="line">  GetToolkitFName</span><br><span class="line">  GetBaseToolkitName</span><br><span class="line">  GetWorldCentricTabPrefix</span><br><span class="line">  GetWorldCentricTabColorScale</span><br><span class="line">  Initialize</span><br><span class="line">  RegisterTabSpawners</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;<code>RegisterTabSpawners</code> 通过这个方法注册生产 Tab 的 ID<br>&emsp;&emsp;后续通过 <code>Initialize</code> 方法调用 AddTab 将 Register 的 Tab 生成。<br>&emsp;&emsp;最后通过 <code>FAssetEditorToolkit::InitAssetEditor</code> 完成 Toolkit 的初始化</p></blockquote><hr><blockquote><p>&emsp;&emsp;如果不想将 Asset 放到 <code>EAssetTypeCategories::Misc</code> 的分类中。<br>&emsp;&emsp;也可以构建一个新的标签附上去。<br>&emsp;&emsp;只是需要将 factory 相关的 <code>GetMenuCategories</code> 放入去掉。<br>&emsp;&emsp;我之前没有去掉，一直很疑惑为啥自定义菜单没有生效。</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">FYaksueTestAssetTypeActions::<span class="built_in">FYaksueTestAssetTypeActions</span>()</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// <span class="doctag">NOTE:</span> 注册新的分类</span></span><br><span class="line">IAssetTools &amp;AssetTools = FModuleManager::<span class="built_in">LoadModuleChecked</span>&lt;FAssetToolsModule&gt;(<span class="string">&quot;AssetTools&quot;</span>).<span class="built_in">Get</span>();</span><br><span class="line">    AssetCategory = AssetTools.<span class="built_in">RegisterAdvancedAssetCategory</span>(<span class="built_in">FName</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;Custom Assets&quot;</span>)), <span class="built_in">LOCTEXT</span>(<span class="string">&quot;CustomAssetCategory&quot;</span>, <span class="string">&quot;Custom Assets&quot;</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">uint32 <span class="title">FYaksueTestAssetTypeActions::GetCategories</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> AssetCategory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;构造函数注册新的分类，头文件需要添加上定义 <code>FYaksueTestAssetTypeActions();</code> <code>EAssetTypeCategories::Type AssetCategory;</code></p></blockquote><h2 id="Custom-Filter"><a href="#Custom-Filter" class="headerlink" title="Custom Filter"></a>Custom Filter</h2><p><a href="https://yaksue.blog.csdn.net/article/details/120929455">https://yaksue.blog.csdn.net/article/details/120929455</a><br><a href="https://github.com/FXTD-ODYSSEY/Unreal-Playground/tree/main/Plugins/Yaksue/TestCustomFilter">https://github.com/FXTD-ODYSSEY/Unreal-Playground/tree/main/Plugins/Yaksue/TestCustomFilter</a></p><blockquote><p>&emsp;&emsp;继承 <code>UContentBrowserFrontEndFilterExtension</code> 可以通过 override <code>AddFrontEndFilterExtensions</code> 方法扩展 filter。<br>&emsp;&emsp;生成一个 <code>FFrontendFilter</code> 子类，然后通过 <code>AddFrontEndFilterExtensions</code> 将过滤对象添加到过滤列表里面。<br>&emsp;&emsp;<code>FFrontendFilter</code> 最核心的方法就是 <code>PassesFilter</code> 它会将每个 item 传到这个函数返回 bool 来决定是否显示。</p></blockquote><!-- TODO PassesFilter item wrong --><h2 id="Slate"><a href="#Slate" class="headerlink" title="Slate"></a>Slate</h2><p><a href="https://yaksue.blog.csdn.net/article/details/110084013">https://yaksue.blog.csdn.net/article/details/110084013</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Put your tab content here!</span></span><br><span class="line"><span class="built_in">SNew</span>(SOverlay)</span><br><span class="line">+ SOverlay::<span class="built_in">Slot</span>()<span class="comment">//底层</span></span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">FillWidth</span>(<span class="number">0.3f</span>)<span class="comment">//占30%</span></span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SButton)<span class="number">1</span></span><br><span class="line">]</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">FillWidth</span>(<span class="number">0.7f</span>)<span class="comment">//占70%</span></span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SVerticalBox)</span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">FillHeight</span>(<span class="number">0.5f</span>)<span class="comment">//占50%</span></span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SButton)</span><br><span class="line">]</span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">FillHeight</span>(<span class="number">0.5f</span>)<span class="comment">//占50%</span></span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SButton)</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">+ SOverlay::<span class="built_in">Slot</span>()<span class="comment">//顶层</span></span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SHorizontalBox)</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">FillWidth</span>(<span class="number">1.0f</span>)<span class="comment">//占满剩余空间</span></span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoWidth</span>()</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SVerticalBox)</span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">FillHeight</span>(<span class="number">1.0f</span>)<span class="comment">//占满剩余空间</span></span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">AutoHeight</span>()</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SBox)</span><br><span class="line">.<span class="built_in">HeightOverride</span>(<span class="number">128</span>)</span><br><span class="line">.<span class="built_in">WidthOverride</span>(<span class="number">128</span>)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(SButton)</span><br><span class="line">]</span><br><span class="line">]</span><br><span class="line">+ SVerticalBox::<span class="built_in">Slot</span>().<span class="built_in">FillHeight</span>(<span class="number">1.0f</span>)<span class="comment">//占满剩余空间</span></span><br><span class="line">]</span><br><span class="line">+ SHorizontalBox::<span class="built_in">Slot</span>().<span class="built_in">FillWidth</span>(<span class="number">1.0f</span>)<span class="comment">//占满剩余空间</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;使用 Unreal Slate 构建窗口，通过代码的属性结构来描述 UI 的构成和配置。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://img-blog.csdnimg.cn/20201124215104568.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTM0MTIzOTE=,size_16,color_FFFFFF,t_70#pic_center" alt="alt"></p><h2 id="DockTab-Layout"><a href="#DockTab-Layout" class="headerlink" title="DockTab Layout"></a>DockTab Layout</h2><p><a href="https://yaksue.blog.csdn.net/article/details/109321869">https://yaksue.blog.csdn.net/article/details/109321869</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTestLayoutWindowModule::StartupModule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">// This code will execute after your module is loaded into memory; the exact timing is specified in the .uplugin file per-module</span></span><br><span class="line"></span><br><span class="line">FTestLayoutWindowStyle::<span class="built_in">Initialize</span>();</span><br><span class="line">FTestLayoutWindowStyle::<span class="built_in">ReloadTextures</span>();</span><br><span class="line"></span><br><span class="line">FTestLayoutWindowCommands::<span class="built_in">Register</span>();</span><br><span class="line"></span><br><span class="line">PluginCommands = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> FUICommandList);</span><br><span class="line"></span><br><span class="line">PluginCommands-&gt;<span class="built_in">MapAction</span>(</span><br><span class="line">FTestLayoutWindowCommands::<span class="built_in">Get</span>().OpenLayoutWindow,</span><br><span class="line">FExecuteAction::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>, &amp;FTestLayoutWindowModule::PluginButtonClicked),</span><br><span class="line"><span class="built_in">FCanExecuteAction</span>());</span><br><span class="line"></span><br><span class="line">FLevelEditorModule&amp; LevelEditorModule = FModuleManager::<span class="built_in">LoadModuleChecked</span>&lt;FLevelEditorModule&gt;(<span class="string">&quot;LevelEditor&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">TSharedPtr&lt;FExtender&gt; MenuExtender = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FExtender</span>());</span><br><span class="line">MenuExtender-&gt;<span class="built_in">AddMenuExtension</span>(<span class="string">&quot;WindowLayout&quot;</span>, EExtensionHook::After, PluginCommands, FMenuExtensionDelegate::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>, &amp;FTestLayoutWindowModule::AddMenuExtension));</span><br><span class="line"></span><br><span class="line">LevelEditorModule.<span class="built_in">GetMenuExtensibilityManager</span>()-&gt;<span class="built_in">AddExtender</span>(MenuExtender);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">TSharedPtr&lt;FExtender&gt; ToolbarExtender = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> FExtender);</span><br><span class="line">ToolbarExtender-&gt;<span class="built_in">AddToolBarExtension</span>(<span class="string">&quot;Settings&quot;</span>, EExtensionHook::After, PluginCommands, FToolBarExtensionDelegate::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>, &amp;FTestLayoutWindowModule::AddToolbarExtension));</span><br><span class="line"></span><br><span class="line">LevelEditorModule.<span class="built_in">GetToolBarExtensibilityManager</span>()-&gt;<span class="built_in">AddExtender</span>(ToolbarExtender);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">FGlobalTabmanager::<span class="built_in">Get</span>()-&gt;<span class="built_in">RegisterNomadTabSpawner</span>(TestLayoutWindowTabName, FOnSpawnTab::<span class="built_in">CreateRaw</span>(<span class="keyword">this</span>, &amp;FTestLayoutWindowModule::OnSpawnPluginTab))</span><br><span class="line">.<span class="built_in">SetDisplayName</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;FTestLayoutWindowTabTitle&quot;</span>, <span class="string">&quot;TestLayoutWindow&quot;</span>))</span><br><span class="line">.<span class="built_in">SetMenuType</span>(ETabSpawnerMenuType::Hidden);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! InnerTab的内容：</span></span><br><span class="line">FGlobalTabmanager::<span class="built_in">Get</span>()-&gt;<span class="built_in">RegisterNomadTabSpawner</span>(InnerTabName, FOnSpawnTab::<span class="built_in">CreateLambda</span>([](<span class="type">const</span> FSpawnTabArgs&amp; SpawnTabArgs)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="built_in">SNew</span>(SDockTab)</span><br><span class="line">.<span class="built_in">TabRole</span>(ETabRole::NomadTab)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock)</span><br><span class="line">.<span class="built_in">Text</span>(FText::<span class="built_in">FromString</span>(<span class="string">&quot;InnerTab&quot;</span>))</span><br><span class="line">];</span><br><span class="line">&#125;))</span><br><span class="line">.<span class="built_in">SetDisplayName</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;InnerTab&quot;</span>, <span class="string">&quot;InnerTab&quot;</span>))</span><br><span class="line">.<span class="built_in">SetMenuType</span>(ETabSpawnerMenuType::Hidden);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! InnerTab2的内容：</span></span><br><span class="line">FGlobalTabmanager::<span class="built_in">Get</span>()-&gt;<span class="built_in">RegisterNomadTabSpawner</span>(InnerTabName2, FOnSpawnTab::<span class="built_in">CreateLambda</span>([](<span class="type">const</span> FSpawnTabArgs&amp; SpawnTabArgs)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="built_in">SNew</span>(SDockTab)</span><br><span class="line">.<span class="built_in">TabRole</span>(ETabRole::NomadTab)</span><br><span class="line">[</span><br><span class="line"><span class="built_in">SNew</span>(STextBlock)</span><br><span class="line">.<span class="built_in">Text</span>(FText::<span class="built_in">FromString</span>(<span class="string">&quot;InnerTab2&quot;</span>))</span><br><span class="line">];</span><br><span class="line">&#125;))</span><br><span class="line">.<span class="built_in">SetDisplayName</span>(<span class="built_in">LOCTEXT</span>(<span class="string">&quot;InnerTab2&quot;</span>, <span class="string">&quot;InnerTab2&quot;</span>))</span><br><span class="line">.<span class="built_in">SetMenuType</span>(ETabSpawnerMenuType::Hidden);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;核心处理是在插件加载的时候 <code>StartupModule</code> 调用 <code>RegisterNomadTabSpawner</code> 注册 Tab</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FTestLayoutWindowModule::PluginButtonClicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">FGlobalTabmanager::<span class="built_in">Get</span>()-&gt;<span class="built_in">InvokeTab</span>(TestLayoutWindowTabName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;点击 GUI 会触发 Tab 生成，调用 <code>OnSpawnPluginTab</code> 方法</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TSharedRef&lt;SDockTab&gt; <span class="title">FTestLayoutWindowModule::OnSpawnPluginTab</span><span class="params">(<span class="type">const</span> FSpawnTabArgs&amp; SpawnTabArgs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">//原来的分页：</span></span><br><span class="line"><span class="type">const</span> TSharedRef&lt;SDockTab&gt; NomadTab = <span class="built_in">SNew</span>(SDockTab)</span><br><span class="line">.<span class="built_in">TabRole</span>(ETabRole::NomadTab);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建TabManager</span></span><br><span class="line"><span class="keyword">if</span> (!TabManager.<span class="built_in">IsValid</span>())</span><br><span class="line">&#123;</span><br><span class="line">TabManager = FGlobalTabmanager::<span class="built_in">Get</span>()-&gt;<span class="built_in">NewTabManager</span>(NomadTab);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建布局：</span></span><br><span class="line"><span class="keyword">if</span> (!TabManagerLayout.<span class="built_in">IsValid</span>())</span><br><span class="line">&#123;</span><br><span class="line">TabManagerLayout = FTabManager::<span class="built_in">NewLayout</span>(<span class="string">&quot;TestLayoutWindow&quot;</span>)</span><br><span class="line">-&gt;<span class="built_in">AddArea</span></span><br><span class="line">(</span><br><span class="line">FTabManager::<span class="built_in">NewPrimaryArea</span>()</span><br><span class="line">-&gt;<span class="built_in">SetOrientation</span>(Orient_Vertical)</span><br><span class="line">-&gt;<span class="built_in">Split</span></span><br><span class="line">(</span><br><span class="line">FTabManager::<span class="built_in">NewStack</span>()</span><br><span class="line">-&gt;<span class="built_in">SetSizeCoefficient</span>(<span class="number">.4</span>f)</span><br><span class="line">-&gt;<span class="built_in">AddTab</span>(InnerTabName, ETabState::OpenedTab)</span><br><span class="line">)</span><br><span class="line">-&gt;<span class="built_in">Split</span></span><br><span class="line">(</span><br><span class="line">FTabManager::<span class="built_in">NewStack</span>()</span><br><span class="line">-&gt;<span class="built_in">SetSizeCoefficient</span>(<span class="number">.4</span>f)</span><br><span class="line">-&gt;<span class="built_in">AddTab</span>(InnerTabName2, ETabState::OpenedTab)</span><br><span class="line">)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//从布局中恢复得到控件</span></span><br><span class="line">TSharedRef&lt;SWidget&gt; TabContents = TabManager-&gt;<span class="built_in">RestoreFrom</span>(TabManagerLayout.<span class="built_in">ToSharedRef</span>(), <span class="built_in">TSharedPtr</span>&lt;SWindow&gt;()).<span class="built_in">ToSharedRef</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">//设置内容控件</span></span><br><span class="line">NomadTab-&gt;<span class="built_in">SetContent</span>(</span><br><span class="line">TabContents</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> NomadTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;这里将之前注册的 Tab 唤起。</p></blockquote><h2 id="Viewport"><a href="#Viewport" class="headerlink" title="Viewport"></a>Viewport</h2><p><a href="https://yaksue.blog.csdn.net/article/details/109258860">https://yaksue.blog.csdn.net/article/details/109258860</a></p><blockquote><p>&emsp;&emsp;引入默认的 <code>SEditorViewport</code> 类<br>&emsp;&emsp;然后 override 方法 <code>MakeEditorViewportClient</code></p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TSharedRef&lt;FEditorViewportClient&gt; <span class="title">STestLevelEditorViewport::MakeEditorViewportClient</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">TSharedPtr&lt;FEditorViewportClient&gt; EditorViewportClient = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FEditorViewportClient</span>(<span class="literal">nullptr</span>));</span><br><span class="line"><span class="keyword">return</span> EditorViewportClient.<span class="built_in">ToSharedRef</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;然后Slate 代码直接使用 <code>SNew(STestLevelEditorViewport)</code> 初始化界面即可。<br>&emsp;&emsp;不过这个方式沿用了 Viewport ，如何构建一个自定义 Viewport 呢？</p></blockquote><hr><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TSharedRef&lt;FEditorViewportClient&gt; <span class="title">STestEditorViewport::MakeEditorViewportClient</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">PreviewScene = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FPreviewScene</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//向预览场景中加一个测试模型</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//读取模型</span></span><br><span class="line">UStaticMesh* SM = <span class="built_in">LoadObject</span>&lt;UStaticMesh&gt;(<span class="literal">NULL</span>, <span class="built_in">TEXT</span>(<span class="string">&quot;StaticMesh&#x27;/Engine/EngineMeshes/Cube.Cube&#x27;&quot;</span>), <span class="literal">NULL</span>, LOAD_None, <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">//创建组件</span></span><br><span class="line">UStaticMeshComponent* SMC = <span class="built_in">NewObject</span>&lt;UStaticMeshComponent&gt;();</span><br><span class="line">SMC-&gt;<span class="built_in">SetStaticMesh</span>(SM);</span><br><span class="line"><span class="comment">//向预览场景中增加组件</span></span><br><span class="line">PreviewScene-&gt;<span class="built_in">AddComponent</span>(SMC, FTransform::Identity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TSharedPtr&lt;FEditorViewportClient&gt; EditorViewportClient = <span class="built_in">MakeShareable</span>(<span class="keyword">new</span> <span class="built_in">FEditorViewportClient</span>(<span class="literal">nullptr</span>, PreviewScene.<span class="built_in">Get</span>()));</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> EditorViewportClient.<span class="built_in">ToSharedRef</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;新建一个自定义的 <code>FPreviewScene</code> ，可以将物体实例化添加到场景当中。<br>&emsp;&emsp;将 <code>PreviewScene</code> 传入到  <code>FEditorViewportClient</code> 中，这样 Viewport 就显示独立的场景。</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">TSharedPtr&lt;SWidget&gt; <span class="title">STestEditorViewport::MakeViewportToolbar</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">SNew</span>(SCommonEditorViewportToolbarBase, <span class="built_in">SharedThis</span>(<span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;使用上面的代码可以构建出默认 Viewport 的 Toolbar。</p></blockquote><h2 id="GraphEditor"><a href="#GraphEditor" class="headerlink" title="GraphEditor"></a>GraphEditor</h2><p><a href="https://yaksue.blog.csdn.net/article/details/107945507">https://yaksue.blog.csdn.net/article/details/107945507</a><br><a href="https://yaksue.blog.csdn.net/article/details/108020797">https://yaksue.blog.csdn.net/article/details/108020797</a><br><a href="https://yaksue.blog.csdn.net/article/details/108227439">https://yaksue.blog.csdn.net/article/details/108227439</a><br><a href="https://yaksue.blog.csdn.net/article/details/109347063">https://yaksue.blog.csdn.net/article/details/109347063</a></p><h2 id="EditorMode"><a href="#EditorMode" class="headerlink" title="EditorMode"></a>EditorMode</h2><!-- TODO -->]]></content>
    
    <summary type="html">
    
      YakSue 工具开发文章学习
    
    </summary>
    
      <category term="游戏开发" scheme="https://blog.l0v0.com/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="Unreal" scheme="https://blog.l0v0.com/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unreal/"/>
    
      <category term="C++" scheme="https://blog.l0v0.com/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unreal/C/"/>
    
    
      <category term="ࠇCpp" scheme="https://blog.l0v0.com/tags/%E0%A0%87Cpp/"/>
    
      <category term="ࠃUnreal" scheme="https://blog.l0v0.com/tags/%E0%A0%83Unreal/"/>
    
  </entry>
  
  <entry>
    <title>Maya C++ pyd 模块开发</title>
    <link href="https://blog.l0v0.com/posts/ce449c32.html"/>
    <id>https://blog.l0v0.com/posts/ce449c32.html</id>
    <published>2022-07-14T02:52:30.000Z</published>
    <updated>2022-12-14T02:54:16.765Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>作者: <a href="http://tw.l0v0.com/#%F0%9F%91%A8%E2%80%8D%F0%9F%92%BBsonictk">👨‍💻sonictk</a></p><p><a href="https://github.com/sonictk/maya_python_c_extension">https://github.com/sonictk/maya_python_c_extension</a></p><blockquote><p>&emsp;&emsp;这篇文章也是参考 sonictk 大佬的提供的 pyd 开发文章。<br>&emsp;&emsp;文章也提到之前的 hot reload 方案已经解决了很多 C++ 开发困难的问题。<br>&emsp;&emsp;然而还是有很多情况需要开发一个 python 的 C++ 模块实现 Maya C++ API 的 调用。<br>&emsp;&emsp;这个情况有点像是 Unreal 暴露 C++ API 到 Python 一样。</p></blockquote><p><a href="./1a24f2d2.html">Maya 编译 c 相关 Python 库 &amp; pyd 编译</a></p><blockquote><p>&emsp;&emsp;之前我也写过关于 Maya pyd 编译的文章，但是这个文章是用 Cython 自动生成 C 代码编译实现的，这次是手写 pyd。</p></blockquote><h2 id="什么是-pyd"><a href="#什么是-pyd" class="headerlink" title="什么是 pyd"></a>什么是 pyd</h2><blockquote><p>&emsp;&emsp;pyd 本质上也是一个 dll 文件，就像 Maya 插件的 mll 一样。<br>&emsp;&emsp;只是 pyd 规定了一些暴露规则，从而让 python 解释器可以读取。<br>&emsp;&emsp;这也是 Python 称之为胶水语言的一大特点，它可以无缝和 C++ 编译的模块进行交互。<br>&emsp;&emsp;因此很多 C++ 的包 比如 Qt 等可以暴露接口到 Python 实现调用。</p></blockquote><h2 id="pyd-hello-world-案例"><a href="#pyd-hello-world-案例" class="headerlink" title="pyd hello world 案例"></a>pyd hello world 案例</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;maya/MGlobal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> MAYA_PYTHON_C_EXT_DOCSTRING[] = <span class="string">&quot;An example Python C extension that makes use of Maya functionality.&quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> HELLO_WORLD_MAYA_DOCSTRING[] = <span class="string">&quot;Says hello world!&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NOTE(timmyliang): 调用 MGlobal API 打印 Python 传递的字符串</span></span><br><span class="line"><span class="function"><span class="type">static</span> PyObject *<span class="title">pyHelloWorldMaya</span><span class="params">(PyObject *<span class="keyword">module</span>, PyObject *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *inputString;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">PyArg_ParseTuple</span>(args, <span class="string">&quot;s&quot;</span>, &amp;inputString))</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PyGILState_STATE pyGILState = <span class="built_in">PyGILState_Ensure</span>();</span><br><span class="line"></span><br><span class="line">MGlobal::<span class="built_in">displayInfo</span>(inputString);</span><br><span class="line"></span><br><span class="line">PyObject *result = <span class="built_in">Py_BuildValue</span>(<span class="string">&quot;s&quot;</span>, inputString);</span><br><span class="line"></span><br><span class="line"><span class="built_in">PyGILState_Release</span>(pyGILState);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NOTE(timmyliang): 定义模块的函数列表</span></span><br><span class="line"><span class="type">static</span> PyMethodDef mayaPythonCExtMethods[] = &#123;</span><br><span class="line">&#123;<span class="string">&quot;hello_world_maya&quot;</span>, pyHelloWorldMaya, METH_VARARGS, HELLO_WORLD_MAYA_DOCSTRING&#125;,</span><br><span class="line">&#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>&#125; <span class="comment">// <span class="doctag">NOTE:</span> (sonictk) Sentinel value for Python</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// NOTE(timmyliang): python2 初始化函数规范 init&lt;module_name&gt; </span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PY_MAJOR_VERSION == 2</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">PyMODINIT_FUNC <span class="title">initpy_hello</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">Py_InitModule3</span>(<span class="string">&quot;py_hello&quot;</span>,</span><br><span class="line">  mayaPythonCExtMethods,</span><br><span class="line">  MAYA_PYTHON_C_EXT_DOCSTRING);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// NOTE(timmyliang): python3 初始化函数规范 PyInit_&lt;module_name&gt; </span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> PY_MAJOR_VERSION == 3</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function">PyMODINIT_FUNC <span class="title">PyInit_py_hello</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">static</span> PyModuleDef hello_module = &#123;</span><br><span class="line">PyModuleDef_HEAD_INIT,</span><br><span class="line"><span class="string">&quot;py_hello&quot;</span>, <span class="comment">// Module name to use with Python import statements</span></span><br><span class="line">MAYA_PYTHON_C_EXT_DOCSTRING, <span class="comment">// Module description</span></span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">mayaPythonCExtMethods <span class="comment">// Structure that defines the methods of the module</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">PyModule_Create</span>(&amp;hello_module);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;上面的代码就是一个小案例，将 C++ 编译成 pyd 给 python 调用。<br>&emsp;&emsp;并且这里引用了 Maya 的 API ，因此只能使用 Maya 的 Python Interpreter (mayapy.exe) 进行加载。<br>&emsp;&emsp;如果使用其他 Python 导入这个模块会出现如下的错误</p></blockquote><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent <span class="keyword">call</span> last):</span><br><span class="line">  File &quot;d:/Obsidian/Personal/<span class="number">2</span>_Area/📝Blog/CG/Maya/C++/test_load.py&quot;, line <span class="number">5</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    import py_hello</span><br><span class="line"><span class="function">ImportError: <span class="title">DLL</span> <span class="title">load</span> <span class="title">failed</span> <span class="title">while</span> <span class="title">importing</span> <span class="title">py_hello</span>: 找不到指定的程序。</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;pyd 的 C++ 代码包含三个部分</p><ol><li>python 定义的函数</li><li>函数列表定义 (需要传入上面的 C++ 编写的 Python 函数)</li><li>模块定义 (传入上面的 函数列表)</li></ol></blockquote><blockquote><p>&emsp;&emsp;最后生成模块部分，Python2 和 Python3 暴露的 API 不一致，可以用宏来区分。</p></blockquote><blockquote><p>&emsp;&emsp;编译这个 cpp 需要加上 Maya include 目录的头文件，以及链接 Maya lib 的静态库文件。<br>&emsp;&emsp;另外编译 pyd 需要特别注意的是，它也需要想 mll 一样暴露出初始化的函数。<br>&emsp;&emsp;在 python2 下是 <code>init&lt;module_name&gt;</code> 开头，在 python3 下是 <code>PyInit_&lt;module_name&gt;</code> 开头。<br>&emsp;&emsp;在 cpp 里面配置编译环境是个相当让人头疼的问题。<br>&emsp;&emsp;我在自己的 <a href="https://github.com/FXTD-ODYSSEY/CMakeMaya">CMakeMaya</a> 库里面已经配置好了编译用的环境，<br>&emsp;&emsp;具体的使用方法可以看 readme 或者参考我的文章 <a href="./5875a169.html">Maya CMake 构建 C++ 插件编译环境</a> </p></blockquote><blockquote><p>&emsp;&emsp;在我提供的环境下执行 <code>doit c -p pyd -v 2020</code> 即可编译出 pyd 到 <code>plug-ins\Release\maya2022\pyd\py_hello.pyd</code><br>&emsp;&emsp;需要注意 pyd 在不同的平台不同Maya版本都需要单独编译。这里我提供了编译好给 Windows64 Maya2020 的 <a href="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/ce449c32/py_hello.pyd">pyd</a> </p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/ce449c32/ea63da79573f07279f606f9b77b16f21.jpeg" alt="image"></p><h3 id="导入-pyd-引入-Maya-C-节点"><a href="#导入-pyd-引入-Maya-C-节点" class="headerlink" title="导入 pyd 引入 Maya C++ 节点"></a>导入 pyd 引入 Maya C++ 节点</h3><blockquote><p>&emsp;&emsp;在相应的版本执行就可以看到如期触发了 maya API 的方法。<br>&emsp;&emsp;也可以用这个方式注册 Maya 的节点和 Mel 命令，具体可以看 <a href="https://github.com/FXTD-ODYSSEY/CMakeMaya/tree/master/projects/sonictk/pyd/pyDeformer">pyDeformer</a> 的代码。<br>&emsp;&emsp;只是由于没有 <code>initializePlugin</code> 拿不到传进来的 <code>MObject</code> 实例化 <code>MFnPlugin</code>。<br>&emsp;&emsp;我测试的 py_deformer 用了 <code>MFnPlugin::findPlug</code> 拿到内置插件 <code>matrixNodes</code> 提供的 MObject 来注册节点。<br>&emsp;&emsp;答案是可以实现的，而且新加入的节点也会显示在 <code>matrixNodes</code> 上。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/ce449c32/877d402bb3650b6b9d965467d2811829.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;这种骚操作不建议使用，而且也不知道会不会有什么 BUG 导致 Maya 崩溃。<br>&emsp;&emsp;另外没有办法触发 <code>uninitializePlugin</code> 来注销这个节点的注册。</p></blockquote><h3 id="pyd-mll-缝合怪"><a href="#pyd-mll-缝合怪" class="headerlink" title="pyd mll 缝合怪"></a>pyd mll 缝合怪</h3><blockquote><p>&emsp;&emsp;基于上面的测试我发现还可以生成出既是 Maya 插件又是 Python 模块的 缝合怪文件。<br>&emsp;&emsp;因为 C++ 只要编译的时候 export 出对应的方法就可以加载。</p></blockquote><blockquote><p>&emsp;&emsp;只是 Python 加载二进制包要求文件后缀为 pyd ，Maya 加载二进制插件要求文件命名为 mll 才可以。<br>&emsp;&emsp;解决这个问题，可以用软连接或者拆分成两个文件来实现，经过测试是可以的，具体可以看 <a href="https://github.com/FXTD-ODYSSEY/CMakeMaya/tree/master/projects/sonictk/pyd/pyCommand">pyCommand</a> 的 <a href="https://github.com/FXTD-ODYSSEY/CMakeMaya/tree/master/projects/sonictk/pyd/scripts/test_py_deformer.py">测试代码</a> 。</p></blockquote><h2 id="使用-mll-嵌入-python-模块"><a href="#使用-mll-嵌入-python-模块" class="headerlink" title="使用 mll 嵌入 python 模块"></a>使用 mll 嵌入 python 模块</h2><blockquote><p>&emsp;&emsp;上面主要实现按照 python 的规范加载包的操作，<code>sonitck</code> 的文章还提供了一个方案，加载 mll 获取到 python 包的方式。<br>&emsp;&emsp;做法也不复杂，就是在 <code>initializePlugin</code> 的时候加上加上 C++ 的模块。</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;maya/MFnPlugin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;maya/MGlobal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *kAUTHOR = <span class="string">&quot;TimmyLiang&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *kVERSION = <span class="string">&quot;1.0.0&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *kREQUIRED_API_VERSION = <span class="string">&quot;Any&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> HELLO_WORLD_MAYA_DOCSTRING[] = <span class="string">&quot;Says hello world!&quot;</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> MAYA_PYTHON_C_EXT_DOCSTRING[] = <span class="string">&quot;An example Python C extension that makes use of Maya functionality.&quot;</span>;</span><br><span class="line"></span><br><span class="line">PyObject *<span class="keyword">module</span> = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> PyObject *<span class="title">pyHelloWorldMaya</span><span class="params">(PyObject *<span class="keyword">module</span>, PyObject *args)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *inputString;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">PyArg_ParseTuple</span>(args, <span class="string">&quot;s&quot;</span>, &amp;inputString)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">PyGILState_STATE pyGILState = <span class="built_in">PyGILState_Ensure</span>();</span><br><span class="line">MGlobal::<span class="built_in">displayInfo</span>(inputString);</span><br><span class="line">PyObject *result = <span class="built_in">Py_BuildValue</span>(<span class="string">&quot;s&quot;</span>, inputString);</span><br><span class="line"><span class="built_in">PyGILState_Release</span>(pyGILState);</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> PyMethodDef mayaPythonCExtMethods[] = &#123;</span><br><span class="line">&#123;<span class="string">&quot;hello_world_maya&quot;</span>, pyHelloWorldMaya, METH_VARARGS, HELLO_WORLD_MAYA_DOCSTRING&#125;,</span><br><span class="line">&#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">MStatus <span class="title">initializePlugin</span><span class="params">(MObject obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="function">MFnPlugin <span class="title">plugin</span><span class="params">(obj, kAUTHOR, kVERSION, kREQUIRED_API_VERSION)</span></span>;</span><br><span class="line"><span class="keyword">if</span> (!<span class="built_in">Py_IsInitialized</span>())</span><br><span class="line"><span class="built_in">Py_Initialize</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">Py_IsInitialized</span>())</span><br><span class="line">&#123;</span><br><span class="line">PyGILState_STATE pyGILState = <span class="built_in">PyGILState_Ensure</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// NOTE(TimmyLiang): python2 直接初始化模块就不会变成 built-in 模块</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> PY_MAJOR_VERSION == 2</span></span><br><span class="line"><span class="keyword">module</span> = <span class="built_in">Py_InitModule3</span>(<span class="string">&quot;mll_py&quot;</span>,</span><br><span class="line">mayaPythonCExtMethods,</span><br><span class="line">MAYA_PYTHON_C_EXT_DOCSTRING);</span><br><span class="line"><span class="comment">// NOTE(TimmyLiang): python3 用官方的方式添加模块不行，可能是因为 Py_Initialize 已经执行了</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> PY_MAJOR_VERSION == 3</span></span><br><span class="line"><span class="comment">// NOTE(TimmyLiang): 参考 https://github.com/LinuxCNC/linuxcnc/issues/825 将模块加到 sys.modules 里面</span></span><br><span class="line"><span class="type">static</span> PyModuleDef hello_module = &#123;</span><br><span class="line">PyModuleDef_HEAD_INIT,</span><br><span class="line"><span class="string">&quot;mll_py&quot;</span>, <span class="comment">// Module name to use with Python import statements</span></span><br><span class="line">MAYA_PYTHON_C_EXT_DOCSTRING, <span class="comment">// Module description</span></span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">mayaPythonCExtMethods <span class="comment">// Structure that defines the methods of the module</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> = <span class="built_in">PyModule_Create</span>(&amp;hello_module);</span><br><span class="line">PyObject *sys_modules = <span class="built_in">PyImport_GetModuleDict</span>();</span><br><span class="line"><span class="built_in">PyDict_SetItemString</span>(sys_modules, <span class="string">&quot;mll_py&quot;</span>, <span class="keyword">module</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">MGlobal::<span class="built_in">displayInfo</span>(<span class="string">&quot;Registered Python bindings!&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">module</span> == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> MStatus::kFailure;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// NOTE(timmyliang): 增加引用计数(确保不会 gc)</span></span><br><span class="line"><span class="built_in">Py_INCREF</span>(<span class="keyword">module</span>);</span><br><span class="line"><span class="built_in">PyGILState_Release</span>(pyGILState);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> MStatus::kSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">MStatus <span class="title">uninitializePlugin</span><span class="params">(MObject obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">MStatus status;</span><br><span class="line">  <span class="comment">// NOTE(timmyliang): 减少引用计数</span></span><br><span class="line"><span class="built_in">Py_DECREF</span>(<span class="keyword">module</span>);</span><br><span class="line"><span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;上面的代码兼容 python2 python3 版本。<br>&emsp;&emsp;python2 直接用默认的 <code>Py_InitModule</code> 方法就可以添加，如果在 Python 打印模块会提示 <code>&lt;module &#39;mll_py&#39; (built-in)&gt;</code><br>&emsp;&emsp;但是 python3 下面不行，后来查找了 Github 的 <a href="https://github.com/LinuxCNC/linuxcnc/issues/825">issue</a> 通过将模块添加到 <code>sys.modules</code> 下面解决问题。<br>&emsp;&emsp;只是模块打印就是普通的模块。<br>&emsp;&emsp;那为什么将模块放到 sys.modules 就可以了，这 Python 的 import 机制有关。 <a href="./5e6e2bc7.html">Python - Import 机制</a></p></blockquote><blockquote><p>&emsp;&emsp;这个方式可以将一些 C++ 的 API 暴露给 Python，只是这个操作需要更多的说明。<br>&emsp;&emsp;否则没人知道这个 mll 居然添加一个 Python 模块。</p></blockquote><h2 id="pybind11-自动绑定"><a href="#pybind11-自动绑定" class="headerlink" title="pybind11 自动绑定"></a>pybind11 自动绑定</h2><blockquote><p>&emsp;&emsp;通过上面一顿操作，也可以深刻体会到如果跨版本兼容 C++ 需要做很多宏的判断，相当繁琐。<br>&emsp;&emsp;包括 Python2 和 Python3 暴露的方法名不一样，需要在 CMake 上进行判断。<br>&emsp;&emsp;使用 pybind11 进行转换相对方便许多</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;maya/MGlobal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pybind11/pybind11.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// https://zhuanlan.zhihu.com/p/80884925</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">displayInfo</span><span class="params">(<span class="type">char</span> *inputString)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">MGlobal::<span class="built_in">displayInfo</span>(inputString);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">PYBIND11_MODULE</span>( pybind11cpp, m )&#123;</span><br><span class="line">    m.<span class="built_in">doc</span>() = <span class="string">&quot;pybind11 example&quot;</span>;</span><br><span class="line">    m.<span class="built_in">def</span>(<span class="string">&quot;display_info&quot;</span>, &amp;displayInfo, <span class="string">&quot;Maya Display Info&quot;</span> ,pybind11::<span class="built_in">arg</span>(<span class="string">&quot;inputString&quot;</span>) = <span class="string">&quot;hello world!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;pybind11 会自动将 Python 的参数进行转换<br>&emsp;&emsp;这样只要将纯粹的 C++ 函数放入到 <code>PYBIND11_MODULE</code> 宏<br>&emsp;&emsp;并且 pybind11 的 2.9 版本支持 python2 python3 的 pyd 编译。<br>&emsp;&emsp;只要在 cmake 里面配置 <code>/export</code> 对应的方法即可。</p></blockquote><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(Pybind11 REQUIRED) </span><br><span class="line"></span><br><span class="line"><span class="keyword">project</span>(pybind11cpp) <span class="comment">#project name</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">file</span>(GLOB SRCS <span class="string">&quot;pybind11/*.cpp&quot;</span> <span class="string">&quot;pybind11/*.h&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;MAYA_INCLUDE_DIR&#125;</span> <span class="variable">$&#123;MAYA_PYTHON_INCLUDE_DIR&#125;</span> <span class="variable">$&#123;PYBIND11_INCLUDE_DIR&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">link_directories</span>(<span class="variable">$&#123;MAYA_LIBRARY_DIR&#125;</span>) <span class="comment">#specifies a directory where a linker should search for libraries</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> SHARED <span class="variable">$&#123;SRCS&#125;</span>) <span class="comment">#Add a dynamic library to the project using the specified source files</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pybind11_add_module($&#123;PROJECT_NAME&#125; $&#123;SRCS&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;MAYA_LIBRARIES&#125;</span>) <span class="comment">#specifies list of libraries to use when linking the terget and its dependents</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$&#123;MAYA_VERSION&#125;</span> <span class="keyword">GREATER</span> <span class="number">2020</span>) </span><br><span class="line">    <span class="keyword">set</span>(PYBIND_LINK_FLAGS <span class="string">&quot;/export:PyInit_pybind11cpp&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>() </span><br><span class="line">    <span class="keyword">set</span>(PYBIND_LINK_FLAGS <span class="string">&quot;/export:initpybind11cpp&quot;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">set_target_properties</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> PROPERTIES</span><br><span class="line">    LINK_FLAGS <span class="variable">$&#123;PYBIND_LINK_FLAGS&#125;</span></span><br><span class="line">    SUFFIX <span class="string">&quot;.pyd&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;pybind11 可以使用 <code>pybind11_add_module</code> 来生成 pyd<br>&emsp;&emsp;但是它是自动查找 Python 环境，指定 Maya 的 Python 需要额外的配置。<br>&emsp;&emsp;所以我就不用这个，自己来配置好了。</p></blockquote><blockquote><p>&emsp;&emsp;通过上面的方式可以大大简化 C++ 的编写。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>&emsp;&emsp;以上就是 pyd 编译的各种折腾结果。<br>&emsp;&emsp;社区里面值得说道的有 <a href="https://github.com/mottosso/cmdc">cmdc</a> 基于 pybind11 编译的二次封装 C++ API 库。</p></blockquote><blockquote><p>&emsp;&emsp;Python 调用 C++ 还有利用 <code>ctypes</code> 库访问 dll 的方式<br>&emsp;&emsp;后续也可以实验一下在 Python 中从 dll 里面调用 function 实现 参考:<a href="https://github.com/Autodesk/animx">https://github.com/Autodesk/animx</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      Python C++ Extension
    
    </summary>
    
      <category term="CG" scheme="https://blog.l0v0.com/categories/CG/"/>
    
      <category term="Maya" scheme="https://blog.l0v0.com/categories/CG/Maya/"/>
    
      <category term="C++" scheme="https://blog.l0v0.com/categories/CG/Maya/C/"/>
    
    
      <category term="ࠇCpp" scheme="https://blog.l0v0.com/tags/%E0%A0%87Cpp/"/>
    
      <category term="ࠀMaya" scheme="https://blog.l0v0.com/tags/%E0%A0%80Maya/"/>
    
  </entry>
  
  <entry>
    <title>Unreal C++ VScode 配置</title>
    <link href="https://blog.l0v0.com/posts/51c731db.html"/>
    <id>https://blog.l0v0.com/posts/51c731db.html</id>
    <published>2022-07-12T06:47:30.000Z</published>
    <updated>2022-12-14T02:54:16.861Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;这次尝试在 VScode 进行引擎编译。<br>&emsp;&emsp;网上一查发现，官方其实有做支持的，具体可以参考这篇文章 <a href="http://jollymonsterstudio.com/2018/11/02/unreal-c-with-visual-studio-code">链接</a><br>&emsp;&emsp;这篇文章传播甚广，可以参照和这个方式配置 VScode 编译。</p></blockquote><p><a href="https://www.youtube.com/watch?v=fydvKedIxKk">https://www.youtube.com/watch?v=fydvKedIxKk</a><br><a href="https://github.com/boocs/ue4-tellisense-fixes">https://github.com/boocs/ue4-tellisense-fixes</a></p><h2 id="C-编译过程"><a href="#C-编译过程" class="headerlink" title="C++ 编译过程"></a>C++ 编译过程</h2><p>深度参考学习这边文章 <a href="https://ericlemes.com/2018/11/21/compiling-c-code/">https://ericlemes.com/2018/11/21/compiling-c-code/</a><br>鉴于本人的 C++ 水平一般，建议阅读原文</p><h3 id="编译步骤"><a href="#编译步骤" class="headerlink" title="编译步骤"></a>编译步骤</h3><blockquote><p>&emsp;&emsp;C++ 编译可能会用到下面的文件。</p></blockquote><ul><li>.cpp 文件编译成 .obj</li><li>生成静态库 .lib</li><li>生成动态库 .dll </li><li>生成可执行文件 executable</li></ul><h3 id="VS-工具链"><a href="#VS-工具链" class="headerlink" title="VS 工具链"></a>VS 工具链</h3><blockquote><p>&emsp;&emsp;.sln 全称是 solution 解决方案，是 VS 的项目配置文件。 (整合了 .vcxproj .csproj)<br>&emsp;&emsp;他可以同时配置多个项目，最后通过 MSBuild 来构建<br>&emsp;&emsp;sln 包含了项目的各种头文件依赖，库引用等描述，执行顺序，通过这个 IDE 就知道怎么编译你的项目。</p></blockquote><blockquote><p>&emsp;&emsp;Xcode 的情况也是类似的。<br>&emsp;&emsp;其中比较特别的时 CMake ，通过 CMakeLists.txt 文件可以根据不同平台生成工程配置文件。</p></blockquote><h3 id="第一步-编译"><a href="#第一步-编译" class="headerlink" title="第一步 编译"></a>第一步 编译</h3><p>输入:</p><ul><li>Defines</li><li>Include 文件夹路径Include directories</li><li>预编译头文件 (如果有用到的话)</li><li>源代码</li></ul><p>输出:</p><ul><li>.obj 文件</li></ul><blockquote><p>&emsp;&emsp;MSBuild 使用 CL.exe 进行 C++ 编译。 可能的路径 <code>C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Tools\MSVC\14.29.30133\bin\Hostx64\x64\cl.exe</code><br>&emsp;&emsp;需要安装 VS 或者用 choco 来安装</p></blockquote><blockquote><p>&emsp;&emsp;编译的时候会根据 宏定义(比如 <code>#ifdef</code>)动态 改变编译行为<br>&emsp;&emsp;通过这个方式可以在不同的平台编译出不同的行为。<br>&emsp;&emsp;C++ 最终编译成对应平台的二进制，这个设计和 Java C# 都不同。</p></blockquote><blockquote><p>&emsp;&emsp;头文件最终会拼接到 C++ 里面进行编译，所以需要加上 <code>#pragma once</code> 或者 <code>#if</code> 来避免多次定义。<br>&emsp;&emsp;预编译头则可以生成 <code>.pch</code> 文件实现头文件复用。</p></blockquote><h3 id="第二步-链接"><a href="#第二步-链接" class="headerlink" title="第二步 链接"></a>第二步 链接</h3><p>输入:</p><ul><li>一些源码生成 .obj 文件</li><li>一些源码生成 .lib 文件</li><li>第三方的 lib 和 obj 文件</li></ul><p>输出:</p><ul><li>.dll 或者 .exe</li></ul><blockquote><p>&emsp;&emsp;这一步会将生成的中间文件合并成 dll 或者 exe<br>&emsp;&emsp;这个过程会完成很多优化的步骤，把不运行的部分清理掉。<br>&emsp;&emsp;最后会将一些平台的 lib 引入确保它在平台上可以运行，比如 wincrt (Windows C Runtime library) 等等<br>&emsp;&emsp;并且 lib 也有很多种类，有 release 版本和 debug 版本等等。</p></blockquote><h2 id="Unreal-Build-Tool"><a href="#Unreal-Build-Tool" class="headerlink" title="Unreal Build Tool"></a>Unreal Build Tool</h2><p><a href="https://ericlemes.com/2018/11/23/understanding-unreal-build-tool/">https://ericlemes.com/2018/11/23/understanding-unreal-build-tool/</a></p><h3 id="CS-配置文件说明"><a href="#CS-配置文件说明" class="headerlink" title="CS 配置文件说明"></a>CS 配置文件说明</h3><p><a href="https://www.bilibili.com/read/cv15297017/">https://www.bilibili.com/read/cv15297017/</a></p><blockquote><p>&emsp;&emsp;<code>Unreal</code> 使用自己开发的 <code>UnrealBuildTool</code> 来编译自己的 C++ 代码<br>&emsp;&emsp;与 <a href="http://tw.l0v0.com/#%F0%9F%92%BECMake">💾CMake</a> 类似的，<code>UnrealBuildTool</code> 会引用你需要在相应的模块添加 <code>.build.cs</code> 的代码文件来描述仓库链接的东西。<br>&emsp;&emsp;<code>.build.cs</code> 之上配套了 <code>Private</code> <code>Public</code> 文件夹分别放置暴露和不暴露的代码。<br>&emsp;&emsp;<code>.target.cs</code> 则可以用来定义输出的类型，有 <code>Game</code> <code>Editor</code> <code>Client</code> <code>Server</code> 几种类型。</p></blockquote><h3 id="生成工程文件"><a href="#生成工程文件" class="headerlink" title="生成工程文件"></a>生成工程文件</h3><blockquote><p>&emsp;&emsp;当我们对 <code>uproject</code> 文件右键生成 project 的时候背后执行就是 <code>UnrealBuildTool</code></p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/51c731db/a897c17f0e8725cfdc7eef597edbc464.png" alt="image"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:/EpicGames/git/UnrealEngine-4.27/Engine/Binaries/DotNET/UnrealBuildTool.exe  -projectfiles -project=&quot;D:/EpicGames/test_plugin/test_plugin.uproject&quot; -game -engine -progress -log=&quot;D:\EpicGames\test_plugin/Saved/Logs/UnrealVersionSelector-2022.07.12-15.50.08.log&quot;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;<code>UnrealBuildTool</code> 会根据 <code>.build.cs</code> 和 <code>.target.cs</code> 里面配置模块路径生成 sln 工程文件。</p></blockquote><h3 id="编译-C"><a href="#编译-C" class="headerlink" title="编译 C++"></a>编译 C++</h3><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/51c731db/00ffce7125f34d3a93cc992f7d154c3c.png" alt="image"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D:/EpicGames/UE_4.27/Engine/Binaries/DotNET/UnrealBuildTool.exe Development Win64 -Project=&quot;D:/EpicGames/Unreal_Playground/Unreal_Playground.uproject&quot; -TargetType=Editor -Progress -NoEngineChanges -NoHotReloadFromIDE</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;这个 <code>Build.bat</code> 背后还是调用 <code>UnrealBuildTool.exe</code> 通过它来编译 C++<br>&emsp;&emsp;上面生成工程时候 <code>.build.cs</code> 和 <code>.target.cs</code> 只是收集了路径。<br>&emsp;&emsp;现在会再次读取这两个文件来获取一些编译用的属性。<br>&emsp;&emsp;然根据配置解决各个模块的依赖关系。</p></blockquote><blockquote><p>&emsp;&emsp;最后会运行 <code>UnrealHeaderTool</code> 将 UObject 的一些特性注入到 UObject 的 cpp 文件当中。<br>&emsp;&emsp;这也说明了为什么需要引入 <code>.generated.h</code> 的头文件。<br>&emsp;&emsp;准备好了所有代码之后再调用相应的编译工具去构建 C++。</p></blockquote><h2 id="VScode-编译配置"><a href="#VScode-编译配置" class="headerlink" title="VScode 编译配置"></a>VScode 编译配置</h2><blockquote><p>&emsp;&emsp;了解了 C++ 编译和 Unreal 全家桶的编译逻辑之后。<br>&emsp;&emsp;我们终于可以回归到本篇文章的正题。</p></blockquote><p><a href="http://jollymonsterstudio.com/2018/11/02/unreal-c-with-visual-studio-code/">http://jollymonsterstudio.com/2018/11/02/unreal-c-with-visual-studio-code/</a></p><blockquote><p>&emsp;&emsp;按照这里提供的文章就可以用 Unreal 官方的方式配置好 <code>.vscode</code> 目录的编译配置。<br>&emsp;&emsp;后续只要 <code>Ctrl + shift + B</code> 就可以触发编译。<br>&emsp;&emsp;编译背后的逻辑就在上面解释了。</p></blockquote><blockquote><p>&emsp;&emsp;相应的我也可以用 python 脚本来触发编译。<br>&emsp;&emsp;sln 工程并不是必须的，不过 VS 有 VA 查找代码比较快。</p></blockquote>]]></content>
    
    <summary type="html">
    
      UnrealBuildTool 实现编译
    
    </summary>
    
      <category term="游戏开发" scheme="https://blog.l0v0.com/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="Unreal" scheme="https://blog.l0v0.com/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unreal/"/>
    
      <category term="C++" scheme="https://blog.l0v0.com/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unreal/C/"/>
    
    
      <category term="ࠇCpp" scheme="https://blog.l0v0.com/tags/%E0%A0%87Cpp/"/>
    
      <category term="ࠃUnreal" scheme="https://blog.l0v0.com/tags/%E0%A0%83Unreal/"/>
    
  </entry>
  
  <entry>
    <title>Maya C++ mll hot reload 研究</title>
    <link href="https://blog.l0v0.com/posts/e6dc9087.html"/>
    <id>https://blog.l0v0.com/posts/e6dc9087.html</id>
    <published>2022-07-08T02:41:12.000Z</published>
    <updated>2022-12-14T02:54:16.764Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>作者: <a href="http://tw.l0v0.com/#%F0%9F%91%A8%E2%80%8D%F0%9F%92%BBsonictk">👨‍💻sonictk</a></p><p><a href="https://sonictk.github.io/maya_hot_reload_example_public/">https://sonictk.github.io/maya_hot_reload_example_public/</a></p><blockquote><p>&emsp;&emsp;详细的说明 &amp; 教程在上面的链接。</p></blockquote><blockquote><p>&emsp;&emsp;Maya 用写 C++ 开发会比较痛苦，一方面是编译问题总是让人烦躁，另一方面加载了 mll 会导致占用，测试起来很不方便。<br>&emsp;&emsp;所以我之前推崇用 Python OpenMaya 做原型设计再转 C++<br>&emsp;&emsp;当然 sonictk 也提到 Fabric Engine 和 Maya Bifrost 使用的时 LLVM IR 的方案来实现 JIT 编译。<br>&emsp;&emsp;具体可以参考另一个项目 <a href="https://github.com/giordi91/babycpp">giordi91/babycpp</a></p></blockquote><h2 id="LLVM-热加载"><a href="#LLVM-热加载" class="headerlink" title="LLVM 热加载"></a>LLVM 热加载</h2><blockquote><p>&emsp;&emsp;<code>babycpp</code> 基于 LLVM 的解决方案我编译没有通过，代码报类型错误，因此也没有测试成功。<br>&emsp;&emsp;不过也了解了 LLVM 是怎么实现热更新的，运行逻辑和 Python 有点像，但是从本质上不一样。</p></blockquote><blockquote><p>&emsp;&emsp;传统的编译器需要有 前端 优化器 后端组成，一般前端是语言，通过 tokenize 和 AST 等方案将语言解析然后通过优化器生成后端的二进制文件。<br>&emsp;&emsp;LLVM 推出了 LLVM IR 中间语言，这样不管前端用什么语言开发，只要有对应的解析工具生成出 LLVM IR ，j就可以利用 LLVM IR 的优化生成 二进制机器语言高效运行。<br>&emsp;&emsp;<code>babycpp</code> 项目就基于 LLVM IR 的机制开发了一个自己的简化版 C++ 语言，通过 LLVM IR JIT 编译动态改变运行逻辑。</p></blockquote><blockquote><p>&emsp;&emsp;我目前个人理解来看，LLVM IR 模式和 Python 模式还是不一样的，Python 是调用自己编译好的模块来运行的，而 LLVM IR 是直接运行时(JIT)生成机器语言，JIT模式的运行效率有时候比 C++ 的静态编译还要高，因为 JIT 可以根据运行过程推断程序下一步的执行来优化非必要的运行逻辑，所以 LLVM IR 的性能要比 Python 好得多。其实我后面了解了一下 numba 提速 Python 的原理就是利用 LLVM 标准实现的。</p></blockquote><blockquote><p>&emsp;&emsp;不过也正如 sonictk 的文章所提到的，这个方案只能调用暴露的东西，无法对内存的细节进行处理。</p></blockquote><h2 id="基于-dll-加载"><a href="#基于-dll-加载" class="headerlink" title="基于 dll 加载"></a>基于 dll 加载</h2><p><a href="https://github.com/FXTD-ODYSSEY/CMakeMaya/tree/master/projects/sonictk/hot_reload">https://github.com/FXTD-ODYSSEY/CMakeMaya/tree/master/projects/sonictk/hot_reload</a></p><blockquote><p>&emsp;&emsp;如果使用作者提供的 github 仓库的代码编译会有问题，作者的 thirdparty 仓库编译不通过。<br>&emsp;&emsp;所以我后面是根据作者文章的代码稍微调整组装到一起实现的。</p></blockquote><blockquote><p>&emsp;&emsp;详细讲解之前，我先用最简单的话说明这个 hotreload 方案。</p><ol><li>编译一个变形器的 mll 插件 和 带逻辑的 dll 文件</li><li>mll 加载之后会调用 dll 的function进行计算</li><li>修改逻辑之后重新编译 dll</li><li>mll 会重新健在最新的 dll 实现热更新。</li></ol></blockquote><h3 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h3><p><a href="https://sonictk.github.io/maya_hot_reload_example_public/getting_started/">https://sonictk.github.io/maya_hot_reload_example_public/getting_started/</a></p><blockquote><p>&emsp;&emsp;这篇文章非常好，不仅仅讲解了作者 hot reload 的思路，还附带了 windows lib dll 之间的运行逻辑等知识。</p></blockquote><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/e6dc9087/90f7f29f4db2deb75e3cad0924734436.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;代码结构上需要将插件分成两个部分，一个是调用 logic 生成 dll<br>&emsp;&emsp;另一个是 deformer 的代码生成 mll<br>&emsp;&emsp;具体编译配置通过 cmake 配置两个 project 实现。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── logic</span><br><span class="line">│   ├── logic.cpp                  dll 代码逻辑</span><br><span class="line">│   └── logic.h</span><br><span class="line">├── maya_deformer</span><br><span class="line">│   ├── deformer_platform.cpp      调用 &lt;windows.h&gt; API 加载 dll</span><br><span class="line">│   ├── deformer_platform.h</span><br><span class="line">│   ├── deformer.cpp               Maya 变形器 deform 调用 deform_platform 提供的方法</span><br><span class="line">│   ├── deformer.h</span><br><span class="line">│   ├── plugin_main.cpp            Maya mll 插件初始化函数</span><br><span class="line">│   └── plugin_main.h</span><br><span class="line">├── scripts</span><br><span class="line">│   └── test_deformer.py           测试插件是否修改</span><br><span class="line">├── CMakeLists.txt</span><br><span class="line">└── readme.md</span><br></pre></td></tr></table></figure><h3 id="dll-加载方案"><a href="#dll-加载方案" class="headerlink" title="dll 加载方案"></a>dll 加载方案</h3><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/e6dc9087/f1b64e13564f1397cbfbe5c238e4f86a.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;上面三个函数调用了 window API 提供的 <code>LoadLibrary</code> <code>FreeLibrary</code> <code>GetProcAddress</code> 加载 dll </p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/e6dc9087/0d97569dbeef6f0dac0f5d7a4f960fe4.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;然后将分装到 <code>loadDeformerLogicDLL</code> 和 <code>unloadDeformerLogicDLL</code> 方法里面。<br>&emsp;&emsp;deformer 在触发计算的时候调用加载 dll。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/e6dc9087/3b60f5c6dd778aca372e3c8525a0561f.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;这样每次触发节点运算的时候会自动按照 dll 的路径进行加载。</p></blockquote><blockquote><p>&emsp;&emsp;问题是怎么在 C++ 动态获取到当前 dll 的路径呢？</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/e6dc9087/38411b72f163aada48c813abf905b0d0.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;在插件加载的时候通过 <code>plugin.loadPath</code> 可以拿到当前 mll 加载的路径。<br>&emsp;&emsp;只要在同一个路径找 <code>logic.dll</code> 路径即可。</p></blockquote><h3 id="遇到的坑"><a href="#遇到的坑" class="headerlink" title="遇到的坑"></a>遇到的坑</h3><h4 id="编译-dll-占用问题"><a href="#编译-dll-占用问题" class="headerlink" title="编译 dll 占用问题"></a>编译 dll 占用问题</h4><blockquote><p>&emsp;&emsp;需要注意的是，mll 被 Maya 加载会产生占用，mll 去加载 dll 也会造成占用。<br>&emsp;&emsp;只有执行 <code>unloadDeformerLogicDLL</code> 才会解除 dll 的占用<br>&emsp;&emsp;但是占用会造成编译失败。</p></blockquote><blockquote><p>&emsp;&emsp;于是我用 CMake 的 API 将旧的 <code>logic.dll</code> 改名叫 <code>logic_old.dll</code><br>&emsp;&emsp;windows 下被占用的文件还是可以改名的。<br>&emsp;&emsp;然后执行编译生成新的 <code>logic.dll</code><br>&emsp;&emsp;这时候需要手动触发 Maya 节点的更新，这样就会按照原来的路径加载新的 dll。</p></blockquote><blockquote><p>&emsp;&emsp;CMake 怎么判断 dll 是否占用，我也没有找到合适方法，于是我想到直接删除这个 dll 在判断 dll 是否存在的方法。</p></blockquote><h3 id="extern-问题"><a href="#extern-问题" class="headerlink" title="extern 问题"></a>extern 问题</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> MString kPluginLogicLibraryPath;</span><br><span class="line"><span class="type">static</span> DeformerLogicLibrary kLogicLibrary;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;源码这两个变量用的是 static 静态变量。<br>&emsp;&emsp;但是不知道为什么在其他 cpp 文件里面调动得到的是不同的 内存 地址。</p></blockquote><p><a href="https://blog.csdn.net/sksukai/article/details/105612235">https://blog.csdn.net/sksukai/article/details/105612235</a></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> MString kPluginLogicLibraryPath;</span><br><span class="line"><span class="keyword">extern</span> DeformerLogicLibrary kLogicLibrary;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;后续是改成 extern<br>&emsp;&emsp;然后在 <code>plugin_main.cpp</code> 里面初始化变量解决问题。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>&emsp;&emsp;这个方法切实解决了 节点热加载的问题，不需要 <code>unloadPlugin</code> 清空场景之类的操作，测试起来方便了许多。</p></blockquote>]]></content>
    
    <summary type="html">
    
      C++ 变形器热更新方案
    
    </summary>
    
      <category term="CG" scheme="https://blog.l0v0.com/categories/CG/"/>
    
      <category term="Maya" scheme="https://blog.l0v0.com/categories/CG/Maya/"/>
    
      <category term="C++" scheme="https://blog.l0v0.com/categories/CG/Maya/C/"/>
    
    
      <category term="ࠇCpp" scheme="https://blog.l0v0.com/tags/%E0%A0%87Cpp/"/>
    
      <category term="ࠀMaya" scheme="https://blog.l0v0.com/tags/%E0%A0%80Maya/"/>
    
  </entry>
  
  <entry>
    <title>Maya CMake 构建 C++ 插件编译环境</title>
    <link href="https://blog.l0v0.com/posts/5875a169.html"/>
    <id>https://blog.l0v0.com/posts/5875a169.html</id>
    <published>2022-07-01T06:21:00.000Z</published>
    <updated>2022-12-14T02:54:16.764Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;过去构建 Maya C++ 插件是按照 Autodesk 官方提供的流程，在 VS 里面配置项目工程。 <a href="https://blog.csdn.net/hp_cpp/article/details/80265856">参考链接</a><br>&emsp;&emsp;通过配置 devkit 的 pluginwizard 来构建项目。<br>&emsp;&emsp;但是使用 VS 配置 Maya 依赖的头文件和 lib 其实挺不方便的。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/5875a169/dedb5d9005f1dff970148bf91c26311a.jpeg" alt="image"></p><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/5875a169/cfafe1377b6d4e6bb1382f53c76c91da.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;依赖和修改都在不同选项里面，配置起来要搞半天。<br>&emsp;&emsp;而且这个工程配置只能兼容 Windows ，如果我们要在 Linux 环境下编译，整个流程又完全不一样了。<br>&emsp;&emsp;其实解决这种问题，有专门的工具去做。<br>&emsp;&emsp;这就是 <a href="https://cmake.org/">CMake</a><br>&emsp;&emsp;通过 cmake 配置可以生成不同平台的工程文件，不需要打开 IDE 就可以调用 compiler 编译结果。</p></blockquote><p><a href="https://github.com/volodinroman/CMakeMaya">https://github.com/volodinroman/CMakeMaya</a></p><blockquote><p>&emsp;&emsp;这个仓库是别人配置好的基于 CMake 构建 Maya 插件的仓库。</p></blockquote><h2 id="Doit-自动构建环境"><a href="#Doit-自动构建环境" class="headerlink" title="Doit 自动构建环境"></a>Doit 自动构建环境</h2><blockquote><p>&emsp;&emsp;但是构建编译环境还是挺麻烦的，一方面需要下载 VS 和 CMake<br>&emsp;&emsp;另外还要配置好 Maya 提供的 SDK</p></blockquote><p><a href="https://github.com/FXTD-ODYSSEY/CMakeMaya">https://github.com/FXTD-ODYSSEY/CMakeMaya</a></p><blockquote><p>&emsp;&emsp;我这个仓库提供了懒人包环境，只需要配置有 Python 环境和poetry 库。<br>&emsp;&emsp;在仓库的目录，执行 <code>poetry install</code> 和 <code>poetry shell</code> 就可以进入开发虚拟环境。(注: 需要管理员权限)<br>&emsp;&emsp;poetry 会自动安装配置好的依赖，包括 <code>doit 框架</code><br>&emsp;&emsp;执行 <code>doit init</code> 会调用 <code>choco</code> 安装 VS 的依赖，以及 CMake<br>&emsp;&emsp;这个过程需要等待一段时间。</p></blockquote><blockquote><p>&emsp;&emsp;执行完之后 VS Build Tool 就添加到系统了。<br>&emsp;&emsp;但还是找不到 C++ compiler ，需要手动打开 installer 下载 C++ CMake 开发包。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/5875a169/911e11826073a3058551680de9aba826.png" alt="image"></p><blockquote><p>&emsp;&emsp;使用 <code>doit SDK -v 2020</code> 会下载 Maya 官方的 devkit 到仓库的 SDK 目录。<br>&emsp;&emsp;准备好环境之后，还需要安装好 maya 2020<br>&emsp;&emsp;如此就是完备的编译环境，只需要用 <code>doit c</code> 执行 cmake 编译命令来编译 C++ 插件。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doit c -p weightDriver -v 2020</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;使用 -p 可以指定编译的项目，-v 可以指定编译的 Maya 版本，默认不指定会编译全部项目的 2020 版本<br>&emsp;&emsp;-p 支持完整的projects 相对路径或者最终目录指定</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">doit c -p IngoClemens/weightDriver</span><br><span class="line">doit c -p weightDriver</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;执行 doit 的时候会用 python 识别将末端目录变成完整的相对目录</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/5875a169/12a58e2b26c25afaa90321434254ccb4.png" alt="image"></p><hr><blockquote><p>&emsp;&emsp;下面是完整执行编译的流程</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/5875a169/105b5139b33ef1c83e10c9a0e171243e.png" alt="image"></p><blockquote><p>&emsp;&emsp;doit 背后执行的是 拼接输入 执行 cmake 命令</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake -Wno-dev -G &quot;Visual Studio 16 2019&quot; -DMAYA_VERSION=&#123;version&#125; -DMAYA_PROJECT=&#123;project&#125;. -B build</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;DMAYA_VERSION 指定 Maya 版本号<br>&emsp;&emsp;DMAYA_PROJECT 指定 Maya 项目，多个项目可以用 ; 分割。<br>&emsp;&emsp;这个命令会读取根目录的 CMakeLists.txt 根据 VS2019 的配置生成 sln 文件到 Build 目录。<br>&emsp;&emsp;windows 下如果需要 Debug 也可以用 VS 打开 sln 去配置 Debug 工具。</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmake --build build --config Release</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;后面会执行 build 命令根据配置编译输出到指定目录。</p></blockquote><h3 id="中文乱码坑"><a href="#中文乱码坑" class="headerlink" title="中文乱码坑"></a>中文乱码坑</h3><p><a href="http://tw.l0v0.com/#%F0%9F%92%A1Vscode%20terminal%20%E4%B8%AD%E6%96%87%E4%B9%B1%E7%A0%81">💡Vscode terminal 中文乱码</a></p><blockquote><p>&emsp;&emsp;Window Terminal 默认不支持 MSBuild 的字符输出。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/5875a169/07a6a6d0ef789b42617075a90cb84b8f.png" alt="image"></p><blockquote><p>&emsp;&emsp;需要在 terminal 上执行 <code>chcp 65001</code> 切换字符集。</p></blockquote><h2 id="添加新工程"><a href="#添加新工程" class="headerlink" title="添加新工程"></a>添加新工程</h2><blockquote><p>&emsp;&emsp;如果需要添加自己的 mll 需要自己填充 CMakeLists.txt 配置<br>&emsp;&emsp;使用 <code>doit new</code> 可以快速生成 插件 编译模板</p></blockquote><h3 id="cmake-配置说明"><a href="#cmake-配置说明" class="headerlink" title="cmake 配置说明"></a>cmake 配置说明</h3><p><code>projects</code> 下每个项目目录都有对应的  <code>CMakeLists.txt</code> </p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置输出目录</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_RUNTIME_OUTPUT_DIRECTORY_RELEASE <span class="variable">$&#123;CMAKE_RUNTIME_OUTPUT_DIRECTORY_RELEASE&#125;</span>/maya<span class="variable">$&#123;MAYA_VERSION&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置项目名称 (一般编译的文件名取项目名)</span></span><br><span class="line"><span class="keyword">project</span>(&#123;&#123;cookiecutter.project_name&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加编译的文件</span></span><br><span class="line"><span class="keyword">file</span>(GLOB SRCS <span class="string">&quot;*.cpp&quot;</span> <span class="string">&quot;*.h&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加头文件依赖</span></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;MAYA_INCLUDE_DIR&#125;</span>) </span><br><span class="line"><span class="comment"># 添加 lib 库目录</span></span><br><span class="line"><span class="keyword">link_directories</span>(<span class="variable">$&#123;MAYA_LIBRARY_DIR&#125;</span>) </span><br><span class="line"><span class="comment"># 链接源码</span></span><br><span class="line"><span class="keyword">add_library</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> SHARED <span class="variable">$&#123;SRCS&#125;</span>) </span><br><span class="line"><span class="comment"># 链接 lib</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span> <span class="variable">$&#123;MAYA_LIBRARIES&#125;</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># mll 输出配置</span></span><br><span class="line">MAYA_PLUGIN(<span class="variable">$&#123;PROJECT_NAME&#125;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;大部分的结构如上图，默认模板如上。<br>&emsp;&emsp;我加上了注释说明。</p></blockquote><blockquote><p>&emsp;&emsp;<code>MAYA_PLUGIN</code>方法将 mll 的 <code>initializePlugin</code> <code>uninitializePlugin</code> 两个方法暴露出来(Maya 加载用)，并且将 dll 的后缀改为 mll。</p></blockquote><h2 id="用-CMake-编译-Devkit-的案例代码"><a href="#用-CMake-编译-Devkit-的案例代码" class="headerlink" title="用 CMake 编译 Devkit 的案例代码"></a>用 CMake 编译 Devkit 的案例代码</h2><blockquote><p>&emsp;&emsp;上面提到的 CMake 是基于 <a href="https://github.com/volodinroman/CMakeMaya">https://github.com/volodinroman/CMakeMaya</a> 的方案搭建的。<br>&emsp;&emsp;cmake 文件基本上是自己编写，可以控制每一处的细节。</p></blockquote><blockquote><p>&emsp;&emsp;其实 Maya 的 Devkit 也提供了一套 CMake 的方案。<br>&emsp;&emsp;每个插件都保留了 CMakeLists.txt 用于编译。<br>&emsp;&emsp;如何顺利编译 Maya C++ 的案例插件是一个好问题。<br>&emsp;&emsp;我过去看 Maya 的文档但是因为不会折腾这个编译(编译出错不知道怎么解决) ，导致无法深入学习 C++ 插件。<br>&emsp;&emsp;只能拿 Devkit 提供的 Python 文件进行学习。<br>&emsp;&emsp;通过上面的折腾与学习，自己也算是对 CMake 有了基础的入门，终于有能力搞定这个问题了~</p></blockquote><p><a href="https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__developer_Maya_SDK_MERGED_A_First_Plugin_HelloWorld_html">https://help.autodesk.com/view/MAYAUL/2020/ENU/?guid=__developer_Maya_SDK_MERGED_A_First_Plugin_HelloWorld_html</a></p><blockquote><p>&emsp;&emsp;上面的链接是官方文档提供的一个 Maya 插件最简案例。<br>&emsp;&emsp;相应的代码在 <code>devkit\plug-ins\helloCmd</code> 找到</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/5875a169/307f99197358b87b94dc4bb1629731b8.jpeg" alt="image"></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">2.8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># include the project setting file</span></span><br><span class="line"><span class="keyword">include</span>($ENV&#123;DEVKIT_LOCATION&#125;/cmake/pluginEntry.cmake)</span><br><span class="line"></span><br><span class="line"><span class="comment"># specify project name</span></span><br><span class="line"><span class="keyword">set</span>(PROJECT_NAME helloCmd)</span><br><span class="line"></span><br><span class="line"><span class="comment"># set SOURCE_FILES</span></span><br><span class="line"><span class="keyword">set</span>(SOURCE_FILES</span><br><span class="line">   helloCmd.cpp</span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># set linking libraries</span></span><br><span class="line"><span class="keyword">set</span>(LIBRARIES</span><br><span class="line">     OpenMaya</span><br><span class="line">     Foundation</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Build plugin</span></span><br><span class="line">build_plugin()</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;构建插件的 cmake 代码如上，核心部分是 <code>$ENV&#123;DEVKIT_LOCATION&#125;</code> 通过环境变量获取 Devkit 的路径<br>&emsp;&emsp;所以执行 CMake 之前可以配置一下环境变量。</p></blockquote><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> DEVKIT_LOCATION=F:\maya_devkit\devkitBase</span><br><span class="line">cmake -G &quot;Visual Studio <span class="number">16</span> <span class="number">2019</span>&quot; . -B build</span><br><span class="line">cmake --build build --config Release</span><br></pre></td></tr></table></figure><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/5875a169/237ae7978ede1e82be485148ff36e526.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;如此操作，就可以编译出 mll 了。(前提是要配置好 VS 的环境)</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>&emsp;&emsp;这个环境我通过 虚拟机 测试过，在 win10 环境是没有问题。<br>&emsp;&emsp;通过 cmake 配置可以快速构建好 C++ 编译环境，比起以前折腾 VS 来方便太多了。<br>&emsp;&emsp;利用 <code>choco</code> 来安装依赖也解决了各种缺库导致起不来的问题。<br>&emsp;&emsp;通过这个人懒人包可以极大降低 Maya 写 C++ 的难度。</p></blockquote><!-- TODO多进程执行 choco自动添加管理员权限 --><h3 id="2022-7-8-补充说明"><a href="#2022-7-8-补充说明" class="headerlink" title="2022-7-8 补充说明"></a>2022-7-8 补充说明</h3><blockquote><p>&emsp;&emsp;最近利用 submodule 添加了很多社区的 C++ 库。<br>&emsp;&emsp;clone 仓库之后需要用执行 <code>git submodule update --init</code> 来拉取 submodule</p></blockquote><blockquote><p>&emsp;&emsp;一些注意事项请参阅 readme 文档</p></blockquote>]]></content>
    
    <summary type="html">
    
      CMake 编译
    
    </summary>
    
      <category term="CG" scheme="https://blog.l0v0.com/categories/CG/"/>
    
      <category term="Maya" scheme="https://blog.l0v0.com/categories/CG/Maya/"/>
    
      <category term="C++" scheme="https://blog.l0v0.com/categories/CG/Maya/C/"/>
    
    
      <category term="ࠇCpp" scheme="https://blog.l0v0.com/tags/%E0%A0%87Cpp/"/>
    
      <category term="ࠀMaya" scheme="https://blog.l0v0.com/tags/%E0%A0%80Maya/"/>
    
  </entry>
  
  <entry>
    <title>Unreal Python 导出 MetaHuman 控制器关键帧</title>
    <link href="https://blog.l0v0.com/posts/1b238b83.html"/>
    <id>https://blog.l0v0.com/posts/1b238b83.html</id>
    <published>2022-06-24T08:57:06.000Z</published>
    <updated>2022-12-14T02:54:16.878Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;MetaHuman 已经在数字人领域里面相当成熟的解决方案。<br>&emsp;&emsp;并且 UE 官方开发了源码工程。<br>&emsp;&emsp;目前 github 上有不少人演示自己套用 MetaHuman 动画的效果。<br>&emsp;&emsp;于是我自己也尝试着想将它 UE 里面的控制器动画导出来。<br>&emsp;&emsp;然而却发现行不通。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1b238b83/01.png" alt="image.png"></p><blockquote><p>&emsp;&emsp;它的控制器关键帧是在 sequencer 里面。<br>&emsp;&emsp;最初是尝试将 sequencer 的资源全部导出成 FBX。<br>&emsp;&emsp;然而控制器的关键帧并没有跟随导入到 FBX 当中。</p></blockquote><blockquote><p>&emsp;&emsp;于是我想到可以用 unreal python 读取关键帧数据导出 json<br>&emsp;&emsp; Maya 再读取数据设置关键帧到控制器上。</p></blockquote><h2 id="unreal-python-导出关键帧"><a href="#unreal-python-导出关键帧" class="headerlink" title="unreal python 导出关键帧"></a>unreal python 导出关键帧</h2><blockquote><p>&emsp;&emsp;有思路之后就好办。<br>&emsp;&emsp;之前我也写过脚本来获取 sequencer 关键帧的。<br>&emsp;&emsp;需要注意如果想要使用 unreal python 的 API 需要开启相应的 C++ 插件。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1b238b83/02.png" alt="image.png"></p><blockquote><p>&emsp;&emsp;否则 python 会获取不到相应的 API 报错。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Import built-in modules</span></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="comment"># Import local modules</span></span><br><span class="line"><span class="keyword">import</span> unreal</span><br><span class="line"></span><br><span class="line">DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unreal_progress</span>(<span class="params">tasks, label=<span class="string">&quot;进度&quot;</span>, total=<span class="literal">None</span></span>):</span><br><span class="line">    total = total <span class="keyword">if</span> total <span class="keyword">else</span> <span class="built_in">len</span>(tasks)</span><br><span class="line">    <span class="keyword">with</span> unreal.ScopedSlowTask(total, label) <span class="keyword">as</span> task:</span><br><span class="line">        task.make_dialog(<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(tasks):</span><br><span class="line">            <span class="keyword">if</span> task.should_cancel():</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            task.enter_progress_frame(<span class="number">1</span>, <span class="string">&quot;%s %s/%s&quot;</span> % (label, i, total))</span><br><span class="line">            <span class="keyword">yield</span> item</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="comment"># <span class="doctag">NOTE:</span> 读取 sequence</span></span><br><span class="line">    sequence = unreal.load_asset(<span class="string">&#x27;/Game/Sequencer/MetaHumanSample_Sequence.MetaHumanSample_Sequence&#x27;</span>)</span><br><span class="line">    <span class="comment"># <span class="doctag">NOTE:</span> 收集 sequence 里面所有的 binding</span></span><br><span class="line">    binding_dict = defaultdict(<span class="built_in">list</span>)</span><br><span class="line">    <span class="keyword">for</span> binding <span class="keyword">in</span> sequence.get_bindings():</span><br><span class="line">        binding_dict[binding.get_name()].append(binding)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># <span class="doctag">NOTE:</span> 遍历命名为 Face 的 binding</span></span><br><span class="line">    <span class="keyword">for</span> binding <span class="keyword">in</span> unreal_progress(binding_dict.get(<span class="string">&quot;Face&quot;</span>, []), <span class="string">&quot;导出 Face 数据&quot;</span>):</span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> 获取关键帧 channel 数据</span></span><br><span class="line">        keys_dict = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> track <span class="keyword">in</span> binding.get_tracks():</span><br><span class="line">            <span class="keyword">for</span> section <span class="keyword">in</span> track.get_sections():</span><br><span class="line">                <span class="keyword">for</span> channel <span class="keyword">in</span> unreal_progress(section.get_channels(), <span class="string">&quot;导出关键帧&quot;</span>):</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> channel.get_num_keys():</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    keys = []</span><br><span class="line">                    <span class="keyword">for</span> key <span class="keyword">in</span> channel.get_keys():</span><br><span class="line">                        frame_time = key.get_time()</span><br><span class="line">                        frame = frame_time.frame_number.value + frame_time.sub_frame</span><br><span class="line">                        keys.append(&#123;<span class="string">&quot;frame&quot;</span>: frame, <span class="string">&quot;value&quot;</span>: key.get_value()&#125;)</span><br><span class="line"></span><br><span class="line">                    keys_dict[channel.get_name()] = keys</span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> 导出 json</span></span><br><span class="line">        name = binding.get_parent().get_name()</span><br><span class="line">        export_path = os.path.join(DIR, <span class="string">&quot;&#123;0&#125;.json&quot;</span>.<span class="built_in">format</span>(name))</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(export_path, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> wf:</span><br><span class="line">            json.dump(keys_dict, wf, indent=<span class="number">4</span>)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;上面的脚本会定位 MetaHuman 的 sequence 资源，然后导出关键帧的信息为 json</p></blockquote><video src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1b238b83/meta_export.mp4" autoplay="autoplay" loop="loop" style="width: 100%; height:100%;"></video><blockquote><p>&emsp;&emsp;导出会在脚本目录输出两个 json 文件。<br>&emsp;&emsp;Maya 可以解析这个这两个 json 将关键帧设置到 控制器上。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Import built-in modules</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"></span><br><span class="line"><span class="comment"># Import third-party modules</span></span><br><span class="line"><span class="keyword">import</span> pymel.core <span class="keyword">as</span> pm</span><br><span class="line"></span><br><span class="line">DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">progress</span>(<span class="params">seq, status=<span class="string">&quot;&quot;</span>, title=<span class="string">&quot;&quot;</span></span>):</span><br><span class="line">    pm.progressWindow(status=status, title=title, progress=<span class="number">0.0</span>, isInterruptable=<span class="literal">True</span>)</span><br><span class="line">    total = <span class="built_in">len</span>(seq)</span><br><span class="line">    <span class="keyword">for</span> i, item <span class="keyword">in</span> <span class="built_in">enumerate</span>(seq):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> pm.progressWindow(query=<span class="literal">True</span>, isCancelled=<span class="literal">True</span>):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            pm.progressWindow(e=<span class="literal">True</span>, progress=<span class="built_in">float</span>(i) / total * <span class="number">100</span>)</span><br><span class="line">            <span class="keyword">yield</span> item  <span class="comment"># with body executes here</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            traceback.print_exc()</span><br><span class="line">            pm.progressWindow(ep=<span class="number">1</span>)</span><br><span class="line">    pm.progressWindow(ep=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line"></span><br><span class="line">    <span class="comment"># <span class="doctag">NOTE:</span> 读取数据</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(DIR, <span class="string">&quot;BP_metahuman_001.json&quot;</span>), <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> rf:</span><br><span class="line">        data = json.load(rf)</span><br><span class="line"></span><br><span class="line">    attr_map = &#123;<span class="string">&quot;location&quot;</span>: <span class="string">&quot;t&quot;</span>, <span class="string">&quot;rotation&quot;</span>: <span class="string">&quot;r&quot;</span>&#125;</span><br><span class="line">    status = <span class="string">&quot;Import Keyframe to metahuman controller&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># <span class="doctag">NOTE:</span> undo 支持</span></span><br><span class="line">    pm.undoInfo(ock=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> channel, frame_list <span class="keyword">in</span> progress(data.items(), status=status):</span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> 解析 channel_name</span></span><br><span class="line">        has_attr = channel.count(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> has_attr:</span><br><span class="line">            <span class="comment"># <span class="doctag">NOTE:</span> 处理 `CTRL_C_eye_parallelLook_4311` 格式</span></span><br><span class="line">            ctrl_name = channel.rsplit(<span class="string">&quot;_&quot;</span>, <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">            attr = <span class="string">&quot;ty&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            parts = <span class="built_in">iter</span>(channel.split(<span class="string">&quot;.&quot;</span>))</span><br><span class="line">            ctrl_name = <span class="built_in">next</span>(parts, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            param = <span class="built_in">next</span>(parts, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            axis = <span class="built_in">next</span>(parts, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> axis:</span><br><span class="line">                <span class="comment"># <span class="doctag">NOTE:</span> 处理 `CTRL_C_teethD.Y_4330` 格式</span></span><br><span class="line">                attr = <span class="string">&quot;t&quot;</span></span><br><span class="line">                axis = param</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># <span class="doctag">NOTE:</span> 处理 `CTRL_L_eyeAim.Rotation.Y_4387` 格式</span></span><br><span class="line">                attr = attr_map.get(param.lower())</span><br><span class="line">            attr += axis.split(<span class="string">&quot;_&quot;</span>)[<span class="number">0</span>].lower()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># <span class="doctag">NOTE:</span> 解析出控制器属性设置关键帧</span></span><br><span class="line">        attribute = pm.PyNode(<span class="string">&quot;.&quot;</span>.join([ctrl_name, attr]))</span><br><span class="line">        <span class="keyword">for</span> frame_data <span class="keyword">in</span> frame_list:</span><br><span class="line">            frame = frame_data.get(<span class="string">&quot;frame&quot;</span>)</span><br><span class="line">            value = frame_data.get(<span class="string">&quot;value&quot;</span>)</span><br><span class="line">            attribute.setKey(t=frame, v=value)</span><br><span class="line"></span><br><span class="line">    pm.undoInfo(cck=<span class="number">1</span>)</span><br></pre></td></tr></table></figure><video src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1b238b83/maya_load.mp4" autoplay="autoplay" loop="loop" style="width: 100%; height:100%;"></video><blockquote><p>&emsp;&emsp;加载 unreal 导出的数据。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>&emsp;&emsp;其实整个流程不复杂，有思路就很好处理。</p></blockquote>]]></content>
    
    <summary type="html">
    
      python 导出 sequencer 关键帧
    
    </summary>
    
      <category term="游戏开发" scheme="https://blog.l0v0.com/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"/>
    
      <category term="Unreal" scheme="https://blog.l0v0.com/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unreal/"/>
    
      <category term="Python" scheme="https://blog.l0v0.com/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unreal/Python/"/>
    
    
      <category term="ࠀMaya" scheme="https://blog.l0v0.com/tags/%E0%A0%80Maya/"/>
    
      <category term="ࠕPython" scheme="https://blog.l0v0.com/tags/%E0%A0%95Python/"/>
    
      <category term="ࠃUnreal" scheme="https://blog.l0v0.com/tags/%E0%A0%83Unreal/"/>
    
  </entry>
  
  <entry>
    <title>TA 工具人知乎分享</title>
    <link href="https://blog.l0v0.com/posts/4831b5c7.html"/>
    <id>https://blog.l0v0.com/posts/4831b5c7.html</id>
    <published>2022-05-13T07:01:29.000Z</published>
    <updated>2022-12-14T02:54:16.931Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="抱歉, 这个密码看着不太对, 请再试试." data-whm="抱歉, 这个文章不能被校验, 不过您还是能看看解密后的内容.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">您好, 这里需要密码. 提示(神秘号码 + 光子)</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="fb2a28db5cfcf9c9721b69dcf0363b14040b5af44b27fd3fff3b68c3375036b0">8fa7d4705a9ea2d031cb386fd946285e6e06572cf6c48f20e4e93f64b126b72db6b7070420aa236602175645bb6952c708919e626ce7b5e4c9c2ce5233d6ca9453e4f985eb5743e515e7e935ac25f512d0f37151972dbb079320ba80baf7dae7ccaa2eb91279dadf7fae0cd4262f09e41d57257560714d89b9af184023b2489db4bac09dbd48acd6b62afd5caa56a00f6f79ea0af9ac70c063e872bf819a68a2f89eaf8c81a21e51f6ab1f3a91025894049dae0b604fa859081918fe71a35ae052db98ec94da9fc5e86e3b1c47227fdd244f77c5d59986005ff1b37286a218081a45349fb7adfb304c0003889441cf65d8496fdacb5ae626f86cc705c44ec6dda6978212ff1f8765b7703603ed6a599d0a93ffe9f9dfd4e7c9dad9e0c7fb3209cff2d173b0d26a14698b982aa16795ba1c9c4e5fb82e68ceac65c9880efd73f864cc74b71e289cb8746e0a31a88c699d10061e0f6116f89794b6d9354c1efdb850045d101d9e0c030a24efbb7477eb2becacec083ee04f093825fd6962f4317a4b3f553088968ef83a4a75d513bf33b67661ed7de6d6c3031b951e520bfd77cb56bb9e19e51b9423183a90e7d1f5f075f485c636dddd9a8459cfcfe2cadd1650faa702db0d76a330e4a290c8f0d45b5722f9c9c96832eee831e28401f0b6c37dedfcdbd5bf55163e425cd9bf30829fbf0df2cc1b800ebb507259c8b3c9a75fa762ef15d114128837d20e3580fa42e53ce665aae00ab344918af64b2367c6392988deb437ee90ee6b4861b478d04d26e52d7961e89a0e81ca50a7dfd02e120efc9f512509787e17233ec1ff4beaa77529df7a8386a41408d9a844c5cb821b5aa53a5b8cae826ed484ea7c6da24779a250ff142c7ad81c297c5da0ba7f3d28c2a3e2bfc2b03f202bfa704493dfbe15e5f26507c7b0f457bf970078dcd18ca628f22e077502247056c2a1d4b9fa49bc2d351911658c42055ad7565dbbea5a31951b8d57dfbaf4ddebe35f2955d7f432061e053534991dc4b5a2007744109cf95db12d1dbec4d2f1ccadd86e00ecca3c715900d4a3d20a0a2473f286a19338cceb8fefebccd22d3595c47ae4e16e5f765465d5c2a40ce91ff17956dd0d7269026bcfe8f275d7a567bf1ab90c42604644ff7739a7cf8480c886a41f366d4b3be977984df0b5f62ec74ca8b5f0adec0f87056981231c0bc1ff80c9bf140de1e145d4dc1f67fe16ee20e42393fd17123ec10faae3eedbdf412eda34476fc33865ef5e75884850c9b298b08c634770c1200719f2e1b8581a72d3b5c0ba3b36c44735a7154105c1840e67ebf48ae8218a48c50d2a7544069871910348093c1c2daff52d9eaa1979a0ecb8b45225a853788add60a2065357de2ac4b9ebd2bdff6ed6ac397d79a90f131f5f25cca4c579dfc98b42a6b1f7baf9ac75abda0d30630c9a4593d0dfbf5e6f5abd72067cd3c0b6d866e58e9c8f3512b3021df06db8d5136a3a71aa6fa09ea53b22c0bc1b7d493e5c7c5569134a48104d5a733893b69f906eeda936aae13aa421517613df2efb8ec05760c64d9160cebcc2397c87da19316b5c1c6f8bdd75939349208d5ddbbc914cd55ca6ae18cb4eaf00586fbbcabada19aa2d838006b21e01ce6248498a5156a20771d48f782aae443a190095ca944bf566c764822bd990184f16823098204ccbb28cdbf0bc2a29df18a50a2fe0db80c4942bf1a68bf016a402ac07228be42d7963f88715756b5259c186bc06bdd8b85ac7dd7351d0588469710d479fccd5f861bddc58a185ae32af2ca8ed902f520ccc2d3eb89d704926d18b4ad2a236193b964c3926164848442597d26069fbbe6f62ed84adf22eceadbbee7fe316f66ca213bcf2aa4ab1ec4eff93aa7ed8bb3fc4d8642ec387641b70b5638696e8633e0c33fd32c314cb3a555f6585477e35832d241472a45be77133edd20344a06e3a4d048387521aff1f9b32b2bf9ecd118618d7574d8e9c6084e2247891c85f365a1d76356bfd1601f5594435e2772d0d5388dfaafa2593b6f6ba6c62cde9ef6322efa8e906417bc9c5fa63a3172c57a7f8150376517828973f43a387447cc8418510ecd7b7eb755940902dabc5fa709ba77ea0ff0319c20826362ed3bb3f08b833b5e81f6f26507f18ad5dd7496eac072c81bac588ff3ad1a05ac184b1a34653a710699a042fa49c470a9302c696580049c0dd76764eb7b92622039b18f232b371bd2b98a0a9c3c02a55c27ffac699179091e4e1baaee1c350e5e17fd7cbc3ad1a7a1c8a47f7110270f841fc0ef62ae25c2b208ddfdea840c9e68ac15eae56377d2aec241f1b6a33a769b5834ab19ba87e87ec66f54df90f1d2bccc32ac9bd47b19b6e91e095c6ce0a080448abe58ed75e6fd658259a4a9bdf6d0a62247fcedd35137c402443c9a8b567480658522ff0c5bc84daa9bba58738ce29e8bf3182872d377b8df42d429dd451d8888aedc99ee256a5d51324c248f62c25b4fdde33968c9f5988ac211af6946e5c669fab6e3b3c2eac93d9c25073de7cf611da967574d0418d71e6d26903a64b3ed2503116d3ba620ccf937acdc99f97358d01d7a6ceaf8846f1fe47923534c0656cd38730ec02d3a0cedf3354df80cc08abd6fac6bd4c7b2a9a1011a22b1f319bbc27b0f42f8ef8c92e39c81432549c73ba3d14ed0a100cb7ef63ab3d77811758f63a45e15794a10f762ed897510b8f818fc224c3f894d88951eeea89bb5c4802397a28280351e02cd6718364b5ac378826283619a425225c59a428cb714cb8352ced7d4a60cf591b59222a98374e6e2b95077b398dc5491ddadf129dc6116cf888e9d5b89de9a266cf5e041e157dd40d8f985569e9d02edb4796b38c83ac08f75b4fa36a1a0f6689496b5f42b1cada3acec32db498cc8777c63c5c778508fdfde422d8c69900685391869cb8dc684527a650d53c12c38345eebfb48a80d223da4bc65eeac5e6f1bca6293a514207ac8b39ac9fa5981aafad0c9773fe9fdb70f9084320a923ea5ca9105c8110bf360466c64c5b567060e6cb45503ae75c20b12a1ad93e4c0a3f08e9a267da59b8a1dba01bebe51c67f1051699513e52360f30fc1d83f3b32142910fe1fc3ad7f3fd0f7125751d533a5064ca4bd9998336809a992fa7b894103603884e8ebf3029a43587c66f81f5b5f0e4f1c635ced6842a042a807456f956be55d88cfb72ebab0b2ad14ac5ce7b412c739ee05fe845ba9b30b9aefc2d760fb2e1f7e1e3d7da54548ac1dc7255b590fec949885ae239fe529b0cb798f966b30e6e279146fe4fc1ccaa6786167cbcfc734a7055915a767340cb15955dac6809199b407eae57c775b999b982c765926862e5a478f17e33e9099ee21d01ac33ca7419621d0243ac60381fb529896246c2ccecb0c7e4252c8f8da1278cfd82970698a7aca505d7d5f0831f4665f48cf8a02f3040c133837efdd05173c4a5a5cfad1783aa3c21bad167a88414a27747fa68786a037f6f9201644612cd515294d3f5641d24e749ee39f86042aa93b301fec4cfe4df2ea2f7cac4b9ec942443777e17ae2b2bed3a04f31c92cb3a49df11512173597affe9790c85a0963d74eabea4fecdc8e9c7423f0b98ead090109ccd786a574e52777569a7018570d5d1b973826e4607362a9c102e9f96eea5a2dbc68ac24fda58ce49fc39ae06b859fd175f6289bdf37f033b3e27215545a0b1c60756154471003e59ee4d6139a9bd506149d9e84163407b60f489d2b2927baa171c27525437d8a0960612c11dd56b0c8b50bd78dcbd1ac513f3c806304a1434b6659663d3d59fabd4f5395957261a4b63b03541288f04aa4dc1f05a39518b213bcf09dc801ba4a402fa3b5f168d09292a77aa78a4c3140580737c7e5f4442c5477987175acf6fd9c57834177f11e90a88d0536b13f31100f697710d1e8d731d352b73d5e75f3b35fd334ce927f9a3794a6c88d709d3824c51750a215f4c19529d89fe077ad9c6b01c2319ffff7d85f710272fc620c82090e1c697343389f71a6576beea4911cde87cf0411c8dbdb7db05252109b21e7fe5e402c07e5b02aa42e8a074ff3ea0506e927a633855cf3847d90c9b78ddd67d3e6a7184346dbd1c4ed25fc61a5d01e76f0e2edcac5d12ab1f912e4900511d7c7df8ef7730638318d25300018bbbbde83f3e5686282d7b7835e459bda0ce31569449a873a51dff65955942f1f3a270b7dac3238d0031851af179ef39bc140b4d715d6a5484f40af20c8feb2d5035f70f37524be26a10374f93870c405bcc696700ba1e509dbf0e24a840bc28c746596079bd8feeb67a4d933f9f4691e7c131d43f6f89ce0a799b1134b8201b4f3bf0969446926b525542d774b1616fc344455e78240a0bdd13576198d950a0e62d84fb0a488e34c90a7322bd9d6fc4f54d0526b238c0395811b21e2bd51ca6ee7dbba677406239d848c2664821b2d978d910f8e105ac780b9c126df7498eb4aad68b431fcb16a023a1b072b4367881de98c9592e100af419922b3197a34e8aa1487ee91c079c915751f9317904f52bc1ee827358a5c6d1c6090d63397ea1c3c49454d1c49e7d0f8ccea1dd319dedc8075a0b8ad0b094d14c925e9c778fd5601e180cfe6ab550f9362babfcf7f0d041038f6b1710fa4d0c8cce3eeac02246070b47e8ac1ad2606de8ae71c89a416affef37d087fe187d67b9538564b9524fa3df08018a88d9f46ecf1c5140066697c5841594f4702c93dd73ffc20eb824b8ee73461427c620d80716cf143f6d935f886ee7c8d4285eb0850bc546700906f9ad3ad4f6e48c1b66fa5ebd75a95a13c56b0838efb3ab1c59e42301bf10f673024e0533c4a1f99b560e15ebd9657a532860f8917dd8fb9a05f9030d0627014b26a6740494cb2fb90ffa5c53b104596d76107557e12fb8b310e74362e70c4c207b28e172bac9592b3cf8a9bf06f19e47ebb08e41bcbd1a1abcf931b78bf9c137289e1bc5bda8d3c316b713934ec9af620b63fa823289ceef2482c0d0e657b81bbb05afd4755d6f41a93a27ca1fae71c52bcd5c7a84770423204d918de498a78cccb07a129b3ae63ae5d49ebf3e934e084e9f84220f6859d679a98c3053ca81243bd2bf9f8b7b8639eaa8b94239374e0f65e40581bbbcf0ab29def2808900c12378add6ea1c3884dba3dc1a9abf94417f34b539129e8eb2629544771fa32d261676ccf605d389d46152681d30900d4bc1a2221e1509a789814cdbf823015de8e5ac05ae280f7d72085806e8067c9dacf7903fed4569efeef1250e8183ac9238fd8b0dfa7f74a0b462860c47f986a9af2bc57e8081f4af248fff773a91d3a39c2efb90824cbdc1d6898630b6e456d3ad03b258c78240713155e89f30b57d2cdf65ca9b07b04338b378eaedb594fa971aa6e34e4206184288e281ed9d6bfd96b97ce510ccdcc5c5eeebe4d004e1cc999cdc0a71405a0b868475b91978a88115b2df1487ddd25bedab60596e858e8bd1200e28b361c58b732b220e5594cc880d2fb16c8f64b80f68f8bba3f14343c2ec9064c64ac148da0259091446b7c520baa32f2ad9eaf57246225e6bd01a726b8413dce00245473c9f8f91f4db3cdd0cbdc643cadad1994fde266ecb8cb9d7c0a72efab8a6011d8c29b9f31fb8ed25d72a63e13ee7b2858707a6c8cb611b57ca79a217ecc52f2a996c54f959cd13dda00148525ece56d5c3f601cb64d8dbe4755a6b6b7811b4525960df0e4bddf59e8b5fb22c8a5f4d66cfd6b3d71a99927f2a6b394f11c08aecad3898859b2a000e8ab8b1d5541b2d1819c1f389d8b58cb14a848cfa17fc5304fc0041857048f9c683ed3a9656777b60d1171903d4e27b7c727c30b55c8c81b571b6998195642d968f78d1d299c23274ecb752241677c78cd2ec822f7f35912ac028db6f125bb8259a2b603626819a4bd1792cdfa31e099533bdf7456d8b73bcf06f38c2d35125433f66a5b6ccb51128b38079168bc6f90e506861bafe3c5bf9a33277d688ec9aecf4b04c59527f6be82d854eaba5d49b79368b435097168c25121f66638fa33228c484352adc69a07955cd29db03fdd5dcb99fbaa9ec9293c1040b1a933da8dd5161e1c165dd6d0b0082c3c077f076fd46991db5726b91f0d360e2d929e698e0d09d57aa83c412bd04db6b6fc3b772d0606f9b8e9b9bd90a1423db27def94d07fdfecf632cbde3cf2e9d3f080801a04e1ec111c4996e7e7c0fb39b03262388afd6f4192852987fa8c39a319680f1a2a059fd58d2a85c9191287d34eedde8ad7b32b4dfb2b17b1737f7085daaadb7d1227dea0c581acf07201aa02014b934fcddfd7834217537f2ab8adafe5b817fe994b49aa8692343cc7fed84e2ee2dc3fe9171ab6694eb65ee2c15e6a463e468e887570b90f0fb016157fb36a3e5c71a55cd46a09af7232129a2a61ad34673c580c3ae990e881337fea4f04c1096718af3d607c4c4923b0f95fb5f15d5df5b8de95871d708aaffe34ccb146d75561d4ba8507d3e5865316a17d84c036870f744d96151098dad673071a39ea8adf73a1793b617de4a65dac6e63f9d962c9e187ebc8d9772f39064198d6abcccfbde981077a7350d8dd82ec3136a8abaade9b8a36e43e96e12aaecf2f03d7be622170caa8359d69c1c2a71bd21b9b24da721cf0c3e7f695d1cab162ad57b48a3a7a01ffbe5723ffa3826d135bc27e05e57029066cfe8c19427fea48b65fc0c7215dbfdc72f1bcb52db4d1c5a01af1384bea939d9855c39b15b504671290d20ed1fd9efa9c879ccd5dd4d8c4d9ea180565318c77a3a6dfb0a16c14b382cfbb64df4590bd2a3b0674ae7f9418a8f28ab0bd3158ac16421bf144c8c894c64931625365dd006ef22c29b93d14c22babee0d1215538d04a4fae6b534d664e8e8326232d4a985ac1e1f49a717c08e04287d774f395ac12fe3c8c1a6eb766fe3ffc0641774d6ee0b8cf2b59c72e86621f2a790e06f0069b234a692211a357b8c22185cd70acc53856e27ce3bb54b83564cd613592aa74e1b647991a5b6e8e75a5f3571da05fd798abc6c130373fb0f0dbec756d02f827567f0d1d381d60538fd3153c66d56b012050782b1b6de7d6d216c33758a2f7d3780eff6d9e3e1a5adf598a54c9b3cb1f3d28f707766fb7276d1d2c39bb40423648ad239c1c5848d74669af5eea35e914993258f4d6aff95cc7f521eeb1d99b6bdae3cac8e786af29d445d078d19465b26e11e427f2deb7f138a8ab630d1d8fdab636c64b1e3241b0a587e8200530d7ef164c7f9674f24d410c2db6cf556e15029834a7f01aa4b563d2e91fe066ab1d89a373f313432f3663fea34caeb0009ab267d81d8bf003ebf727b552fdbe6ab882c8162e4a4cf589c2243fce3b59d6985621b3ca88d3c8aa7fc8e50c52e5e9c61ffc6a2c910d0deaa7a03f50d68652d0c5b0a4a0908637f93257791c2a872f72f37c27912307e53b5e8385c9ebc6ceda46db959ecb37e565a30b7c5352c87520ac6b2542ebb6ec39e5d0107fe2d833023cb8c9d7b1320ce7b15a41cfdb7bc499938b05178facf71e7c52a88a26e9e44af7674c388267c95dd2547cf34848954d73862d06985efa06c1bcc82e12e4f0ee3ad0481c7b32c77226ac6b5f025fe17dd47de3201d3b25b6526faecc51ef230f028de0df3246615056ea4ca0d901db7ed4e9402469785f7b3416ddd66fa747400929cabbe77d685f24c9c488cea6ce9b1d56c6c81d9396bc15d9d194b5dc37d22d852d20b19a74818f9a32c101d1fdf373ceedf33c99cf6ff5ad64d8c09d77d780c87c0bd20c672fc1e91e6d4d055130b4d42744c903f640db33a2f2f8397518269423175a251f51e810007eb7bb95a099d0364acb9c6f96acfdebf569d0c3d572a406e544702ccb9be27036b325cbd7dd75f08fb0ca2db5d8f65291f6d1dcd9dca4ccaf3de92789b2fb5eeac1a91f56b61fe075a81e6499a7cbef9c3e59ba91ed5fed565a80cc307805f1dfbadb5ebb0cf38ae656f3ac4cea27c2de36c88b31e9e2e7bab92af0fb6b8b04b1efba530781cce6e49deca95172e286ecf324cd1785c2a4d5439d9becdd276fd464e97df27554f6b7e508a35151afb06d5c8113920598cb72bbdd6cb48dd3ad6cab309091b84d4524a58c262b713f459228c424e0fc2340f2e6ea8f6de06186f9e6d1392b56eb35e5093475304c915f4b89d05bd05b23290f2ed3338e09725dee38e109eabcd92168db4d319df75b4ec0a4102a9a806a177bb4e8f1b25e841f4a9cc6621373e89c6595e5f51e7cf1b91cfa58c79679cd653782ea375abbd3223ac1b7b36a4450009883a009a2ba0f44920284026e7a2030882d1c62c4bd0d40643fc7717e708bd78b43b71a65af1ee58e973dee3f70dc32c0663e2636ce28f571beaae7c17699ac8ca802bb29ea2b63c5f26c487ca6487072cc0fecf84ebb7c5d088aa00a218d4548c0c519d47495187b0f062b83630218090c1a68a704118528a225e1d52ddb09ab074e2e1a85170175c03107266ec0fe4c0b6ef3dab705a21d96aa989bbee153b35fcd8d6dea8cf925d7f42f89233e11d72facf4017ecb423b2ecef55c74e109c5fe9a85387d58fb8c285c84f8daa6c9be94080799309b12e65a7b3f4ad911e3c281f0b54db5a579964ad742a248a90056e344e2053d5d919114d3e40378a8db5c8423e177b1ee429ebfca4946b013c79d6a743e5448f6b88a4708d399e5114a6e0660a5d7cf354cefd285c1aa9fcb8d25543f51e32b71656e4b249fe60cf248e98f72d1f661e80cfe54511e7fdcd00f46dd2ddb7b3f9aba026bcb68aea6821703b3dd3fb6b64507287fa36e29afa28a2e1c069ba4d21d1c067376c67fff08105d14204ee472076ba990c4f8652cecc1855b1145503e12e3b07b8db10d468c07fc9ea7fea0138f33d3d13e30e16801330caa88c23e961376390cd390975472a3281f12a59992fa356e8bf97e67f71d64ed2dda7df30d27eb507cb29570beb41d47231ff837669683c82bf0753e8bc9b7e8ac8abdde1cd794ffb838bedcf52e12b789c93deb35e4daa109e07c1306433f037f72d83656dce0ffe1672700812602e988162c9295ca31dc6ab8f0d493a918d4b5bcf7ceb95cebeb4edb295db614b327ab28608fb25f24bb144022a87e66ae43eff370eb302de6467dfcfbbb8329a7aea1676519dfe3114c1ea6668eefe085491325d825d4556daaeccf428e069ad24e5a8e113947d6d19ba72d82ea7fbfea3871c077057674e6a3cd04c467b3c32a8d40d212f975c7003ab81be8c2c827eb1c74756cff558dac3cc13f99017bb1604c6f38888d663fb3a7a96685c862f81b2434c84dd6ba083698d3f2dcb9a4a629bff2120c8cfb7e271844d8e57f5f4cacb7b1aa9394f9980b7775ee24487fa46ad100a021017fb222fcd7cdb4ddb80bdeaee7e64bd954d3822510c61bd38294b4dcd55e175ce231c86419a0ad44373870a795174b15cb6e1f6cceb4e63eebc5bdefea5fed59f253af69bea6e033247c1572c40b47e2792f8d34e34be8f7d90f340a8a7afbc1a3fbb555cb76303fc0527fb993df76334b3887fe613b9573ee12dffb1dd7ab6715eeca5f4f28ac9fc71f08d2cbf98c989e5d5bfaf44a0519c8b9925dd42dd2136e90f2278171bc037ef4c4a1121fd4c616aeabe0aaa02970debce08a97454b5c0bad33e91255d0ab7f44b71c9aafdb37b7365d294db5c6175ad7cdc3d396f65a1b76b3fd0388eea8b8c5e0eb8a1750edf4c16582395da5207b56225fb375d25fe21226647e6ddc0141f7a475bab6781a67065b73e4f6ca2469c20c4d0f3fa762a65d6d61f8bb5060666fa3aca71b0ca682853f259490bfa14520cfd136415888f3034bfb928af4ba16831c4420c25c73f6e51083f6d69e48633bde32b396994e51bac0e5395c00600282e6ceeabe622d315ba7d6f8cc5bbdb49e38ef4e6884ee74a2eb6e0b4688f87da223ff954c8b3ce05f858cb8ff5ce63c3450d8ec8583db7387be852975608e409248a9538980ab20ad8da5344ae3855be2188ef086c94861e3db46c2e65f84bf9f965c168c45f4acbd20beec8f0e2183c8a471a4f38b38348dab3900858e050a4f258148e6184610596334d10382d150cfb4ab54e98051509ae67e87ced0ca6b5eb1cff3c4e1866bd35fec02efa96cd688a59faee57ed1f8b95c21d5e6eca42cb2bb1871233529c4af1eabe79ccdbec8f41d7d0f18378e915ceaa8dec08a148c55edc2f0d6e169e83d36d5577d278b424a433fb2ce6fd3a2ddc9c60bd55c3fcf1e97abad7133c90e3578851a9ae898a6faff8b7788edb76df7c43afbe799a519fd864c46a8eb18ab9bef622969e8e82387e19fa551e7c9ec609c0bb248f796287591c8bd70423cef929028f060ab5c34d273be15408f4b474b85537bb4d27868324bfc52428b454e773d8111bb45bcded7fcde6d9acbe2facc6192fa483b2b2096b868a614382d331f756c08dfe70e2910b0f767778545ad5bbb79cac49b79cf990112f2386036fed9435c7972fafcda30418161eaa68a30f527f1300e3b3a1842aec219a015e8cc2a03b5fcfd2b9b3ba782be8834d91490c243b0e0b984276cac82406897338db70fccf15b42a58cab504cf941194c25b29f199adea59954cb41a3578d6bc23bc2beb5e142ddf587246f77f187c105a4176a8bf78a82b068441a2d51a17af44e7241dd313ec6516f8ff6fe3c6f606cfa917de6413fb4bfaefde58eec54469aff9b6fed5d8618ff19f29a827bbf576f05351df5611f8f3d4ed754b5acc13bd7bb1962ea7deadeb02423ca604f63b85132de332349336cf75d4c4652343dd14536707e3fb4d4fffd1393425662016adb4fdf2eb0a24dccf75b24a075d2b230028b08c29822a174edf14f9349d1b2b48e80b5643836f33b199ca535d1a0fceb8f63d0e8cb1281c134456224681789e271add11650763db2712f29f3a23ca1cc845549fd77f3503c7d7f1aaf1b8e5e8cfbda41847e34e27f80cda5625adb730e77c064ff22035bbeeef398af056839ec8198bbdd5e8b4540c07de52568d81d6f7939d7cdcecfee1242d9baf04b71c761cff6a4aa70c32245515134e4f41b999c58529f9746a9c784c1086a5b62d895d710740e1ce5a9cf3e7f39a9c588c9b5e94f0f2b945c55a1d76dfd2c7e723b48de32aa01ab05b45eae5b00c443af52d72ed86a34c9cbc997d7665ab78389428718352abb5fb7853ab0d238b94eea092a94790449abb88fd58efeb8fe047dca4b5dcb91ac8482a03619c407bb562cd6232c3843ebfb61187fefe890de2d81236076a218fd3a6571827831d8d4912c8c4fe00955b5e48a1e89ab946064431a3e0e4bd76ecb445a0866b245e641a3af747dca807da16c355a444ba5e7a663eec995bb347d246e5c70fb23e2017a13f798fb571ee0dfd98da8aaa6a33c4c2eb1b9eb211cbf88059097e89d8e7afc9f45f589ad1b554f12a979b22b1330aabe09396f57d786fc52718dd7afda8f9679d16d13c6e73b0499bacb411b96bc4e1fc61bf7b3add288241b2c2d08fead59c4d6a385f8bcab775827a3fb9848da3ee319cbc1bd615b0bc8f4747cefe72dbbc2264398bc62b4671a00624106c7ab45a9701e75ce03eea712fc2445d9bd01da87e3365d930ed5390732f26785e0801ba593e5f57ab06463e5d4460e240d62d02e3093fe23c87b5b4a4be59fbf391a94a2bccac00ad12a53c3d1ecdb21fa6dde784ab2474a8bf9ffba514d22bbb653cf62f3feb2ab624bce584628f321fd22b7343878f7b371823bea3550d84e1f91bf2b1e4aa6e87b076d1c4fbc8cac0bef6853c074d27a5b925478951db0c69ebb40d65a4411109d88789e745915acf057e2582c30ac8ace8a01f61b2687e8b71d4bedb241feeb3c0b1fe12ee808fe6f981804fc9c495c6c97cdf4c6202a7a021a2036dbde3b5f54d1271e10891485a8c7eca6a5c4d5c0d3b506527ad00107fca053d28f955f1db0d087ba7f4d954b02b8d169587aa7adfd6889573e1935ada68c88846b0c03b66a490167b78978a59ca9936226bf0d687bf7e3f5a89f5042c0711777ab684eeefdfee6747f9a5b788bdee9356fbc2f560f58611506878e0ec2abafa7fe06f8f3d8f8d4386d50fc050e18c74f09f7a36fcf7b110d2ae78cfcac824f029c252477c4aa944d14614990487df7a4ea79c310558eeeba46e608c351989bc22e36134a439f38de9f6cbe9014f23cd6851c6c08a18f983e75dd2c69187c0becf19df8ac969f87c7b44f8882c01521e0bc225b48bdaa3fc321f03babaaefd60ee0728c39b6d821f963145e335efaa0c1c6d4818bbdeacc339690e9fa6cb945a56f55edd0c67cee9a95f585523b37d3efac8abd5ae3a2f5fb71c0a399a6e780cf87159f405a70c61385d8344300bf535f56505e11d3d2aafff43d4e682eb02735f084a8496742f23593459f8a2984b683371d59096206fdc936f356091590b3ad809ffafb2b7f983050839555d3158e057de7733e4d39d5adbb37f0462c80e30e972dccde17b27aaf8237577676bfabf613772e92bbf9185d3b474d215f7279de634849fd6934334fc711857d9fe337cc7e85f1a24d66b649fac998b3792cf7c46161dfe0574b546dcc1a2ad3196511ab130607a1ac1e772b837573890b27702f9fec7c0545eb0df2129050045a21a11645b3a4b7ca18ae6d9c5b4cad0f7f441472413903ad3aef973b00e5ed88962599b51ab025de8fa1e79c251bcae5e15079b73fae17cb647848860e3a80434df4c9c5b99437258a81e869509e54ca037b4b92c6ed99954683ad3d469f4b22aee33eb37b79ad1ec365554da2bf4415e9247f2b74a9f4499e2c6be4db517ab23a0dbf6b6bc33549927d469513c242b03edd77a5d52e384550b56f749abbafe31760d76ad9edf497bb790a98791542efac0f64d5231ecae5ed00a3ea8d498951a1fce4b4b47218d9374f62d38453b1f3e7dc37d27942ee716ea00e7225f6f8fb3a0e378e491b291006962a133e8ecf61e42eccd003efaf873811c7d116b194fb10f8bf646bdff19b563128b2431d5bdc69881ef0f694305f0ff838e931172392acb88c49b7cb07531bf6f13d983cb8e2d5f50c08df71640635936d3213641d935c4f9ef3680f9db88a82a1677319f3e04aa9fe3742c67e5c3484379089a3188249bc1c5f9605b89661f6926c8bf99c11a78858f058e108be900d169ebc1a1e742aa08c7c462703d80c96298502ea7752e257652cc75f4508957b0c9394c4fa96a055b1d371621b3aca4d923d261d6de397280541946e00c6506022822d4738581196e28956c383099bbeaeab78bada79e7b826a81a7fafa6ed714d36c5b8144d0dcf70fa6198b8d2a3493b3dcc82190dd000582ffce3f7638f478b7a144fc15b7312986995433f701ebcc32bd4fbc8c35e84b69aa2a21738a7d7fac15e4cafddec0b9c0b4f09a23f19e13d3fc7903c67ba1f002ce9e22f49b09ed0a6a0106aa1b81471d6dbd046fba8ccf15174150e8f76d77d8ab9d1cf04c08b0ac8e125a001318927699cbe46df994f43320b77435c087de28235a316e4e8c34cd73c5e48775d98824b88b2112443285c32abb0b57cfee39d80f8b458baa7e43361c9202108e352c8d8c51a8ca0c9113b76707073064ba96844c414f3e5c37f1fe3dc8fc7efbb27b0998dba63d39a2ec82ce19b9a3c0b51e46d0018d06cd9c1b886ab49725fcfd65439b57ab1fe05f0b814eb1d1a819dcf64e6919ad4c9fa78bd1133e58076894eea3616c8846af2ebf926a44881580e617a733eeaf8b2ab5269428111f5b8e597fd0e2baf714099a04e73b94917a87bd4d192b1623c63c287a3cf372bea2cf56b916ced14860c14701ffa23ab2b1cba136c758e48dd4bbd263d87dcdc8e1b1480d349974f4eb5e76db2deff85ac0d48ddd02689406058565cf5f010d7493e7e15c204fdcb5d4dc52f7b11f0b43765a8da0485ffa6b75afe5b881a7353a787adf5ea69db7f9d9af48948d123ac70a7d95f0aed1a8a0bd937249602f5a959934f7208205592f73a8e9f1e2791bcc2c299933c1f1fb7b50db2e35d4b69381d6766f1d2519bb5397c690beaedcdd228e2d9f32578648aed03012c5ecb3c8f28b0b581e16cc9ba6be3e8e625beb0dea5985d96d9dcfeec69824a98dfbb76153fee0969d28c4c49bcefb55342fc2435e549ecc8986624513de76f060bf9bcfdf92d0b3248300ae2b4baca3c9ca7610df44f5f58ca4053d6a8aaf1d795aca713ae0002149e9ef9bb6f2f58b6dca8f10fa23595625c2571c18d0fbed47a92613464f192703112953052a27cb5e0ec40807626b5f4d911b928af6423355ecb74044269f3eb7745be427f33afe8cf7d8d6f55557ad09082a75902d5ef846ffd85a93ad806de9ca02eb4e36b557df019e5fd60b5b9ea26792372511dd33f8b5df6c86681d8c722257b9daf593401c67488ef27ffcb3eac186563657d00c82a3ff53938fdb7dbb5b51c4132d633d57c4519811b61e4fe1baf34f846f001e96c0c16a6edcfd6932b88c333aef51bd364f82986292b0c63fdfab6ab7412f67025fa63fe36caba70c95e4fced67d4f45797e1ed858c2fd32b29fcf51c61bbb0f800410f10123867150625fbbcf64a074cda092925110644ac549e1418b85125f1712f338abcb6c8a516b2a66188a7df577eecb474df0e869cce6d3f5e2a8e822da76f5eb12b763168cd9469e62b664db7ddfb867c3fa6bc0653f684cdc6bb0cecddf5c212362dead5c87987429f6b4aaa98415f7ba0a8ec58ae834359f459fa86e988bf214b26b3e8422e7129b3d0809551122be29b1586159549e0366bed0925875552415951ca71d98904c695313aaf631df87566d566c389a999bf0a5226bc1876c46b587aa66b5f26a534336bf740cdf5656b822a81e48b5068bfa345af1b74f7fbb6a2c59b54751fad370b6f2d77c66928fd0df11f1cee75110b132b5e4c9f7086b43fe828868d46e5edbcf834450e0146bfc0b535e102360bec39d420a1ac0d61d613dd7aade39759e6543e8e7de9a925a2d9c6f4ee89d897d98858306d9d0956df041861c4e18705f1a54bb83037c1d67a42d7c717dad762a3f209cba7b1595687613a0b173413f7e4e3605ba491481225c04c5319c1a4e8ddc79c8299d2f08da66e63ee56d2196f17287964c70593f80617d8a48d68014773d05bc81e8cddb65adb217804f19186b493dc9fdfbecc0fb6cd5a69c9d33801c4c1a31873d7b994bd095e1080181f2198648606798e175f0e05ce9a2e1b83c50d424ee2ff081401fd49c41dc6a8f374cee05291b5b08abbd673f0d66f85f30bb5bdd0dac505a90b4a0bc8f1417388c9b6a5d88634b742b648e8bb39ddd7834d00ef34c5d32c43ee3ba9fbe2c54e12833caddb6fba00b246c83cc28905b3cadc0f48558807738ba1fca33f012085663a6f9852c59a6f37bb9de622c062e6bd9a31c38f0dc1c424e66741a0db74dcecf8273fb66e22b3dae9d87b95b3dc9d9e65567cf7123f8e5681371bdf09debe56a4d274df7598ca5df84521383aee23ac8c1a9c1dc3f48f4772249e45a0dc4fd8145068728bfaeb2b477c07437cf49ecb0f6a05c741aef4df3d495b28a23b12cebb12bd6cec8d629556d55147d6ae3ce601b0247f19180fee1c0992224361b515e5358f874ae2770c29b7a92a4cfb481766835b6a6694048d31a64fd2f958d23273570663168382b70d86467df5093ac7e5837b1b9588a84aba349c0539a68b92e81d966737b506ccf9772b606998d6fa05150357f6dcf0d7c38098b2090dea40677420846ac0dfcab70714581ceb0136e876cf212dd73567b33c2d692dda7e1a59d1fa32d2d53534257e2ad02663cd72f87230d829acc172bcb2766bb596b0f35385c02b0761b236a2f8122329bc1e79d26d5a83eb4c6d39827890049f0a52d8b84c885d621de71bdd116b029b8ac561dac8b66136e362ec017ffdd82c1e6643da74f6fa8cd60f743ddeb3c19bb1daf0b0353a716286be8e99c29d91ddbe41227c606f31a48930005bf2d77bbd2ef82e0a439d4545ad4254f7795edd62837f22a1ccd90762cfde79e42f6441e6cff588c37cef73086415da708b848280d4c1dc9af5b44b51f95dfc156bebe7668c7434edad5b93c27bdf5f7928d00d04692ca61ad6cd07be336ba0326a76ac7faa1b2b6a5755ec6fdea96a22a2a4b2269459b40d8828c2166cbb00e61bd55053387b0392eb11e022455efcd5665b052445b715ccde9ace3ee107c021058df727b8532f806e3a9f11f2aa38513e2742d8f907cc412f65fe12bef6304a64693435dff47750a59cf77ad6485c1d7e2f8724d2d2fcf526b0c6fd0da3c6241ff08952812bab9903103cd617e5be020284c3693d45f757ae8e252ef06be91acd206ed9f5e030e1a6180d3519eb559e5c780073b25e4162da06c46cee20533f1247537084e897b5c7177fb7178736c5337afbf3fcb718023bbe3890f0ffeab56349481d18a7e1abb316d9815cd8bac6f55144e8882786e8bb9c6a06929bda7b00fbaed214a36eee1701c73a51b926c2a5b2b8f1a7eef407a97623aeeb4e74660ed5d44f98b67d9d11e9668788a73a477cdcb64e509b960b9f4fcec688bb9efa916fb43bc8b7a7e4c174de79c8b07603954ceac76cb97117f3460676f30a5fa988a2b436e37a814d04a9fe3641c4c21daf2057476e831fc5b9c72b571a2a0b845726062f78fa0f7bba897a7d82cea9f9dbf8489d33546042704dae1c5420491382b14dd5fe7c8b834216eb37128c458989e822f25ee14acd08b1d8c1024b61d7ae6a138f9a50a09b8833100ee60a83ea08f7bade4c6f8d86464b52698ddb89624a655ebd8501839f74d0804cd8697125d4b050cf401eb1002706e21ce8362cb774301343ad940d8bc5e6c6d4e41fa756194cb83b6e019bba349f4bf56d85d2c2c3202a7f1a488b0d7e2fc48170c5291e5b651714d2c8e4e3869498dd9f39e9e33b5cd938a81b6b27a391fd08e350f198d888eb60ddb788a29f99935e988e9145095a816fd4cedf6306102c7c135e6525fce80df748c9d2a81f64b5da870b2aed8388b96a5bae8e257cf117641e17515a8886a4b91b53d38b71b5f991af3bbbb27d0da7d5eb32318cf654a6f43e080c69294a8e59cffc9bfab71b3cb65c37837a38fc3057c8c9666384faaec63c1ba22d9e043798882d9eee8e171c1e030483b3b779e2317b6d90c47739b9f519f0e04fcfc01beb9b0a56f78862e8399cfda86ae38564e1b01d345fbbecb59589d4f867f756ef19fe215961e6069e027a92b881f648a2362cc5579144ec08e65ffe4a017a1f945089b5713dd643a168be98c313f08ae5dff83378fbad2467e8945910db64614e943cd9abf5d0c8e817ce36b3da1759cbe9ed53ffe16adef734316e0f7ecc0398d9bb25e2ff5e2815ff9d77797848481031afd65b07736e41def9c01919538c06007dcab83bfbf024555d6bbf2fb4f276890a27ae61f9302bcf0a04cb670c47dd896754711663acd8c469316df9a47f7a49d0438513e2eaf9ee796069e4531319c26f7bb7534cf2de0cf2f42d22d6171c65938a2fcb62ad69ba9bbc6aecc34f1a733f09876e949b9c2aa7b7ac52019c90663e184606d0b8959fb1ebcda9c17c086e9a249a0f58cb215b27884538dc45231e105965a63e513d883e3f3321d4807c4c3a9ed32e913808bffe015a2d007da21f1317c6fc5c9fad3537c298599a499937ba57495fe8e62746cd7c1f7efb6e1bb055e7f92eafcd8f0bde2437398eba921136f953a1d843075b1a9aca7ff3446ed63d8c1e7b59f48ecea3665bc4a009bf4e435d0bd6b447b9d9f3ebbdb78ce86e02b2f434c78e2f06b78f671d67da27ef622cf3673cb6e3cd174a304ecf0e6f05df6d111f2ec6cdf1f7d95eaed2061d36ed595a19138d58aa4ebab964898304ed053c092a6f8c183b84391a518c29b999666a1a0abb234b8cf7abe00bc2b1b188632338ab732e1257d0eccacfc72adff1d6474959671df167302ce999527b9677fd47077e272fddef5c2ea572ddc001ab0d9c1bef243982bfd6c4b04ac409518e4b702aa92a8527f8df95f7ce6b0743107db99941c3cfea6de5b08718e8a2e5ab2dafdaf8274e4ac365170130ee50b559d1aa96d9529c7c61be846171d024cbb3721b52faeb8e58ac866e1782f3aa815f4bed58df7930d963e65f2bf977a269d52b8a4b8c108ad1fbd2c85409c240688c473658ab008d08d8db8a018e916c90de0d1316a054872bff56d4b4acbc5b6b35e766fde27981ffb34833b505d3d0d87e29ffbe1cc67f5392608d0af23874f4754f8af995dab066a2df21914e0fcfd9c894e97479726e47b4cc506b8ad66346495a7ba8675cad3867690e21d526286b8a8bbdd0cce291d23e2934ed3e3a2590c39ed3814c951849bc06c8c071e82c75b04e539a31ccb9a9899c2f7bb12e6afaca175de4e88ffa964b8f889e824b65af248f2b79107d114a332b14141e549d0e6bfbc9c7f6813ee7ec7f4a6da42cfca749bce9a128fb7cbb2d8f4bee01106bcb181df75e1088909ec7b5f0b82deff5b559495ef9c03565b381552969a0bccaa0dd98136ecb89e547c0639953556c93604118ed5d8216cc19f3518c349e0814e794dcb24bbdc1156e6025c02a777c58d756dd691ea0ee2a66ae943ae58762b92ff02b583eb55efcbb6cf816abd8a0d5f566c94b8cfc0847cb37d930a6503b9b07af8ee135441d872aa63f3bc7fe934b352220bb62650c86b042e46033826eb425edc2feb60aa1b5d3a3c04294aa5648d98fbec0ae67c24ff9c629586a2cdd3954648fd241bdda48bbaa28cac7fbc30d6977b353472d94836bc724654c40e88e8e1e5e50eb536e352398de44f44e871dc166eb40528f0ed6138de6ebe175d2d400a0d44793c36a4fc9cdce74642baf33fbe610bcc61c74b2429a93488d127cd37d5af15664c36adf1557536a688976691160d740b813e97ece28a11d12b970775a92149ab3ffce8b8466a81d8583e04f80a1d7f726816e0add5287533b86209b7594e41f1c9eb61e39fa8f4164416f69589efbb87cdc6fd1167f6e4f9a1dcbe818afe39d0cadd24bc77861b4a66394d9253d06f17640533ce9893b222a53d4bdc7a88d215b3d15af7a64dc52b6b309f57fc79d3107d496bcad2738ff54d5a0a1ce16e82ef02a6c5172295b0ae2e6eda8a5ed86e0fd026fc77746937bfd4f93321fbb6d22dfee9345bb9c1b96ec71be000d5bd9fae793293db6cff5536b9285c2a0b4e091e3cd03da6de40569f594cc60bde75971ac2712c9ba3514c48470682c215f78a73713543d776fb7b01bf5c1a29d5c55cb79e34506980163a51bfe6d77dec5760933e9ae39522e5b30f151a0c731559ae0e70777b78715cec6b7ec3532019dd5365aa741fb35ad8ef1885f1446ff9c0a84d550a3447649ac94c824f90ff19da8d21ba62c77ebd13573c5d72c27bd33c8b496aebacd3e9e9f465c9bd2fc42570432ed71c3b375dafa0807e855d4047a467c48100e38375c4c2d3acb89140592186ccd78324601286f4edc002f9aa9eeeb9c85679cb30741baa33ba0c5052aea4c503200df8da59c1070f2515efed087c7959e8389f35499c2cb5973c3f85df1ff106cfcffa76fe13043447d158293693627b0f6fd8f1644176df961de64f92fcb2c1c9454b5cf9a19d35f3a597aa9f7a45699fe9e17481f451a91cb5b86c193bec42107e0201feed624a27f930ee045237d93187640e8841318b80679a45e3d0a99e8f30023e76420504520678e387d246dadea6ad8bda37468ad5de81ac43cdc1abd0d95e5665ecdfca0506d4b9167b72659b53f5485f82624c4385acbe4bc93f73d6d4be57f241214c3e5a1cdd4e97b48885ca017587d4ab443e95c8f8a3958aa93ebeeca7b4ebb29d168feb0c25f64b9fae418705bc138586ec17e094ed8bee2269925eb50ef307d939d0a0399a7bd7ab723ab63700ad69cf2e8d17917798a9ae94f865c12aaec6e911157b226fdb0da1aa8fb4787db305a319475fd77ce492ab77a3c472a0056884d53b28fdbf1a211b900bea5094f9be52ba3f507fd1a8428316e8b0ed7a81129264fc72ec029fc836bdd008aa1e1d0f4495f959dcbd001a371a858ec4d5a3b2f24b7a87d9e1bdac41161fc0d65259c7c67c4cec44b7af97fb7afb631334d08aa9a9f5fa05ce8448f41a32add145301292eabcca045c2c15a7f3d3cf7ad261475b78737e42fa4e59a6facba2a2c81e2eb123d6fc02f31967ca71779fdd7a4ca03b04c8944d54cf1bf89f33b40222476a4961e326f60c0014cd8253e8950e456858683811f885569cf361b651b7c62ee0edb36aa764d9a24a4ed5c1591d6c95ad1f2842405e1de0d927474bff647d875cd49c57636be78605c7b74ebf6ba8610933d6a23ee3e6f81f1bd99d7b9a3fc3d6f9a861ef1bb6a3b0766e4078f57cdf6626aefdae32b37dc1a78a0e4a4ecab84310baaadd6585e57d884efc9637e6bda0d4f0d3b021460a06613588bafd45ecc45d13dde939a7fdb4dd47f1809d6b558307161539e10ec7187d852cdb9d41ed6d58898019cb2f6201ca8ec99973e2172ffffa4055cb9f735033dbf67da130f7ecd1fdbf5938b8134a6eeaa2f8986f143db83e5b8bd851079606d5d57c7a6e132dcee394d79aef73bae8d925d1e12cf1e092b23d10ef0f5f13e78776529bdacb76f04e68f1658f1dfb8630395206eb291d17b9a83d58f9a891bf893375bb8b1583a87cbee6c5886c0dec5d1f546a9d5ba964ab0c8bd9458b76e895a075b0ee654e263f58570f70a5ad6d888c0d310e5ee22b6b4f496eb17e1dd5f7a31320693c6ec9d8f6cb77895f27708ddb12b057991013360450f9db1091151c7575a6f764d93583d779b1b6480cad94758be647d4cf8794e20c6b5718381e8fce46fed3820e20c4e4c82b8465794b6984adc52596c6827f01e6e9a99db61784e39d1ea23ccdf1b720210a1b26c8a8bff1509bf7f179bf485388286766cc3094176121983c35d01eef78e1c7c67cf7789eb3450b833db4c3526b74ecf5d15d56074d5e788fe8ee99c7e12f823cc10ab1171ecac2d49a2d4ff80dff1ad371a98bf6d37f60b627e16a7fd0b550a98088356cbde17d0cffa78c6375b6d9daa66e3c8d154a685f515e66667961fab09d412ac4c2ea2b2f0e6213e7f6ff2a717a9ebce30fec12d8de7f3cc31f4eb2bfe95031505a3d75a8b8fb42afa4fca8cccffccfe7b15bc6d02699c86d5c0593f4cedcb3d523bc4c97e9fa5f448d03f75f794528e2a792e67948154d80ad2733030323b6dc51220281e61e2159fd3011197b8035da6104369229f6897ddc15338f761e303c81fd4306c7150fa2c24bb64d805cfd84f41b7ea94c874ea5619cd09e4d8b89bacb71da01ec5e4da36718977876b4f9a9dd8c3c956bb76c3828f105456fad1a2df55e0e91baa5c96c4cb0e94f73a57a9f6ca9dfbecf6af0150db77918fab3c4a8afcbfa5cc3f82748955885b74bf31b1404f88fb08bbcbedbc171bfa546a1bc8a7a207e85605dbf36e73b992da2c38006b0db8b6d2a255a2b12e7bba361710ca620ef471ad4e7016759c12efcc6d4816a677834d4ef1b5246bd778d8de3092aafa52c352b478fb2dc7308e42d9c97edfcf838c9b755568dea4428b7b163fa078084e879d84ec0e5a778098761cab7ad1a1b0ca217adfb3be505d587ef8f018893969db88eb8b44dcf64ac529070b33a42fab1f756df6d87e11f4919578631e4e6a92238aad138c0e73e60f4e376c78a411e644c3434d0e82f60bec1d8feb5c3f594d5fe9d6f2083657aabde969dec3f22b6fad6e6b5db7f941232b108f581ef70ef75e769d6848368d874de979bfe25776f0763fffd4e80051cff954b8c103c6dedcc839c410b95f0065b92a8bc53284557ab82115a0eafef47dd022842b8e36403486f1d6d2d819a65ac183c700d204007aaeb484afd70e108a9db278f3ffd116b83a1c1705933c542c08d2ec4aab489c4c658d038fd7d81cccde7780c7f675c596d32c50a93a2a4f1ceb0681e034357b630bc23cabcaa765173d29a4930</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      围绕一些主题的约稿
    
    </summary>
    
      <category term="光子" scheme="https://blog.l0v0.com/categories/%E5%85%89%E5%AD%90/"/>
    
    
      <category term="ࠕPython" scheme="https://blog.l0v0.com/tags/%E0%A0%95Python/"/>
    
  </entry>
  
  <entry>
    <title>Python 代码规范</title>
    <link href="https://blog.l0v0.com/posts/1cd351e0.html"/>
    <id>https://blog.l0v0.com/posts/1cd351e0.html</id>
    <published>2022-05-09T03:16:02.000Z</published>
    <updated>2022-12-14T02:54:16.957Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h2 id="Python-编程规范系列大纲"><a href="#Python-编程规范系列大纲" class="headerlink" title="Python 编程规范系列大纲"></a>Python 编程规范系列大纲</h2><ol><li><strong>Python 代码规范</strong><ol><li>flake8 代码检查工具</li><li>wemake python style</li></ol></li><li>Python poetry 包管理</li><li>Python 工具配置<ol><li>commitizen</li><li>isort</li><li>black</li><li>pylint</li><li>falkehell</li><li>pre-commit</li><li>tox &amp; nox 测试环境管理</li></ol></li><li>Python mkdocs 文档构建</li><li>Python pytest 单元测试</li><li>Python cookiecutter 项目模板生成工具</li><li>Python Github 开源项目维护流程<ol><li>Github Action</li><li>pull request</li><li>git rebase 说明</li></ol></li></ol><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;过去在项目组开发，需要快速迭代，通常都是面向美术编程，这个需要快准狠地解决问题，至于代码怎么写其实是没有任何要求的。<br>&emsp;&emsp;但是这对于长线维护来说简直是灾难，当这种代码越来越多之后，就会变成一堆没人敢碰的屎山代码。<br>&emsp;&emsp;那怎么才能写出可以长期维护的代码呢？<br>&emsp;&emsp;下面我会开一个 Python 编程规范 系列，整理出一整套 Python 的编程规范，以及配套的工具。<br>&emsp;&emsp;这个过程是这小半年来的一次总结，这里诚挚地感谢我的同事 <code>龙浩</code> ，它教会了很多~</p></blockquote><h2 id="Python-代码规范"><a href="#Python-代码规范" class="headerlink" title="Python 代码规范"></a>Python 代码规范</h2><ol><li>谷歌规范 <a href="https://google.github.io/styleguide/pyguide.html">styleguide | Style guides for Google-originated open-source projects</a></li><li>Maya Python 开发规范: <a href="https://www.chadvernon.com/python-scripting-for-maya-artists/#writing-clean-code">Python Scripting for Maya Artists | Chad Vernon</a></li><li>TA 101: <a href="https://github.com/theodox/ta_101">theodox/ta_101: a coding standards doc for technical artists (github.com)</a></li></ol><blockquote><p>&emsp;&emsp;其中我结合自身理解，翻译了 <a href="">Maya Python 开发规范</a> 和 <a href="">TA 101</a>，大家可以自行参阅。</p></blockquote><h2 id="文件头部统一写法"><a href="#文件头部统一写法" class="headerlink" title="文件头部统一写法"></a>文件头部统一写法</h2><blockquote><p>&emsp;&emsp;我们的代码优先采用 Python3 写法，因此根据谷歌规范，所有的代码文件需要加上下列规范<br>&emsp;&emsp;<code>__future__</code> 模块用来兼容 Python3 写法<br>&emsp;&emsp;<code>coding:utf-8</code> 兼容 utf-8 编码</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">module docstring</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;<code>from __future__ import division</code> 可以引入整数相除可以得到小数 (Python2的默认环境是得到整数)<br>&emsp;&emsp;<code>from __future__ import print_function</code> 可以让 print 关键字变为 Python3 的 print 方法，可以在 lambda 里面使用 <code>print</code><br>&emsp;&emsp;<em>**</em><code>from __future__ import absolute_import</code> 引入绝对导入</p></blockquote><blockquote><p>&emsp;&emsp;division 会导致 OpenMaya 一些类型的运算符失效</p></blockquote><p><a href="http://www.jp.square-enix.com/tech/library/pdf/BDSeminar20210518_sasaki.pdf">PowerPoint プレゼンテーション (square-enix.com)</a></p><blockquote><p>&emsp;&emsp;原因是引入 division 之后 除法 除法 __truediv__ 而不再是 __div__ 了</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cd351e0/01.png" alt="enter image description here"></p><h2 id="backport-兼容库"><a href="#backport-兼容库" class="headerlink" title="backport 兼容库"></a>backport 兼容库</h2><h3 id="six-py2-amp-py3-兼容"><a href="#six-py2-amp-py3-兼容" class="headerlink" title="six - py2 &amp; py3 兼容"></a>six - py2 &amp; py3 兼容</h3><p>Github: <a href="https://github.com/benjaminp/six">benjaminp/six: Python 2 and 3 compatibility library (github.com)</a></p><blockquote><p>&emsp;&emsp;six 库提供了统一的 API 解决了 Py2 Py3 不统一的问题。<br>&emsp;&emsp;比如加入 metaclass </p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Python2</span></span><br><span class="line"><span class="keyword">import</span> abc</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestClass</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">__metaclass__ = abc.ABCMeta</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Python3</span></span><br><span class="line"><span class="keyword">import</span> abc</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestClass</span>(metaclass=abc.ABCMeta):</span><br><span class="line"><span class="keyword">pass</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># py2 &amp; py3 兼容</span></span><br><span class="line"><span class="keyword">import</span> abc</span><br><span class="line"><span class="keyword">import</span> six</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestClass</span>(six.with_metaclass(abc.ABCMeta, <span class="built_in">object</span>)):</span><br><span class="line"><span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h3 id="future-模块"><a href="#future-模块" class="headerlink" title="future 模块"></a>future 模块</h3><p><a href="https://python-future.org/quickstart.html">Quick-start guide — Python-Future documentation</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> future.standard_library <span class="keyword">import</span> install_aliases</span><br><span class="line">install_aliases()</span><br><span class="line"><span class="keyword">import</span> queue</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;可以支持大部分名字迁移的库，比如 Python2 里面用 <code>Queue</code> 在 Python3 下用 <code>queue</code><br>&emsp;&emsp;使用 future 库就可以用 Python3 写法在 Python2 下运行。</p></blockquote><h3 id="Qt-py-Qt库兼容"><a href="#Qt-py-Qt库兼容" class="headerlink" title="Qt.py Qt库兼容"></a>Qt.py Qt库兼容</h3><p>Github : <a href="https://github.com/mottosso/Qt.py">mottosso/Qt.py: Minimal Python 2 &amp; 3 shim around all Qt bindings - PySide, PySide2, PyQt4 and PyQt5. (github.com)</a></p><p>Qt.py 的作者是 流程TD 因此影视行业多采用这个，Qt.py 是运行时 Resolve Qt 的库，因此不太兼容 pyinstaller 打包之类依赖静态分析的库，要解决这个问题可以用 <a href="https://github.com/spyder-ide/qtpy">qtpy</a> 库 (qtpy 是多文件 Qt.py 是单文件)</p><hr><p>Qt 的 Python Binding 因为一些历史瓜葛，导致拆分出了两个可用的库<br><strong>PyQt</strong> &amp; <strong>PySide</strong><br>PyQt 商用付费，PySide 商用免费</p><p>两者都是 Qt C++ 封装暴露到 Python 库，使用上大部分的代码都是能够兼容的。<br>需要注意的部分差异有信号槽区别<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PyQt5 <span class="keyword">import</span> QtCore</span><br><span class="line">signal = QtCore.pyqtSignal()</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> PySide2 <span class="keyword">import</span> QtCore</span><br><span class="line">signal = QtCore.Signal()</span><br></pre></td></tr></table></figure></p><hr><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cd351e0/02.png" alt="enter image description here"></p><table><thead><tr><th>Maya</th><th>C++ Qt 版本</th><th>PyQt</th><th>PySide</th></tr></thead><tbody><tr><td>2014+ <a href="https://download.autodesk.com/global/docs/maya2014/en_us/index.html?url=files/GUID-AEAEAE08-96B2-47EC-BD0D-21A4D072C458.htm,topicNumber=d30e47245">信息源</a></td><td>Qt4</td><td>PyQt4</td><td>PySide</td></tr><tr><td>2017+  <a href="https://help.autodesk.com/view/MAYAUL/2017/ENU/?guid=GUID-955290A5-C27E-47AC-B930-A0430182EAA0">信息源</a></td><td>Qt5</td><td>PyQt5</td><td>PySide2</td></tr><tr><td>未支持</td><td>Qt6</td><td>PyQt6</td><td>PySide6</td></tr></tbody></table><p><a href="https://fredrikaverpil.github.io/2016/07/25/dealing-with-maya-2017-and-pyside2/">Dealing with Maya 2017 and PySide2 · Fredrik Averpil</a></p><p>需要注意 PySide 升级到 PySide2 的 API 由以前的两个模块拆分成了三个 (QtCore QtWidgets QtGui)<br>官方推荐下列的代码解决问题 <a href="https://help.autodesk.com/view/MAYAUL/2017/ENU/?guid=GUID-0617A132-1B57-474F-A656-6E71A002CA28">信息源</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">from</span> PySide2.QtCore <span class="keyword">import</span> * </span><br><span class="line">    <span class="keyword">from</span> PySide2.QtGui <span class="keyword">import</span> * </span><br><span class="line">    <span class="keyword">from</span> PySide2.QtWidgets <span class="keyword">import</span> *</span><br><span class="line">    <span class="keyword">from</span> PySide2 <span class="keyword">import</span> __version__</span><br><span class="line">    <span class="keyword">from</span> shiboken2 <span class="keyword">import</span> wrapInstance </span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">from</span> PySide.QtCore <span class="keyword">import</span> * </span><br><span class="line">    <span class="keyword">from</span> PySide.QtGui <span class="keyword">import</span> * </span><br><span class="line">    <span class="keyword">from</span> PySide <span class="keyword">import</span> __version__</span><br><span class="line">    <span class="keyword">from</span> shiboken <span class="keyword">import</span> wrapInstance </span><br></pre></td></tr></table></figure><p>但是上面的代码需要 <code>*</code> 导入，并不符合我们的代码规范<br>使用 Qt.py 就可以轻松解决问题</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtCore</span><br><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtGui</span><br><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtWidgets</span><br><span class="line"><span class="keyword">from</span> Qt.QtCompat <span class="keyword">import</span> wrapInstance</span><br></pre></td></tr></table></figure><p>老版本的 Maya 使用 PySide 也会被映射到 PySide2 的调用规范上。</p><h2 id="black-代码格式化"><a href="#black-代码格式化" class="headerlink" title="black 代码格式化"></a>black 代码格式化</h2><p>VScode 配置 black 工具<br><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cd351e0/03.png" alt="enter image description here"><br>使用的 Python 必须 <code>pip install black</code></p><h2 id="Pylint-代码提示"><a href="#Pylint-代码提示" class="headerlink" title="Pylint 代码提示"></a>Pylint 代码提示</h2><p>VScode 配置 Pylint 工具<br><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cd351e0/04.png" alt="enter image description here"></p><p>该选项默认是启用的<br>只要启用 Python 安装过 Pylint (<code>pip install pylint</code>)</p><h2 id="docstring-规范"><a href="#docstring-规范" class="headerlink" title="docstring 规范"></a>docstring 规范</h2><p>docstring有四种通用的标注规范</p><ul><li>Epytext</li><li>reST</li><li>Google</li><li>Numpy</li></ul><p><a href="https://www.chadvernon.com/python-scripting-for-maya-artists/#epytext">四种规范的样式</a></p><p><a href="https://www.sphinx-doc.org/en/master/usage/extensions/napoleon.html">sphinx.ext.napoleon 支持将 Google 和 Numpy 转换成 reST</a></p><p>建议做到所有的函数都进行 docstirng 注释</p><h3 id="VScode-自动生成-docstring"><a href="#VScode-自动生成-docstring" class="headerlink" title="VScode 自动生成 docstring"></a>VScode 自动生成 docstring</h3><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cd351e0/05.png" alt="enter image description here"><br><a href="https://marketplace.visualstudio.com/items?itemName=njpwerner.autodocstring">Python Docstring Generator - Visual Studio Marketplace</a><br>安装 VScode 插件</p><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cd351e0/06.png" alt="enter image description here"><br>设定可以修改 Docstring 的生成格式。<br>默认生成快捷键为 ctrl+shift+2</p><h2 id="代码-review"><a href="#代码-review" class="headerlink" title="代码 review"></a>代码 review</h2><p>仓库设置必须经过 review 才能合并<br>review 代码可以大家共同成长，统一代码规范。</p><h2 id="tox"><a href="#tox" class="headerlink" title="tox"></a>tox</h2><p><a href="https://iwiki.woa.com/pages/viewpage.action?pageId=758823139">THM中的tox命令行大全 - 腾讯iWiki (woa.com)</a></p><p>龙浩提供的 thm 仓库会提供 <code>open-dev-shell.cmd</code> 脚本，需要本机安装 thm<br>启动可以进入 thm 的命令行开发环境，配备了多个中心化部署的工具</p><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cd351e0/07.png" alt="enter image description here"></p><p>利用上面的 <code>tox -a</code> 可以查看龙浩提供的 tox 配置命令。<br>使用 <code>tox -e pkg-py</code> 可以初始化当前仓库，生成 package.py 和 setup.py 等一系列配置文件。<br>可以使用 <code>tox -e ide-code</code> 使用中心化的 vscode 打开当前仓库</p><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cd351e0/08.png" alt="enter image description here"></p><p>默认 package.py 已经配置好 docs 和 单元测试 等诸多环境。<br>环境变量利用 rez 的规则添加到 commands 函数里面。</p><hr><p>日常上传代码前使用 <code>tox -e preflight</code><br>会运行 <a href="https://pre-commit.com/">pre-commit</a>,<a href="https://github.com/psf/black">black</a>和<a href="https://pycqa.github.io/isort/">isort</a> 标准化所有的代码，也能提前发现一些文件错误。</p><p>后续使用 <code>git add &lt;文件&gt;</code> 命令将要提交的文件添加到 git 记录里。<br>commit 步骤 <code>tox -e commit</code>添加提交信息。(这样提交信息有统一规范)</p><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1cd351e0/09.png" alt="enter image description here"><br><a href="https://iwiki.woa.com/pages/viewpage.action?pageId=768400271">参考链接</a></p><hr><p>发布前可以使用 <code>tox -e build-test &lt;版本号&gt;</code> 测试是否可以正常发布 thm packages<br>如果 build-test 通过可以使用 <code>tox -e build &lt;版本号&gt;</code> 来发布到 thm 中心化云端上</p><h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><p><a href="https://www.chadvernon.com/blog/unit-testing-in-maya/">Unit Testing in Maya | Chad Vernon</a><br><a href="https://www.chadvernon.com/blog/unit-testing-in-maya-part-2/">Unit Testing in Maya (Part 2) | Chad Vernon</a></p><p>可以使用 龙浩 配置好的 tox 进行单元测试</p><h3 id="Qt-单元测试"><a href="#Qt-单元测试" class="headerlink" title="Qt 单元测试"></a>Qt 单元测试</h3><p><a href="https://pytest-qt.readthedocs.io/en/latest/">pytest-qt — pytest-qt documentation</a></p><h2 id="sphinx-文档生成"><a href="#sphinx-文档生成" class="headerlink" title="sphinx 文档生成"></a>sphinx 文档生成</h2><p><a href="https://www.jianshu.com/p/d38573785b66">使用 Sphinx 撰写技术文档并生成 PDF 总结 - 简书 (jianshu.com)</a></p><p><a href="https://www.sphinx-doc.org/en/master/usage/markdown.html">使用 Markdown 编写 Sphinx 文档</a></p><p>使用 龙浩 的 _build_docs 命令可以自动生成文档。</p><h2 id="Poetry-依赖管理"><a href="#Poetry-依赖管理" class="headerlink" title="Poetry 依赖管理"></a>Poetry 依赖管理</h2><p><a href="https://mp.weixin.qq.com/s/0tHCKnEpdFOmk8yKM7iDCQ">Poetry | PYTHON 打包和依赖管理变得简单 (qq.com)</a><br>基于 龙浩 提供的 thm(rez) 流程，不是十分需要 poetry。</p><h2 id="Sentry-错误追踪"><a href="#Sentry-错误追踪" class="headerlink" title="Sentry 错误追踪"></a>Sentry 错误追踪</h2><p><a href="https://mp.weixin.qq.com/s/PoBwVvREoeKQmGzcxK5LXQ">Sentry | 应用程序监控和错误跟踪 (qq.com)</a></p><h2 id="typing-静态类型检测"><a href="#typing-静态类型检测" class="headerlink" title="typing 静态类型检测"></a>typing 静态类型检测</h2><p><a href="https://github.com/python/mypy">python/mypy: Optional static typing for Python 3 and 2 (PEP 484) (github.com)</a></p>]]></content>
    
    <summary type="html">
    
      PEP8 规范 | Google Python Style Guide
    
    </summary>
    
      <category term="Python" scheme="https://blog.l0v0.com/categories/Python/"/>
    
      <category term="Python 编程规范" scheme="https://blog.l0v0.com/categories/Python/Python-%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83/"/>
    
    
      <category term="ࠕPython" scheme="https://blog.l0v0.com/tags/%E0%A0%95Python/"/>
    
      <category term="࠴编程/编程规范" scheme="https://blog.l0v0.com/tags/%E0%A0%B4%E7%BC%96%E7%A8%8B-%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83/"/>
    
  </entry>
  
  <entry>
    <title>Python - Import 机制</title>
    <link href="https://blog.l0v0.com/posts/5e6e2bc7.html"/>
    <id>https://blog.l0v0.com/posts/5e6e2bc7.html</id>
    <published>2022-04-15T01:23:50.000Z</published>
    <updated>2022-12-14T02:54:16.940Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;你是否也会为 reload Python 的模块干到烦恼。<br>&emsp;&emsp;需要在不同的脚本加上 reload 导入的模块确保可以看到代码的更新。<br>&emsp;&emsp;Python 是怎么缓存 import 的模块的。</p></blockquote><p>TLDR;</p><blockquote><p>&emsp;&emsp;我后来了解了 Python 的加载机制之后弄了一个函数，只要将我们开发的包命名加上，就可以实现整个开发包 reload 。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">module_cleanup</span>(<span class="params">module_name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Cleanup module_name in sys.modules cache.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        module_name (str): Module Name</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> module_name <span class="keyword">in</span> sys.builtin_module_names:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    packages = [mod <span class="keyword">for</span> mod <span class="keyword">in</span> sys.modules <span class="keyword">if</span> mod.startswith(<span class="string">&quot;%s.&quot;</span> % module_name)]</span><br><span class="line">    <span class="keyword">for</span> package <span class="keyword">in</span> packages + [module_name]:</span><br><span class="line">        module = sys.modules.get(package)</span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">del</span> sys.modules[package]  <span class="comment"># noqa:WPS420</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NOTES(timmyliang): 这个操作等同于对 test_module 下所有的 module 进行 reload</span></span><br><span class="line">module_cleanup(<span class="string">&quot;test_module&quot;</span>)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;如果我们的 test_module 下有众多脚本就不需要逐个去添加 reload 了。<br>&emsp;&emsp;万一不小心把 reload 发布出去了也会稍微降低脚本运行的性能。</p></blockquote><h2 id="Python-Import"><a href="#Python-Import" class="headerlink" title="Python Import"></a>Python Import</h2><p><a href="https://docs.python.org/3/reference/import.html">https://docs.python.org/3/reference/import.html</a></p><!-- https://docs.python.org/3/library/sys.html#sys.modules --><blockquote><p>&emsp;&emsp;上面是 Python 的官方文档讲述 Python的 import 的时候背后的运行机理，也可以切换成中文进行阅读。<br>&emsp;&emsp;这里我将上面的文章结合自己的实践总结一番。</p></blockquote><blockquote><p>&emsp;&emsp;Python import 模块可以用关键字 <code>import</code> 或者 <code>importlib.import_module()</code><br>备注: 关键字调用无法放到 lambda 函数里面，这也是为什么 Python2 下默认 <code>print</code> 无法放入 lambda 里面， python3 <code>print</code> 不再是关键字可以放入 lambda<br>&emsp;&emsp;使用 <code>import</code> 关键字其实背后执行的是 <code>__import__()</code> 内置方法。<br>&emsp;&emsp;import 触发之后会从 <code>sys.modules</code> 查找缓存，找不到就从 <code>sys.path</code> 里面匹配模块 (这个过程也会触发 meta_path 等触发自定义的 import 行为)<br>&emsp;&emsp;找到匹配的模块就会创建模块 否则 <code>raise ModuleNotFoundError</code><br>&emsp;&emsp;生成的模块会放入到 <code>sys.modules</code> 进行缓存。</p></blockquote><p>import 执行操作(不考虑自定义 import 情况)</p><ol><li>从 <code>sys.modules</code> 查找模块缓存</li><li>从 <code>sys.path</code> 匹配脚本 生成模块 放入  <code>sys.modules</code> 缓存</li></ol><h3 id="sys-modules"><a href="#sys-modules" class="headerlink" title="sys.modules"></a>sys.modules</h3><blockquote><p>&emsp;&emsp;由于 <code>sys.modules</code> 的缓存机制，Python 下次导入就从已经加载的缓存中获取模块，导致模块用的还是旧的代码逻辑。<br>&emsp;&emsp;相应的也可以修改 sys.modules 的字典实现骚操作</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.modules[<span class="string">&#x27;a&#x27;</span>] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> a</span><br><span class="line"><span class="built_in">print</span>(a) <span class="comment"># 打印 1</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;当然这种骚操作不推荐使用就是了。<br>&emsp;&emsp;另外还有一些危险的操作，比如 <code>del sys.modules[&quot;builtins&quot;]</code> 会让 Python 变得不正常<em>(:з」∠)</em></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">del</span> sys.modules[<span class="string">&quot;builtins&quot;</span>]  </span><br><span class="line"><span class="built_in">map</span></span><br><span class="line"><span class="comment"># Traceback (most recent call last):</span></span><br><span class="line"><span class="comment">#   File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span></span><br><span class="line"><span class="comment"># RuntimeError: lost builtins module</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;基于这个原理，如果将缓存清理了，下次 Python import 就会重新加载这个模块，实现 reload 的效果。<br>&emsp;&emsp;我最初也是在 mGear 的代码里面学习它们的 reload 方法学习到的。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/5e6e2bc7/f00532dcd9c19a47bf2caf9012f31df4.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;它背后实现的代码就是 <code>del sys.modules[&quot;mgear&quot;]</code> 等相关的模块</p></blockquote><p><a href="https://docs.python.org/3/reference/import.html#the-module-cache">https://docs.python.org/3/reference/import.html#the-module-cache</a></p><blockquote><p>&emsp;&emsp;根据官方文档的说明，如果一个大模块下有很多子模块，都是单独键值缓存的。<br>&emsp;&emsp;所以要 reload 所有的子模块需要编译键值将匹配的都删除掉。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">module_cleanup</span>(<span class="params">module_name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Cleanup module_name in sys.modules cache.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        module_name (str): Module Name</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> module_name <span class="keyword">in</span> sys.builtin_module_names:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    packages = [mod <span class="keyword">for</span> mod <span class="keyword">in</span> sys.modules <span class="keyword">if</span> mod.startswith(<span class="string">&quot;%s.&quot;</span> % module_name)]</span><br><span class="line">    <span class="keyword">for</span> package <span class="keyword">in</span> packages + [module_name]:</span><br><span class="line">        module = sys.modules.get(package)</span><br><span class="line">        <span class="keyword">if</span> module <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">del</span> sys.modules[package]  <span class="comment"># noqa:WPS420</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NOTES(timmyliang): 这个操作等同于对 test_module 下所有的 module 进行 reload</span></span><br><span class="line">module_cleanup(<span class="string">&quot;test_module&quot;</span>)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;这个就是我整理的遍历所有匹配的模块进行缓存删除的函数，<code>sys.builtin_module_names</code> 通过规避对内置模块的清理。<br>&emsp;&emsp;这样源代码不需要添加 reload ，我们只在开发用的调试脚本添加这个函数执行 reload 即可。<br>&emsp;&emsp;另外有一个小小注意点，用这个删除缓存的方式 reload 会将之前的 module 删除生成新的 module 对象，但是如果用 <code>reload</code> 的话是沿用之前的 module 对象。<br>&emsp;&emsp;目前我实践上还没遇到过因为这个导致出现问题的情况。</p></blockquote><h2 id="packages-命名空间包"><a href="#packages-命名空间包" class="headerlink" title="packages 命名空间包"></a>packages 命名空间包</h2><p><a href="https://packaging.python.org/en/latest/guides/packaging-namespace-packages/">https://packaging.python.org/en/latest/guides/packaging-namespace-packages/</a></p><blockquote><p>&emsp;&emsp;按照上面链接提供的目录结构</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mynamespace-subpackage-a/</span><br><span class="line">    setup.py</span><br><span class="line">    mynamespace/</span><br><span class="line">        subpackage_a/</span><br><span class="line">            __init__.py</span><br><span class="line"></span><br><span class="line">mynamespace-subpackage-b/</span><br><span class="line">    setup.py</span><br><span class="line">    mynamespace/</span><br><span class="line">        subpackage_b/</span><br><span class="line">            __init__.py</span><br><span class="line">        module_b.py</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;然后就可以 <code>from mynamespace import subpackage_b</code> <code>from mynamespace import subpackage_a</code><br>&emsp;&emsp;用同一个 <code>mynamespace</code> 包导入两个不同路径的模块。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/5e6e2bc7/db4d5d1b1d1d7fe61a561b13a9c00e2d.jpeg" alt="image"></p><blockquote><p>&emsp;&emsp;但是上面的链接也提到 命名空间包并不适用所有的情况，反而是用前缀包会更好。</p></blockquote><h3 id="模块遍历查找"><a href="#模块遍历查找" class="headerlink" title="模块遍历查找"></a>模块遍历查找</h3><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pkgutil</span><br><span class="line"><span class="keyword">import</span> xml</span><br><span class="line"><span class="keyword">for</span> finder,name,ispkg <span class="keyword">in</span> pkgutil.walk_packages(xml.__path__,xml.__name__+<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">    <span class="built_in">print</span>(finder,name,ispkg)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出如下</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml&#x27;) xml.dom True</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\dom&#x27;) xml.dom.NodeFilter False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\dom&#x27;) xml.dom.domreg False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\dom&#x27;) xml.dom.expatbuilder False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\dom&#x27;) xml.dom.minicompat False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\dom&#x27;) xml.dom.minidom False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\dom&#x27;) xml.dom.pulldom False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\dom&#x27;) xml.dom.xmlbuilder False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml&#x27;) xml.etree True</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\etree&#x27;) xml.etree.ElementInclude False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\etree&#x27;) xml.etree.ElementPath False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\etree&#x27;) xml.etree.ElementTree False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\etree&#x27;) xml.etree.cElementTree False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml&#x27;) xml.parsers True</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\parsers&#x27;) xml.parsers.expat False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml&#x27;) xml.sax True</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\sax&#x27;) xml.sax._exceptions False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\sax&#x27;) xml.sax.expatreader False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\sax&#x27;) xml.sax.handler False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\sax&#x27;) xml.sax.saxutils False</span></span><br><span class="line"><span class="comment"># FileFinder(&#x27;C:\\tools\\Anaconda3\\lib\\xml\\sax&#x27;) xml.sax.xmlreader False</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;通过 <code>pkgutil.walk_packages</code> 可以遍历一个模块所有的子模块。<br>&emsp;&emsp;<code>from setuptools import find_packages</code> 也可以实现类似的功能<br>&emsp;&emsp;但是 <code>find_packages</code> 面对命名空间模块不好使，但是 <code>walk_packages</code> 好使。(原因是 <code>find_packages</code> 通过 <code>os.walk</code> 去查找路径的)<br>&emsp;&emsp;也可以通过这个方式将对应模块的缓存进行删除~</p></blockquote><h3 id="判断模块是否存在"><a href="#判断模块是否存在" class="headerlink" title="判断模块是否存在"></a>判断模块是否存在</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">importable</span>(<span class="params">module_name</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">__import__</span>(module_name)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> ImportError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;过去判断一模块是否可以 import 通常使用异常进行处理。<br>&emsp;&emsp;其实 <code>pkgutil.find_loader</code> 也可以返回模块是否可以 import</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pkgutil</span><br><span class="line">loader = pkgutil.find_loader(<span class="string">&quot;maya&quot;</span>)</span><br><span class="line">has_maya = loader <span class="keyword">and</span> loader.load_module(<span class="string">&quot;maya&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(has_maya) <span class="comment"># 如果存在返回 maya 库，不存在返回 None</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;上面的方式就不需要用 exception 进行处理。(find_loader 的源码已经有 exception 的逻辑)</p></blockquote><blockquote><p>&emsp;&emsp;如果模块可以导入会返回对应的 <code>loader</code>，使用 <code>load_module</code> 可以进行加载。<br>注: py2 的 <code>load_module</code> 必须要传参。</p></blockquote><h2 id="自定义-import-行为"><a href="#自定义-import-行为" class="headerlink" title="自定义 import 行为"></a>自定义 import 行为</h2><blockquote><p>&emsp;&emsp;除了 <code>sys.path</code> 通过系统路径查找 python 包进行加载之外。<br>&emsp;&emsp;Python 还有 <code>sys.meta_path</code> 存储一系列 Finder 类 (Py3还需要 <code>Loader</code> 类) 来自定义 import 逻辑。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> types</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomFinder</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.submodule_search_locations = []</span><br><span class="line">        self.has_location = <span class="literal">False</span></span><br><span class="line">        self.origin = <span class="literal">None</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_module</span>(<span class="params">self, spec</span>):</span><br><span class="line">        <span class="keyword">return</span> self.load_module(spec.name)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">exec_module</span>(<span class="params">self, module</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Execute the given module in its own namespace</span></span><br><span class="line"><span class="string">        This method is required to be present by importlib.abc.Loader,</span></span><br><span class="line"><span class="string">        but since we know our module object is already fully-formed,</span></span><br><span class="line"><span class="string">        this method merely no-ops.</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_spec</span>(<span class="params">self, fullname,*args</span>):</span><br><span class="line">        self.name = fullname</span><br><span class="line">        self.loader = self</span><br><span class="line">        <span class="keyword">return</span> self.find_module()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># NOTES(timmyliang): compat with Python2</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_module</span>(<span class="params">self,*args</span>):</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">load_module</span>(<span class="params">self, fullname</span>):</span><br><span class="line">        module = sys.modules.get(fullname)</span><br><span class="line">        <span class="keyword">if</span> module:</span><br><span class="line">            <span class="keyword">return</span> module</span><br><span class="line">        </span><br><span class="line">        new_module = types.ModuleType(fullname)</span><br><span class="line">        sys.modules[fullname] = new_module</span><br><span class="line">        new_module.__name__ = fullname</span><br><span class="line">        new_module.__loader__ = self</span><br><span class="line">        <span class="keyword">return</span> new_module</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    sys.meta_path.append(CustomFinder())</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">import</span> myapp</span><br><span class="line">    <span class="built_in">print</span>(myapp)  </span><br><span class="line">    <span class="comment"># Py3: &lt;module &#x27;myapp&#x27; (&lt;__main__.CustomFinder object at 0x000002A2A2904808&gt;)&gt;</span></span><br><span class="line">    <span class="comment"># Py2: &lt;module &#x27;myapp&#x27; (built-in)&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;上面的代码实现了 py2 py3 的 Finder 兼容。<br>&emsp;&emsp;可以实现加载任意名称的模块都能成功返回而不会引发 ImportError<br>&emsp;&emsp;当然这种操作如果用到项目里面，肯定会被人打死 😄</p></blockquote><blockquote><p>&emsp;&emsp;在 Py2 环境下 Finder 需要实现 <code>find_module</code> 和 <code>load_module</code> 方法<br>&emsp;&emsp;Py3 环境可以参考下面的链接。</p></blockquote><p><a href="https://stackoverflow.com/a/58275573/13452951">https://stackoverflow.com/a/58275573/13452951</a></p><blockquote><p>&emsp;&emsp;需要有 Finder 需要实现 <code>find_spec</code> 返回 <code>ModuleSpec</code> 类，这个类需要有 <code>Loader</code> 进行加载逻辑</p></blockquote><blockquote><p>&emsp;&emsp;官方提供的 <code>zipimport.zipimporter</code> 在 Py2 下是 Finder ，在 Py3 下是 Loader。<br>&emsp;&emsp;可以从下面官方文档的类方法中看出来。</p></blockquote><p><a href="https://docs.python.org/2.7/library/zipimport.html?highlight=zip#module-zipimport">https://docs.python.org/2.7/library/zipimport.html?highlight=zip#module-zipimport</a><br><a href="https://docs.python.org/3.10/library/zipimport.html?highlight=zip#module-zipimport">https://docs.python.org/3.10/library/zipimport.html?highlight=zip#module-zipimport</a></p><blockquote><p>&emsp;&emsp;通过需改 import 机制，可以实现很多黑科技，但是推荐使用侵入性较小的使用方式。<br>&emsp;&emsp;这个机制可以让某个模块虚空导入而不报错，这不符合正常使用 Python 的逻辑，可能会让团队其他人很懵逼的。<br>&emsp;&emsp;如果某个 BUG 是因为这个机制导致的，其他人又不熟悉这块的话，那这问题查半天也不一定有结果 😢</p></blockquote><blockquote><p>&emsp;&emsp;这种黑科技的方式无法支持 mypy 类型检测和回溯，倒是可以做一些代码桩来实现提示，但不是很推荐。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>&emsp;&emsp;本次深入浅出地学习了 Python Import 的各种底层逻辑。<br>&emsp;&emsp;以后有机会的话也想好好学习一下 CPython 的底层实现。</p></blockquote>]]></content>
    
    <summary type="html">
    
      自动 unload 模块 &amp; meta import 学习
    
    </summary>
    
      <category term="Python" scheme="https://blog.l0v0.com/categories/Python/"/>
    
      <category term="工具开发" scheme="https://blog.l0v0.com/categories/Python/%E5%B7%A5%E5%85%B7%E5%BC%80%E5%8F%91/"/>
    
    
      <category term="ࠕPython" scheme="https://blog.l0v0.com/tags/%E0%A0%95Python/"/>
    
  </entry>
  
  <entry>
    <title>Python doit 库</title>
    <link href="https://blog.l0v0.com/posts/b552c0c3.html"/>
    <id>https://blog.l0v0.com/posts/b552c0c3.html</id>
    <published>2022-03-28T07:50:36.000Z</published>
    <updated>2022-12-14T02:54:16.949Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;代码开发的过程中可能遇到一些情况想要通过 代码 来自动执行命令行生成一些东西的情况。<br>&emsp;&emsp;如果不使用框架进行管理，这些代码脚本就很零碎地散落在各个地方。<br>&emsp;&emsp;因此就找到这个框架可以很方便管理多个任务，实现</p></blockquote><p><a href="https://github.com/pydoit/doit">Github 地址</a><br><a href="https://pydoit.org/">官方说明文档</a></p><h2 id="doit-的基本用法"><a href="#doit-的基本用法" class="headerlink" title="doit 的基本用法"></a>doit 的基本用法</h2><blockquote><p>&emsp;&emsp;在 doit 执行命令的地方添加一个 <code>dodo.py</code> 的脚本<br>&emsp;&emsp;doit 会去读取 <code>dodo.py</code> 里面命名开头为 <code>task_</code> 的方法作为执行的命令。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">task_hello</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;hello&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">python_hello</span>(<span class="params">targets</span>):</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(targets[<span class="number">0</span>], <span class="string">&quot;a&quot;</span>) <span class="keyword">as</span> output:</span><br><span class="line">            output.write(<span class="string">&quot;Python says Hello World!!!\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;actions&#x27;</span>: [python_hello],</span><br><span class="line">        <span class="string">&#x27;targets&#x27;</span>: [<span class="string">&quot;hello.txt&quot;</span>],</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;比如添加上面的方法到 <code>dodo.py</code> 里面<br>&emsp;&emsp;执行 <code>doit list</code> 可以罗列出当前的可执行的命令</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">F:\thm_git\adam_pose_editor&gt;doit list</span><br><span class="line">hello   hello</span><br><span class="line">F:\thm_git\adam_pose_editor&gt;doit hello</span><br><span class="line">.  hello</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;执行 <code>doit hello</code> 就会在 <code>dodo.py</code> 缩在目录下输出一个 hello.txt 的文件。<br>&emsp;&emsp;这个就是 doit 的基本用法。</p></blockquote><h3 id="dodo-py-配置"><a href="#dodo-py-配置" class="headerlink" title="dodo.py 配置"></a>dodo.py 配置</h3><p><a href="https://pydoit.org/configuration.html">https://pydoit.org/configuration.html</a></p><blockquote><p>&emsp;&emsp;可以使用 <code>doit -f xxx/dodo.py</code> 配置 <code>dodo.py</code> 的路径<br>&emsp;&emsp;也可以使用 <code>pyproject.toml</code> 进行配置</p></blockquote><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[tool.doit]</span></span><br><span class="line"><span class="attr">dodoFile</span> = <span class="string">&quot;scripts/dodo.py&quot;</span></span><br></pre></td></tr></table></figure><h3 id="task-配置"><a href="#task-配置" class="headerlink" title="task 配置"></a>task 配置</h3><blockquote><p>&emsp;&emsp;<code>dodo.py</code> 的 task 支持导入<br>&emsp;&emsp;只要是 <code>task_</code> 前缀的方法就会自动识别。<br>&emsp;&emsp;也可以给函数添加 <code>create_doit_tasks</code> 属性，这样就可以自动生成了。 <a href="https://pydoit.org/task-creation.html#custom-task-definition">文档链接</a></p></blockquote><blockquote><p>&emsp;&emsp;利用这些机制，我搞了一个装饰器可以给 task 添加一个短名的方案。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add_short_name</span>(<span class="params">short_name</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Doit for short decorator.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        short_name (str): short alias name.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        callable: decoartor function.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">decorator</span>(<span class="params">func</span>):</span><br><span class="line">        <span class="built_in">globals</span>()[<span class="string">&quot;task_&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(short_name)] = func  <span class="comment"># noqa: WPS421</span></span><br><span class="line">        <span class="keyword">return</span> func</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decorator</span><br><span class="line"></span><br><span class="line"><span class="meta">@add_short_name(<span class="params"><span class="string">&quot;pf&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task_preflight</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Run pre commit for all files.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        dict: doit config.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    command = [<span class="string">&quot;poetry&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;pre-commit&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;-a&quot;</span>]</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;actions&quot;</span>: [command], <span class="string">&quot;verbosity&quot;</span>: <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;这样运行 doit 会识别到两个 task ，可以分别通过 <code>doit pf</code> 或者 <code>doit preflight</code> 触发指令</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt;doit list </span><br><span class="line">pf          Run pre commit <span class="keyword">for</span> all files.</span><br><span class="line">preflight   Run pre commit <span class="keyword">for</span> all files.</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;但是默认排序是按命名来的，如果命令很多就会混在一起</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt;doit list </span><br><span class="line">b             Run black format all python files.</span><br><span class="line">black         Run black format all python files.</span><br><span class="line">d             Run mkdocs serve.</span><br><span class="line"><span class="built_in">dd</span>            Run mike to deploy docs.</span><br><span class="line">docs          Run mkdocs serve.</span><br><span class="line">docs_deploy   Run mike to deploy docs.</span><br><span class="line">f             Run `black` `isort`.</span><br><span class="line">format        Run `black` `isort`.</span><br><span class="line">i             Run isort format all python files.</span><br><span class="line">isort         Run isort format all python files.</span><br><span class="line">l             Run flakehell lint <span class="keyword">for</span> all python files.</span><br><span class="line">lint          Run flakehell lint <span class="keyword">for</span> all python files.</span><br><span class="line">m             Run mike serve.</span><br><span class="line">mike          Run mike serve.</span><br><span class="line">pf            Run pre commit <span class="keyword">for</span> all files.</span><br><span class="line">preflight     Run pre commit <span class="keyword">for</span> all files.</span><br><span class="line">pt            Run pytest.</span><br><span class="line">pytest        Run pytest.</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;可以使用 doit list –sort=definition 的方式让排序变成创建顺序。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt;doit list --<span class="built_in">sort</span>=definition</span><br><span class="line">f             Run `black` `isort`.</span><br><span class="line">format        Run `black` `isort`.</span><br><span class="line">pf            Run pre commit <span class="keyword">for</span> all files.</span><br><span class="line">preflight     Run pre commit <span class="keyword">for</span> all files.</span><br><span class="line">b             Run black format all python files.</span><br><span class="line">black         Run black format all python files.</span><br><span class="line">i             Run isort format all python files.</span><br><span class="line">isort         Run isort format all python files.</span><br><span class="line">l             Run flakehell lint <span class="keyword">for</span> all python files.</span><br><span class="line">lint          Run flakehell lint <span class="keyword">for</span> all python files.</span><br><span class="line">pt            Run pytest.</span><br><span class="line">pytest        Run pytest.</span><br><span class="line">d             Run mkdocs serve.</span><br><span class="line">docs          Run mkdocs serve.</span><br><span class="line">m             Run mike serve.</span><br><span class="line">mike          Run mike serve.</span><br><span class="line"><span class="built_in">dd</span>            Run mike to deploy docs.</span><br><span class="line">docs_deploy   Run mike to deploy docs.</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;但是每次使用都要加一个参数配置，那是相当的麻烦。<br>&emsp;&emsp;我们可以利用 <code>DOIT_CONFIG</code> 进行配置 <a href="https://pydoit.org/configuration.html#configuration-at-dodo-py">文档链接</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DOIT_CONFIG = &#123;</span><br><span class="line">    <span class="string">&quot;sort&quot;</span>: <span class="string">&quot;definition&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="task-group"><a href="#task-group" class="headerlink" title="task group"></a>task group</h3><blockquote><p>&emsp;&emsp;可以使用 <code>task_dep</code> 的方式执行多个定义好的 task <a href="https://pydoit.org/task-creation.html#custom-task-definition">文档链接</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> glob</span><br><span class="line">DIR = os.path.dirname(__file__)</span><br><span class="line">PY_FILES = glob.glob(os.path.join(DIR, <span class="string">&quot;**/*.py&quot;</span>), recursive=<span class="literal">True</span>)</span><br><span class="line"><span class="meta">@add_short_name(<span class="params"><span class="string">&quot;f&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task_format</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Run `black` `isort`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        dict: doit config.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;actions&quot;</span>: <span class="literal">None</span>, <span class="string">&quot;task_dep&quot;</span>: [<span class="string">&quot;black&quot;</span>, <span class="string">&quot;isort&quot;</span>]&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@add_short_name(<span class="params"><span class="string">&quot;b&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task_black</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Run black format all python files.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        dict: doit config.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    command = [<span class="string">&quot;poetry&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;black&quot;</span>] + PY_FILES</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;actions&quot;</span>: [command], <span class="string">&quot;verbosity&quot;</span>: <span class="number">2</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@add_short_name(<span class="params"><span class="string">&quot;i&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task_isort</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Run isort format all python files.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        dict: doit config.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    command = [<span class="string">&quot;poetry&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;isort&quot;</span>] + PY_FILES</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;actions&quot;</span>: [command], <span class="string">&quot;verbosity&quot;</span>: <span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;通过上面的配置就可以快速给所有的 python 脚本运行 black 和 isort </p></blockquote><h3 id="task-传参"><a href="#task-传参" class="headerlink" title="task 传参"></a>task 传参</h3><p><a href="https://pydoit.org/task-args.html#task-action-parameters">文档链接</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gen_api</span>(<span class="params">api</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Generate API docs.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        api (bool): flag to generate docs</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        str: running command</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># NOTES(timmyliang): remove reference api</span></span><br><span class="line">    rmtree(os.path.join(DIR, <span class="string">&quot;docs&quot;</span>, <span class="string">&quot;reference&quot;</span>), ignore_errors=<span class="literal">True</span>)</span><br><span class="line">    script_path = os.path.join(DIR, <span class="string">&quot;docs&quot;</span>, <span class="string">&quot;gen_api_nav.py&quot;</span>)</span><br><span class="line">    api_command = <span class="string">&quot; &quot;</span>.join([<span class="string">&quot;poetry&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;python&quot;</span>, script_path])</span><br><span class="line">    serve_command = <span class="string">&quot; &quot;</span>.join([<span class="string">&quot;poetry&quot;</span>, <span class="string">&quot;run&quot;</span>, <span class="string">&quot;mkdocs&quot;</span>, <span class="string">&quot;serve&quot;</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;api_command&#125;</span> &amp; <span class="subst">&#123;serve_command&#125;</span>&quot;</span> <span class="keyword">if</span> api <span class="keyword">else</span> serve_command</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@add_short_name(<span class="params"><span class="string">&quot;d&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">task_docs</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Run mkdocs serve.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">        dict: doit config.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&quot;actions&quot;</span>: [CmdAction(gen_api)],</span><br><span class="line">        <span class="string">&quot;params&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;api&quot;</span>,</span><br><span class="line">                <span class="string">&quot;short&quot;</span>: <span class="string">&quot;a&quot;</span>,</span><br><span class="line">                <span class="string">&quot;type&quot;</span>: <span class="built_in">bool</span>,</span><br><span class="line">                <span class="string">&quot;default&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">                <span class="string">&quot;inverse&quot;</span>: <span class="string">&quot;flagoff&quot;</span>,</span><br><span class="line">                <span class="string">&quot;help&quot;</span>: <span class="string">&quot;generate api docs&quot;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;verbosity&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;通过 <code>params</code> 定义传入的参数，就可以控制 mkdocs 是否自动生成 api 的 markdown 脚本。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>&emsp;&emsp;目前我使用上面的写法已经很够用了，其实它还有很多其他的配置可以用来做 C 编译。<br>&emsp;&emsp;还可以定义 task 依赖 和 文件依赖，确保 task 的执行顺序。<br>&emsp;&emsp;整体而言，doit 是个非常简单而是用的框架，配置 tox 等工具可谓是锦上添花。</p></blockquote>]]></content>
    
    <summary type="html">
    
      Python 任务管理命令行
    
    </summary>
    
      <category term="Python" scheme="https://blog.l0v0.com/categories/Python/"/>
    
    
      <category term="ࠕPython" scheme="https://blog.l0v0.com/tags/%E0%A0%95Python/"/>
    
  </entry>
  
  <entry>
    <title>Python dependencies 库</title>
    <link href="https://blog.l0v0.com/posts/7aa50252.html"/>
    <id>https://blog.l0v0.com/posts/7aa50252.html</id>
    <published>2022-03-28T01:50:26.000Z</published>
    <updated>2022-12-14T02:54:16.949Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;在 Java Spring Boot 等等的后端领域，会大量使用依赖注入的方式来简化复杂的设计模式。<br>&emsp;&emsp;实现参数的自动化注入。<br>&emsp;&emsp;这些设计方式在 Python 的世界里使用不多，因为 Python 语言足够灵活。<br>&emsp;&emsp;倘若需要开发复杂的框架，使用 依赖注入 框架可以简化很多代码。</p></blockquote><p><a href="https://github.com/proofit404/dependencies">Github 地址</a><br><a href="https://proofit404.github.io/dependencies/">官方说明文档</a></p><h2 id="依赖注入解决的问题"><a href="#依赖注入解决的问题" class="headerlink" title="依赖注入解决的问题"></a>依赖注入解决的问题</h2><p><a href="https://sobolevn.me/2020/02/typed-functional-dependency-injection">参考文章</a></p><blockquote><p>&emsp;&emsp;在日常开发中，我们的方法调用可能会越来越深。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_robot</span>(<span class="params">robot_name</span>):</span><br><span class="line">    create_robot_hand()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_robot_hand</span>():</span><br><span class="line">    create_robot_finger()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_robot_finger</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;create_robot_finger&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;上面是一个简单的机器人创建调用函数。<br>&emsp;&emsp;调用方式会伴随则系统的复杂程度逐层深入。<br>&emsp;&emsp;到了 <code>create_robot_finger</code> 深度的时候，可能会需要在上层传入参数控制 finger 的数量</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_robot</span>(<span class="params">robot_name,finger_num=<span class="number">10</span></span>):</span><br><span class="line">    create_robot_hand(finger_num=finger_num)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_robot_hand</span>(<span class="params">finger_num=<span class="number">10</span></span>):</span><br><span class="line">    create_robot_finger(finger_num=finger_num)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_robot_finger</span>(<span class="params">finger_num=<span class="number">10</span></span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;create_robot_finger finder_number:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(finger_num))</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;这需要将参数补充到 调用链条 的每一个函数当中。<br>&emsp;&emsp;如果只是上面的 三层 调用深度，那可能手动修改维护还不是什么问题。<br>&emsp;&emsp;但倘若调用深度很深，那这个代码修改量就会非常庞大。<br>&emsp;&emsp;不利于代码的扩展和维护。</p></blockquote><hr><blockquote><p>&emsp;&emsp;在 Python 的世界里，解决这个问题的方法有很多。</p><ol><li>导入 配置 模块，外部获取参数配置</li><li>面向对象 注入依赖，从实例化中获取参数配置</li></ol></blockquote><h3 id="方案一-导入模块"><a href="#方案一-导入模块" class="headerlink" title="方案一 导入模块"></a>方案一 导入模块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;settings.py&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"></span><br><span class="line">ROBOT_FINGER_NUM = <span class="number">10</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_robot</span>(<span class="params">robot_name</span>):</span><br><span class="line">    create_robot_hand()</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_robot_hand</span>():</span><br><span class="line">    create_robot_finger()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_robot_finger</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;create_robot_finger finder_number:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(settings.ROBOT_FINGER_NUM))</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;通过模块的方式将参数转移到外部，进行配置。<br>&emsp;&emsp;这个做法可以解决参数传递的问题。</p></blockquote><blockquote><p>&emsp;&emsp;缺点就是参数管理会比较麻烦，通常是将全局配置的参数都放到一个文件方便集中管理。<br>&emsp;&emsp;但是这样会导致不同的逻辑调用的参数都会塞到一个文件里面，并不是十分整洁。</p></blockquote><h3 id="方案二-注入依赖"><a href="#方案二-注入依赖" class="headerlink" title="方案二 注入依赖"></a>方案二 注入依赖</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dependencies <span class="keyword">import</span> Injector</span><br><span class="line"><span class="keyword">import</span> attr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Robot</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    finger_num = attr.ib(default=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_robot</span>(<span class="params">self,robot_name</span>):</span><br><span class="line">        self.create_robot_hand()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_robot_hand</span>(<span class="params">self</span>):</span><br><span class="line">        self.create_robot_finger()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">create_robot_finger</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;create_robot_finger finder_number:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(self.finger_num))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Container</span>(<span class="title class_ inherited__">Injector</span>):</span><br><span class="line">    finger_num = <span class="number">10</span></span><br><span class="line">    robot = Robot</span><br><span class="line">Container.robot.create_robot(<span class="string">&quot;robot name&quot;</span>)</span><br><span class="line"><span class="comment"># 打印 create_robot_finger finder_number:10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># `dependencies` 的实现等价于下面的代码</span></span><br><span class="line">robot = Robot(finger_num=<span class="number">10</span>)</span><br><span class="line">robot.create_robot(<span class="string">&quot;robot name&quot;</span>)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;使用 <code>dependencies</code> 库实现依赖注入，自动将容器内的数据填充到 类的实例化过程中。<br>&emsp;&emsp;通过类的属性实现参数传递。</p></blockquote><h2 id="dependencies-介绍"><a href="#dependencies-介绍" class="headerlink" title="dependencies 介绍"></a>dependencies 介绍</h2><blockquote><p>&emsp;&emsp;通过上面的案例可以看到。<br>&emsp;&emsp;<code>dependencies</code> 可以自动实例化类，填充类初始化需要的参数。<br>&emsp;&emsp;但它的功能还远不止这么简单。<br>&emsp;&emsp;它还可以实现多个类实例化的自动填充，只要参数变量名命名配置好即可。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dependencies <span class="keyword">import</span> Injector</span><br><span class="line"><span class="keyword">import</span> attr</span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Robot</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    servo = attr.ib()</span><br><span class="line">    controller = attr.ib()</span><br><span class="line">    settings = attr.ib()</span><br><span class="line">    di_environment = attr.ib()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;controller di_environment&quot;</span>,self.controller.di_environment)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;self di_environment&quot;</span>,self.di_environment)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;settings threshold&quot;</span>,self.settings.threshold)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;servo threshold&quot;</span>,self.servo.threshold)</span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Servo</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    threshold = attr.ib()</span><br><span class="line">    </span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Controller</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    di_environment = attr.ib()</span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Settings</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    threshold = attr.ib()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Container</span>(<span class="title class_ inherited__">Injector</span>):</span><br><span class="line">    threshold = <span class="number">1</span></span><br><span class="line">    di_environment = <span class="string">&quot;production&quot;</span></span><br><span class="line">    </span><br><span class="line">    robot = Robot</span><br><span class="line">    servo = Servo</span><br><span class="line">    settings = Settings</span><br><span class="line">    controller = Controller</span><br><span class="line"></span><br><span class="line">Container.robot.run()</span><br><span class="line"><span class="comment"># 打印: </span></span><br><span class="line"><span class="comment"># controller di_environment production</span></span><br><span class="line"><span class="comment"># self di_environment production</span></span><br><span class="line"><span class="comment"># settings threshold 1</span></span><br><span class="line"><span class="comment"># servo threshold 1</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;通过 <code>dependencies</code> 可以根据属性命名自动填充多个类的参数数据。<br>&emsp;&emsp;container 的逻辑等价于下面的代码</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">threshold = <span class="number">1</span></span><br><span class="line">di_environment = <span class="string">&quot;production&quot;</span></span><br><span class="line">servo = Servo(threshold)</span><br><span class="line">settings = Settings(threshold)</span><br><span class="line">controller = Controller(di_environment)</span><br><span class="line">robot = Robot(servo,controller,settings,di_environment)</span><br><span class="line">robot.run()</span><br><span class="line"><span class="comment"># 打印: </span></span><br><span class="line"><span class="comment"># controller di_environment production</span></span><br><span class="line"><span class="comment"># self di_environment production</span></span><br><span class="line"><span class="comment"># settings threshold 1</span></span><br><span class="line"><span class="comment"># servo threshold 1</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;但是 <code>dependencies</code> 库根据参数的命名自动实例化对象，参数的调整变得简单可控。</p></blockquote><h2 id="dependencies-实现-caller-方法"><a href="#dependencies-实现-caller-方法" class="headerlink" title="dependencies 实现 caller 方法"></a>dependencies 实现 caller 方法</h2><p><a href="https://sobolevn.me/2019/03/enforcing-srp">参考文章</a></p><blockquote><p>&emsp;&emsp;利用 依赖注入 可以分离 依赖 和 业务 逻辑</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> attr</span><br><span class="line"><span class="keyword">from</span> dependencies <span class="keyword">import</span> Injector</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Editor</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">install_language</span>(<span class="params">self,lang</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;install language:&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(lang))</span><br><span class="line"></span><br><span class="line">editor = Editor()</span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s(<span class="params">frozen=<span class="literal">True</span>, slots=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ChangeLanguage</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    editor = attr.ib()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self,lang</span>):</span><br><span class="line">        self.editor.install_language(lang)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Container</span>(<span class="title class_ inherited__">Injector</span>):</span><br><span class="line">    editor = editor</span><br><span class="line">    change_language = ChangeLanguage</span><br><span class="line"></span><br><span class="line">Container.change_language(<span class="string">&quot;en_US&quot;</span>)</span><br><span class="line"><span class="comment"># 打印: install language:en_US</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;利用 dependencies 可以构建出 caller 对象。<br>&emsp;&emsp;caller 虽然用类构建，但是调用方式和方法一致，可以方法需要用到的依赖用类实例化的方式进行注入。<br>&emsp;&emsp;实现依赖和传参的分离。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>&emsp;&emsp;依赖注入可以很好解决函数调用过深的问题，让代码结构更加清晰。</p></blockquote>]]></content>
    
    <summary type="html">
    
      Python 依赖注入实现
    
    </summary>
    
      <category term="Python" scheme="https://blog.l0v0.com/categories/Python/"/>
    
    
      <category term="ࠕPython" scheme="https://blog.l0v0.com/tags/%E0%A0%95Python/"/>
    
  </entry>
  
  <entry>
    <title>Python blinker 库</title>
    <link href="https://blog.l0v0.com/posts/9ad5ab39.html"/>
    <id>https://blog.l0v0.com/posts/9ad5ab39.html</id>
    <published>2022-02-28T12:47:25.000Z</published>
    <updated>2022-12-14T02:54:16.947Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;Qt 内置了非常棒的 信号槽的函数。<br>&emsp;&emsp;可以让 UI 进行异步调用。<br>&emsp;&emsp;但是有些时候，并不想依赖 Qt 框架同时又能实现信号槽的功能。<br>&emsp;&emsp;这里可以使用 <code>blinker</code> 库来完成。</p></blockquote><p><a href="https://pythonhosted.org/blinker/">Github 地址</a><br><a href="https://github.com/jek/blinker">官方说明文档</a></p><h2 id="blinker-基本用法"><a href="#blinker-基本用法" class="headerlink" title="blinker 基本用法"></a>blinker 基本用法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> blinker <span class="keyword">import</span> signal,Signal</span><br><span class="line"></span><br><span class="line">initialized = signal(<span class="string">&#x27;initialized&#x27;</span>)</span><br><span class="line">initialized <span class="keyword">is</span> signal(<span class="string">&#x27;initialized&#x27;</span>)</span><br><span class="line">sig = Signal()</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;可以使用匿名信号槽，也可以使用带名称的信号槽。</p></blockquote><hr><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> blinker <span class="keyword">import</span> signal</span><br><span class="line">send_data = signal(<span class="string">&#x27;send-data&#x27;</span>)</span><br><span class="line"><span class="meta">@send_data.connect</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">receive_data</span>(<span class="params">sender, **kw</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Caught signal from %r, data %r&quot;</span> % (sender, kw))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;received!&#x27;</span></span><br><span class="line">result = send_data.send(<span class="string">&#x27;anonymous&#x27;</span>, abc=<span class="number">123</span>)</span><br><span class="line"><span class="built_in">print</span>(result)  <span class="comment"># 打印 [(&lt;function receive_data at 0x000002A3328D4DC8&gt;, &#x27;received!&#x27;)]</span></span><br><span class="line"><span class="comment"># 打印 Caught signal from &#x27;anonymous&#x27;, data &#123;&#x27;abc&#x27;: 123&#125;</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;可以用装饰器的方式连接信号槽<br>&emsp;&emsp;触发信号槽使用 send 方法<br>&emsp;&emsp;并且信号槽执行完可以拿到函数触发的返回值。</p></blockquote><hr><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> blinker <span class="keyword">import</span> signal</span><br><span class="line"></span><br><span class="line">dice_roll = signal(<span class="string">&#x27;dice_roll&#x27;</span>)</span><br><span class="line"><span class="meta">@dice_roll.connect_via(<span class="params"><span class="number">1</span></span>)</span></span><br><span class="line"><span class="meta">@dice_roll.connect_via(<span class="params"><span class="number">3</span></span>)</span></span><br><span class="line"><span class="meta">@dice_roll.connect_via(<span class="params"><span class="number">5</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">odd_subscriber</span>(<span class="params">sender</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Observed dice roll %r.&quot;</span> % sender)</span><br><span class="line">result = dice_roll.send(<span class="number">3</span>)</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;另外一个特点就是可以根据触发的参数去触发相应注册的函数。<br>&emsp;&emsp;Qt 因为要使用 C++，这种注册方式会非常麻烦。</p></blockquote><hr><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> blinker <span class="keyword">import</span> signal</span><br><span class="line"></span><br><span class="line">initialized = signal(<span class="string">&quot;initialized&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@initialized.connect</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initialize_call1</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;initialize_call1&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@initialized.connect</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initialize_call2</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;initialize_call2&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@initialized.connect</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initialize_call3</span>():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;initialize_call3&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> key, weakref <span class="keyword">in</span> initialized.receivers.items():</span><br><span class="line">    func = weakref()</span><br><span class="line">    func()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印: </span></span><br><span class="line"><span class="comment"># initialize_call1</span></span><br><span class="line"><span class="comment"># initialize_call2</span></span><br><span class="line"><span class="comment"># initialize_call3</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;通过信号槽的 <code>receivers</code> 方法可以获取到注册到信号槽的所有函数。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>&emsp;&emsp;这个库可以摆脱 Qt 的依赖实现函数的异步调用。<br>&emsp;&emsp;如果是 Qt 的环境建议还是使用 Qt 内置的 信号槽，这样可以支持 Qt 的多线程等处理。<br>&emsp;&emsp;但如果是 Python 环境下想要摆脱 Qt 的依赖，则推荐 blinker 来完成信号触发。<br>&emsp;&emsp;blinker 还有个好处是可以获取到注册的函数列表，而 Qt 基于 C++ 的并没有提供这个功能，只能通过 Meta 对象来判断这个信号槽是否有函数连接。 <a href="https://github.com/PyQt5/PyQt/blob/0c8e7d33d7a1da7a53a6b6d15869095f1626faf0/Demo/IsSignalConnected.py">参考实现</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      纯 Python 信号槽库
    
    </summary>
    
      <category term="Python" scheme="https://blog.l0v0.com/categories/Python/"/>
    
    
      <category term="ࠕPython" scheme="https://blog.l0v0.com/tags/%E0%A0%95Python/"/>
    
  </entry>
  
  <entry>
    <title>Python marshmallow 库</title>
    <link href="https://blog.l0v0.com/posts/2c8022e3.html"/>
    <id>https://blog.l0v0.com/posts/2c8022e3.html</id>
    <published>2022-02-28T07:37:44.000Z</published>
    <updated>2022-12-14T02:54:16.946Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote><p>&emsp;&emsp;使用 Python 经常需要将一些数据序列化存储到本地<br>&emsp;&emsp;同时又想要反序列化将本地的 json 数据转换为对象。<br>&emsp;&emsp;通常的解决方案是使用数据库的 orm 方案，用 orm 对象来同步数据库。<br>&emsp;&emsp;数据全部附着在 orm 上，当 orm 上的数据改变时直接修改到数据库上。</p></blockquote><blockquote><p>&emsp;&emsp;但是在我的工作使用场景中，Data Centric 的流程更为推崇，因此输出一个 json 文件会更好一点。<br>&emsp;&emsp;那么 marshmallow 库就是一个很不错的选项。</p></blockquote><blockquote><p>&emsp;&emsp;另外这个库可以和 之前提到的 attrs 库可以结合使用。 <a href="./1f4cc7d1.html">文章</a></p></blockquote><p><a href="https://github.com/marshmallow-code/marshmallow">Github 地址</a><br><a href="https://marshmallow.readthedocs.io/en/stable/">官方说明文档</a></p><h2 id="什么是序列化-什么是-orm"><a href="#什么是序列化-什么是-orm" class="headerlink" title="什么是序列化 什么是 orm"></a>什么是序列化 什么是 orm</h2><blockquote><p>&emsp;&emsp;序列化就是将代码对象转换为纯数据进行存储<br>&emsp;&emsp;反序列化就是将纯数据重新转换为 代码对象<br>&emsp;&emsp;代码对象可以拥有特定的方法，可以直接触发对数据的处理。</p></blockquote><blockquote><p>&emsp;&emsp;orm 全称是 Object-relational Mappers<br>&emsp;&emsp;通常是一个定义了对象实例化规则的类。<br>&emsp;&emsp;通过操作这个类的实例就可以用代码的方式将数据进行互相转换。</p></blockquote><p><img src= "/img/loading.gif" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/2c8022e3/01.png" alt="alt"></p><blockquote><p>&emsp;&emsp;上面的图片就是传统 orm 实现的效果，可以用 orm 对象来执行 sql 语句从而简化数据库同步的操作，同时也增加了代码的安全性。<br>&emsp;&emsp;这个操作实现了内存到硬盘桥梁，管理更加清晰方便。</p></blockquote><h2 id="marshmallow-介绍"><a href="#marshmallow-介绍" class="headerlink" title="marshmallow 介绍"></a>marshmallow 介绍</h2><h3 id="marshmallow-基本用法"><a href="#marshmallow-基本用法" class="headerlink" title="marshmallow 基本用法"></a>marshmallow 基本用法</h3><blockquote><p>&emsp;&emsp;和其他 orm 库一样，marshmallow 需要定义 Schema 类作为数据约束。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> attr</span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Album</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    title = attr.ib()</span><br><span class="line">    artist = attr.ib()</span><br><span class="line">    </span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Artist</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    name = attr.ib()</span><br><span class="line"></span><br><span class="line"><span class="comment"># NOTE 生成 Python 对象</span></span><br><span class="line">bowie = Artist(name=<span class="string">&quot;David Bowie&quot;</span>)</span><br><span class="line">album = Album(artist=bowie, title=<span class="string">&quot;Hunky Dory&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> Schema, fields</span><br><span class="line"></span><br><span class="line"><span class="comment"># NOTE 定义 Schema 来约束数据转换</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArtistSchema</span>(<span class="title class_ inherited__">Schema</span>):</span><br><span class="line">    name = fields.Str()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AlbumSchema</span>(<span class="title class_ inherited__">Schema</span>):</span><br><span class="line">    title = fields.Str()</span><br><span class="line">    artist = fields.Nested(ArtistSchema())</span><br><span class="line"></span><br><span class="line"><span class="comment"># NOTE 通过 Schema 将对象转换为字典</span></span><br><span class="line">schema = AlbumSchema()</span><br><span class="line">result = schema.dump(album)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(result))  <span class="comment"># &lt;class &#x27;dict&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(result)  <span class="comment"># &#123;&#x27;artist&#x27;: &#123;&#x27;name&#x27;: &#x27;David Bowie&#x27;&#125;, &#x27;title&#x27;: &#x27;Hunky Dory&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line">result = schema.dumps(album)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(result))  <span class="comment"># &lt;class &#x27;str&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(result)   <span class="comment"># &#x27;&#123;&quot;artist&quot;: &#123;&quot;name&quot;: &quot;David Bowie&quot;&#125;, &quot;title&quot;: &quot;Hunky Dory&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">album = schema.loads(result)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(album))  <span class="comment"># &lt;class &#x27;dict&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(album)  <span class="comment"># &#123;&#x27;artist&#x27;: &#123;&#x27;name&#x27;: &#x27;David Bowie&#x27;&#125;, &#x27;title&#x27;: &#x27;Hunky Dory&#x27;&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;通过 Schema 定义好数据对象的转换方式。<br>&emsp;&emsp;<code>dump</code> 可以将对象数据转换为字典，<code>dumps</code> 则是转换为 字符串<br>&emsp;&emsp;<code>load</code> 可以将字典转换为对象(默认是字典，需要额外的处理才可以)，<code>loads</code> 可以将字符串转换为对象。</p></blockquote><h3 id="反序列化为对象"><a href="#反序列化为对象" class="headerlink" title="反序列化为对象"></a>反序列化为对象</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> attr</span><br><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> Schema, fields, post_load</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Album</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    title = attr.ib()</span><br><span class="line">    artist = attr.ib()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Artist</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    name = attr.ib()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArtistSchema</span>(<span class="title class_ inherited__">Schema</span>):</span><br><span class="line">    name = fields.Str()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ArtistSchema</span>(<span class="title class_ inherited__">Schema</span>):</span><br><span class="line">    name = fields.Str()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @post_load</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_artist</span>(<span class="params">self, data, **kwargs</span>):</span><br><span class="line">        <span class="keyword">return</span> Artist(**data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AlbumSchema</span>(<span class="title class_ inherited__">Schema</span>):</span><br><span class="line">    title = fields.Str()</span><br><span class="line">    artist = fields.Nested(ArtistSchema())</span><br><span class="line"></span><br><span class="line"><span class="meta">    @post_load</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_album</span>(<span class="params">self, data, **kwargs</span>):</span><br><span class="line">        <span class="keyword">return</span> Album(**data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bowie = Artist(name=<span class="string">&quot;David Bowie&quot;</span>)</span><br><span class="line">album = Album(artist=bowie, title=<span class="string">&quot;Hunky Dory&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># NOTE 通过 Schema 将对象转换为字典</span></span><br><span class="line">schema = AlbumSchema()</span><br><span class="line">result = schema.dumps(album)</span><br><span class="line">album = schema.loads(result)</span><br><span class="line"><span class="built_in">print</span>(album)  <span class="comment"># Album(title=&#x27;Hunky Dory&#x27;, artist=Artist(name=&#x27;David Bowie&#x27;))</span></span><br><span class="line"><span class="built_in">print</span>(album.title)  <span class="comment"># Hunky Dory</span></span><br><span class="line"><span class="built_in">print</span>(album.artist)  <span class="comment"># Artist(name=&#x27;David Bowie&#x27;)</span></span><br><span class="line"><span class="built_in">print</span>(album.artist.name)  <span class="comment"># David Bowie</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;通过加入 <code>post_load</code> 装饰器可以将字典数据做进一步的转换。<br>&emsp;&emsp;使用 attrs 库就不需要在 <code>__init__</code> 函数中写入大量传参和初始化数据的信息了。</p></blockquote><h3 id="嵌套-Schema"><a href="#嵌套-Schema" class="headerlink" title="嵌套 Schema"></a>嵌套 Schema</h3><p><a href="https://marshmallow.readthedocs.io/en/stable/nesting.html">官方文档</a></p><blockquote><p>&emsp;&emsp;通过 <code>fields.Nested</code> 的方法定义嵌套的对象，从而序列化和反序列化可以复用 Schema。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> attr</span><br><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> Schema, fields</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(<span class="title class_ inherited__">Dict</span>):</span><br><span class="line">    title = attr.ib()</span><br><span class="line">    author = attr.ib()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Author</span>(<span class="title class_ inherited__">Dict</span>):</span><br><span class="line">    name = attr.ib()</span><br><span class="line">    books = attr.ib()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">potter = Book(<span class="string">&quot;potter&quot;</span>, <span class="string">&quot;JK&quot;</span>)</span><br><span class="line">JK = Author(<span class="string">&quot;JK&quot;</span>, [potter])</span><br><span class="line">potter.author = JK</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookSchema</span>(<span class="title class_ inherited__">Schema</span>):</span><br><span class="line">    title = fields.Str()</span><br><span class="line">    author = fields.Nested(<span class="string">&quot;AuthorSchema&quot;</span>, only=(<span class="string">&quot;name&quot;</span>,))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthorSchema</span>(<span class="title class_ inherited__">Schema</span>):</span><br><span class="line">    name = fields.Str()</span><br><span class="line">    books = fields.<span class="type">List</span>(fields.Nested(<span class="string">&quot;BookSchema&quot;</span>, exclude=(<span class="string">&quot;author&quot;</span>,)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">schema = BookSchema()</span><br><span class="line">res = schema.dump(potter)</span><br><span class="line"><span class="built_in">print</span>(res)  <span class="comment"># &#123;&#x27;title&#x27;: &#x27;potter&#x27;, &#x27;author&#x27;: &#123;&#x27;name&#x27;: &#x27;JK&#x27;&#125;&#125;</span></span><br></pre></td></tr></table></figure><h3 id="自定义-Field"><a href="#自定义-Field" class="headerlink" title="自定义 Field"></a>自定义 Field</h3><p><a href="https://marshmallow.readthedocs.io/en/stable/custom_fields.html">官方文档</a></p><blockquote><p>&emsp;&emsp;默认提供的 field 可能不能满足需求。<br>&emsp;&emsp;有些库的 field 需要自定义复杂的 序列化 和 反序列化操作。<br>&emsp;&emsp;这个时候就可以定义自己的 field 来解决问题。</p></blockquote><blockquote><p>&emsp;&emsp;简单的情况可以使用 <code>Method</code> 和 <code>Function</code> 来解决问题</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserSchema</span>(<span class="title class_ inherited__">Schema</span>):</span><br><span class="line">    name = fields.String()</span><br><span class="line">    email = fields.String()</span><br><span class="line">    created_at = fields.DateTime()</span><br><span class="line">    since_created = fields.Method(<span class="string">&quot;get_days_since_created&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_days_since_created</span>(<span class="params">self, obj</span>):</span><br><span class="line">        <span class="keyword">return</span> dt.datetime.now().day - obj.created_at.day</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserSchema</span>(<span class="title class_ inherited__">Schema</span>):</span><br><span class="line">    name = fields.String()</span><br><span class="line">    email = fields.String()</span><br><span class="line">    created_at = fields.DateTime()</span><br><span class="line">    uppername = fields.Function(<span class="keyword">lambda</span> obj: obj.name.upper())</span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;默认情况下是 serialize 函数，如果要自定义 deserialize 可以使用  <code>Method</code> 和 <code>Function</code> 传入 deserialize 参数进行指定。</p></blockquote><blockquote><p>&emsp;&emsp;复杂的情况就需要 <code>fields.Field</code> 类。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> fields, ValidationError</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PinCode</span>(fields.Field):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Field that serializes to a string of numbers and deserializes</span></span><br><span class="line"><span class="string">    to a list of numbers.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_serialize</span>(<span class="params">self, value, attr, obj, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> value <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(<span class="built_in">str</span>(d) <span class="keyword">for</span> d <span class="keyword">in</span> value)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_deserialize</span>(<span class="params">self, value, attr, data, **kwargs</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">return</span> [<span class="built_in">int</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> value]</span><br><span class="line">        <span class="keyword">except</span> ValueError <span class="keyword">as</span> error:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&quot;Pin codes must contain only digits.&quot;</span>) <span class="keyword">from</span> error</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserSchema</span>(<span class="title class_ inherited__">Schema</span>):</span><br><span class="line">    name = fields.String()</span><br><span class="line">    email = fields.String()</span><br><span class="line">    created_at = fields.DateTime()</span><br><span class="line">    pin_code = PinCode()</span><br></pre></td></tr></table></figure><h2 id="踩过的坑"><a href="#踩过的坑" class="headerlink" title="踩过的坑"></a>踩过的坑</h2><h3 id="双向嵌套数据"><a href="#双向嵌套数据" class="headerlink" title="双向嵌套数据"></a>双向嵌套数据</h3><blockquote><p>&emsp;&emsp;如果数据存在相互嵌套引用的关系，是无法通过原生的 json 内置库进行序列化的。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> attr</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> addict <span class="keyword">import</span> <span class="type">Dict</span></span><br><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> Schema, fields</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(<span class="title class_ inherited__">Dict</span>):</span><br><span class="line">    title = attr.ib()</span><br><span class="line">    author = attr.ib()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Author</span>(<span class="title class_ inherited__">Dict</span>):</span><br><span class="line">    name = attr.ib()</span><br><span class="line">    books = attr.ib()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">potter = Book(<span class="string">&quot;potter&quot;</span>, <span class="string">&quot;JK&quot;</span>)</span><br><span class="line">JK = Author(<span class="string">&quot;JK&quot;</span>, [potter])</span><br><span class="line">potter.author = JK</span><br><span class="line"><span class="built_in">print</span>(json.dumps(potter))</span><br><span class="line"><span class="comment"># Traceback (most recent call last):</span></span><br><span class="line"><span class="comment">#   File &quot;f:/repo/_blog/source/_posts/Python/pacakge/02_marshmallow.py&quot;, line 22, in &lt;module&gt;</span></span><br><span class="line"><span class="comment">#     print(json.dumps(potter))</span></span><br><span class="line"><span class="comment">#   File &quot;C:\tools\Anaconda3\lib\json\__init__.py&quot;, line 231, in dumps</span></span><br><span class="line"><span class="comment">#     return _default_encoder.encode(obj)</span></span><br><span class="line"><span class="comment">#   File &quot;C:\tools\Anaconda3\lib\json\encoder.py&quot;, line 199, in encode</span></span><br><span class="line"><span class="comment">#     chunks = self.iterencode(o, _one_shot=True)</span></span><br><span class="line"><span class="comment">#   File &quot;C:\tools\Anaconda3\lib\json\encoder.py&quot;, line 257, in iterencode</span></span><br><span class="line"><span class="comment">#     return _iterencode(o, 0)</span></span><br><span class="line"><span class="comment"># ValueError: Circular reference detected</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;marshmallow 则需要通过 Schema 的定义过滤掉特定的嵌套键值才可用。<br>&emsp;&emsp;并且加载数据的时候并不能还原它们原有的关联关系。<br>&emsp;&emsp;需要自己的手动去定义反序列化之后的操作。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> attr</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> addict <span class="keyword">import</span> <span class="type">Dict</span></span><br><span class="line"><span class="keyword">from</span> marshmallow <span class="keyword">import</span> Schema, fields,post_load</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>(<span class="title class_ inherited__">Dict</span>):</span><br><span class="line">    title = attr.ib()</span><br><span class="line">    author = attr.ib(default=<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@attr.s</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Author</span>(<span class="title class_ inherited__">Dict</span>):</span><br><span class="line">    name = attr.ib()</span><br><span class="line">    books = attr.ib(factory=<span class="built_in">list</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">potter = Book(<span class="string">&quot;potter&quot;</span>, <span class="string">&quot;JK&quot;</span>)</span><br><span class="line">JK = Author(<span class="string">&quot;JK&quot;</span>, [potter])</span><br><span class="line">potter.author = JK</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BookSchema</span>(<span class="title class_ inherited__">Schema</span>):</span><br><span class="line">    title = fields.Str()</span><br><span class="line">    author = fields.Nested(<span class="string">&quot;AuthorSchema&quot;</span>, only=(<span class="string">&quot;name&quot;</span>,))</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @post_load</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_object</span>(<span class="params">self, data, **kwargs</span>):</span><br><span class="line">        book = Book(**data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;author&#x27;</span> <span class="keyword">in</span> data:</span><br><span class="line">            books = book.author.books</span><br><span class="line">            <span class="keyword">if</span> book <span class="keyword">not</span> <span class="keyword">in</span> books:</span><br><span class="line">                books.append(book)</span><br><span class="line">        <span class="keyword">return</span> book</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AuthorSchema</span>(<span class="title class_ inherited__">Schema</span>):</span><br><span class="line">    name = fields.Str()</span><br><span class="line">    books = fields.<span class="type">List</span>(fields.Nested(<span class="string">&quot;BookSchema&quot;</span>, exclude=(<span class="string">&quot;author&quot;</span>,)))</span><br><span class="line"></span><br><span class="line"><span class="meta">    @post_load</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_object</span>(<span class="params">self, data, **kwargs</span>):</span><br><span class="line">        author = Author(**data)</span><br><span class="line">        <span class="keyword">for</span> book <span class="keyword">in</span> author.books:</span><br><span class="line">            book.author = author</span><br><span class="line">        <span class="keyword">return</span> author</span><br><span class="line"></span><br><span class="line">schema = BookSchema()</span><br><span class="line">res = schema.dumps(potter).data</span><br><span class="line"></span><br><span class="line">new_potter = schema.loads(res).data</span><br><span class="line"><span class="built_in">print</span>(potter)  <span class="comment"># Book(title=&#x27;potter&#x27;, author=Author(name=&#x27;JK&#x27;, books=[...]))</span></span><br><span class="line"><span class="built_in">print</span>(new_potter)  <span class="comment"># Book(title=&#x27;potter&#x27;, author=Author(name=&#x27;JK&#x27;, books=[...]))</span></span><br><span class="line"></span><br><span class="line">schema = AuthorSchema()</span><br><span class="line">res = schema.dumps(JK).data</span><br><span class="line">new_JK = schema.loads(res).data</span><br><span class="line"><span class="built_in">print</span>(JK)  <span class="comment"># Author(name=&#x27;JK&#x27;, books=[Book(title=&#x27;potter&#x27;, author=...)])</span></span><br><span class="line"><span class="built_in">print</span>(new_JK)  <span class="comment"># Author(name=&#x27;JK&#x27;, books=[Book(title=&#x27;potter&#x27;, author=...)])</span></span><br></pre></td></tr></table></figure><blockquote><p>&emsp;&emsp;关系重建需要手动处理。</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote><p>&emsp;&emsp;使用 marshmallow 可以很方便实现数据序列化。<br>&emsp;&emsp;使用的时候可以配合 <code>addict</code> 以及下一篇文章要介绍的 <code>cerberus</code> 结合使用。<br>&emsp;&emsp;可以让使用体验更上一层楼。</p></blockquote>]]></content>
    
    <summary type="html">
    
      序列化 orm 工具
    
    </summary>
    
      <category term="Python" scheme="https://blog.l0v0.com/categories/Python/"/>
    
    
      <category term="ࠕPython" scheme="https://blog.l0v0.com/tags/%E0%A0%95Python/"/>
    
  </entry>
  
</feed>
