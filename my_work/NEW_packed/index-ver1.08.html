<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1"  charset="utf-8">
<title>穗源网络科技</title>
<style>
html , body {height:100%;width:100%;margin: 0px;padding: 0px;overflow: hidden}

#logo{position:absolute;width:40%; left: 50%;top: 50%;transform: translate(-50%,-50%);} 

/*#panel {padding: 0; margin: 0; width: 200px;height: 500px;background: #a0a0f0;position: absolute;right:3px;top:20%;border:4px solid #000}*/
#panel {padding: 0; margin: 0; width: 30%;height: 500px;position: absolute;right:3px;top:0%;}

</style>
<meta name="generator" content="Hexo 4.2.1"></head>

<body>
   <!--设置webgl的id让threejs链接-->
    <div id="webgl">

        <div id="logo">
           <div id="container"></div>
        </div>
    </div>
       
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/3.3.7/css/bootstrap.min.css">  
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/92/three.min.js"></script><!--链接threejs的库-->
    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/controls/OrbitControls.js"></script><!--Orbit摄像机脚本-->
    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/controls/EditorControls.js"></script><!--Editor摄像机脚本-->
    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/controls/PointerLockControls.js"></script><!--第一人称脚本-->
    
     <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/loaders/OBJLoader.js"></script><!--加载OBJ的脚本-->
    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/loaders/MTLLoader.js"></script><!--加载mtl的脚本-->
    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/loaders/DDSLoader.js"></script><!--加载DDS的脚本-->
    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/loaders/DDSLoader.js"></script><!--加载DDS的脚本-->
    <!-- <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/libs/inflate.min.js"></script> -->
    <!--FBX脚本引用的库-->
    <!-- <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/loaders/FBXLoader.js"></script> -->
    <!--加载FBX的脚本-->

    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/libs/inflate.min.js"></script><!--FBX脚本引用的库-->
    <script src="js/loaders/FBXLoader.js"></script><!--加载FBX的脚本-->

    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/shaders/CopyShader.js"></script>
    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/shaders/FXAAShader.js"></script>
    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/postprocessing/EffectComposer.js"></script>
    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/postprocessing/RenderPass.js"></script>
    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/postprocessing/ShaderPass.js"></script>
    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/threejs/postprocessing/OutlinePass.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/progressbar.js/1.0.1/progressbar.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5tooltipsjs/1.7.2/html5tooltips.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/html5tooltipsjs/1.7.2/html5tooltips.animation.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/html5tooltipsjs/1.7.2/html5tooltips.min.css" rel="stylesheet">
    
    <script src="https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/NEW_packed/js/SuiYuan_THREE_View-ver1.0.6.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/draggabilly/2.2.0/draggabilly.pkgd.min.js"></script>
    
    <script type="text/javascript">
        (function(){
        var script=document.createElement('script');//添加script标签
        script.onload=function(){//当脚本加载时运行
            var stats = new Stats();
            document.body.appendChild(stats.dom);//添加到body标签中
            requestAnimationFrame(function loop(){//添加刷新函数
                stats.update();//调用实时刷新
                requestAnimationFrame(loop)//递归调用实现刷新
            });
        };
        script.src='https://cdnjs.cloudflare.com/ajax/libs/stats.js/16/Stats.min.js';//script标签加入src
        document.head.appendChild(script);//script标签添加到头部
    })()//闭包编写，减少对其他代码的影响
    
        var app = new SuiYuan.THREE_View();
        
        app.setCamera({focalLength:45});
        app.setWebGLRenderer({antialias:true});
//        
        var init = app.initScene();
        

        init.scene.background = new THREE.Color(0x87CEFA );
        
//        //背景图片hdr
//        var BGsphere = init.backgroundImage('texture/blur.jpg');
//        BGsphere.scale.x = BGsphere.scale.y = BGsphere.scale.z = 20;
        
//        //360控制
        var Control = init.EditorControl();
        
        //360控制
//        var Control = init.OrbitControl();
//        Control.maxDistance = 25;
//        Control.enablePan = true;
//        Control.panSpeed = .1;
//        Control.maxPolarAngle = Math.PI*.45;//限制摄像机往下移动
//        
        
        //第一人称
//        init.collide_Objects.push(cube);
//        init.PointerLockControl();
//        init.PointerLockControl_block();
        
//        //外轮廓显示
        var pass = app.renderPass();
        var outline = pass.outlinePass('#00ff00',false,true);
        
        var area = "占地面积："
        var price = "价格："
        var sold = "出售情况："
        var areaUnit = " 平方米"
        var priceUnit = " 元/平方米"
        var currentSelected;
        var lastSelected = [];
        var PanelClickPrevent = true;
        var combineCheck = true;
    
        // var Data = [
        //     {"area":33,"price":444,"sold":true,"model":"tower_top"},
        //     {"area":23,"price":4424,"sold":true,"model":"tower_inner_1"},
        //     {"area":13,"price":4444,"sold":false,"model":"tower_inner_2"},
        //     {"area":53,"price":44254,"sold":true,"model":"tower_inner_3"},
        //     {"area":43,"price":4414,"sold":false,"model":"tower_inner_4"},
        //     {"area":63,"price":42414,"sold":true,"model":"tower_inner_5"}
        // ]
//       var Data = [
////           {"area":33,"price":444,"sold":true,"model":"polySurface4390 group16"},
//            {"area":33,"price":444,"sold":true,"model":"polySurface4390"},
//            {"area":23,"price":4424,"sold":true,"model":"group16"},
////            {"area":13,"price":4444,"sold":false,"model":"group17"},
////            {"area":53,"price":44254,"sold":true,"model":"Line1645"},
////            {"area":43,"price":4414,"sold":false,"model":"group18"},
//           {"area":43,"price":4414,"sold":false,"model":"group18 Line1645 group17"},
////            {"area":63,"price":42414,"sold":true,"model":"group19"},
////            {"area":73,"price":4614,"sold":true,"model":"group20"},
//           {"area":73,"price":4614,"sold":true,"model":"group20 group19"},
////            {"area":83,"price":43414,"sold":false,"model":"group21"},
////            {"area":93,"price":4614,"sold":true,"model":"group22"},
//           {"area":93,"price":4614,"sold":true,"model":"group22 group21"},
//       ]
       
       var Data = []
       for(let i = 1; i<=40;i++){
           var dataTest = {
        "area":Math.floor(Math.random(i)*100),
        "price":Math.floor(Math.random(i)*1000),
        "sold":true,
        "model":"obj_"+i,
        "text":"房间" + i}
           Data.push(dataTest);
       }
        for(let i = 1; i<=35;i++){
           var dataTest = {
            "area":Math.floor(Math.random(i)*100),
            "price":Math.floor(Math.random(i)*1000),
            "sold":true,
            "model":"obj2_"+i,
            "text":"房间" + i}
           Data.push(dataTest);
        }

        app.outlineIntersectCall(function(selected,outlineGrp){//光线发射时执行
             
        if(PanelClickPrevent){//面板点击阻断
            //递归遍历消除所有的emissive
            (function removeEmissive( objects ) {
                for ( var i = 0, l = objects.length; i < l; i ++ ) {

                    var object = objects[ i ];

                    if(object.material != undefined){
                        if(object.material.length == undefined){//说明是单个材质
                            if(object.material.type != "MeshBasicMaterial"){
                                object.material.emissive = new THREE.Color( 0x000000 );
                            }
                            
                        }else{
                            for(let m in object.material){
                                object.material[m].emissive = new THREE.Color( 0x000000 );
                            }
                                
                        }
                    }
                    removeEmissive( object.children );
                }
            } )(init.scene.children)
            
            combineCheck = true;
            
            if(selected.name == 'background_capsule:background_bowl'){//点击背景
                $("#btn").hide();
                $('#attr1').text("名称：")
                $('#attr2').text(area)
                $('#attr3').text(price)
                $('#attr4').text(sold) 
                outlineGrp = []
                lastSelected = []
            }else{
                
                for (let num in Data){
                    
                    var arr= Data[num].model.split(' ');//检测空格
                    
                    if(arr.length == 1){//没有模型合并情况
                        if(selected.name == Data[num].model){
//                            console.log(selected.name)
                        lastSelected.length = 0; 
                        lastSelected[0] = selected;   
                        outlineGrp.length = 0;//清空外轮廓的数组
                        outlineGrp[0] = selected ;//加入外轮廓效果
                        $("#btn").show();
                        $('#attr1').text("名称：" + Data[num].text)
                        $('#attr2').text(area + Data[num].area + areaUnit)
                        $('#attr3').text(price + Data[num].price + priceUnit)
                        if(Data[num].sold)
                            $('#attr4').text(sold + "在售")
                        else
                           $('#attr4').text(sold + "售罄") 
                           
                           if(selected.material.length == undefined){
                               selected.material.emissive = new THREE.Color( 0x4411ff );
                           }else{
                               for(let t in selected.material){
                                   selected.material[t].emissive = new THREE.Color( 0x4411ff );
                               }
                                    
                           }
                        
                            
                        combineCheck = false;//禁止执行合并的模型
                        }
                        
                    }else if(combineCheck){ //存在模型合并情况
                        lastSelected.length = 0;
                        outlineGrp.length = 0;
                        //递归遍历消除所有的emissive
                        (function removeEmissive( objects ) {
                            for ( var i = 0, l = objects.length; i < l; i ++ ) {

                                var object = objects[ i ];

                                if(object.material != undefined){
                                    if(object.material.length == undefined){//说明是单个材质
                                        if(object.material.type != "MeshBasicMaterial"){
//                                            object.material.opacity = 0;
                                            object.material.emissive = new THREE.Color( 0x000000 );
                                        }
                                        
                                        
                                    }else{
                                        for(let m in object.material){
                                            object.material[m].emissive = new THREE.Color( 0x000000 );
//                                            object.material[m].opacity = 0;
                                        }
                                            
                                    }
                                }
                                removeEmissive( object.children );
                            }
                        } )(init.scene.children)
                        for(let num2 in arr){
                            //递归遍历生成模型合并效果
                            (function traverseObjects( objects ) {

                                for ( var i = 0, l = objects.length; i < l; i ++ ) {

                                    var object = objects[ i ];

                                    if(object.name == arr[num2]){
                                        for(let t in object.material){
                                          object.material[t].emissive = new THREE.Color( 0x4411ff );
//                                            object.material[t].opacity = 1;  
                                        }
                                        

                                        outlineGrp.push( object );
                                        lastSelected.push(object);
                                    }
                                    traverseObjects( object.children );
                                }
                            } )(init.scene.children)                                                     
                            if(selected.name == arr[num2]){
                                $("#btn").show();
                                $('#attr1').text("名称：" + Data[num].text)
                                $('#attr2').text(area + Data[num].area + areaUnit)
                                $('#attr3').text(price + Data[num].price + priceUnit)
                                if(Data[num].sold)
                                    $('#attr4').text(sold + "在售")
                                else
                                   $('#attr4').text(sold + "售罄") 
                                combineCheck = false;//确保不会再被后面的模型影响
                            }
                            
                        }
                    }
                } 
            }
        }else{
            if(lastSelected)
                for(let i in lastSelected)
                    outlineGrp.push( lastSelected[i] );
            
        }

        PanelClickPrevent = true;

        },
        function(raycaster){
            
//            var SpriteIntersects = raycaster.intersectObjects( SpriteGrp.children, true );
//            
//            if(SpriteIntersects.length > 0){
//                console.log("hello");
//            }
        })
        /************************/
        var bar = app.progressBarSVG(logo,undefined,'circle');
        
        app.cameraFixEnabled(function(){//在模型加载完之后执行
            
            setTimeout('app.camera_check = true;',1000);//摄像机移动
            
            //复制模型
            for(let i = 1;i<12;i++){
                var test = model_source_3.clone()
                test.position.x += i*0.65;
                RotateGrp.add(test);
            }
            
            for(let i = 1;i<11;i++){
                var test = model_source_4.clone()
                test.position.x -= i*0.65;
                RotateGrp.add(test);
            }

            //递归添加第一层Sprite
            (function addSprite( objects ) {
                for ( var i = 0, l = objects.length; i < l; i ++ ) {

                    var object = objects[ i ];

                    for(let num = 1; num <= 40;num++){
                       if(object.name == "obj_" + num){

                            var spritey = makeTextSprite( Data[num-1].text, 
                            { fontsize: 32, fontface: "Georgia", borderColor: {r:0, g:0, b:255, a:1.0} } );
                            
                            let centroid = getCentroid(object);
                           
                            spritey.position.set(centroid.x,centroid.y,centroid.z);
                            
                            SpriteGrp.add(spritey)
                        } 
                    }
                    addSprite( object.children );
                }
            } )(model_source_2.children)           
            SpriteGrp.position.y += 28.5;
            SpriteGrp.visible = false;
            RotateGrp.add( SpriteGrp );
            
            //递归添加第二层Sprite
            (function addSprite( objects ) {
                for ( var i = 0, l = objects.length; i < l; i ++ ) {

                    var object = objects[ i ];

                    for(let num = 1; num <= 35;num++){
                       if(object.name == "obj2_" + num){

                            var spritey = makeTextSprite( Data[num+39].text, 
                            { fontsize: 32, fontface: "Georgia", borderColor: {r:0, g:0, b:255, a:1.0} } );
                            
                            let centroid = getCentroid(object);
                           
                            spritey.position.set(centroid.x,centroid.y,centroid.z);
//                            console.log(centroid)
                            SpriteGrp2.add(spritey)
                        } 
                    }
                    addSprite( object.children );
                }
            } )(model_source_7.children) ;          
            SpriteGrp2.position.y -= 166.5;
            RotateGrp.add( SpriteGrp2 );
            
            //递归遍历所有transparent的物体 记录transparent值
            (function transparentObject( objects ) {
                for ( var i = 0, l = objects.length; i < l; i ++ ) {

                    var object = objects[ i ];

                    if(object.material != undefined){
                        if(object.material.length == undefined){//说明是单个材质
                            if(object.material.transparent == true){
                                TransparentArray.push(object.material);
                                TransparentArrayValue.push(object.material.opacity);
                            }
                        }else{
                            for(let m in object.material){
                                if(object.material[m].transparent == true){
                                    TransparentArray.push(object.material[m]);
                                    TransparentArrayValue.push(object.material[m].opacity);
                                    }
                                }
                        }
                    }
                    transparentObject( object.children );
                }
            } )(RotateGrp.children);

            //递归遍历第二层不透明物体 
            (function setSecondArray( objects ) {
                for ( var i = 0, l = objects.length; i < l; i ++ ) {

                    var object = objects[ i ];

                    if(object.material != undefined){
                        if(object.material.length == undefined){//说明是单个材质
                            if(object.material.transparent == false){
                                SecondOpaqueArray.push(object.material);
                            }
                        }else{
                            for(let m in object.material){
                                if(object.material[m].transparent == false){
                                    SecondOpaqueArray.push(object.material[m]);
                                    }
                                }
                        }
                    }
                    setSecondArray( object.children );
                }
            } )(SecondGrp.children);
            
            //递归遍历记录第二层楼顶
            (function transparentObject( objects ) {
                for ( var i = 0, l = objects.length; i < l; i ++ ) {

                    var object = objects[ i ];

                    if(object.material != undefined){
                        if(object.material.length == undefined){//说明是单个材质
                            if(object.material.transparent == false){
                                object.material.transparent = true;
                                SecondCeilingOpaqueArray.push(object.material);
                            }
                        }else{
                            for(let m in object.material){
                                if(object.material[m].transparent == false){
                                    object.material[m].transparent= true;
                                    SecondCeilingOpaqueArray.push(object.material[m])
                                }
                            }
                        }
                    }
                    transparentObject( object.children );
                }
            } )(model_source_12.children);
            console.log(SecondCeilingOpaqueArray)
        },function(){
            app.camera_check = false; 
        });
        
        
        var manager = app.LoadingManagement();
        
        var RotateGrp = new THREE.Group();
        var SecondGrp = new THREE.Group();
        var SpriteGrp = new THREE.Group();
        var SpriteGrp2 = new THREE.Group();
        var SecondOpaqueArray = []
        var SecondCeilingOpaqueArray = []
        var TransparentArray = []
        var TransparentArrayValue = []
        
        var textureLoader = new THREE.TextureLoader();
        var envPath = 'https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/NEW_packed/texture/skyboxsun25deg/';
        var reflectionCube = app.getEnvMap(envPath);
        
        var path = 'https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/NEW_packed/model/scene/fbx/model.fbx';
        var model_source_1= new app.getModel(path);

        var path = 'https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/NEW_packed/model/scene/fbx/click.fbx';
        var model_source_2= new app.getModel(path);
        
        var path = 'https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/NEW_packed/model/scene/fbx/copy_chair_12.fbx';
        var model_source_3= new app.getModel(path);

        var path = 'https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/NEW_packed/model/scene/fbx/copy_chair_10.fbx';
        var model_source_4= new app.getModel(path);
        
        var path = 'https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/NEW_packed/model/scene/fbx/first_ceiling.fbx';
        var model_source_6= new app.getModel(path);
        model_source_6.scale.set(0.01,0.01,0.01)
        
        var path = 'https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/NEW_packed/model/scene/fbx/second_click.fbx';
        var model_source_7= new app.getModel(path);
        model_source_7.scale.set(0.01,0.01,0.01)
        
        var path = 'https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/NEW_packed/model/scene/fbx/second3.fbx';
        var model_source_8= new app.getModel(path);
        model_source_8.scale.set(0.01,0.01,0.01)
        
        var path = 'https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/NEW_packed/model/scene/fbx/desk_1.fbx';
        var model_source_9= new app.getModel(path);
        model_source_9.scale.set(0.01,0.01,0.01)
        
        var path = 'https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/NEW_packed/model/scene/fbx/desk_2.fbx';
        var model_source_10= new app.getModel(path);
        model_source_10.scale.set(0.01,0.01,0.01)
        
//        var path = 'https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/NEW_packed/model/scene/fbx/second.fbx';
//        var model_source_11= new app.getModel(path);
//        model_source_11.scale.set(0.01,0.01,0.01)
        
        var path = 'https://blog-1257068932.cos.ap-guangzhou.myqcloud.com/NEW_packed/model/scene/fbx/second_ceiling.fbx';
        var model_source_12= new app.getModel(path);
        model_source_12.scale.set(0.01,0.01,0.01)
        SecondGrp.add(model_source_6,model_source_7,model_source_8,model_source_9,model_source_10)
        
        RotateGrp.add(model_source_1,model_source_2,model_source_3,model_source_4,SecondGrp,model_source_12)
        
        init.scene.add(RotateGrp);
        

        var light = app.initLight();
        light.ambientLight.intensity = .7;
        
        var all_focus_first =false;
        var all_focus_first_cal = 0;
        var all_focus_first_once = true;
        var all_focus_second =false;
        var all_focus_second_cal = 0;
        var second_focus =false;
        var second_focus_once =true;
        var second_focus_cal = 0;
        var first_focus =false;
        var first_focus_once =true;
        var first_focus_cal = 0;
        
        app.update(function(){

            if(second_focus){
                if(second_focus_once){
                    second_focus_once = false;
                    SecondGrp.position.y = 0;
                    model_source_12.position.y = 1000;
                    SpriteGrp.visible = false;
                    
                }
                //递归遍历开启transparent
                (function transparentObject( objects ) {
                    for ( var i = 0, l = objects.length; i < l; i ++ ) {

                        var object = objects[ i ];

                        if(object.material != undefined){
                            if(object.material.length == undefined){//说明是单个材质
                                if(object.material.opacity < 0 ){
                                    object.material.opacity = 0;
                                }
                                object.material.opacity += 0.05;
                                if(object.material.opacity > 0.5){
                                    object.material.depthWrite = true;
                                }
                            }else{
                                for(let m in object.material){
                                    if(object.material[m].opacity <0){
                                        object.material[m].opacity = 0;
                                    }
                                    object.material[m].opacity += 0.05;
                                    if(object.material[m].opacity > 0.5){
                                        object.material[m].depthWrite = true;
                                    }
                                }
                            }
                        }
                        transparentObject( object.children );
                    }
                } )(SecondGrp.children)
                

                  for(let i in SecondCeilingOpaqueArray){
                      if(SecondCeilingOpaqueArray[i].opacity > 1){
                            SecondCeilingOpaqueArray[i].opacity = 1
                        }
                        SecondCeilingOpaqueArray[i].opacity -= 0.05;
                    }  
                
                second_focus_cal++;
                if(second_focus_cal>21){
                    for(let i in TransparentArray){
                        TransparentArray[i].opacity = TransparentArrayValue[i];
                    }
                    for(let t in SecondOpaqueArray){
                        SecondOpaqueArray[t].transparent = false;
                    }   
                    second_focus = false;
                    second_focus_once = true;
                    second_focus_cal = 0;
                    SpriteGrp2.visible = true;
                }
            }
            
            if(first_focus){
                if(first_focus_once){
                    first_focus_once = false;
                    SpriteGrp2.visible = false;
                    for(let t in SecondOpaqueArray){
                        SecondOpaqueArray[t].transparent = true;
                    }  
                }
                //递归遍历开启transparent
                (function transparentObject( objects ) {
                    for ( var i = 0, l = objects.length; i < l; i ++ ) {

                        var object = objects[ i ];

                        if(object.material != undefined){
                            if(object.material.length == undefined){//说明是单个材质
                                if(object.material.opacity > 1){
                                    object.material.opacity = 1;
                                }
                                object.material.opacity -= 0.05;
                                if(object.material.opacity < 0.5){
                                    object.material.depthWrite = false;
                                }
                            }else{
                                for(let m in object.material){
                                    if(object.material[m].opacity > 1){
                                        object.material[m].depthWrite = 1;
                                    }
                                    object.material[m].opacity -= 0.05;
                                    if(object.material[m].opacity < 0.5){
                                        object.material[m].depthWrite = false;
                                    }
                                }
                            }
                        }
                        transparentObject( object.children );
                    }
                } )(SecondGrp.children)
                
                for(let i in SecondCeilingOpaqueArray){
                    if(SecondCeilingOpaqueArray[i].opacity > 1){
                        SecondCeilingOpaqueArray[i].opacity = 1
                    }
                    SecondCeilingOpaqueArray[i].opacity -= 0.05;
                }
                
                first_focus_cal++;
                if(first_focus_cal>21){
                    first_focus = false;
                    first_focus_once = true;
                    first_focus_cal = 0;
                    SecondGrp.position.y = 1000;
                    model_source_12.position.y = 1000;
                    SpriteGrp.visible = true;
                }
            }
            
            if(all_focus_first){
                if(all_focus_first_once){
                    all_focus_first_once = false;
                    SecondGrp.position.y = 0;
                    model_source_12.position.y = 0;
                }
                //递归遍历开启transparent
                (function transparentObject( objects ) {
                    for ( var i = 0, l = objects.length; i < l; i ++ ) {

                        var object = objects[ i ];

                        if(object.material != undefined){
                            if(object.material.length == undefined){//说明是单个材质
                                if(object.material.opacity < 0 ){
                                    object.material.opacity = 0;
                                }
                                object.material.opacity += 0.05;
                                if(object.material.opacity > 0.5){
                                    object.material.depthWrite = true;
                                }
                            }else{
                                for(let m in object.material){
                                    if(object.material[m].opacity < 0){
                                        object.material[m].opacity = 0
                                    }
                                    object.material[m].opacity += 0.05;
                                    if(object.material[m].opacity > 0.5){
                                        object.material[m].depthWrite = true;
                                    }
                                }
                            }
                        }
                        transparentObject( object.children );
                    }
                } )(SecondGrp.children)

                for(let i in SecondCeilingOpaqueArray){
                    if(SecondCeilingOpaqueArray[i].opacity < 0){
                        SecondCeilingOpaqueArray[i].opacity = 0
                    }
                    SecondCeilingOpaqueArray[i].opacity += 0.05;
                }
                all_focus_first_cal ++;
                if(all_focus_first_cal>21){
                    for(let i in TransparentArray){
                        TransparentArray[i].opacity = TransparentArrayValue[i];
                    }
                    for(let t in SecondOpaqueArray){
                        SecondOpaqueArray[t].transparent = false;
                    }   
                    all_focus_first_once = true;
                    all_focus_first = false;
                    all_focus_first_cal = 0;
                    SpriteGrp2.visible = false;
                    SpriteGrp.visible = false;
                }
            }
            
            if(all_focus_second){
                console.log("top show second")
                for(let i in SecondCeilingOpaqueArray){
                    if(SecondCeilingOpaqueArray[i].opacity < 0){
                        SecondCeilingOpaqueArray[i].opacity = 0
                    }
                    SecondCeilingOpaqueArray[i].opacity += 0.05;
                }
                all_focus_second_cal ++;
                if(all_focus_second_cal>21){
                    
                    SecondGrp.position.y = 0;
                    model_source_12.position.y = 0;
                    all_focus_second = false;
                    all_focus_second_cal = 0;
                    SpriteGrp2.visible = false;
                    SpriteGrp.visible = false;
                }
            }
            
        });
        
        app.animate();
        
        function getCentroid( mesh ) {

            mesh.geometry.computeBoundingBox();
            boundingBox = mesh.geometry.boundingBox;

            var x0 = boundingBox.min.x;
            var x1 = boundingBox.max.x;
            var y0 = boundingBox.min.y;
            var y1 = boundingBox.max.y;
            var z0 = boundingBox.min.z;
            var z1 = boundingBox.max.z;


            var bWidth = ( x0 > x1 ) ? x0 - x1 : x1 - x0;
            var bHeight = ( y0 > y1 ) ? y0 - y1 : y1 - y0;
            var bDepth = ( z0 > z1 ) ? z0 - z1 : z1 - z0;

            var centroidX = x0 + ( bWidth / 2 ) + mesh.position.x;
            var centroidY = y0 + ( bHeight / 2 )+ mesh.position.y;
            var centroidZ = z0 + ( bDepth / 2 ) + mesh.position.z;

            return mesh.geometry.centroid = { x : centroidX, y : centroidY, z : centroidZ };

        }
        
        function makeTextSprite( message, parameters )
        {
            if ( parameters === undefined ) parameters = {};

            var fontface = parameters.hasOwnProperty("fontface") ? 
                parameters["fontface"] : "Arial";

            var fontsize = parameters.hasOwnProperty("fontsize") ? 
                parameters["fontsize"] : 18;

            var borderThickness = parameters.hasOwnProperty("borderThickness") ? 
                parameters["borderThickness"] : 4;

            var borderColor = parameters.hasOwnProperty("borderColor") ?
                parameters["borderColor"] : { r:0, g:0, b:0, a:1.0 };

            var backgroundColor = parameters.hasOwnProperty("backgroundColor") ?
                parameters["backgroundColor"] : { r:255, g:255, b:255, a:1.0 };

//            var spriteAlignment = THREE.SpriteAlignment.topLeft;

            var canvas = document.createElement('canvas');
            var context = canvas.getContext('2d');
            context.font = "Bold " + fontsize + "px " + fontface;

            // get size data (height depends only on font size)
            var metrics = context.measureText( message );
            var textWidth = metrics.width;

            // background color
            context.fillStyle   = "rgba(" + backgroundColor.r + "," + backgroundColor.g + ","
                                          + backgroundColor.b + "," + backgroundColor.a + ")";
            // border color
            context.strokeStyle = "rgba(" + borderColor.r + "," + borderColor.g + ","
                                          + borderColor.b + "," + borderColor.a + ")";

            context.lineWidth = borderThickness;
            roundRect(context, borderThickness/2, borderThickness/2, textWidth + borderThickness, fontsize * 1.4 + borderThickness, 6);
            // 1.4 is extra height factor for text below baseline: g,j,p,q.

            // text color
            context.fillStyle = "rgba(0, 0, 0, 1.0)";

            context.fillText( message, borderThickness, fontsize + borderThickness);

            // canvas contents will be used for a texture
            var texture = new THREE.Texture(canvas) 
            texture.needsUpdate = true;

            var spriteMaterial = new THREE.SpriteMaterial( 
                { map: texture } );
            var sprite = new THREE.Sprite( spriteMaterial );
            return sprite;	
        }

        // function for drawing rounded rectangles
        function roundRect(ctx, x, y, w, h, r) 
        {
            ctx.beginPath();
            ctx.moveTo(x+r, y);
            ctx.lineTo(x+w-r, y);
            ctx.quadraticCurveTo(x+w, y, x+w, y+r);
            ctx.lineTo(x+w, y+h-r);
            ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
            ctx.lineTo(x+r, y+h);
            ctx.quadraticCurveTo(x, y+h, x, y+h-r);
            ctx.lineTo(x, y+r);
            ctx.quadraticCurveTo(x, y, x+r, y);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();   
        }
        
    </script>
     
    <div class="container" >
	<div class="row clearfix" >
		<div class="col-md-12 column" id="panel">
			<div class="panel panel-primary" >
				<div class="panel-heading">
					<h3 class="panel-title  text-center " id="prevent">
						<a data-toggle="collapse" data-parent="#accordion" 
                           href="#collapseOne " >信息面板<span class="caret"></span>
                           </a>
					</h3>
				</div>
				<div class="panel-body collapse in" id="collapseOne">
                <div id="attr1" style="padding: 15px 5px;font-size: 20px;">名称：</div>
                <div id="attr2" style="padding: 15px 5px;font-size: 20px;">占地面积：</div>
                <div id="attr3" style="padding: 15px 5px;font-size: 20px;">价格：</div>
                <div id="attr4" style="padding: 15px 5px;font-size: 20px;">出售情况：</div>
                <div id="attr5">
                    <div class="pre-scrollable center-block" style="height: 270px;width: inherit; word-wrap:break-word; word-break:break-all;text-indent: 2em;">
                    <center><h2>详细信息</h2></center>
                   佳兆业未来城位于广州主城区黄埔区黄埔区是广州高新技术产能中心也是广州房地产市场成交面积最大、热度最高的区域2017年房价涨幅达28%,地价突破2万/平方米<br>
                   300米即达地铁13号线南岗站6站到天河,3站到广州新东站开创大道、黄埔东路、广园快速三大主干道广深沿江高速多条城际高速路网,半小时即达深圳<br>
                   约66万平方米未来生活城邦,10万平方米商业中心毗邻佳兆业·城市广场,更有万达项目即将入驻市一级幼儿园、省一级小学、区一级中学,一站式教育暨南大学暨华医院、黄埔区红十字会医院,为健康保驾护航
                    </div>  
                </div>
				</div>
				<div class="panel-footer collapse in" id="collapseOne" >
                    <div class="row clearfix">
                    <div class="col-md-12 column">
                        <div class="row clearfix">
                            <div class="col-md-12 column">
                                 <button id="all" type="button" class="btn btn-default btn-block btn-primary">所有楼层</button>
                            </div>
                        </div>
                        <div class="row clearfix">
                            <div class="col-md-6 column">
                                 <button id="first_floor" type="button" class="btn btn-default btn-primary btn-block">第一层</button>
                            </div>
                            <div class="col-md-6 column">
                                 <button id="second_floor" type="button" class="btn btn-default btn-primary btn-block">第二层</button>
                            </div>
                        </div>
                    </div>
                </div>
            
				</div>
			</div>
		</div>
	</div>
   
    <script>
    var second_btnClick_once = true;
    var first_btnClick_once = true;
    var all_btnClick_once = true;
    SpriteGrp2.visible = false;
    SpriteGrp.visible = false;
        
    $("#all").click(function(){
        
        if(all_btnClick_once){
            all_btnClick_once = false;
            if(first_btnClick_once == false){
                all_focus_first = true;
                first_btnClick_once = true;
            }
            if(second_btnClick_once == false){
                console.log("test")
                all_focus_second = true;
                second_btnClick_once = true;
            }
        }

    })
    
    $("#first_floor").click(function(){
        second_btnClick_once = true;
        all_btnClick_once = true;
        if(first_btnClick_once){
            first_btnClick_once = false;
            first_focus = true;
        }
    })
    
    $("#second_floor").click(function(){
        first_btnClick_once = true;
        all_btnClick_once = true;
        if(second_btnClick_once){
            second_btnClick_once =false;
            second_focus = true;
            
        }
        
    })
    
    
    
    //设置面板头部可移动
    var draggable = $('.panel').draggabilly({
      handle:'.panel-heading',
      containment: '#webgl',
    })
    
    //鼠标移动头部时切换为移动十字
    $('.panel-heading').css('cursor','move')
    
    //防止在面板上触发点击
    $('#panel').mousedown(function(e){//防止面板误触
        PanelClickPrevent = false;
    })
    
    //bootstrap 折叠的时候不会挡住三维的旋转
    $('#panel').on('hidden.bs.collapse', function () {
       $('#panel').outerHeight( $('.panel').outerHeight())
    })
    $('#collOne').on('show.bs.collapse', function () {
        $('#panel').outerHeight( $('.panel').outerHeight())
    });
        
    
    </script>
</body>
</html>
