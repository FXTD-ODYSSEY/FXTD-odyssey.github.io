<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>QBinder 数据绑定框架 | 智伤帝的个人博客</title><meta name="keywords" content="ࠆQt/PyQt,ࠆQt,ࠆQt/PySide"><meta name="author" content="智伤帝"><meta name="copyright" content="智伤帝"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="框架开发心路历程 &amp; 原理分析">
<meta property="og:type" content="article">
<meta property="og:title" content="QBinder 数据绑定框架">
<meta property="og:url" content="https://blog.l0v0.com/posts/301b3c35.html">
<meta property="og:site_name" content="智伤帝的个人博客">
<meta property="og:description" content="框架开发心路历程 &amp; 原理分析">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/12.gif">
<meta property="article:published_time" content="2020-11-22T10:07:28.000Z">
<meta property="article:modified_time" content="2022-07-07T13:39:42.307Z">
<meta property="article:author" content="智伤帝">
<meta property="article:tag" content="ࠆQt&#x2F;PyQt">
<meta property="article:tag" content="ࠆQt">
<meta property="article:tag" content="ࠆQt&#x2F;PySide">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/12.gif"><link rel="shortcut icon" href="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/img/favicon.png"><link rel="canonical" href="https://blog.l0v0.com/posts/301b3c35.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="preconnect" href="//zz.bdstatic.com"/><meta name="google-site-verification" content="google15d1ccb0af66991a"/><meta name="msvalidate.01" content="D306EED72EF12BF89A2A951583FF91C7"/><meta name="baidu-site-verification" content="A3TUx6EZdy"/><meta name="360-site-verification" content="48ce68b0e3754c994b6e79677b842d48"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?cda99107ced8e9ef4d02339065438d4f";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '4.2.1',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2022-07-07 21:39:42'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><link rel="stylesheet" href="/css/iconfont.css"><link rel="stylesheet" href="/css/extra.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/img/avatar.png" onerror="onerror=null;src='//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">293</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">69</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">67</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 系列总结</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/%E6%95%88%E7%8E%87%E6%8F%90%E5%8D%87%E6%8C%87%E5%8D%97/"><span> 效率提升指南</span></a></li><li><a class="site-page" href="/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unreal/Python"><span> Unreal Python</span></a></li><li><a class="site-page" href="/categories/Python/Python-%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83/"><span> Python 编程规范</span></a></li><li><a class="site-page" href="/categories/CG/Qt/Python%E7%BB%93%E5%90%88Qt%E7%B3%BB%E5%88%97%E5%BC%80%E5%8F%91%E6%95%99%E7%A8%8B/"><span> Python Qt 开发教程</span></a></li><li><a class="site-page" href="/tags/VScode/"><span> VScode 全面使用攻略</span></a></li><li><a class="site-page" href="/categories/Wiki/TiddlyWiki-%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97"><span> TiddlyWiki 使用指南</span></a></li><li><a class="site-page" href="/categories/%E5%89%8D%E7%AB%AF/hexo/"><span> Hexo博客搭建历程</span></a></li><li><a class="site-page" href="/categories/Photogrammetry/"><span> Photogrammetry</span></a></li><li><a class="site-page" href="/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/Shader%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/"><span> Shader学习之路</span></a></li><li><a class="site-page" href="/categories/CG/Maya/Maya%20%E7%A0%94%E7%A9%B6%E8%AE%B0%E5%BD%95"><span> Maya 研究记录</span></a></li><li><a class="site-page" href="/categories/%E5%89%8D%E7%AB%AF/Vue/Vue%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/"><span> Vue学习之路</span></a></li><li><a class="site-page" href="/categories/%E5%9B%9E%E5%BF%86%E5%BD%95/"><span> 回忆录</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-user"></i><span> 关于我</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 博客初心</span></a></li><li><a class="site-page" href="/about/log.html"><i class="fa-fw fa fa-gift"></i><span> 博客日志</span></a></li><li><a class="site-page" href="https://wiki.l0v0.com/" target="_blank" rel="noopener"><i class="fa-fw fa fa-book"></i><span> wiki 文档</span></a></li><li><a class="site-page" href="http://hou.l0v0.com" target="_blank" rel="noopener"><i class="fa-fw fa fa-futbol"></i><span> Houdini Wiki</span></a></li><li><a class="site-page" href="/about/todo.html"><i class="fa-fw fa fa-check"></i><span> 更新计划</span></a></li><li><a class="site-page" href="/about/plan.html"><i class="fa-fw fa fa-lightbulb"></i><span> 教程计划</span></a></li><li><a class="site-page" href="/about/focus.html"><i class="fa-fw fa fa-bullseye"></i><span> 关注列表</span></a></li><li><a class="site-page" href="/about/note/note.html"><i class="fa-fw fa fa-sticky-note"></i><span> 我的笔记</span></a></li><li><a class="site-page" href="/about/my_work.html"><i class="fa-fw fa fa-briefcase"></i><span> 我的作品</span></a></li><li><a class="site-page" href="/about/contact.html"><i class="fa-fw fa fa-id-badge"></i><span> 联系我</span></a></li></ul></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Python-Qt-相似框架的研究"><span class="toc-number">2.</span> <span class="toc-text">Python Qt 相似框架的研究</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dayu-widgets-MFieldMixin"><span class="toc-number">2.1.</span> <span class="toc-text">dayu_widgets - MFieldMixin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pyqtconfig"><span class="toc-number">2.2.</span> <span class="toc-text">pyqtconfig</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#QMVVM-数据绑定"><span class="toc-number">3.</span> <span class="toc-text">QMVVM 数据绑定</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#QBinder"><span class="toc-number">4.</span> <span class="toc-text">QBinder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据绑定案例"><span class="toc-number">4.1.</span> <span class="toc-text">数据绑定案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#结合-QEventHook-案例"><span class="toc-number">4.2.</span> <span class="toc-text">结合 QEventHook 案例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#复杂使用场景"><span class="toc-number">4.3.</span> <span class="toc-text">复杂使用场景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#QBinder-实现原理"><span class="toc-number">5.</span> <span class="toc-text">QBinder 实现原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自动绑定"><span class="toc-number">5.1.</span> <span class="toc-text">自动绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Binder-数据绑定容器"><span class="toc-number">5.2.</span> <span class="toc-text">Binder 数据绑定容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Binding-绑定对象-amp-lambda-绑定"><span class="toc-number">5.3.</span> <span class="toc-text">Binding 绑定对象 &amp; lambda 绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FnBinding-函数绑定"><span class="toc-number">5.4.</span> <span class="toc-text">FnBinding 函数绑定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#QEventHook-全局事件钩子"><span class="toc-number">5.5.</span> <span class="toc-text">QEventHook 全局事件钩子</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据自动存储加载"><span class="toc-number">5.6.</span> <span class="toc-text">数据自动存储加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#handler-扩展操作"><span class="toc-number">5.7.</span> <span class="toc-text">handler 扩展操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">6.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/12.gif)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">智伤帝的个人博客</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间线</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友情链接</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 系列总结</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/categories/%E6%95%88%E7%8E%87%E6%8F%90%E5%8D%87%E6%8C%87%E5%8D%97/"><span> 效率提升指南</span></a></li><li><a class="site-page" href="/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unreal/Python"><span> Unreal Python</span></a></li><li><a class="site-page" href="/categories/Python/Python-%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83/"><span> Python 编程规范</span></a></li><li><a class="site-page" href="/categories/CG/Qt/Python%E7%BB%93%E5%90%88Qt%E7%B3%BB%E5%88%97%E5%BC%80%E5%8F%91%E6%95%99%E7%A8%8B/"><span> Python Qt 开发教程</span></a></li><li><a class="site-page" href="/tags/VScode/"><span> VScode 全面使用攻略</span></a></li><li><a class="site-page" href="/categories/Wiki/TiddlyWiki-%E9%A3%9F%E7%94%A8%E6%8C%87%E5%8D%97"><span> TiddlyWiki 使用指南</span></a></li><li><a class="site-page" href="/categories/%E5%89%8D%E7%AB%AF/hexo/"><span> Hexo博客搭建历程</span></a></li><li><a class="site-page" href="/categories/Photogrammetry/"><span> Photogrammetry</span></a></li><li><a class="site-page" href="/categories/%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/Unity/Shader%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/"><span> Shader学习之路</span></a></li><li><a class="site-page" href="/categories/CG/Maya/Maya%20%E7%A0%94%E7%A9%B6%E8%AE%B0%E5%BD%95"><span> Maya 研究记录</span></a></li><li><a class="site-page" href="/categories/%E5%89%8D%E7%AB%AF/Vue/Vue%E5%AD%A6%E4%B9%A0%E4%B9%8B%E8%B7%AF/"><span> Vue学习之路</span></a></li><li><a class="site-page" href="/categories/%E5%9B%9E%E5%BF%86%E5%BD%95/"><span> 回忆录</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-user"></i><span> 关于我</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 博客初心</span></a></li><li><a class="site-page" href="/about/log.html"><i class="fa-fw fa fa-gift"></i><span> 博客日志</span></a></li><li><a class="site-page" href="https://wiki.l0v0.com/" target="_blank" rel="noopener"><i class="fa-fw fa fa-book"></i><span> wiki 文档</span></a></li><li><a class="site-page" href="http://hou.l0v0.com" target="_blank" rel="noopener"><i class="fa-fw fa fa-futbol"></i><span> Houdini Wiki</span></a></li><li><a class="site-page" href="/about/todo.html"><i class="fa-fw fa fa-check"></i><span> 更新计划</span></a></li><li><a class="site-page" href="/about/plan.html"><i class="fa-fw fa fa-lightbulb"></i><span> 教程计划</span></a></li><li><a class="site-page" href="/about/focus.html"><i class="fa-fw fa fa-bullseye"></i><span> 关注列表</span></a></li><li><a class="site-page" href="/about/note/note.html"><i class="fa-fw fa fa-sticky-note"></i><span> 我的笔记</span></a></li><li><a class="site-page" href="/about/my_work.html"><i class="fa-fw fa fa-briefcase"></i><span> 我的作品</span></a></li><li><a class="site-page" href="/about/contact.html"><i class="fa-fw fa fa-id-badge"></i><span> 联系我</span></a></li></ul></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">QBinder 数据绑定框架</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-11-22T10:07:28.000Z" title="发表于 2020-11-22 18:07:28">2020-11-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-07-07T13:39:42.307Z" title="更新于 2022-07-07 21:39:42">2022-07-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CG/">CG</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CG/Qt/">Qt</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CG/Qt/Python/">Python</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>33分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p>&emsp;&emsp;这篇文章就是好好分享一下开发 QBinder <a href="https://github.com/FXTD-ODYSSEY/QBinder" target="_blank" rel="noopener">Github地址</a> 框架一路过来的心路历程，以及框架里的实现机制。<br>&emsp;&emsp;如果要更直接了解框架的使用方法，推荐前往框架的 wiki 文档进行了解。 <a href="https://wiki.l0v0.com/Python/QBinder/#/" target="_blank" rel="noopener">链接</a></p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;我以前做过一些 Vue 和 React 的前端开发，前端领域的数据绑定框架目前是如日中天，谁用谁知道，好用得很。<br>&emsp;&emsp;本来今年的毕设想要做一个 CG资产管理库 的。<br>&emsp;&emsp;打算要做一个数据绑定的框架，实现类似前端开发的体验，否则界面复杂之后，组件的通信会变得很难受。<br>&emsp;&emsp;虽然 Qt 也内置了比较古老的 MVC 框架，还是能够用一下的，但是使用场景比较限制。<br>&emsp;&emsp;只支持几个 View 以及衍生出来的组件，对于日常的 LineEdit CheckBox 的数据绑定均是没有支持。<br>&emsp;&emsp;我当时打算先把这个数据绑定框架做出来，再去做 CG 资产管理库。<br>&emsp;&emsp;当时师弟他们还做一个类似库去打比赛，我也从中帮了一些忙。<br>&emsp;&emsp;花了不少时间研究如何将 WebGL 嵌入到 Python Qt 框架里面 <a href="./d2b44b01.html">链接</a><br>&emsp;&emsp;于是就把数据绑定框架给搁置了(加上因为自己懒<em>(:з」∠)</em>)<br>&emsp;&emsp;再就是自己也没有想好到底怎样的数据绑定才是好用的，还是在网上找了很多 相关的案例，以及 Python 能够实现的黑科技进行研究.<br>&emsp;&emsp;也就是那个时候研究了 future-fstring 库的实现原理 <a href="./595dd86f.html">链接</a><br>&emsp;&emsp;其实还研究很了解了很多别的东西，比如 ast 、 dis 等等 Python 内置的包，它们的作用以及能够实现的黑科技。<br>&emsp;&emsp;并且也找了很多 github 上的 PyQt 相关的数据绑定框架来参考学习。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;当时很多研究并没有记录下来，而是仅仅存放在了我自己的框架的 research 文件夹 <a href="https://github.com/FXTD-ODYSSEY/QBinder/tree/master/research" target="_blank" rel="noopener">链接</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/01.png" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;我记得还考虑在 Qt Designer 里面加入自定义 property 来配置数据绑定，导致引申出了个 unicode_literal 的问题 <a href="./12108ee7.html">链接</a><br>&emsp;&emsp;后来有放弃了上面的方案，使用装饰器加 字典 配置的方式 具体可以参考我仓库的 QMVVM 分支，后面再详细说一下 <a href="https://github.com/FXTD-ODYSSEY/QBinder/tree/QMVVM" target="_blank" rel="noopener">链接</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/02.png" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;当时的确是实现了比较粗糙的数据绑定，但是使用上不太理想。<br>&emsp;&emsp;而且终究折腾太久，时间不够了<em>(:з」∠)</em><br>&emsp;&emsp;差不多 5 月份了，毕设还卡在前期的框架搭建中，而且当时已经复工了(没有请假回学校)<br>&emsp;&emsp;所以后来临时改了毕设的方案，将资产管理库改为全栈开发，顺便学一下时下很热的 Go 语言，跳过数据绑定框架的开发。<br>&emsp;&emsp;还好我的指导老师很随意，从来没有打听过我的毕设进度，我偷梁换柱也完全没有关系，在我匆匆赶工之下，做了一个月把毕设给赶出来了 <a href="./7bc09203.html">链接</a><br>&emsp;&emsp;所以毕设的水平也就那样，内容量其实很单薄，还好大学的老师都不懂，随意吹嘘一下就给忽悠过去了。<br>&emsp;&emsp;毕设论文也是按照写博客的方式写的，一点问题也没有(<em>/ω＼</em>)</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;后来毕设过去了之后，这个数据绑定框架的制作也就搁置了，真就一鼓作气，再而衰，三而竭吧。<br>&emsp;&emsp;其实自己也是一直记着的，但是当时工作的原因，要开始搞 Unreal 的 Python 流程，于是乎就这了。<br>&emsp;&emsp;一直到 10 月份之后，我总算脱离了项目组，可以做一些更加框架性的东西了。<br>&emsp;&emsp;并且和 Unreal 相关的需求也少了，每当做 Maya Qt 的界面就一直惦记着想要把这个框架重新撸起来。<br>&emsp;&emsp;然而 10 月份的时候是计划开始开撸 Houdini 教程的，还花了很多时间整理了相关的教程。<br>&emsp;&emsp;最后的导火索是 10 月底，我忍不住还是给 焕焕 演示了以前做的不成熟的数据绑定框架案例。<br>&emsp;&emsp;虽然他表示了肯定，然而也没有掀起什么波澜~<br>&emsp;&emsp;我回去反思了一下，还是觉得目前的阶段的框架太拉胯了，没法很好进行推广。<br>&emsp;&emsp;于是我一意孤行地搁置了 Houdini 学习计划，将大部分的空余时间都投入到这个框架的重构上。<br>&emsp;&emsp;最近还把 仓库的名字改为更贴切一点名字， 叫做 QBinder 。<br>&emsp;&emsp;目前重构了一个月，感觉进入了可以发布推广的阶段了，毕竟闭门造车并不好，这段时间一直觉得很多东西不完善，所以一直没有和别人交流分享。<br>&emsp;&emsp;稍微完善了点，所以写下文章记录一下。</p>
</blockquote>
<h2 id="Python-Qt-相似框架的研究"><a href="#Python-Qt-相似框架的研究" class="headerlink" title="Python Qt 相似框架的研究"></a>Python Qt 相似框架的研究</h2><blockquote>
<p>&emsp;&emsp;我其实不太喜欢造轮子的，拿别人做好的轮子，再花点研究一下底层的原理就可以了。<br>&emsp;&emsp;所以既然要做框架也不可能上来就是莽，看看别人都是怎么做的。<br>&emsp;&emsp;然而 github 上能找到的资料并不多，只找到两个比较相近的</p>
<ul>
<li><a href="https://github.com/phenom-films/dayu_widgets/blob/master/dayu_widgets/field_mixin.py" target="_blank" rel="noopener">MFieldMixin</a></li>
<li><a href="https://github.com/learnpyqt/pyqtconfig" target="_blank" rel="noopener">pyqtconfig</a></li>
</ul>
</blockquote>
<blockquote>
<p>&emsp;&emsp;另外也需要感受一下前端框架的数据同步的感觉。这里拿 Vue 的官方文档进行演示 <a href="https://cn.vuejs.org/v2/guide/forms.html" target="_blank" rel="noopener">链接</a> ↓↓↓</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/03.gif" alt="alt"></p>
<h3 id="dayu-widgets-MFieldMixin"><a href="#dayu-widgets-MFieldMixin" class="headerlink" title="dayu_widgets - MFieldMixin"></a>dayu_widgets - MFieldMixin</h3><blockquote>
<p>&emsp;&emsp;<a href="https://github.com/phenom-films/dayu_widgets" target="_blank" rel="noopener">dayu_widgets</a> 强烈推荐，我的 <a href="https://github.com/FXTD-ODYSSEY/Unreal-PyToolkit" target="_blank" rel="noopener">PyToolkit</a> 的 qt 界面就是基于这个组件库做的。<br>&emsp;&emsp;在它的案例里面可以找到一些使用 MFieldMixin 进行数据绑定的例子。<br>&emsp;&emsp;比如 <a href="https://github.com/phenom-films/dayu_widgets/blob/master/examples/field_mixin_example.py" target="_blank" rel="noopener">field_mixin_example.py</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/04.gif" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;可以看到上面输入的时候下面的邮箱也可以进行数据同步。<br>&emsp;&emsp;不过有个小 BUG ， 输入的指针位置会因为数据更新被挪到了最后，我做框架的时候也遇到了这个问题。<br>&emsp;&emsp;实现上很 pythonic ，但是用起来比起前端框架就繁琐很多。</p>
</blockquote>
<p>dayu_widgets 需要预先在组件层提供好 qt 的 property 属性<br>注册用到的数据名称和初始值<br>使用 MFieldMixin 混合之后需要用 bind 方法来绑组件和 property 属性<br>最后还要通过调用函数来修改数据</p>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/05.png" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;毕竟 Python Qt 里面少了 前端的 html 模板作为界面描述，所以数据绑定的时候就需要用户提供更多信息，来满足绑定。<br>&emsp;&emsp;我认为这是很难平衡的痛点。</p>
</blockquote>
<h3 id="pyqtconfig"><a href="#pyqtconfig" class="headerlink" title="pyqtconfig"></a>pyqtconfig</h3><blockquote>
<p>&emsp;&emsp;发现 pyqtconfig 这个框架也是很偶然<br>&emsp;&emsp;某天在国外某个大佬教学网站里面找到了他的 github，然后随手搜了一下大佬的仓库找到的。<a href="https://github.com/learnpyqt" target="_blank" rel="noopener">链接</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/06.gif" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;这个框架比起 MFiledMixin 要更加完善，还实现了 QSettings json xml 不同的格式来存储。<br>&emsp;&emsp;调用上比起你 MFiledMixin 更加简洁一点。<br>&emsp;&emsp;因为不需要提供 信号槽， 代码上通过字典的方式将 Qt 自带组件的信号槽实现了自动绑定。<br>&emsp;&emsp;不过编写上基本还是和 MFiledMixin 一样的。</p>
</blockquote>
<h2 id="QMVVM-数据绑定"><a href="#QMVVM-数据绑定" class="headerlink" title="QMVVM 数据绑定"></a>QMVVM 数据绑定</h2><blockquote>
<p>&emsp;&emsp;结合上面两个框架，我想要数据绑定框架的使用更加简单,使用的代价降到最小。<br>&emsp;&emsp;参考 Vue 框架的做法，会通过字典将所有相关的配置作为参数传入框架内。<br>&emsp;&emsp;然后框架解析 dom 生成出 virtualdom 将配置关系和 templete 里面添加的属性进行匹配绑定。<br>&emsp;&emsp;通过我也没搞清楚的 diff 算法，算出更新的 dom 对象实现高效更新。<br>&emsp;&emsp;当然这种写法都是单独引入 vue 作为 js 脚本的用法。<br>&emsp;&emsp;如果使用 vue 脚手架结合 node.js 就可以直接解析 vue 文件代码，让 MVVM 框架更加紧凑。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;然而目前 Python Qt 的代码环境下，缺失了 Html 层来描述组件状态，所以绑定就很难做得精简。<br>&emsp;&emsp;Qt 之下其实可以使用 qml 作为代替，但是传统代码无法兼容，迁移也不方便。<br>&emsp;&emsp;我其实还想到 ui 文件，毕竟是个 xml ，可以用 python 来解析当 view 来用，实现 view model。<br>&emsp;&emsp;但是在 UI 文件上修改还是很蛋疼，而且 ui 可以转代码，但是代码没有转 ui 的工具，还不如上面两个框架通过代码解决好。<br>&emsp;&emsp;所以我最后的想法回归到如何精简代码绑定数据的过程。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;参考了 Vue 的写法之后，我想通过 装饰器加上配置信息来进行绑定。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> QMVVM</span><br><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtGui,QtCore,QtWidgets</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WidgetTest</span><span class="params">(QtWidgets.QWidget)</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @QMVVM.store(&#123;</span></span><br><span class="line">        <span class="string">"state"</span>: &#123;</span><br><span class="line">            <span class="string">"message"</span>: <span class="string">""</span>, <span class="comment"># 初始化数据</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"methods"</span>: &#123;</span><br><span class="line">            <span class="string">"label.setText"</span>:&#123; <span class="comment"># 绑定 setter</span></span><br><span class="line">                <span class="string">"args"</span>:[<span class="string">"message"</span>], <span class="comment"># action 传递的参数</span></span><br><span class="line">                <span class="string">"action"</span>: <span class="keyword">lambda</span> a: <span class="string">"message is %s"</span> % a, <span class="comment"># action 作为响应传递的数据</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"edit.setText"</span>:<span class="string">"message"</span>, <span class="comment"># 直接绑定 等价 下面的扩充写法 ↓↓↓</span></span><br><span class="line">            <span class="comment"># "edit.setText":&#123;</span></span><br><span class="line">            <span class="comment">#     "args":["message"],</span></span><br><span class="line">            <span class="comment">#     "action" : lambda a: a ,</span></span><br><span class="line">            <span class="comment"># &#125;,</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(WidgetTest, self).__init__()</span><br><span class="line">        self.initialize()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(self)</span>:</span></span><br><span class="line">        layout = QtWidgets.QVBoxLayout()</span><br><span class="line">        self.setLayout(layout)</span><br><span class="line"></span><br><span class="line">        self.edit = QtWidgets.QLineEdit()</span><br><span class="line">        self.label = QtWidgets.QLabel()</span><br><span class="line">        layout.addWidget(self.edit)</span><br><span class="line">        layout.addWidget(self.label)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app = QtWidgets.QApplication([])</span><br><span class="line">    widget = WidgetTest()</span><br><span class="line">    widget.show()</span><br><span class="line">    app.exec_()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/07.gif" alt="alt"></p>
<p>state 里面初始化响应的绑定变量。<br>methods 定义绑定的方法以及响应的参数和数据</p>
<blockquote>
<p>&emsp;&emsp;python 有很灵活的反射系统，可以通过字符串结合 getattr 可以获取到相应的属性。<br>&emsp;&emsp;但是为了更加灵活，更好区分地获取不同的变量数据，就需要加入更多标识符来区分。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@QMVVM.store(&#123;</span></span><br><span class="line">    <span class="string">"state"</span>:&#123;</span><br><span class="line">        <span class="string">"count"</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="string">"count2"</span>:<span class="number">6</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"methods"</span>:&#123;</span><br><span class="line">        <span class="string">"label.setText"</span>:<span class="string">"count"</span>,</span><br><span class="line">        <span class="string">"@label2.setText"</span>:&#123;</span><br><span class="line">            <span class="string">"args"</span>:[<span class="string">"$count"</span>,<span class="string">"count"</span>],</span><br><span class="line">            <span class="string">"action"</span>:<span class="keyword">lambda</span> a,b: <span class="string">"&lt;center&gt;%s %s&lt;/center&gt;"</span>%(a,b),</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"@label4.setText"</span>:&#123;</span><br><span class="line">            <span class="string">"args"</span>:[<span class="string">"$count"</span>,<span class="string">"count2"</span>],</span><br><span class="line">            <span class="string">"action"</span>:<span class="string">"$calculate"</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"@label5.setText"</span>:&#123;</span><br><span class="line">            <span class="string">"args"</span>:[<span class="string">"count2"</span>],</span><br><span class="line">            <span class="string">"action"</span>:<span class="keyword">lambda</span> a :str(a),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/08.gif" alt="alt"></p>
<p>后来引入 @ 前缀来获取本地变量的 widget<br>methods 的参数上用 $ 符号只带本地的变量以及类方法。</p>
<blockquote>
<p>&emsp;&emsp;结果可以看到上面的配置越来越复杂，而且配置文件必须和代码对应，否则就会报错。<br>&emsp;&emsp;报错还无法判断到底是哪一行配置出错了，为此我还专门定义了一个 SchemaError 的类来进行这种配置错误的处理。<br>&emsp;&emsp;实现了一定程度的错误定位功能，总体而言用起来可能比之前两个框架还要繁琐。<br>&emsp;&emsp;而且方法绑定无法做到 js 一般直接上匿名函数，所以还要用字符串来指向类方法。<br>&emsp;&emsp;比较复杂的配置还需要通过正则来匹配配置的字符串数据，我写起来也很难受。<br>&emsp;&emsp;虽然绑定关系可能因为全部放到一起会更加清晰，但是规则复杂，配置起来也不友好。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@QBinding.store(&#123;</span></span><br><span class="line">    <span class="string">"state"</span>: &#123;</span><br><span class="line">        <span class="string">"selected"</span>: <span class="string">""</span>,</span><br><span class="line">        <span class="string">"option_A"</span>: <span class="string">"A"</span>,</span><br><span class="line">        <span class="string">"option_B"</span>: <span class="string">"B"</span>,</span><br><span class="line">        <span class="string">"option_C"</span>: <span class="string">"C"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"computed"</span>:&#123;</span><br><span class="line">        <span class="string">"item_list"</span>: [</span><br><span class="line">            <span class="string">"$&#123;selected&#125;"</span>,</span><br><span class="line">            <span class="string">"$&#123;option_A&#125;"</span>,</span><br><span class="line">            <span class="string">"$&#123;option_B&#125;"</span>,</span><br><span class="line">            <span class="string">"$&#123;option_C&#125;"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"*item_model"</span>: [</span><br><span class="line">            [<span class="string">"$&#123;option_A&#125;"</span>,<span class="string">"$&#123;option_B&#125;"</span>],</span><br><span class="line">            <span class="string">"$&#123;option_B&#125;"</span>,</span><br><span class="line">            <span class="string">"$&#123;option_C&#125;"</span>,</span><br><span class="line">            [<span class="string">"12"</span>],</span><br><span class="line">            [<span class="string">"asd"</span>,<span class="string">"1234"</span>]</span><br><span class="line">        ],</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"signals"</span>:&#123;</span><br><span class="line">        <span class="string">"line.textChanged"</span>:<span class="string">"option_B"</span>,</span><br><span class="line">        <span class="comment"># "combo.currentTextChanged":"selected",</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/09.gif" alt="alt"></p>
<p>最后为了兼容 Qt 内置的 model 还做了更进一步的规则扩展<br>coumpted 参数可以通过 $符号获取上面定义 state 构建新的数据<br>* 前缀生成 model<br>singals 进行数据更新的绑定绑定</p>
<blockquote>
<p>&emsp;&emsp;做好了 model 这个 demo 之后，开发进度就停滞了。<br>&emsp;&emsp;当时我觉得这个配置过于复杂了，研究 future-fstrings 之后一直想通过里面的黑科技实现代码转换。<br>&emsp;&emsp;利用 python coding 的机制将 python 源码当做一个 html 进行绑定数据的提取，自动修改源码实现自动绑定。<br>&emsp;&emsp;不过这个想法太复杂了，一点也不好实现。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;后来有和 dayu_widgets 的作者  鬼猫猫 聊过一下数据绑定相关的话题。<br>&emsp;&emsp;她想要实现绑定之后还能保留代码的提示功能，确保代码文件的 pylint 不会报错。<br>&emsp;&emsp;我觉得这个要求很合理，但是不好去实现。<br>&emsp;&emsp;不过至少她给我指了个方向，无论用上多少黑科技，至少得兼容 pylint 才是好的写法。<br>&emsp;&emsp;为了实现这个有点奢侈的想法，我又研究了一段时间。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;当时我的配置需要加上 methods 来配置 setter 数据响应的行为。<br>&emsp;&emsp;后来我想到其实可以直接将我的 lambda 方法加到 setter 上。</p>
</blockquote>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.label.setText(<span class="keyword">lambda</span>:<span class="string">"CheckedNames: %s"</span> % self.state.checkedNames)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>&emsp;&emsp;这样绑定 method 更加直观，我只要通过装饰器扩展一下 setText 方法让它接受 lambda 参数即可。<br>&emsp;&emsp;加入 lambda 之后由于数据不是立刻算好传递的，所以每次 lambda 触发的时候都会用 self.state.checkedNames 最新的数值组合成字符串。<br>&emsp;&emsp;也达到了我想要的数据更新的效果。<br>&emsp;&emsp;这个想法对我后来重写出 QBinder 有很大启发~</p>
</blockquote>
<h2 id="QBinder"><a href="#QBinder" class="headerlink" title="QBinder"></a>QBinder</h2><blockquote>
<p>&emsp;&emsp;时隔 5 个月之后，我决定重写之前 QMVVM 框架。<br>&emsp;&emsp;而且框架命名也名不副实， 因为我根本就没有 Vue 这种的 ViewModel 对象。<br>&emsp;&emsp;回想起之前定下的大方向目标，要 pylint 支持不会报错，并且最好还能自动提示出绑定的变量。<br>&emsp;&emsp;那我这套字符串配置是不可能实现的了。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;既然要重构，就要玩大的，这次我将之前的装饰器加配置的方案彻底给改了。<br>&emsp;&emsp;后来我觉得在 Qt 的 setter 上通过装饰器支持 lambda 绑定参数还挺好的写法，虽然看着很 evil<br>&emsp;&emsp;但是耐不住用起来很方便。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;后来因为一些契机研究了 pymel 初始化过程 <a href="https://github.com/LumaPictures/pymel/blob/c624e7e28697d611a6c6d027129c243b43b6c40e/pymel/internal/pmcmds.py#L66" target="_blank" rel="noopener">链接</a> ，在这里我发现 python 的 __clousure__ 黑科技。<br>&emsp;&emsp;于是我觉得 lambda 的玩法还能进一步扩展，实现更好的支持，</p>
</blockquote>
<p>QBinder 特性</p>
<ul>
<li>使用简单，修改代价小</li>
<li>自动记录数据 进行持久化存储</li>
<li>lambda 特性简化绑定</li>
<li>数据绑定可以实现动态 stylesheet </li>
<li>QEventHook qapp 全局事件钩子</li>
</ul>
<h3 id="数据绑定案例"><a href="#数据绑定案例" class="headerlink" title="数据绑定案例"></a>数据绑定案例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> QBinder <span class="keyword">import</span> Binder</span><br><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtWidgets</span><br><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtCore</span><br><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtGui</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WidgetTest</span><span class="params">(QtWidgets.QWidget)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># NOTE 注册 绑定变量 binding</span></span><br><span class="line">    state = Binder()</span><br><span class="line">    state.text = <span class="string">"empty"</span></span><br><span class="line">    state.num = <span class="number">1</span></span><br><span class="line">    state.val = <span class="number">2.0</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(WidgetTest, self).__init__()</span><br><span class="line"></span><br><span class="line">        layout = QtWidgets.QVBoxLayout()</span><br><span class="line">        self.setLayout(layout)</span><br><span class="line"></span><br><span class="line">        self.edit = QtWidgets.QLineEdit()</span><br><span class="line">        self.label = QtWidgets.QLabel()</span><br><span class="line">        self.button = QtWidgets.QPushButton(<span class="string">"change Text"</span>)</span><br><span class="line">        layout.addWidget(self.edit)</span><br><span class="line">        layout.addWidget(self.label)</span><br><span class="line">        layout.addWidget(self.button)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        self.button.clicked.connect(self.change_text)</span><br><span class="line">        <span class="comment"># NOTE 数据绑定</span></span><br><span class="line">        self.edit.setText(<span class="keyword">lambda</span>: self.state.text)</span><br><span class="line">        self.label.setText(<span class="keyword">lambda</span>: <span class="string">"message is %s"</span> % self.state.text)</span><br><span class="line">        </span><br><span class="line">        self.spin = QtWidgets.QSpinBox(self)</span><br><span class="line">        self.label = QtWidgets.QLabel()</span><br><span class="line">        layout.addWidget(self.spin)</span><br><span class="line">        layout.addWidget(self.label)</span><br><span class="line">        <span class="comment"># NOTE 数据绑定</span></span><br><span class="line">        self.spin.setValue(<span class="keyword">lambda</span>: self.state.num)</span><br><span class="line">        self.label.setText(<span class="keyword">lambda</span>: <span class="string">"num is %s"</span> % self.state.num)</span><br><span class="line">        </span><br><span class="line">        self.spin = QtWidgets.QDoubleSpinBox(self)</span><br><span class="line">        self.label = QtWidgets.QLabel()</span><br><span class="line">        layout.addWidget(self.spin)</span><br><span class="line">        layout.addWidget(self.label)</span><br><span class="line">        <span class="comment"># NOTE 数据绑定</span></span><br><span class="line">        self.spin.setValue(<span class="keyword">lambda</span>: self.state.val)</span><br><span class="line">        self.label.setText(<span class="keyword">lambda</span>: <span class="string">"val is %s"</span> % self.state.val)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">change_text</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.state.text = <span class="string">"asd"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app = QtWidgets.QApplication([])</span><br><span class="line">    widget = WidgetTest()</span><br><span class="line">    widget.show()</span><br><span class="line">    app.exec_()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/10.gif" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;QBinder 实现了 Python 最小改动来实现数据绑定的效果。<br>&emsp;&emsp;仅仅使用非常 tricky 的方式让 组件的 setter 可以支持 lambda 函数<br>&emsp;&emsp;lambda 函数注入 Binder 注册的变量，就可以实现的数据绑定。<br>&emsp;&emsp;当 binder 的变量改变的时候会自动触发 setter 进行更新~</p>
</blockquote>
<h3 id="结合-QEventHook-案例"><a href="#结合-QEventHook-案例" class="headerlink" title="结合 QEventHook 案例"></a>结合 QEventHook 案例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> QBinder <span class="keyword">import</span> Binder,QEventHook</span><br><span class="line"><span class="keyword">from</span> QBinder.handler <span class="keyword">import</span> Set</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtWidgets</span><br><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtCore</span><br><span class="line"><span class="keyword">from</span> Qt <span class="keyword">import</span> QtGui</span><br><span class="line"></span><br><span class="line">event_hook = QEventHook()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WidgetTest</span><span class="params">(QtWidgets.QWidget)</span>:</span></span><br><span class="line">    state = Binder()</span><br><span class="line">    state.text = <span class="string">"aasdsd"</span></span><br><span class="line">    state.num = <span class="number">1</span></span><br><span class="line">    state.val = <span class="number">2.0</span></span><br><span class="line">    state.color = <span class="string">"black"</span></span><br><span class="line">    state.spin_color = <span class="string">"black"</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(WidgetTest, self).__init__()</span><br><span class="line">        self.initialize()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(self)</span>:</span></span><br><span class="line">        layout = QtWidgets.QVBoxLayout()</span><br><span class="line">        self.setLayout(layout)</span><br><span class="line"></span><br><span class="line">        self.edit = QtWidgets.QLineEdit()</span><br><span class="line">        self.label = QtWidgets.QLabel()</span><br><span class="line">        self.button = QtWidgets.QPushButton(<span class="string">"change Text"</span>)</span><br><span class="line">        layout.addWidget(self.edit)</span><br><span class="line">        layout.addWidget(self.label)</span><br><span class="line">        layout.addWidget(self.button)</span><br><span class="line"></span><br><span class="line">        self.button.clicked.connect(<span class="keyword">lambda</span>:self.state.text &gt;&gt; Set(<span class="string">"asd"</span>))</span><br><span class="line">        self.edit.setText(<span class="keyword">lambda</span>: self.state.text)</span><br><span class="line">        self.label.setText(<span class="keyword">lambda</span>: <span class="string">"message is %s"</span> % self.state.text)</span><br><span class="line">        </span><br><span class="line">        event_hook.add_hook(self.edit,QtCore.QEvent.FocusIn,<span class="keyword">lambda</span>:self.state.color &gt;&gt; Set(<span class="string">"red"</span>))</span><br><span class="line">        event_hook.add_hook(self.edit,QtCore.QEvent.FocusOut,<span class="keyword">lambda</span>:self.state.color &gt;&gt; Set(<span class="string">"black"</span>))</span><br><span class="line">        self.label.setStyleSheet(<span class="keyword">lambda</span>:<span class="string">"color:%s"</span> % self.state.color)</span><br><span class="line"></span><br><span class="line">        self.spin = QtWidgets.QSpinBox(self)</span><br><span class="line">        self.label = QtWidgets.QLabel()</span><br><span class="line">        layout.addWidget(self.spin)</span><br><span class="line">        layout.addWidget(self.label)</span><br><span class="line">        self.spin.setValue(<span class="keyword">lambda</span>: self.state.num)</span><br><span class="line">        self.label.setText(<span class="keyword">lambda</span>: <span class="string">"num is %s"</span> % self.state.num)</span><br><span class="line">        </span><br><span class="line">        self.spin &gt;&gt; event_hook(<span class="string">"HoverEnter"</span>,<span class="keyword">lambda</span>:self.state.spin_color &gt;&gt; Set(<span class="string">"pink"</span>))</span><br><span class="line">        self.spin &gt;&gt; event_hook(<span class="string">"HoverLeave"</span>,<span class="keyword">lambda</span>:self.state.spin_color &gt;&gt; Set(<span class="string">"blue"</span>))</span><br><span class="line">        self.label.setStyleSheet(<span class="keyword">lambda</span>:<span class="string">"color:%s"</span> % self.state.spin_color)</span><br><span class="line">        </span><br><span class="line">        self.spin = QtWidgets.QDoubleSpinBox(self)</span><br><span class="line">        self.label = QtWidgets.QLabel()</span><br><span class="line">        layout.addWidget(self.spin)</span><br><span class="line">        layout.addWidget(self.label)</span><br><span class="line">        self.spin.setValue(<span class="keyword">lambda</span>: self.state.val)</span><br><span class="line">        self.label.setText(<span class="keyword">lambda</span>: <span class="string">"val is %s"</span> % self.state.val)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/11.gif" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;上面的案例结合 handler 和 QEventHook 可以实现更加灵活方便的组件写法。<br>&emsp;&emsp;handler 的使用场景是通过 &gt;&gt; 运算符重载对 binding 进行操作。<br>&emsp;&emsp;上面使用 Set 方法类就是用来解决 lambda 无法赋值的兼容方案。<br>&emsp;&emsp;简单的数据操作就不需要声明冗余的函数</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;QEventHook 会劫持 Qt 全局的事件响应，这样不需要继承组件来实现。<br>&emsp;&emsp;可以通过我的 劫持 钩子来直接扩展组件的行为响应。<br>&emsp;&emsp;QEventHook 使用单例模式，无论在哪里实例化都只获取同一个实例。(避免多重劫持导致性能下降)</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;QEventHook 支持两种写法 <code>add_hook</code> 或者 <code>&gt;&gt; 运算符</code> 。<br>&emsp;&emsp;&gt;&gt; 运算符重载的写法更加简洁，只是如果前面的组件有重载 __rshift__ 运算符会导致出错。<br>&emsp;&emsp;事件绑定上支持 QEvent 和 字符串 两种写法。</p>
</blockquote>
<h3 id="复杂使用场景"><a href="#复杂使用场景" class="headerlink" title="复杂使用场景"></a>复杂使用场景</h3><blockquote>
<p>&emsp;&emsp;后面我模仿 Vue 做的 todo <a href="https://vuejs.org/v2/examples/todomvc.html" target="_blank" rel="noopener">案例</a>写了一个 QBinder 实现的版本。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/12.gif" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;除了部分样式效果没有同步， Todo 相关的所有功能已经全部用 QBinder 绑定实现了~<br>&emsp;&emsp;另外之前 QMVVM 架构留下的一些历史功能还是支持的。<br>&emsp;&emsp;比如直接绑定一个 Model 变量，实现多个 View 同步数据。</p>
</blockquote>
<h2 id="QBinder-实现原理"><a href="#QBinder-实现原理" class="headerlink" title="QBinder 实现原理"></a>QBinder 实现原理</h2><blockquote>
<p>&emsp;&emsp;上面看到的效果是第一个成熟版本实现的绑定效果。<br>&emsp;&emsp;中间的实现并不是一帆风顺的，磕磕绊绊地走过来，也踩了不少的坑。</p>
</blockquote>
<h3 id="自动绑定"><a href="#自动绑定" class="headerlink" title="自动绑定"></a>自动绑定</h3><blockquote>
<p>&emsp;&emsp;最初的想法我是参考了 pyqtconfig 的实现方式。<br>&emsp;&emsp;通过字典来描述 Qt 组件的行为，然后解析字典来实现绑定。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Qt</span><br><span class="line">HOOKS = &#123;&#125;</span><br><span class="line">HOOKS.update(&#123;</span><br><span class="line">    <span class="string">"QtWidgets.QWidget"</span>: &#123;</span><br><span class="line">        <span class="string">"setStyleSheet"</span>: &#123;</span><br><span class="line">            <span class="string">"type"</span>: str,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"setVisible"</span>: &#123;</span><br><span class="line">            <span class="string">"type"</span>: bool,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"QtWidgets.QLabel"</span>: &#123;</span><br><span class="line">        <span class="string">"setText"</span>: &#123;<span class="string">"type"</span>: str, <span class="string">"getter"</span>: <span class="string">"text"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"QtWidgets.QCheckBox"</span>: &#123;</span><br><span class="line">        <span class="string">"setChecked"</span>: &#123;</span><br><span class="line">            <span class="string">"type"</span>: bool,</span><br><span class="line">            <span class="string">"getter"</span>: <span class="string">"isChecked"</span>,</span><br><span class="line">            <span class="string">"updater"</span>: <span class="string">"stateChanged"</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"setText"</span>: &#123;<span class="string">"type"</span>: str, <span class="string">"getter"</span>: <span class="string">"text"</span>&#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hook_initialize</span><span class="params">(hooks)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> widget, setters <span class="keyword">in</span> hooks.items():</span><br><span class="line">        lib, widget = widget.split(<span class="string">"."</span>)</span><br><span class="line">        widget = getattr(getattr(Qt, lib), widget)</span><br><span class="line">        <span class="keyword">for</span> setter, options <span class="keyword">in</span> setters.items():</span><br><span class="line">            wrapper = binding_handler(getattr(widget, setter), options)</span><br><span class="line">            setattr(widget, setter, wrapper)</span><br><span class="line">hook_initialize(HOOKS)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>&emsp;&emsp;大致的操作如上面所示<br>&emsp;&emsp;默认只需要添加上 setter 即可绑定，倘若要双向数据绑定的话则需要添加上 updater<br>&emsp;&emsp;但是这样需要手动配置 Qt 所有的方法，感觉不太现实。<br>&emsp;&emsp;后来研究了一下 Qt 内置的机制，发现 Qt 有 meta 反射机制用来给 C++ 获取自身属性的。 <a href="https://doc.qt.io/qtforpython/overviews/metaobjects.html" target="_blank" rel="noopener">链接</a><br>&emsp;&emsp;虽然日常 Python 就带有反射特性，平时根本用不上，<br>&emsp;&emsp;但是通过 Qt 的 meta 特性可以判断函数是否为 signal 对象，这给我双向绑定提供了自动化操作的可能。<br>&emsp;&emsp;并且如果要兼容 Qt 的老版本，通过 meta 特性获取的函数比起手动配置考虑兼容要更好。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="comment"># NOTE https://stackoverflow.com/a/8702435</span></span><br><span class="line">nestdict = <span class="keyword">lambda</span>: defaultdict(nestdict)</span><br><span class="line">HOOKS = nestdict()</span><br><span class="line">_HOOKS_REL = nestdict()</span><br><span class="line">qt_dict = &#123;<span class="string">"QtWidgets.%s"</span> % n: m <span class="keyword">for</span> n, m <span class="keyword">in</span> inspect.getmembers(QtWidgets)&#125;</span><br><span class="line">qt_dict.update(&#123;<span class="string">"QtCore.%s"</span> % n: m <span class="keyword">for</span> n, m <span class="keyword">in</span> inspect.getmembers(QtCore)&#125;)</span><br><span class="line">qt_dict.update(&#123;<span class="string">"QtGui.%s"</span> % n: m <span class="keyword">for</span> n, m <span class="keyword">in</span> inspect.getmembers(QtGui)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">byte2str</span><span class="params">(text)</span>:</span></span><br><span class="line">    <span class="comment"># NOTE compat python 2 and 3</span></span><br><span class="line">    <span class="keyword">return</span> str(text, encoding=<span class="string">"utf-8"</span>) <span class="keyword">if</span> sys.hexversion &gt;= <span class="number">0x3000000</span> <span class="keyword">else</span> str(text)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_method_name</span><span class="params">(method)</span>:</span></span><br><span class="line">    <span class="comment"># NOTE compat Qt 4 and 5</span></span><br><span class="line">    version = QtCore.qVersion()</span><br><span class="line">    name = <span class="string">""</span></span><br><span class="line">    count = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">if</span> version.startswith(<span class="string">"5"</span>):</span><br><span class="line">        name = method.name()</span><br><span class="line">        count = method.parameterCount()</span><br><span class="line">    <span class="keyword">elif</span> version.startswith(<span class="string">"4"</span>):</span><br><span class="line">        name = method.signature()</span><br><span class="line">        name = name.split(<span class="string">"("</span>)[<span class="number">0</span>]</span><br><span class="line">        count = method.parameterNames()</span><br><span class="line">    <span class="keyword">return</span> byte2str(name), count</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> name, member <span class="keyword">in</span> qt_dict.items():</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> hasattr(member, <span class="string">"staticMetaObject"</span>):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    meta_obj = getattr(member, <span class="string">"staticMetaObject"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># NOTE 目前最新版本使用了 json 配置进行 hook</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(meta_obj.methodCount()):</span><br><span class="line">        method = meta_obj.method(i)</span><br><span class="line">        method_name, count = get_method_name(method)</span><br><span class="line">        <span class="keyword">if</span> count <span class="keyword">and</span> method.methodType() != QtCore.QMetaMethod.Signal:</span><br><span class="line">            <span class="keyword">if</span> hasattr(member, method_name):</span><br><span class="line">                HOOKS[name][method_name] = &#123;&#125;</span><br><span class="line">                _HOOKS_REL[name][method_name.lower()] = method_name</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(meta_obj.propertyCount()):</span><br><span class="line">        property = meta_obj.property(i)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> property.hasNotifySignal():</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        property_name = property.name()</span><br><span class="line">        method_name = _HOOKS_REL[name].get(<span class="string">"set%s"</span> % property_name.lower())</span><br><span class="line">        data = HOOKS[name].get(method_name)</span><br><span class="line">        <span class="keyword">if</span> isinstance(data, dict):</span><br><span class="line">            updater, _ = get_method_name(property.notifySignal())</span><br><span class="line">            <span class="keyword">if</span> updater:</span><br><span class="line">                data.update(&#123;<span class="string">"updater"</span>: updater, <span class="string">"property"</span>: property_name&#125;)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>&emsp;&emsp;上面的代码可以获取到对应的 updater 和 property ，结构可以参考这个 <a href="https://github.com/FXTD-ODYSSEY/QBinder/blob/master/research/test_qt_meta.json" target="_blank" rel="noopener">链接</a><br>&emsp;&emsp;python3 之后 inspect 可以获取到函数的 signature 参数，但是要兼容 python2 的话只能使用这个。</p>
</blockquote>
<hr>
<blockquote>
<p>&emsp;&emsp;写文章的时候，我测试了代码，感觉到不对劲。<br>&emsp;&emsp;Qt 的 Meta 机制并没有记录所有的函数，只是记录特别少的部分，所以无法 hook 到所有的方法上。<br>&emsp;&emsp;我当时测试了 QLineEdit 的 setSelection 函数，就是没有 hook 到的。<br>&emsp;&emsp;所以只能修改方案。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;然而 Qt 不能无脑 hook 所有的函数，因为 Qt 有些函数是 static 类型的。<br>&emsp;&emsp;我 hook 了之后，测试一下案例就会出现 QApplication.postEvent 的错误。<br>&emsp;&emsp;而这个错误是因为静态方法变成了 unbouded method 导致的。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;于是为了解决这个问题走了很大的弯路。<br>&emsp;&emsp;首先我拿 QApplication 的 setStyleSheet 和 postEvent 进行方法类型对比。<br>&emsp;&emsp;发现在不同的环境下的获取的类型不一样</p>
</blockquote>
<pre><code>setStyleSheet
PySide  &lt;type &apos;method_descriptor&apos;&gt;
PyQt4   &lt;type &apos;builtin_function_or_method&apos;&gt;
PySide2 &lt;class &apos;method_descriptor&apos;&gt;
PyQt5   &lt;class &apos;builtin_function_or_method&apos;&gt;

postEvent
PySide  &lt;type &apos;builtin_function_or_method&apos;&gt;
PyQt4   &lt;type &apos;builtin_function_or_method&apos;&gt;
PySide2 &lt;class &apos;builtin_function_or_method&apos;&gt;
PyQt5   &lt;class &apos;builtin_function_or_method&apos;&gt;
</code></pre><blockquote>
<p>&emsp;&emsp;所以在 PySide 下可以利用这个类型的不同过滤出可以 hook 的函数。<br>&emsp;&emsp;但是在 PyQt 下的环境不可以区隔，如果用常规的装饰器写法会出错。<br>&emsp;&emsp;最难受的是 hook 的时候不会出错，出错在后面执行方法的时候，所以无法用异常处理来调整 hook 的过程。<br>&emsp;&emsp;我考虑到是 unbounded method 的问题其实可以让装饰器的 wrapper 函数提升为 类方法 去解决。<br>&emsp;&emsp;然后就用了很特殊的方法来写装饰器。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">deco</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,func)</span>:</span></span><br><span class="line">        self.func = func</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(self,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.func(*args,**kwargs)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">func = deco(func).wrapper</span><br></pre></td></tr></table></figure>
<blockquote>
<p>&emsp;&emsp;好好的装饰器被我魔改成类方法，就可以解决 unbondedmethod 的问题。<br>&emsp;&emsp;因为类已经实例化了， wrapper 返回的不是 unboundedmethod<br>&emsp;&emsp;这可以解决 postEvent 的问题。<br>&emsp;&emsp;但是在一些普通的 Qt 组件方法 比如 addWidget setLayout 就会出错<br>&emsp;&emsp;因为传入 func 变成 Qt 没有实例化的方法了。<br>&emsp;&emsp;所以这些方法需要用过去的装饰器来包裹才可以。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;于是折腾了好久又回到 static 函数区分的问题上。<br>&emsp;&emsp;最后来回折腾，决定还是使用白名单过滤来解决问题，直接简单。<br>&emsp;&emsp;反正我在 PySide 环境下已经获取出可以 hook 的名单，借助 Qt.py 的兼容，就可以直接过滤出 PyQt 的白名单。<br>&emsp;&emsp;然后读取 json 名单进行过滤即可。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;所以绕了一圈其实和最初的做法差不多，只是借助 Meta 机制自动绑定了 Signal 实现双向数据绑定。</p>
</blockquote>
<h3 id="Binder-数据绑定容器"><a href="#Binder-数据绑定容器" class="headerlink" title="Binder 数据绑定容器"></a>Binder 数据绑定容器</h3><blockquote>
<p>&emsp;&emsp;过去 QMVVM 框架下，容器被我固定命名为了 self.state 获取。<br>&emsp;&emsp;一方面 pylint 找不到 self.state 的定义，另外 self.state 变量如果已经有别的用途，会造成冲突。<br>&emsp;&emsp;所以这次重构的容器 Binder 作为一个可以任意命名的实例化对象。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># NOTE 需要 QApplication 启动的环境下运行</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> QBinder <span class="keyword">import</span> Binder</span><br><span class="line"></span><br><span class="line">state = Binder()</span><br><span class="line">state.num = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">print(type(state.num))</span><br><span class="line"><span class="comment"># &lt;type 'int'&gt;</span></span><br><span class="line">print(type(state[<span class="string">"num"</span>]))</span><br><span class="line"><span class="comment"># &lt;class 'QBinder.binding.Binding'&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NOTE 注册事件</span></span><br><span class="line">state[<span class="string">"num"</span>].connect(<span class="keyword">lambda</span>:print(<span class="string">'num change'</span>))</span><br><span class="line">state.num = <span class="number">2</span></span><br><span class="line"><span class="comment"># num change</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>&emsp;&emsp;Binder 重载 __setattr__ 这样给类对象添加 member 的时候可以自动将 member 转换为 binding 对象。<br>&emsp;&emsp;确保外部的写法保持简洁。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;利用 binding 对象的 __get__ 方法确保每次从 binder 获取的值都是值的本身，而不是 binding 对象。<br>&emsp;&emsp;但是一些特殊的情况，比如 binding 注册自定义更新事件的方法还是需要获取 binding 对象来执行。<br>&emsp;&emsp;于是我重载了 __getitem__ 和 __setitem__ 来用字典取值的方式获取变量的 binding 对象。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> QBinder <span class="keyword">import</span> Binder</span><br><span class="line"></span><br><span class="line">state = Binder()</span><br><span class="line">dispatcher = state(<span class="string">'dispatcher'</span>)</span><br><span class="line">dumper = state(<span class="string">'dumper'</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>&emsp;&emsp;为了避免 Binder 绑定 binding 对象的时候和自身命名的方法产生冲突<br>&emsp;&emsp;Binder 类重载 __call__ 方法，然后通过 命令 模式。<br>&emsp;&emsp;将对应方法 通过 BinderDispatcher 类进行分发调用。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;输入对应字符串会调用 BinderDispatcher 对象下的方法<br>&emsp;&emsp;输入 ‘dispatcher’ 是返回自己，获取到 BinderDispatcher 对象。<br>&emsp;&emsp;输入 ‘dumper’ 则是获取 BinderDumper 类来进行特殊存储标记。<br>&emsp;&emsp;具体的调用规则可以参考文档，如果输入非法调用名称会直接报错。<br>&emsp;&emsp;往后也可以考虑可以扩展用户自定义的方法~</p>
</blockquote>
<h3 id="Binding-绑定对象-amp-lambda-绑定"><a href="#Binding-绑定对象-amp-lambda-绑定" class="headerlink" title="Binding 绑定对象 &amp; lambda 绑定"></a>Binding 绑定对象 &amp; lambda 绑定</h3><blockquote>
<p>&emsp;&emsp;最初我先想法是通过 lambda 函数的 __closure__ 获取闭包的数据。<br>&emsp;&emsp;然而这个方法只能获取到传递到 lambda 的变量字符串。<br>&emsp;&emsp;也无法判断这些变量是否对应到实现定义的 binder 里面。<br>&emsp;&emsp;并不是那么好从这个方向获取 lambda 里面绑定的变量。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;后来我测试 Python 类的 __get__ 变量描述符可以在 lambda 里面触发。<br>&emsp;&emsp;那么当 __get__ 触发的时候我可以将触发的 binding 存储到一个数组里面。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/13.png" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;我用 contextmanager 通过 with 语句来简化代码</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/14.png" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;触发 lambda 的时候包裹一下 with 追踪一下 binding 变量就可以知道 binding 和 setter 关联的数组。<br>&emsp;&emsp;借助这个方法就可以给 binding 绑定 setter 函数<br>&emsp;&emsp;binding 则模仿 Qt 信号槽接口写了个很简易的函数注册执行功能</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/15.png" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;connect 注册 setter 更新函数。<br>&emsp;&emsp;emit 则遍历执行所有的 更新函数。<br>&emsp;&emsp;当 binding 的数值发生修改的时候会触发 BinderBase 的 __setattr__ 方法<br>&emsp;&emsp;__setattr__ 再触发 binding 的 set 方法来 emit 实现数据同步更新。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;Binding 对象本身是继承 QStandardItem 的，重载了部分相关方法，用来兼容 Qt 的 MVC 框架。<br>&emsp;&emsp;Binding 在设置对象的时候会根据对象类型自动重载相关的运算符。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;Binding 因为继承 QStandardItem 并不是继承 QObject 的。<br>&emsp;&emsp;因此无法使用 Qt 自带的 signal ， 我这里用 Python 的方式简单实现了 signal 的 API。<br>&emsp;&emsp;不过并没有考虑到多线程交互的情况，可能还是有必要改为 signal 来触发函数比较好。</p>
</blockquote>
<h3 id="FnBinding-函数绑定"><a href="#FnBinding-函数绑定" class="headerlink" title="FnBinding 函数绑定"></a>FnBinding 函数绑定</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> QBinder <span class="keyword">import</span> Binder</span><br><span class="line"></span><br><span class="line">state = Binder()</span><br><span class="line">state.callback = FnBinding()</span><br><span class="line"></span><br><span class="line"><span class="meta">@state.callback</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_</span><span class="params">()</span>:</span></span><br><span class="line">    print(<span class="string">'call'</span>)</span><br><span class="line"></span><br><span class="line">state.callback()</span><br><span class="line"><span class="comment"># call</span></span><br><span class="line"></span><br><span class="line">state.cls_method = FnBinding()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="meta">    @state.cls_method</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">callback</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'class callback'</span>,self)</span><br><span class="line"></span><br><span class="line">instance = Test()</span><br><span class="line"><span class="comment"># NOTE 因为绑定的是 类方法 需要注入 instance </span></span><br><span class="line">state.cls_method(instance)</span><br><span class="line"><span class="comment"># ('class callback', &lt;__main__.Test object at 0x00000259E1E93FD0&gt;)</span></span><br><span class="line"><span class="comment"># NOTE 如此注入 instance 方便 signal 链接</span></span><br><span class="line">state.cls_method[instance]</span><br><span class="line"></span><br><span class="line"><span class="comment"># NOTE 最初的函数绑定方法 | 不需要拆开成两行 但是 pylint 无法识别定义</span></span><br><span class="line"><span class="meta">@state('fn_bind')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>&emsp;&emsp;FnBinding 可以绑定组件的方法，方便其他组件进行调用。<br>&emsp;&emsp;目前类方法绑定的方式还是有点不友好，需要将实例传进函数里面，有待优化。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;另外之前的绑定方式是使用 dispatcher 驱动的 fn_bind 函数。<br>&emsp;&emsp;后来还是因为确保能够代码更加优雅，还是不推荐使用了。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;函数绑定的实现原理比较取巧。<br>&emsp;&emsp;配合 __call__ 方法实现装饰器调用和函数触发调用。<br>&emsp;&emsp;之前还写过一个 FnHook 的版本 和 FnBinding 类是分开的，后来觉得其实是可以合并到一起的。<br>&emsp;&emsp;只是会把 FnBinding 给写得稍微复杂了点。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/19.png" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;为了向前支持 fn_bind 的写法，所以 __init__ 保留了绑定的判断<br>&emsp;&emsp;如果不是老方案进行函数绑定。<br>&emsp;&emsp;那么装饰器触发的 __call__ 会进入 <code>self.binded</code> 的判断里面进行函数绑定。<br>&emsp;&emsp;最后会将当前的类信息和方法名 存储到字典里面。<br>&emsp;&emsp;后面会在 binder 对象里面找有没有添加到 binder 的类实例，实现实例的自动注入。<br>&emsp;&emsp;但是如果 binder 存在多个实例，那么默认只会拿第一个找到的实例，不是很好的方案，有待改进。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;connect_binder 函数会在 <code>state.callback = FnBinding()</code> 赋值语句中通过 __setattr__ 触发。<br>&emsp;&emsp;将后面绑定函数需要的信息补充完整。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;__getitem__ 的操作方便注入 instance 给 signal 进行连接。</p>
</blockquote>
<h3 id="QEventHook-全局事件钩子"><a href="#QEventHook-全局事件钩子" class="headerlink" title="QEventHook 全局事件钩子"></a>QEventHook 全局事件钩子</h3><blockquote>
<p>&emsp;&emsp;这个实现活用了 Qt 的 eventFilter 机制 <a href="https://doc.qt.io/qtforpython/overviews/eventsandfilters.html" target="_blank" rel="noopener">链接</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/16.png" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;给 QApplicaiton 的 instance 执行 installEventFilter 就可以 hook 到当前应用下所有的 Qt 事件。<br>&emsp;&emsp;这个就非常灵活， DCC 端也是完全支持的。<br>&emsp;&emsp;根据这个方法就可以捕获到特定组件的特定事件。<br>&emsp;&emsp;后来开发这个框架的过程中，突发奇想，如果我可以提供这些 event 事件接口的话。<br>&emsp;&emsp;我就不需要写一个新类去重载 虚函数事件了。(虚函数事件指的是 mousePressEvent 等的函数)<br>&emsp;&emsp;有时候就是想要在默认的组件上扩展一些小功能。<br>&emsp;&emsp;那么全局事件过滤来实现就会方便很多。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;QEventHook 的用法已经在上面领略过了。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/17.png" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;代码上使用 单例模式， 类在任何地方实例化都不会重复 添加事件过滤<br>&emsp;&emsp;重载了 类 的运算符，使得扩展组件的写法更加好看。<br>&emsp;&emsp;不过如果组件也重载了相关的运算符会出错的，所以这里保留了 函数 添加方案。<br>&emsp;&emsp;事件定义支持 QEvent 对象以及 字符串。</p>
</blockquote>
<h3 id="数据自动存储加载"><a href="#数据自动存储加载" class="headerlink" title="数据自动存储加载"></a>数据自动存储加载</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">state = Binder()</span><br><span class="line"></span><br><span class="line">dumper = state(<span class="string">'dumper'</span>)</span><br><span class="line"><span class="keyword">with</span> state(<span class="string">'dumper'</span>):</span><br><span class="line">    state.num = <span class="number">1</span></span><br><span class="line">    state.text = <span class="string">"text"</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>&emsp;&emsp;上面有演示过 state 通过命令调用 dispatcher 的方法<br>&emsp;&emsp;state(‘dumper’) 会直接返回 dumper 对象。<br>&emsp;&emsp;默认配置下 dumper 会在事件循环里面自动对双向绑cc定的 binding 进行读取和输出。<br>&emsp;&emsp;如果要对特殊的 binding 属性进行绑定，可以用 给 dumper 对象使用 with 语句。<br>&emsp;&emsp;with 语句下添加的 binding 会自动记录进行存储。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;实现原理其实类似于 lambda 绑定一样。<br>&emsp;&emsp;会在 binder __setattr__ 下查是否开启 trace ，开启就会将相关的 命名 存储到数组里面。<br>&emsp;&emsp;再通过 __exit__ 将数组的数据提取存放到 dumper 的名单里面进行 dump </p>
</blockquote>
<hr>
<blockquote>
<p>&emsp;&emsp;自动存储是通过 lambda 绑定实现的。<br>&emsp;&emsp;如果 lambda 绑定发现数据属于双向绑定状态会自动加入定时器触发 自动 读取和存储 功能<br>&emsp;&emsp;通过 QTimer.singleShot 确保在下一个 eventloop 里面实现存储数据的添加。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/18.png" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;自动存储会将文件存储到 临时目录，通过 md5 以 json 的格式进行存储。<br>&emsp;&emsp;其实用数据库比如 Python 自带的 sqlite 也是完全可以的，后期有时间可以把这些功能都补充一下。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;上面的自动存储 md5 对应的唯一计算方案也是我想了好久用比较取巧的方式实现的。<br>&emsp;&emsp;首先 Binder 实例化的时候会自动将实例存储到 BinderCollector 里面。<br>&emsp;&emsp;而这个添加的过程是和 Qt eventloop 关联起来的。<br>&emsp;&emsp;每次 eventloop 执行的时候就会将 Binder 添加到 BinderCollector 对应的字典里面，字典的值用 uuid 实现，确保不会碰撞。<br>&emsp;&emsp;那么每次 eventloop 跑完之后的数组序号对应的 Binder 都是可以匹配上的。<br>&emsp;&emsp;这样可以确保在 DCC 软件里面每次启动界面 Binder 实例都是对应同样的序号。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;最后为了区分脚本， json 文件的名称是 脚本路径+序号 再用 md5 算出来的。<br>&emsp;&emsp;这样我在 DCC 环境下多开个工具的时候读取的数据还是固定路径的数据。</p>
</blockquote>
<h3 id="handler-扩展操作"><a href="#handler-扩展操作" class="headerlink" title="handler 扩展操作"></a>handler 扩展操作</h3><blockquote>
<p>&emsp;&emsp;handler 函数是用来简化 binding 数据操作的类。<br>&emsp;&emsp;通过重写 __rrshift__ 函数重载了 &gt;&gt; 运算符。<br>&emsp;&emsp;实现上其实也没有什么特殊的，运算符重载的好处就是可以兼容 lambda 里面对 binding 赋值。<br>&emsp;&emsp;目前有考虑将 handler 做成可扩展的 API ，方便对 binding 做更复杂的操作。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;另外 handler 是如何获取到 binding 对象的，毕竟直接 <code>state.属性</code> 借助 __get__  方法获取的是实实在在的值。<br>&emsp;&emsp;但是 handler 却可以通过这个获取到 binding 对象。<br>&emsp;&emsp;其实还是利用 binding 的 __get__ 方法将自身存放到数组里面。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/301b3c35/20.png" alt="alt"></p>
<blockquote>
<p>&emsp;&emsp;handler 就可以通过 类的 _inst_ 属性来获取获取到数组。<br>&emsp;&emsp;之所以用数组而不是直接存储 self ，是应为直接获取 self 还是出发了 __get__ 导致获取的不是 binding 对象。<br>&emsp;&emsp;用数组包裹一层才是获取到 binding 的对象。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;handler 里面就是 <code>binding = Binding._inst_.pop()</code> 这样就可以为所欲为地对 binding 对象进行操作了。</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><blockquote>
<p>&emsp;&emsp;我过去重来没有做过这么复杂的框架，也就年初的时候搞了两个 Maya 工具 <a href="./13258e66.html">mpdb</a> <a href="./18de3838.html">CommandLauncher</a><br>&emsp;&emsp;要做比较庞大的框架，感觉自己的经验很有限。<br>&emsp;&emsp;以前看过网上一些 Design Pattern 设计模式的教程，都是一通讲解猛如虎，实践才知不清楚。<br>&emsp;&emsp;毕竟是闭门造车，只能自己摸着石头过河了。<br>&emsp;&emsp;所以这个框架用到的设计模式我自己也说不清楚，就是怎么方便调用怎么来的。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;这篇文章也断断续续写了 1 个多星期，因为写的时候发现 框架出现了一些问题。<br>&emsp;&emsp;于是又去把框架优化好再继续写。</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;这个框架的目标打算是兼容 python2&amp;3 同时兼容 PySide 和 PyQt 多个版本。<br>&emsp;&emsp;希望能借助 github 的生态让更多人参与到这个框架的开发。<br>&emsp;&emsp;也希望这个数据绑定框架能够方便到我们这些工具人，提高界面开发的效率~</p>
</blockquote>
<blockquote>
<p>&emsp;&emsp;这个只是个人填坑的记录，写得太冗长了，而且还把以前的历史版本都翻出来鞭尸了。<br>&emsp;&emsp;后续还要做个更精简的 wiki 文档~ ▄︻┻┳═一</p>
</blockquote>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">智伤帝</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://blog.l0v0.com/posts/301b3c35.html">https://blog.l0v0.com/posts/301b3c35.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.l0v0.com" target="_blank">智伤帝的个人博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E0%A0%86Qt-PyQt/">ࠆQt/PyQt</a><a class="post-meta__tags" href="/tags/%E0%A0%86Qt/">ࠆQt</a><a class="post-meta__tags" href="/tags/%E0%A0%86Qt-PySide/">ࠆQt/PySide</a></div><div class="post_share"><div class="addtoany"><div class="a2a_kit a2a_kit_size_32 a2a_default_style"><a class="a2a_button_facebook"></a><a class="a2a_button_twitter"></a><a class="a2a_button_wechat"></a><a class="a2a_button_sina_weibo"></a><a class="a2a_button_facebook_messenger"></a><a class="a2a_button_email"></a><a class="a2a_button_copy_link"></a><a class="a2a_dd" href="https://www.addtoany.com/share" target="_blank" rel="noopener"></a></div></div><script async="async" src="https://static.addtoany.com/menu/page.js"></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/img/wechatimg.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/img/wechatimg.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/img/alipayimg.jpg" target="_blank"><img class="post-qr-code-img" data-lazy-src="//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/img/alipayimg.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/e8c230c0.html"><img class="prev-cover" data-lazy-src="/" onerror="onerror=null;src='//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">【转载】 PYCON中国(2018)大会笔记 | Huoty's Blog</div></div></a></div><div class="next-post pull-right"><a href="/posts/c45d9aff.html"><img class="next-cover" data-lazy-src="/" onerror="onerror=null;src='//cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Maya Python 模型拍屏合并工具</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/1ba28015.html" title="Python Qt Overlay 堆叠组件"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/1ba28015/09.gif" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-04-06</div><div class="title">Python Qt Overlay 堆叠组件</div></div></a></div><div><a href="/posts/712b664b.html" title="Python - Python Qt 开发教程(7)"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/712b664b/01.gif" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-05-26</div><div class="title">Python - Python Qt 开发教程(7)</div></div></a></div><div><a href="/posts/6830570a.html" title="Python - Python Qt 开发教程(6)"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/6830570a/01.gif" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-05-25</div><div class="title">Python - Python Qt 开发教程(6)</div></div></a></div><div><a href="/posts/431d04c9.html" title="Python - Python Qt 开发教程(5)"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/431d04c9/01.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-05-20</div><div class="title">Python - Python Qt 开发教程(5)</div></div></a></div><div><a href="/posts/5a063588.html" title="Python - Python Qt 开发教程(4)"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/5a063588/01.gif" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-05-14</div><div class="title">Python - Python Qt 开发教程(4)</div></div></a></div><div><a href="/posts/2e0af969.html" title="Python - Python Qt 开发教程 扩展说明"><img class="cover" data-lazy-src="https://cdn.jsdelivr.net/gh/FXTD-odyssey/FXTD-odyssey.github.io@master/post_img/2e0af969/02.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2019-05-13</div><div class="title">Python - Python Qt 开发教程 扩展说明</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div class="comment-switch"><span class="first-comment">Valine</span><label><input id="switch-comments-btn" type="checkbox"/><span class="slider"></span></label><span class="second-comment">Gitalk</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="gitalk-container"></div></div></div></div></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By 智伤帝</div><div class="framework-info"><span>框架 </span><a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.spacingElementById('content-inner')
  else {
    $.getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js', () => {
      pangu.spacingElementById('content-inner')
    })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguFn)</script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> {preloader.endLoading()})</script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    let initData = {
      el: '#vcomment',
      appId: 'mrRioyNTSEAOvVLAsLgkhr4j-gzGzoHsz',
      appKey: 'wHDm1kxC2FUpOA7FNdgTOEnx',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
    }

    if (true) { 
      initData.requiredFields= ('nick,mail'.split(','))
    }
    
    if (false) {
      const otherData = false
      initData = Object.assign({}, initData, otherData)
    }
    
    const valine = new Valine(initData)
  }

  if (typeof Valine === 'function') initValine() 
  else $.getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js', initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.querySelector('#vcomment'),loadValine)
  else setTimeout(() => loadValine(), 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk({
      clientID: '355e44f722e24963b9dd',
      clientSecret: 'f8ec08d349714aa06152735a75b6d9ac9ef77016',
      repo: 'FXTD-odyssey.github.io',
      owner: 'FXTD-odyssey',
      admin: ['FXTD-odyssey'],
      id: 'c9b4e9dde633f494031f01c40bd38899',
      language: 'zh-CN',
      perPage: 10,
      distractionFreeMode: false,
      pagerDirection: 'last',
      createIssueManually: false,
      updateCountCallback: commentCount
    })
    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    $.getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js', initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Valine' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="https://cdn.jsdelivr.net/gh/wilq32/jqueryrotate/jQueryRotate.js"></script><script src="/js/classify.js"></script><script src="/js/jsdelivr.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script>(function(){
  const bp = document.createElement('script');
  const curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https'){
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  bp.dataset.pjax = ''
  const s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})()</script></div></body></html>